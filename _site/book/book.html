<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Architecture Patterns with Python</title>
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */

@import url("//fonts.googleapis.com/css?family=Noto+Sans:300,600italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700");
@import url(//asciidoctor.org/stylesheets/asciidoctor.css); /* Default asciidoc style framework - important */

/* customisations by harry */

/* hide inline ditaa/plantuml source listings for images */
.image-source {
    display: none
}
/* make formal codeblocks a bit nicer */
.exampleblock > .content {
    padding: 2px;
    background-color: white;
    border: 0;
    margin-bottom: 2em;
}

.exampleblock .title {
    text-align: right;
}

/* end customisations by harry */

/* CUSTOMISATIONS */

/* Change the values in root for quick customisation. If you want even more fine grain... venture further. */

:root{
--maincolor:#FFFFFF;
--primarycolor:#2c3e50;
--secondarycolor:#ba3925;
--tertiarycolor: #186d7a;
--sidebarbackground:#CCC;
--linkcolor:#b71c1c;
--linkcoloralternate:#f44336;
--white:#FFFFFF;
--black:#000000;
}

/* Text styles */
h1{color:var(--primarycolor) !important;}
h2,h3,h4,h5,h6{color:var(--secondarycolor) !important;}
.title{color:var(--tertiarycolor) !important; font-family:"Noto Sans",sans-serif !important;font-style: normal !important; font-weight: normal !important;}
p{font-family: "Noto Sans",sans-serif !important}

/* Table styles */
th{font-family: "Noto Sans",sans-serif !important}

/* Responsiveness fixes */
video {
  max-width: 100%;
}

@media all and (max-width: 600px) {
table {
  width: 55vw!important;
  font-size: 3vw;
}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book">
<div id="header">
<h1>Architecture Patterns with Python</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#preface">Preface</a>
<ul class="sectlevel2">
<li><a href="#_managing_complexity_solving_business_problems">Managing Complexity, Solving Business Problems</a></li>
<li><a href="#_why_python">Why Python?</a></li>
<li><a href="#_tdd_ddd_and_event_driven_architecture">TDD, DDD, and Event-Driven Architecture</a></li>
<li><a href="#_who_should_read_this_book">Who Should Read This Book</a></li>
<li><a href="#_a_brief_overview_of_what_youll_learn">A Brief Overview of What You&#8217;ll Learn</a></li>
<li><a href="#_example_code_and_coding_along">Example Code and Coding Along</a></li>
<li><a href="#_license">License</a></li>
<li><a href="#_conventions_used_in_this_book">Conventions Used in This Book</a></li>
<li><a href="#_oreilly_online_learning">O&#8217;Reilly Online Learning</a></li>
<li><a href="#_how_to_contact_oreilly">How to Contact O&#8217;Reilly</a></li>
<li><a href="#_acknowledgments">Acknowledgments</a></li>
</ul>
</li>
<li><a href="#introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#_why_do_our_designs_go_wrong">Why Do Our Designs Go Wrong?</a></li>
<li><a href="#_encapsulation_and_abstractions">Encapsulation and Abstractions</a></li>
<li><a href="#_layering">Layering</a></li>
<li><a href="#dip">The Dependency Inversion Principle</a></li>
<li><a href="#_a_place_for_all_our_business_logic_the_domain_model">A Place for All Our Business Logic: The Domain Model</a></li>
</ul>
</li>
<li><a href="#part1">Building an Architecture to Support Domain Modeling</a></li>
<li><a href="#chapter_01_domain_model">1. Domain Modeling</a>
<ul class="sectlevel2">
<li><a href="#_what_is_a_domain_model">1.1. What Is a Domain Model?</a></li>
<li><a href="#_exploring_the_domain_language">1.2. Exploring the Domain Language</a></li>
<li><a href="#_unit_testing_domain_models">1.3. Unit Testing Domain Models</a></li>
<li><a href="#_not_everything_has_to_be_an_object_a_domain_service_function">1.4. Not Everything Has to Be an Object: A Domain Service Function</a></li>
</ul>
</li>
<li><a href="#chapter_02_repository">2. Repository Pattern</a>
<ul class="sectlevel2">
<li><a href="#_persisting_our_domain_model">2.1. Persisting Our Domain Model</a></li>
<li><a href="#_some_pseudocode_what_are_we_going_to_need">2.2. Some Pseudocode: What Are We Going to Need?</a></li>
<li><a href="#_applying_the_dip_to_data_access">2.3. Applying the DIP to Data Access</a></li>
<li><a href="#_reminder_our_model">2.4. Reminder: Our Model</a></li>
<li><a href="#_introducing_the_repository_pattern">2.5. Introducing the Repository Pattern</a></li>
<li><a href="#_building_a_fake_repository_for_tests_is_now_trivial">2.6. Building a Fake Repository for Tests Is Now Trivial!</a></li>
<li><a href="#what_is_a_port_and_what_is_an_adapter">2.7. What Is a Port and What Is an Adapter, in Python?</a></li>
<li><a href="#_wrap_up">2.8. Wrap-Up</a></li>
</ul>
</li>
<li><a href="#chapter_03_abstractions">3. A Brief Interlude: On Coupling <span class="keep-together">and Abstractions</span></a>
<ul class="sectlevel2">
<li><a href="#_abstracting_state_aids_testability">3.1. Abstracting State Aids Testability</a></li>
<li><a href="#_choosing_the_right_abstractions">3.2. Choosing the Right Abstraction(s)</a></li>
<li><a href="#_implementing_our_chosen_abstractions">3.3. Implementing Our Chosen Abstractions</a></li>
<li><a href="#_wrap_up_2">3.4. Wrap-Up</a></li>
</ul>
</li>
<li><a href="#chapter_04_service_layer">4. Our First Use Case: <span class="keep-together">Flask API and Service Layer</span></a>
<ul class="sectlevel2">
<li><a href="#_connecting_our_application_to_the_real_world">4.1. Connecting Our Application to the Real World</a></li>
<li><a href="#_a_first_end_to_end_test">4.2. A First End-to-End Test</a></li>
<li><a href="#_the_straightforward_implementation">4.3. The Straightforward Implementation</a></li>
<li><a href="#_error_conditions_that_require_database_checks">4.4. Error Conditions That Require Database Checks</a></li>
<li><a href="#_introducing_a_service_layer_and_using_fakerepository_to_unit_test_it">4.5. Introducing a Service Layer, and Using FakeRepository to Unit Test It</a></li>
<li><a href="#why_is_everything_a_service">4.6. Why Is Everything Called a Service?</a></li>
<li><a href="#_putting_things_in_folders_to_see_where_it_all_belongs">4.7. Putting Things in Folders to See Where It All Belongs</a></li>
<li><a href="#_wrap_up_3">4.8. Wrap-Up</a></li>
</ul>
</li>
<li><a href="#chapter_05_high_gear_low_gear">5. TDD in High Gear and Low Gear</a>
<ul class="sectlevel2">
<li><a href="#_how_is_our_test_pyramid_looking">5.1. How Is Our Test Pyramid Looking?</a></li>
<li><a href="#_should_domain_layer_tests_move_to_the_service_layer">5.2. Should Domain Layer Tests Move to the Service Layer?</a></li>
<li><a href="#kinds_of_tests">5.3. On Deciding What Kind of Tests to Write</a></li>
<li><a href="#_high_and_low_gear">5.4. High and Low Gear</a></li>
<li><a href="#primitive_obsession">5.5. Fully Decoupling the Service-Layer Tests from the Domain</a></li>
<li><a href="#_carrying_the_improvement_through_to_the_e2e_tests">5.6. Carrying the Improvement Through to the E2E Tests</a></li>
<li><a href="#_wrap_up_4">5.7. Wrap-Up</a></li>
</ul>
</li>
<li><a href="#chapter_06_uow">6. Unit of Work Pattern</a>
<ul class="sectlevel2">
<li><a href="#_the_unit_of_work_collaborates_with_the_repository">6.1. The Unit of Work Collaborates with the Repository</a></li>
<li><a href="#_test_driving_a_uow_with_integration_tests">6.2. Test-Driving a UoW with Integration Tests</a></li>
<li><a href="#_unit_of_work_and_its_context_manager">6.3. Unit of Work and Its Context Manager</a></li>
<li><a href="#_using_the_uow_in_the_service_layer">6.4. Using the UoW in the Service Layer</a></li>
<li><a href="#_explicit_tests_for_commitrollback_behavior">6.5. Explicit Tests for Commit/Rollback Behavior</a></li>
<li><a href="#_explicit_versus_implicit_commits">6.6. Explicit Versus Implicit Commits</a></li>
<li><a href="#_examples_using_uow_to_group_multiple_operations_into_an_atomic_unit">6.7. Examples: Using UoW to Group Multiple Operations into an Atomic Unit</a></li>
<li><a href="#_tidying_up_the_integration_tests">6.8. Tidying Up the Integration Tests</a></li>
<li><a href="#_wrap_up_5">6.9. Wrap-Up</a></li>
</ul>
</li>
<li><a href="#chapter_07_aggregate">7. Aggregates and Consistency Boundaries</a>
<ul class="sectlevel2">
<li><a href="#_why_not_just_run_everything_in_a_spreadsheet">7.1. Why Not Just Run Everything in a Spreadsheet?</a></li>
<li><a href="#_invariants_constraints_and_consistency">7.2. Invariants, Constraints, and Consistency</a></li>
<li><a href="#_what_is_an_aggregate">7.3. What Is an Aggregate?</a></li>
<li><a href="#_choosing_an_aggregate">7.4. Choosing an Aggregate</a></li>
<li><a href="#_one_aggregate_one_repository">7.5. One Aggregate = One Repository</a></li>
<li><a href="#_what_about_performance">7.6. What About Performance?</a></li>
<li><a href="#_optimistic_concurrency_with_version_numbers">7.7. Optimistic Concurrency with Version Numbers</a></li>
<li><a href="#_testing_for_our_data_integrity_rules">7.8. Testing for Our Data Integrity Rules</a></li>
<li><a href="#_wrap_up_6">7.9. Wrap-Up</a></li>
<li><a href="#_part_i_recap">7.10. Part I Recap</a></li>
</ul>
</li>
<li><a href="#part2">Event-Driven Architecture</a></li>
<li><a href="#chapter_08_events_and_message_bus">8. Events and the Message Bus</a>
<ul class="sectlevel2">
<li><a href="#_avoiding_making_a_mess">8.1. Avoiding Making a Mess</a></li>
<li><a href="#_single_responsibility_principle">8.2. Single Responsibility Principle</a></li>
<li><a href="#_all_aboard_the_message_bus">8.3. All Aboard the Message Bus!</a></li>
<li><a href="#_option_1_the_service_layer_takes_events_from_the_model_and_puts_them_on_the_message_bus">8.4. Option 1: The Service Layer Takes Events from the Model and Puts Them on the Message Bus</a></li>
<li><a href="#_option_2_the_service_layer_raises_its_own_events">8.5. Option 2: The Service Layer Raises Its Own Events</a></li>
<li><a href="#_option_3_the_uow_publishes_events_to_the_message_bus">8.6. Option 3: The UoW Publishes Events to the Message Bus</a></li>
<li><a href="#_wrap_up_7">8.7. Wrap-Up</a></li>
</ul>
</li>
<li><a href="#chapter_09_all_messagebus">9. Going to Town on the Message Bus</a>
<ul class="sectlevel2">
<li><a href="#_a_new_requirement_leads_us_to_a_new_architecture">9.1. A New Requirement Leads Us to a New Architecture</a></li>
<li><a href="#_refactoring_service_functions_to_message_handlers">9.2. Refactoring Service Functions to Message Handlers</a></li>
<li><a href="#_implementing_our_new_requirement">9.3. Implementing Our New Requirement</a></li>
<li><a href="#test-driving-ch9">9.4. Test-Driving a New Handler</a></li>
<li><a href="#fake_message_bus">9.5. Optionally: Unit Testing Event Handlers in Isolation with a Fake Message Bus</a></li>
<li><a href="#_wrap_up_8">9.6. Wrap-Up</a></li>
</ul>
</li>
<li><a href="#chapter_10_commands">10. Commands and Command Handler</a>
<ul class="sectlevel2">
<li><a href="#_commands_and_events">10.1. Commands and Events</a></li>
<li><a href="#_differences_in_exception_handling">10.2. Differences in Exception Handling</a></li>
<li><a href="#_discussion_events_commands_and_error_handling">10.3. Discussion: Events, Commands, and Error Handling</a></li>
<li><a href="#recovering_from_errors">10.4. Recovering from Errors Synchronously</a></li>
<li><a href="#_wrap_up_9">10.5. Wrap-Up</a></li>
</ul>
</li>
<li><a href="#chapter_11_external_events">11. Event-Driven Architecture: Using Events to Integrate Microservices</a>
<ul class="sectlevel2">
<li><a href="#_distributed_ball_of_mud_and_thinking_in_nouns">11.1. Distributed Ball of Mud, and Thinking in Nouns</a></li>
<li><a href="#_error_handling_in_distributed_systems">11.2. Error Handling in Distributed Systems</a></li>
<li><a href="#_the_alternative_temporal_decoupling_using_asynchronous_messaging">11.3. The Alternative: Temporal Decoupling Using Asynchronous Messaging</a></li>
<li><a href="#_using_a_redis_pubsub_channel_for_integration">11.4. Using a Redis Pub/Sub Channel for Integration</a></li>
<li><a href="#_test_driving_it_all_using_an_end_to_end_test">11.5. Test-Driving It All Using an End-to-End Test</a></li>
<li><a href="#_internal_versus_external_events">11.6. Internal Versus External Events</a></li>
<li><a href="#_wrap_up_10">11.7. Wrap-Up</a></li>
</ul>
</li>
<li><a href="#chapter_12_cqrs">12. Command-Query Responsibility Segregation (CQRS)</a>
<ul class="sectlevel2">
<li><a href="#_domain_models_are_for_writing">12.1. Domain Models Are for Writing</a></li>
<li><a href="#_most_users_arent_going_to_buy_your_furniture">12.2. Most Users Aren&#8217;t Going to Buy Your Furniture</a></li>
<li><a href="#_postredirectget_and_cqs">12.3. Post/Redirect/Get and CQS</a></li>
<li><a href="#hold-on-ch12">12.4. Hold On to Your Lunch, Folks</a></li>
<li><a href="#_testing_cqrs_views">12.5. Testing CQRS Views</a></li>
<li><a href="#_obvious_alternative_1_using_the_existing_repository">12.6. "Obvious" Alternative 1: Using the Existing Repository</a></li>
<li><a href="#_your_domain_model_is_not_optimized_for_read_operations">12.7. Your Domain Model Is Not Optimized for Read Operations</a></li>
<li><a href="#_obvious_alternative_2_using_the_orm">12.8. "Obvious" Alternative 2: Using the ORM</a></li>
<li><a href="#_select_n1_and_other_performance_considerations">12.9. SELECT N+1 and Other Performance Considerations</a></li>
<li><a href="#_time_to_completely_jump_the_shark">12.10. Time to Completely Jump the Shark</a></li>
<li><a href="#_changing_our_read_model_implementation_is_easy">12.11. Changing Our Read Model Implementation Is Easy</a></li>
<li><a href="#_wrap_up_11">12.12. Wrap-Up</a></li>
</ul>
</li>
<li><a href="#chapter_13_dependency_injection">13. Dependency Injection (and Bootstrapping)</a>
<ul class="sectlevel2">
<li><a href="#_implicit_versus_explicit_dependencies">13.1. Implicit Versus Explicit Dependencies</a></li>
<li><a href="#_arent_explicit_dependencies_totally_weird_and_java_y">13.2. Aren&#8217;t Explicit Dependencies Totally Weird and Java-y?</a></li>
<li><a href="#_preparing_handlers_manual_di_with_closures_and_partials">13.3. Preparing Handlers: Manual DI with Closures and Partials</a></li>
<li><a href="#_an_alternative_using_classes">13.4. An Alternative Using Classes</a></li>
<li><a href="#_a_bootstrap_script">13.5. A Bootstrap Script</a></li>
<li><a href="#_message_bus_is_given_handlers_at_runtime">13.6. Message Bus Is Given Handlers at Runtime</a></li>
<li><a href="#_using_bootstrap_in_our_entrypoints">13.7. Using Bootstrap in Our Entrypoints</a></li>
<li><a href="#_initializing_di_in_our_tests">13.8. Initializing DI in Our Tests</a></li>
<li><a href="#_building_an_adapter_properly_a_worked_example">13.9. Building an Adapter "Properly": A Worked Example</a></li>
<li><a href="#_wrap_up_12">13.10. Wrap-Up</a></li>
</ul>
</li>
<li><a href="#epilogue_1_how_to_get_there_from_here">Appendix A: Epilogue</a>
<ul class="sectlevel2">
<li><a href="#_what_now">What Now?</a></li>
<li><a href="#_how_do_i_get_there_from_here">How Do I Get There from Here?</a></li>
<li><a href="#_separating_entangled_responsibilities">Separating Entangled Responsibilities</a></li>
<li><a href="#_identifying_aggregates_and_bounded_contexts">Identifying Aggregates and Bounded Contexts</a></li>
<li><a href="#_an_event_driven_approach_to_go_to_microservices_via_strangler_pattern">An Event-Driven Approach to Go to Microservices via Strangler Pattern</a></li>
<li><a href="#_convincing_your_stakeholders_to_try_something_new">Convincing Your Stakeholders to Try Something New</a></li>
<li><a href="#_questions_our_tech_reviewers_asked_that_we_couldnt_work_into_prose">Questions Our Tech Reviewers Asked That We Couldn&#8217;t Work into Prose</a></li>
<li><a href="#footguns">Footguns</a></li>
<li><a href="#_more_required_reading">More Required Reading</a></li>
<li><a href="#_wrap_up_13">Wrap-Up</a></li>
</ul>
</li>
<li><a href="#appendix_ds1_table">Appendix B: Summary Diagram and Table</a></li>
<li><a href="#appendix_project_structure">Appendix C: A Template Project Structure</a>
<ul class="sectlevel2">
<li><a href="#_env_vars_12_factor_and_config_inside_and_outside_containers">C.1. Env Vars, 12-Factor, and Config, Inside and Outside Containers</a></li>
<li><a href="#_config_py">C.2. Config.py</a></li>
<li><a href="#_docker_compose_and_containers_config">C.3. Docker-Compose and Containers Config</a></li>
<li><a href="#_installing_your_source_as_a_package">C.4. Installing Your Source as a Package</a></li>
<li><a href="#_dockerfile">C.5. Dockerfile</a></li>
<li><a href="#_tests">C.6. Tests</a></li>
<li><a href="#_wrap_up_14">C.7. Wrap-Up</a></li>
</ul>
</li>
<li><a href="#appendix_csvs">Appendix D: Swapping Out the Infrastructure: <span class="keep-together">Do Everything with CSVs</span></a>
<ul class="sectlevel2">
<li><a href="#_implementing_a_repository_and_unit_of_work_for_csvs">D.1. Implementing a Repository and Unit of Work for CSVs</a></li>
</ul>
</li>
<li><a href="#appendix_django">Appendix E: Repository and Unit of Work <span class="keep-together">Patterns with Django</span></a>
<ul class="sectlevel2">
<li><a href="#_repository_pattern_with_django">E.1. Repository Pattern with Django</a></li>
<li><a href="#_unit_of_work_pattern_with_django">E.2. Unit of Work Pattern with Django</a></li>
<li><a href="#_api_django_views_are_adapters">E.3. API: Django Views Are Adapters</a></li>
<li><a href="#_why_was_this_all_so_hard">E.4. Why Was This All So Hard?</a></li>
<li><a href="#_what_to_do_if_you_already_have_django">E.5. What to Do If You Already Have Django</a></li>
<li><a href="#_steps_along_the_way">E.6. Steps Along the Way</a></li>
</ul>
</li>
<li><a href="#appendix_validation">Appendix F: Validation</a>
<ul class="sectlevel2">
<li><a href="#_what_is_validation_anyway">F.1. What Is Validation, Anyway?</a></li>
<li><a href="#_validating_syntax">F.2. Validating Syntax</a></li>
<li><a href="#_postels_law_and_the_tolerant_reader_pattern">F.3. Postel&#8217;s Law and the Tolerant Reader Pattern</a></li>
<li><a href="#_validating_at_the_edge">F.4. Validating at the Edge</a></li>
<li><a href="#_validating_semantics">F.5. Validating Semantics</a></li>
<li><a href="#_validating_pragmatics">F.6. Validating Pragmatics</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="preface">Preface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You may be wondering who we are and why we wrote this book.</p>
</div>
<div class="paragraph">
<p>At the end of Harry&#8217;s last book,
<a href="http://obeythetestinggoat.com"><em>Test-Driven Development with Python</em></a> (O&#8217;Reilly),
he found himself asking a bunch of questions about architecture, such as,
What&#8217;s the best way of structuring your application so that it&#8217;s easy to test?
More specifically, so that your core business logic is covered by unit tests,
and so that you minimize the number of integration and end-to-end tests you need?
He made vague references to "Hexagonal Architecture" and "Ports and Adapters"
and "Functional Core, Imperative Shell," but if he was honest, he&#8217;d have to
admit that these weren&#8217;t things he really understood or had done in practice.</p>
</div>
<div class="paragraph">
<p>And then he was lucky enough to run into Bob, who has the answers to all these
questions.</p>
</div>
<div class="paragraph">
<p>Bob ended up a software architect because nobody else on his team was
doing it. He turned out to be pretty bad at it, but <em>he</em> was lucky enough to run
into Ian Cooper, who taught him new ways of writing and thinking about code.</p>
</div>
<div class="sect2">
<h3 id="_managing_complexity_solving_business_problems">Managing Complexity, Solving Business Problems</h3>
<div class="paragraph">
<p>We both work for MADE.com, a European ecommerce company that sells furniture
online; there, we apply the techniques in this book to build distributed systems
that model real-world business problems. Our example domain is the first system
Bob built for MADE, and this book is an attempt to write down all the <em>stuff</em> we
have to teach new programmers when they join one of our teams.</p>
</div>
<div class="paragraph">
<p>MADE.com operates a global supply chain of freight partners and manufacturers.
To keep costs low, we try to optimize the delivery of stock to our
warehouses so that we don&#8217;t have unsold goods lying around the place.</p>
</div>
<div class="paragraph">
<p>Ideally, the sofa that you want to buy will arrive in port on the very day
that you decide to buy it, and we&#8217;ll ship it straight to your house without
ever storing it. <span class="keep-together">Getting</span> the timing right is a tricky balancing act when goods take
three months to arrive by container ship. Along the way, things get broken or water
damaged, storms cause unexpected delays, logistics partners mishandle goods,
paperwork goes missing, customers change their minds and amend their orders,
and so on.</p>
</div>
<div class="paragraph">
<p>We solve those problems by building intelligent software representing the
kinds of operations taking place in the real world so that we can automate as
much of the business as possible.</p>
</div>
</div>
<div class="sect2">
<h3 id="_why_python">Why Python?</h3>
<div class="paragraph">
<p>If you&#8217;re reading this book, we probably don&#8217;t need to convince you that Python
is great, so the real question is "Why does the <em>Python</em> community need a book
like this?" The answer is about Python&#8217;s popularity and maturity: although Python is
probably the world&#8217;s fastest-growing programming language and is nearing the top
of the absolute popularity tables, it&#8217;s only just starting to take on the kinds
of problems that the C# and Java world has been working on for years.
Startups become real businesses; web apps and scripted automations are becoming
(whisper it) <em>enterprise</em> <span class="keep-together"><em>software</em></span>.</p>
</div>
<div class="paragraph">
<p>In the Python world, we often quote the Zen of Python:
"There should be one&#8212;&#8203;and preferably only one&#8212;&#8203;obvious way to do it."<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
Unfortunately, as project size grows, the most obvious way of doing things
isn&#8217;t always the way that helps you manage complexity and evolving
requirements.</p>
</div>
<div class="paragraph">
<p>None of the techniques and patterns we discuss in this book are
new, but they are mostly new to the Python world. And this book isn&#8217;t
a replacement for the classics in the field such as Eric Evans&#8217;s
<em>Domain-Driven Design</em>
or Martin Fowler&#8217;s <em>Patterns of
Enterprise Application Architecture</em> (both published by Addison-Wesley <span class="keep-together">Professional</span>)—which we often refer to and
encourage you to go and read.</p>
</div>
<div class="paragraph">
<p>But all the classic code examples in the literature do tend to be written in
Java or <span class="keep-together">C++/#</span>, and if you&#8217;re a Python person and haven&#8217;t used either of
those languages in a long time (or indeed ever), those code listings can be
quite&#8230;&#8203;trying. There&#8217;s a reason the latest edition of that other classic text, Fowler&#8217;s
<em>Refactoring</em> (Addison-Wesley Professional), is in JavaScript.</p>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_tdd_ddd_and_event_driven_architecture">TDD, DDD, and Event-Driven Architecture</h3>
<div class="paragraph">
<p>In order of notoriety, we know of three tools for managing complexity:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>Test-driven development</em> (TDD) helps us to build code that is correct
and enables us to refactor or add new features, without fear of regression.
But it can be hard to get the best out of our tests: How do we make sure
that they run as fast as possible? That we get as much coverage and feedback
from fast, dependency-free unit tests and have the minimum number of slower,
flaky end-to-end tests?</p>
</li>
<li>
<p><em>Domain-driven design</em> (DDD) asks us to focus our efforts on building a good
model of the business domain, but how do we make sure that our models aren&#8217;t
encumbered with infrastructure concerns and don&#8217;t become hard to change?</p>
</li>
<li>
<p>Loosely coupled (micro)services integrated via messages (sometimes called
<em>reactive microservices</em>) are a well-established answer to managing complexity
across multiple applications or business domains. But it&#8217;s not always
obvious how to make them fit with the established tools of
the Python world&#8212;&#8203;Flask, Django, Celery, and so on.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Don&#8217;t be put off if you&#8217;re not working with (or interested in) microservices.  The vast majority of the patterns we discuss, including much of the event-driven architecture material, is absolutely applicable in a monolithic architecture.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Our aim with this book is to introduce several classic architectural patterns
and show how they support TDD, DDD, and event-driven services.  We hope
it will serve as a reference for implementing them in a Pythonic way, and that
people can use it as a first step toward further research  in this field.</p>
</div>
</div>
<div class="sect2">
<h3 id="_who_should_read_this_book">Who Should Read This Book</h3>
<div class="paragraph">
<p>Here are a few things we assume about you, dear reader:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You&#8217;ve been close to some reasonably complex Python applications.</p>
</li>
<li>
<p>You&#8217;ve seen some of the pain that comes with trying to manage
that complexity.</p>
</li>
<li>
<p>You don&#8217;t necessarily know anything about DDD or any of the
classic application architecture patterns.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We structure our explorations of architectural patterns around an example app,
building it up chapter by chapter. We use TDD at
work, so we tend to show listings of tests first, followed by implementation.
If you&#8217;re not used to working test-first, it may feel a little strange at
the beginning, but we hope you&#8217;ll soon get used to seeing code "being used"
(i.e., from the outside) before you see how it&#8217;s built on the inside.</p>
</div>
<div class="paragraph">
<p>We use some specific Python frameworks and technologies, including Flask,
SQLAlchemy, and pytest, as well as Docker and Redis. If you&#8217;re already
familiar with them, that won&#8217;t hurt, but we don&#8217;t think it&#8217;s required.  One of
our main aims with this book is to build an architecture for which specific
technology choices become minor implementation details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_brief_overview_of_what_youll_learn">A Brief Overview of What You&#8217;ll Learn</h3>
<div class="paragraph">
<p>The book is divided into two parts; here&#8217;s a look at the topics we&#8217;ll cover
and the chapters they live in.</p>
</div>
<div class="sect3">
<h4 id="_part1"><a data-type="xref" data-xrefstyle="chap-num-title" href="#part1">#part1</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Domain modeling and DDD (Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_01_domain_model">#chapter_01_domain_model</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_07_aggregate">#chapter_07_aggregate</a>)</dt>
<dd>
<p>At some level, everyone has learned the lesson that complex business
problems need to be reflected in code, in the form of a model of the domain.
But why does it always seem to be so hard to do without getting tangled
up with infrastructure concerns, our web frameworks, or whatever else?
In the first chapter we give a broad overview of <em>domain modeling</em> and DDD, and we
show how to get started with a model that has no external dependencies, and
fast unit tests. Later we return to DDD patterns to discuss how to choose
the right aggregate, and how this choice relates to questions of data
integrity.</p>
</dd>
<dt class="hdlist1">Repository, Service Layer, and Unit of Work patterns (Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_02_repository">#chapter_02_repository</a>, <a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_04_service_layer">#chapter_04_service_layer</a>, and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_05_high_gear_low_gear">#chapter_05_high_gear_low_gear</a>)</dt>
<dd>
<p>In these three chapters we present three closely related and
mutually reinforcing patterns that support our ambition to keep
the model free of extraneous dependencies.  We build a layer of
abstraction around persistent storage, and we build a service
layer to define the entrypoints to our system and capture the
primary use cases. We show how this layer makes it easy to build
thin entrypoints to our system, whether it&#8217;s a Flask API or a CLI.</p>
</dd>
</dl>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Some thoughts on testing and abstractions (Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_03_abstractions">#chapter_03_abstractions</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_06_uow">#chapter_06_uow</a>)</dt>
<dd>
<p>After presenting the first abstraction (the Repository pattern), we take the
opportunity for a general discussion of how to choose abstractions, and
what their role is in choosing how our software is coupled together. After
we introduce the Service Layer pattern, we talk a bit about achieving a <em>test pyramid</em>
and writing unit tests at the highest possible level of abstraction.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_part2"><a data-type="xref" data-xrefstyle="chap-num-title" href="#part2">#part2</a></h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Event-driven architecture (Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_08_events_and_message_bus">#chapter_08_events_and_message_bus</a>–<a data-type="xref" data-xrefstyle="select:labelnumber" href="#chapter_11_external_events">#chapter_11_external_events</a>)</dt>
<dd>
<p>We introduce three more mutually reinforcing patterns: the Domain Events, Message Bus, and Handler patterns. <em>Domain events</em> are a vehicle for capturing the idea that some
interactions with a system are triggers for others. We use  a <em>message
bus</em> to allow actions to trigger events and call appropriate <em>handlers</em>.
We move on to discuss how events can be used as a pattern for integration
between services in a microservices architecture. Finally, we distinguish between <em>commands</em> and <em>events</em>. Our application is now
fundamentally a message-processing system.</p>
</dd>
<dt class="hdlist1">Command-query responsibility segregation (<a href="#chapter_12_cqrs">Command-Query Responsibility Segregation (CQRS)</a>)</dt>
<dd>
<p>We present an example of <em>command-query responsibility segregation</em>, with and without
events.</p>
</dd>
<dt class="hdlist1">Dependency injection (<a href="#chapter_13_dependency_injection">Dependency Injection (and Bootstrapping)</a>)</dt>
<dd>
<p>We tidy up our explicit and implicit dependencies and implement a
simple dependency injection framework.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_addtional_content">Addtional Content</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">How do I get there from here? (<a href="#epilogue_1_how_to_get_there_from_here">Epilogue</a>)</dt>
<dd>
<p>Implementing architectural patterns always looks easy when you show a simple
example, starting from scratch, but many of you will probably be wondering how
to apply these principles to existing software. We&#8217;ll provide a
few pointers in the epilogue and some links to further reading.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_example_code_and_coding_along">Example Code and Coding Along</h3>
<div class="paragraph">
<p>You&#8217;re reading a book, but you&#8217;ll probably agree with us when we say that
the best way to learn about code is to code.  We learned most of what we know
from pairing with people, writing code with them, and learning by doing, and
we&#8217;d like to re-create that experience as much as possible for you in this book.</p>
</div>
<div class="paragraph">
<p>As a result, we&#8217;ve structured the book around a single example project
(although we do sometimes throw in other examples). We&#8217;ll build up this project as the chapters progress, as if you&#8217;ve paired with us and
we&#8217;re explaining what we&#8217;re doing and why at each step.</p>
</div>
<div class="paragraph">
<p>But to really get to grips with these patterns, you need to mess about with the
code and get a feel for how it works. You&#8217;ll find all the code on
GitHub; each chapter has its own branch. You can find <a href="https://github.com/cosmicpython/code/branches/all">a list</a> of the branches on GitHub as well.</p>
</div>
<div class="paragraph pagebreak-before">
<p>Here are three ways you might code along with the book:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Start your own repo and try to build up the app as we do, following the
examples from listings in the book, and occasionally looking to our repo
for hints. A word of warning, however: if you&#8217;ve read Harry&#8217;s previous book
and coded along with that, you&#8217;ll find that this book requires you to figure out more on
your own; you may need to lean pretty heavily on the working versions on GitHub.</p>
</li>
<li>
<p>Try to apply each pattern, chapter by chapter, to your own (preferably
small/toy) project, and see if you can make it work for your use case.  This
is high risk/high reward (and high effort besides!). It may take quite some
work to get things working for the specifics of your project, but on the other
hand, you&#8217;re likely to learn the most.</p>
</li>
<li>
<p>For less effort, in each chapter we outline an "Exercise for the Reader,"
and point you to a GitHub location where you can download some partially finished
code for the chapter with a few missing parts to write yourself.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Particularly if you&#8217;re intending to apply some of these patterns in your own
projects, working through a simple example is a great way to
safely practice.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
At the very least, do a <code>git checkout</code> of the code from our repo as you
    read each chapter. Being able to jump in and see the code in the context of
    an actual working app will help answer a lot of questions as you go, and
    makes everything more real. You&#8217;ll find instructions for how to do that
    at the beginning of each chapter.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_license">License</h3>
<div class="paragraph">
<p>The code (and the online version of the book) is licensed under a Creative
Commons CC BY-NC-ND license, which means you are free to copy and share it with
anyone you like, for non-commercial purposes, as long as you give attribution.
If you want to re-use any of the content from this book and you have any
worries about the license, contact O&#8217;Reilly at <a class="email"
href="mailto:permissions@oreilly.com"><em>permissions@oreilly.com</em></a>.</p>
</div>
<div class="paragraph">
<p>The print edition is licensed differently; please see the copyright page.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conventions_used_in_this_book">Conventions Used in This Book</h3>
<div class="paragraph">
<p>The following typographical conventions are used in this book:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>Italic</em></dt>
<dd>
<p>Indicates new terms, URLs, email addresses, filenames, and file extensions.</p>
</dd>
<dt class="hdlist1">Constant width</dt>
<dd>
<p>Used for program listings, as well as within paragraphs to refer to program elements such as variable or function names, databases, data types, environment variables, statements, and keywords.</p>
</dd>
<dt class="hdlist1"><strong><code>Constant width bold</code></strong></dt>
<dd>
<p>Shows commands or other text that should be typed literally by the user.</p>
</dd>
<dt class="hdlist1"><em>Constant width italic</em></dt>
<dd>
<p>Shows text that should be replaced with user-supplied values or by values determined by context.</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This element signifies a tip or suggestion.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This element signifies a general note.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This element indicates a warning or caution.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_oreilly_online_learning">O&#8217;Reilly Online Learning</h3>
<div class="admonitionblock note ormenabled">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For more than 40 years, <a href="http://oreilly.com" class="orm:hideurl"><em class="hyperlink">O’Reilly Media</em></a> has provided technology and business training, knowledge, and insight to help companies succeed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Our unique network of experts and innovators share their knowledge and expertise through books, articles, conferences, and our online learning platform. O’Reilly’s online learning platform gives you on-demand access to live training courses, in-depth learning paths, interactive coding environments, and a vast collection of text and video from O&#8217;Reilly and 200+ other publishers. For more information, please visit <a href="http://oreilly.com" class="orm:hideurl"><em>http://oreilly.com</em></a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_contact_oreilly">How to Contact O&#8217;Reilly</h3>
<div class="paragraph">
<p>Please address comments and questions concerning this book to the publisher:</p>
</div>
<ul class="simplelist">
  <li>O’Reilly Media, Inc.</li>
  <li>1005 Gravenstein Highway North</li>
  <li>Sebastopol, CA 95472</li>
  <li>800-998-9938 (in the United States or Canada)</li>
  <li>707-829-0515 (international or local)</li>
  <li>707-829-0104 (fax)</li>
</ul>
<div class="paragraph">
<p>We have a web page for this book, where we list errata, examples, and any additional information. You can access this page at <a href="https://oreil.ly/architecture-patterns-python" class="bare">https://oreil.ly/architecture-patterns-python</a>.</p>
</div>
<!--Don't forget to update the link above.-->
<div class="paragraph">
<p>Email <a class="email" href="mailto:bookquestions@oreilly.com"><em>bookquestions@oreilly.com</em></a> to comment or ask technical questions about this book.</p>
</div>
<div class="paragraph">
<p>For more information about our books, courses, conferences, and news, see our website at <a href="http://www.oreilly.com" class="bare">http://www.oreilly.com</a>.</p>
</div>
<div class="paragraph">
<p>Find us on Facebook: <a href="http://facebook.com/oreilly" class="bare">http://facebook.com/oreilly</a></p>
</div>
<div class="paragraph">
<p>Follow us on Twitter: <a href="http://twitter.com/oreillymedia" class="bare">http://twitter.com/oreillymedia</a></p>
</div>
<div class="paragraph">
<p>Watch us on YouTube: <a href="http://www.youtube.com/oreillymedia" class="bare">http://www.youtube.com/oreillymedia</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_acknowledgments">Acknowledgments</h3>
<div class="paragraph">
<p>To our tech reviewers, David Seddon, Ed Jung, and Hynek Schlawack: we absolutely
do not deserve you. You are all incredibly dedicated, conscientious, and
rigorous. Each one of you is immensely smart, and your different points of
view were both useful and complementary to each other. Thank you from the
bottom of our hearts.</p>
</div>
<div class="paragraph">
<p>Gigantic thanks also to our Early Release readers for their comments and
suggestions:
Ian Cooper, Abdullah Ariff, Jonathan Meier, Gil Gonçalves, Matthieu Choplin,
Ben Judson, James Gregory, Łukasz Lechowicz, Clinton Roy, Vitorino Araújo,
Susan Goodbody, Josh Harwood, Daniel Butler, Liu Haibin, Jimmy Davies, Ignacio
Vergara Kausel, Gaia Canestrani, Renne Rocha, pedroabi, Ashia Zawaduk, Jostein
Leira, Brandon Rhodes, Jazeps Basko
and many more; our apologies if we missed you on this list.</p>
</div>
<div class="paragraph">
<p>Super-mega-thanks to our editor Corbin Collins for his gentle chivvying, and
for being a tireless advocate of the reader. Similarly-superlative thanks to the production staff, Katherine Tozer, Sharon Wilkey, Ellen Troutman-Zaig, and Rebecca Demarest, for your dedication, professionalism, and attention to detail. This book is immeasurably improved thanks to you.</p>
</div>
<div class="paragraph">
<p>Any errors remaining in the book are our own, naturally.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_why_do_our_designs_go_wrong">Why Do Our Designs Go Wrong?</h3>
<div class="paragraph">
<p>What comes to mind when you hear the word <em>chaos?</em> Perhaps you think of a noisy
stock exchange, or your kitchen in the morning&#8212;&#8203;everything confused and
jumbled. When you think of the word <em>order</em>, perhaps you think of an empty room,
serene and calm. For scientists, though, chaos is characterized by homogeneity
(sameness), and order by complexity (difference).</p>
</div>
<div class="paragraph">
<p>For example, a well-tended garden is a highly ordered system. Gardeners define
boundaries with paths and fences, and they mark out flower beds or vegetable
patches. Over time, the garden evolves, growing richer and thicker; but without
deliberate effort, the garden will run wild. Weeds and grasses will choke out
other plants, covering over the paths, until eventually every part looks the
same again&#8212;&#8203;wild and unmanaged.</p>
</div>
<div class="paragraph">
<p>Software systems, too, tend toward chaos. When we first start building a new
system, we have grand ideas that our code will be clean and well ordered, but
over time we find that it gathers cruft and edge cases and ends up a confusing
morass of manager classes and util modules. We find that our sensibly layered
architecture has collapsed into itself like an oversoggy trifle. Chaotic
software systems are characterized by a sameness of function: API handlers that
have domain knowledge and send email and perform logging; "business logic"
classes that perform no calculations but do perform I/O; and everything coupled
to everything else so that changing any part of the system becomes fraught with
danger. This is so common that software engineers have their own term for
chaos: the Big Ball of Mud anti-pattern (<a href="#bbom_image">A real-life dependency diagram (source: <a href="https://oreil.ly/dbGTW">"Enterprise Dependency: Big Ball of Yarn"</a> by Alex Papadimoulis)</a>).</p>
</div>
<div id="bbom_image" class="imageblock">
<div class="content">
<img src="images/apwp_0001.png" alt="apwp 0001">
</div>
<div class="title">Figure 1. A real-life dependency diagram (source: <a href="https://oreil.ly/dbGTW">"Enterprise Dependency: Big Ball of Yarn"</a> by Alex Papadimoulis)</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
A big ball of mud is the natural state of software in the same way that wilderness
    is the natural state of your garden. It takes energy and direction to
    prevent the collapse.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Fortunately, the techniques to avoid creating a big ball of mud aren&#8217;t complex.</p>
</div>
</div>
<div class="sect2">
<h3 id="_encapsulation_and_abstractions">Encapsulation and Abstractions</h3>
<div class="paragraph">
<p>Encapsulation and abstraction are tools that we all instinctively reach for
as programmers, even if we don&#8217;t all use these exact words.  Allow us to dwell
on them for a moment, since they are a recurring background theme of the book.</p>
</div>
<div class="paragraph">
<p>The term <em>encapsulation</em> covers two closely related ideas: simplifying
behavior and hiding data. In this discussion, we&#8217;re using the first sense. We
encapsulate behavior by identifying a task that needs to be done in our code
and giving that task to a well-defined object or function. We call that object or function an
<em>abstraction</em>.</p>
</div>
<div class="paragraph">
<p>Take a look at the following two snippets of Python code:</p>
</div>
<div id="urllib_example" class="exampleblock">
<div class="title">Do a search with urllib</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">import</span> <span class="tok-nn">json</span>
<span class="tok-kn">from</span> <span class="tok-nn">urllib.request</span> <span class="tok-kn">import</span> <span class="tok-n">urlopen</span>
<span class="tok-kn">from</span> <span class="tok-nn">urllib.parse</span> <span class="tok-kn">import</span> <span class="tok-n">urlencode</span>

<span class="tok-n">params</span> <span class="tok-o">=</span> <span class="tok-nb">dict</span><span class="tok-p">(</span><span class="tok-n">q</span><span class="tok-o">=</span><span class="tok-s1">&#39;Sausages&#39;</span><span class="tok-p">,</span> <span class="tok-n">format</span><span class="tok-o">=</span><span class="tok-s1">&#39;json&#39;</span><span class="tok-p">)</span>
<span class="tok-n">handle</span> <span class="tok-o">=</span> <span class="tok-n">urlopen</span><span class="tok-p">(</span><span class="tok-s1">&#39;http://api.duckduckgo.com&#39;</span> <span class="tok-o">+</span> <span class="tok-s1">&#39;?&#39;</span> <span class="tok-o">+</span> <span class="tok-n">urlencode</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">))</span>
<span class="tok-n">raw_text</span> <span class="tok-o">=</span> <span class="tok-n">handle</span><span class="tok-o">.</span><span class="tok-n">read</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">decode</span><span class="tok-p">(</span><span class="tok-s1">&#39;utf8&#39;</span><span class="tok-p">)</span>
<span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-n">json</span><span class="tok-o">.</span><span class="tok-n">loads</span><span class="tok-p">(</span><span class="tok-n">raw_text</span><span class="tok-p">)</span>

<span class="tok-n">results</span> <span class="tok-o">=</span> <span class="tok-n">parsed</span><span class="tok-p">[</span><span class="tok-s1">&#39;RelatedTopics&#39;</span><span class="tok-p">]</span>
<span class="tok-k">for</span> <span class="tok-n">r</span> <span class="tok-ow">in</span> <span class="tok-n">results</span><span class="tok-p">:</span>
    <span class="tok-k">if</span> <span class="tok-s1">&#39;Text&#39;</span> <span class="tok-ow">in</span> <span class="tok-n">r</span><span class="tok-p">:</span>
        <span class="tok-k">print</span><span class="tok-p">(</span><span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-s1">&#39;FirstURL&#39;</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-s1">&#39; - &#39;</span> <span class="tok-o">+</span> <span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-s1">&#39;Text&#39;</span><span class="tok-p">])</span></code></pre>
</div>
</div>
</div>
</div>
<div id="requests_example" class="exampleblock">
<div class="title">Do a search with requests</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">import</span> <span class="tok-nn">requests</span>

<span class="tok-n">params</span> <span class="tok-o">=</span> <span class="tok-nb">dict</span><span class="tok-p">(</span><span class="tok-n">q</span><span class="tok-o">=</span><span class="tok-s1">&#39;Sausages&#39;</span><span class="tok-p">,</span> <span class="tok-n">format</span><span class="tok-o">=</span><span class="tok-s1">&#39;json&#39;</span><span class="tok-p">)</span>
<span class="tok-n">parsed</span> <span class="tok-o">=</span> <span class="tok-n">requests</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s1">&#39;http://api.duckduckgo.com/&#39;</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-o">=</span><span class="tok-n">params</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">()</span>

<span class="tok-n">results</span> <span class="tok-o">=</span> <span class="tok-n">parsed</span><span class="tok-p">[</span><span class="tok-s1">&#39;RelatedTopics&#39;</span><span class="tok-p">]</span>
<span class="tok-k">for</span> <span class="tok-n">r</span> <span class="tok-ow">in</span> <span class="tok-n">results</span><span class="tok-p">:</span>
    <span class="tok-k">if</span> <span class="tok-s1">&#39;Text&#39;</span> <span class="tok-ow">in</span> <span class="tok-n">r</span><span class="tok-p">:</span>
        <span class="tok-k">print</span><span class="tok-p">(</span><span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-s1">&#39;FirstURL&#39;</span><span class="tok-p">]</span> <span class="tok-o">+</span> <span class="tok-s1">&#39; - &#39;</span> <span class="tok-o">+</span> <span class="tok-n">r</span><span class="tok-p">[</span><span class="tok-s1">&#39;Text&#39;</span><span class="tok-p">])</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Both code listings do the same thing: they submit form-encoded values
to a URL in order to use a search engine API. But the second is simpler to read
and understand because it operates at a higher level of abstraction.</p>
</div>
<div class="paragraph">
<p>We can take this one step further still by identifying and naming the task we
want the code to perform for us and using an even higher-level abstraction to make
it explicit:</p>
</div>
<div id="ddg_example" class="exampleblock">
<div class="title">Do a search with the duckduckgo module</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">import</span> <span class="tok-nn">duckduckgo</span>
<span class="tok-k">for</span> <span class="tok-n">r</span> <span class="tok-ow">in</span> <span class="tok-n">duckduckgo</span><span class="tok-o">.</span><span class="tok-n">query</span><span class="tok-p">(</span><span class="tok-s1">&#39;Sausages&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">results</span><span class="tok-p">:</span>
    <span class="tok-k">print</span><span class="tok-p">(</span><span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">url</span> <span class="tok-o">+</span> <span class="tok-s1">&#39; - &#39;</span> <span class="tok-o">+</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">text</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Encapsulating behavior by using abstractions is a powerful tool for making
code more expressive, more testable, and easier to maintain.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the literature of the object-oriented (OO) world, one of the classic
    characterizations of this approach is called
    <a href="http://www.wirfs-brock.com/Design.html"><em>responsibility-driven design</em></a>;
    it uses the words <em>roles</em> and <em>responsibilities</em> rather than <em>tasks</em>.
    The main point is to think about code in terms of behavior, rather than
    in terms of data or algorithms.<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Abstractions and ABCs</div>
<div class="paragraph">
<p>In a traditional OO language like Java or C#, you might use an abstract base
class (ABC) or an interface to define an abstraction. In Python you can (and we
sometimes do) use ABCs, but you can also happily rely on duck typing.</p>
</div>
<div class="paragraph">
<p>The abstraction can just mean "the public API of the thing you&#8217;re using"—a
function name plus some arguments, for example.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Most of the patterns in this book involve choosing an abstraction, so you&#8217;ll
see plenty of examples in each chapter. In addition,
<a href="#chapter_03_abstractions">A Brief Interlude: On Coupling <span class="keep-together">and Abstractions</span></a> specifically discusses some general heuristics
for choosing abstractions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_layering">Layering</h3>
<div class="paragraph">
<p>Encapsulation and abstraction help us by hiding details and protecting the
consistency of our data, but we also need to pay attention to the interactions
between our objects and functions. When one function, module, or object uses
another, we say that the one <em>depends on</em> the other. These dependencies form a
kind of network or graph.</p>
</div>
<div class="paragraph">
<p>In a big ball of mud, the dependencies are out of control (as you saw in
<a href="#bbom_image">A real-life dependency diagram (source: <a href="https://oreil.ly/dbGTW">"Enterprise Dependency: Big Ball of Yarn"</a> by Alex Papadimoulis)</a>). Changing one node of the graph becomes difficult because it
has the potential to affect many other parts of the system. Layered
architectures are one way of tackling this problem. In a layered architecture,
we divide our code into discrete categories or roles, and we introduce rules
about which categories of code can call each other.</p>
</div>
<div class="paragraph">
<p>One of the most common examples is the <em>three-layered architecture</em> shown in
<a href="#layered_architecture1">Layered architecture</a>.</p>
</div>
<div id="layered_architecture1" class="imageblock width-75">
<div class="content">
<img src="images/apwp_0002.png" alt="apwp 0002">
</div>
<div class="title">Figure 2. Layered architecture</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[ditaa, apwp_0002]
+----------------------------------------------------+
|                Presentation Layer                  |
+----------------------------------------------------+
                          |
                          V
+----------------------------------------------------+
|                 Business Logic                     |
+----------------------------------------------------+
                          |
                          V
+----------------------------------------------------+
|                  Database Layer                    |
+----------------------------------------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>Layered architecture is perhaps the most common pattern for building business
software. In this model we have user-interface components, which could be a web
page, an API, or a command line; these user-interface components communicate
with a business logic layer that contains our business rules and our workflows;
and finally, we have a database layer that&#8217;s responsible for storing and retrieving
data.</p>
</div>
<div class="paragraph">
<p>For the rest of this book, we&#8217;re going to be systematically turning this
model inside out by obeying one simple principle.</p>
</div>
</div>
<div class="sect2">
<h3 id="dip">The Dependency Inversion Principle</h3>
<div class="paragraph">
<p>You might be familiar with the <em>dependency inversion principle</em> (DIP) already, because
it&#8217;s the <em>D</em> in SOLID.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup></p>
</div>
<div class="paragraph">
<p>Unfortunately, we can&#8217;t illustrate the DIP by using three tiny code listings as
we did for encapsulation. However, the whole of <a href="#part1">Building an Architecture to Support Domain Modeling</a> is essentially a worked
example of implementing the DIP throughout an application, so you&#8217;ll get
your fill of concrete examples.</p>
</div>
<div class="paragraph">
<p>In the meantime, we can talk about DIP&#8217;s formal definition:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>High-level modules should not depend on low-level modules. Both should
depend on abstractions.</p>
</li>
<li>
<p>Abstractions should not depend on details. Instead, details should depend on
abstractions.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>But what does this mean? Let&#8217;s take it bit by bit.</p>
</div>
<div class="paragraph">
<p><em>High-level modules</em> are the code that your organization really cares about.
Perhaps you work for a pharmaceutical company, and your high-level modules deal
with patients and trials. Perhaps you work for a bank, and your high-level
modules manage trades and exchanges. The high-level modules of a software
system are the functions, classes, and packages that deal with our real-world
concepts.</p>
</div>
<div class="paragraph">
<p>By contrast, <em>low-level modules</em> are the code that your organization doesn&#8217;t
care about. It&#8217;s unlikely that your HR department gets excited about filesystems or network sockets. It&#8217;s not often that you discuss SMTP, HTTP,
or AMQP with your finance team. For our nontechnical stakeholders, these
low-level concepts aren&#8217;t interesting or relevant. All they care about is
whether the high-level concepts work correctly. If payroll runs on time, your
business is unlikely to care whether that&#8217;s a cron job or a transient function
running on Kubernetes.</p>
</div>
<div class="paragraph">
<p><em>Depends on</em> doesn&#8217;t mean <em>imports</em> or <em>calls</em>, necessarily, but rather a more
general idea that one module <em>knows about</em> or <em>needs</em> another module.</p>
</div>
<div class="paragraph">
<p>And we&#8217;ve mentioned <em>abstractions</em> already: they&#8217;re simplified interfaces that
encapsulate behavior, in the way that our duckduckgo module encapsulated a
search engine&#8217;s API.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>All problems in computer science can be solved by adding another level of
indirection.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; David Wheeler
</div>
</div>
<div class="paragraph">
<p>So the first part of the DIP says that our business code shouldn&#8217;t depend on
technical details; instead, both should use abstractions.</p>
</div>
<div class="paragraph">
<p>Why? Broadly, because we want to be able to change them independently of each
other. High-level modules should be easy to change in response to business
needs. Low-level modules (details) are often, in practice, harder to
change: think about refactoring to change a function name versus defining, testing,
and deploying a database migration to change a column name. We don&#8217;t
want business logic changes to slow down because they are closely coupled
to low-level infrastructure details. But, similarly, it is important to <em>be
able</em> to change your infrastructure details when you need to (think about
sharding a database, for example), without needing to make changes to your
business layer. Adding an abstraction between them (the famous extra
layer of indirection) allows the two to change (more) independently of each
other.</p>
</div>
<div class="paragraph">
<p>The second part is even more mysterious. "Abstractions should not depend on
details" seems clear enough, but "Details should depend on abstractions" is
hard to imagine. How can we have an abstraction that doesn&#8217;t depend on the
details it&#8217;s abstracting? By the time we get to <a href="#chapter_04_service_layer">Our First Use Case: <span class="keep-together">Flask API and Service Layer</span></a>,
we&#8217;ll have a concrete example that should make this all a bit clearer.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_place_for_all_our_business_logic_the_domain_model">A Place for All Our Business Logic: The Domain Model</h3>
<div class="paragraph">
<p>But before we can turn our three-layered architecture inside out, we need to
talk more about that middle layer: the high-level modules or business
logic. One of the most common reasons that our designs go wrong is that
business logic becomes spread throughout the layers of our application,
making it hard to identify, understand, and change.</p>
</div>
<div class="paragraph">
<p><a href="#chapter_01_domain_model">Domain Modeling</a> shows how to build a business
layer with a <em>Domain Model</em> pattern. The rest of the patterns in <a href="#part1">Building an Architecture to Support Domain Modeling</a> show
how we can keep the domain model easy to change and free of low-level concerns
by choosing the right abstractions and continuously applying the DIP.</p>
</div>
</div>
</div>
</div>
<div class="sect1 pagenumrestart">
<h2 id="part1">Building an Architecture to Support Domain Modeling</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Most developers have never seen a domain model, only a data model.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Cyrille Martraire<br>
<cite>DDD EU 2017</cite>
</div>
</div>
<div class="paragraph">
<p>Most developers we talk to about architecture have a nagging sense that
things could be better. They are often trying to rescue a system that has gone
wrong somehow, and are trying to put some structure back into a ball of mud.
They know that their business logic shouldn&#8217;t be spread all over the place,
but they have no idea how to fix it.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve found that many developers, when asked to design a new system, will
immediately start to build a database schema, with the object model treated
as an afterthought. This is where it all starts to go wrong. Instead, <em>behavior
should come first and drive our storage requirements.</em> After all, our customers don&#8217;t care about the data model. They care about what
the system <em>does</em>; otherwise they&#8217;d just use a spreadsheet.</p>
</div>
<div class="paragraph">
<p>The first part of the book looks at how to build a rich object model
through TDD (in <a href="#chapter_01_domain_model">Domain Modeling</a>), and then we&#8217;ll show how
to keep that model decoupled from technical concerns. We show how to build
persistence-ignorant code and how to create stable APIs around our domain so
that we can refactor aggressively.</p>
</div>
<div class="paragraph">
<p>To do that, we present four key design patterns:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="#chapter_02_repository">Repository pattern</a>, an abstraction over the
idea of persistent storage</p>
</li>
<li>
<p>The <a href="#chapter_04_service_layer">Service Layer</a> pattern to clearly define where our
use cases begin and end</p>
</li>
</ul>
</div>
<div class="ulist pagebreak-before">
<ul>
<li>
<p>The <a href="#chapter_06_uow">Unit of Work pattern</a> to provide atomic operations</p>
</li>
<li>
<p>The <a href="#chapter_07_aggregate">Aggregate pattern</a> to enforce the integrity
of our data</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you&#8217;d like a picture of where we&#8217;re going, take a look at
<a href="#part1_components_diagram">A component diagram for our app at the end of <a href="#part1">Building an Architecture to Support Domain Modeling</a></a>, but don&#8217;t worry if none of it makes sense
yet!  We introduce each box in the figure, one by one, throughout this part of the book.</p>
</div>
<div id="part1_components_diagram" class="imageblock width-90">
<div class="content">
<img src="images/apwp_p101.png" alt="apwp p101">
</div>
<div class="title">Figure 3. A component diagram for our app at the end of <a href="#part1">Building an Architecture to Support Domain Modeling</a></div>
</div>
<div class="paragraph">
<p>We also take a little time out to talk about
<a href="#chapter_03_abstractions">coupling and abstractions</a>, illustrating it with a simple example that shows how and why we choose our
abstractions.</p>
</div>
<div class="paragraph">
<p>Three appendices are further explorations of the content from Part I:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#appendix_project_structure">A Template Project Structure</a> is a write-up of the infrastructure for our example
code: how we build and run the Docker images, where we manage configuration
info, and how we run different types of tests.</p>
</li>
<li>
<p><a href="#appendix_csvs">Swapping Out the Infrastructure: <span class="keep-together">Do Everything with CSVs</span></a> is a "proof is in the pudding" kind of content, showing
how easy it is to swap out our entire infrastructure&#8212;&#8203;the Flask API, the
ORM, and Postgres—for a totally different I/O model involving a CLI and
CSVs.</p>
</li>
<li>
<p>Finally, <a href="#appendix_django">Repository and Unit of Work <span class="keep-together">Patterns with Django</span></a> may be of interest if you&#8217;re wondering how these
patterns might look if using Django instead of Flask and SQLAlchemy.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_01_domain_model">1. Domain Modeling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter looks into how we can model business processes with code, in a way
that&#8217;s highly compatible with TDD.  We&#8217;ll discuss <em>why</em> domain modeling
matters, and we&#8217;ll look at a few key patterns for modeling domains: Entity,
Value Object, and Domain Service.</p>
</div>
<div class="paragraph">
<p><a href="#maps_chapter_01_notext">A placeholder illustration of our domain model</a> is a simple visual placeholder for our Domain
Model pattern. We&#8217;ll fill in some details in this chapter, and as we move on to
other chapters, we&#8217;ll build things around the domain model, but you should
always be able to find these little shapes at the core.</p>
</div>
<div id="maps_chapter_01_notext" class="imageblock">
<div class="content">
<img src="images/apwp_0101.png" alt="apwp 0101">
</div>
<div class="title">Figure 4. A placeholder illustration of our domain model</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_what_is_a_domain_model">1.1. What Is a Domain Model?</h3>
<div class="paragraph">
<p>In the <a href="#introduction">introduction</a>, we used the term <em>business logic layer</em> to describe the
central layer of a three-layered architecture. For the rest of the book, we&#8217;re
going to use the term <em>domain model</em> instead. This is a term from the DDD
community that does a better job of capturing our intended meaning (see the
next sidebar for more on DDD).</p>
</div>
<div class="paragraph">
<p>The <em>domain</em> is a fancy way of saying <em>the problem you&#8217;re trying to solve.</em> Your
authors currently work for an online retailer of furniture. Depending on which system
you&#8217;re talking about, the domain might be purchasing and procurement, or product
design, or logistics and delivery. Most programmers spend their days trying to
improve or automate business processes; the domain is the set of activities
that those processes support.</p>
</div>
<div class="paragraph">
<p>A <em>model</em> is a map of a process or phenomenon that captures a useful property.
Humans are exceptionally good at producing models of things in their heads. For
example, when someone throws a ball toward you, you&#8217;re able to predict its
movement almost unconsciously, because you have a model of the way objects move in
space. Your model isn&#8217;t perfect by any means. Humans have terrible intuitions
about how objects behave at near-light speeds or in a vacuum because our model
was never designed to cover those cases. That doesn&#8217;t mean the model is wrong,
but it does mean that some predictions fall outside of its domain.</p>
</div>
<div class="paragraph">
<p>The domain model is the mental map that business owners have of their
businesses. All business people have these mental maps&#8212;&#8203;they&#8217;re how humans think
about complex processes.</p>
</div>
<div class="paragraph">
<p>You can tell when they&#8217;re navigating these maps because they use business speak.
Jargon arises naturally among people who are collaborating on complex systems.</p>
</div>
<div class="paragraph">
<p>Imagine that you, our unfortunate reader, were suddenly transported light years
away from Earth aboard an alien spaceship with your friends and family and had
to figure out, from first principles, how to navigate home.</p>
</div>
<div class="paragraph">
<p>In your first few days, you might just push buttons randomly, but soon you&#8217;d
learn which buttons did what, so that you could give one another instructions.
"Press the red button near the flashing doohickey and then throw that big
lever over by the radar gizmo," you might say.</p>
</div>
<div class="paragraph">
<p>Within a couple of weeks, you&#8217;d become more precise as you adopted words to
describe the ship&#8217;s functions: "Increase oxygen levels in cargo bay three"
or "turn on the little thrusters." After a few months, you&#8217;d have adopted
language for entire complex processes: "Start landing sequence" or "prepare
for warp." This process would happen quite naturally, without any formal effort
to build a shared glossary.</p>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">This Is Not a DDD Book. You Should Read a DDD Book.</div>
<div class="paragraph">
<p>Domain-driven design, or DDD, popularized the concept of domain modeling,<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup>
and it&#8217;s been a hugely successful movement in transforming the way people
design software by focusing on the core business domain. Many of the
architecture patterns that we cover in this book—including Entity, Aggregate, Value Object (see <a href="#chapter_07_aggregate">Aggregates and Consistency Boundaries</a>), and Repository (in
<a href="#chapter_02_repository">the next chapter</a>)—come from the DDD tradition.</p>
</div>
<div class="paragraph">
<p>In a nutshell, DDD says that the most important thing about software is that it
provides a useful model of a problem.  If we get that model right, our
software delivers value and makes new things possible.</p>
</div>
<div class="paragraph">
<p>If we get the model wrong, it becomes an obstacle to be worked around. In this book,
we can show the basics of building a domain model, and building an architecture
around it that leaves the model as free as possible from external constraints,
so that it&#8217;s easy to evolve and change.</p>
</div>
<div class="paragraph">
<p>But there&#8217;s a lot more to DDD and to the processes, tools, and techniques for
developing a domain model. We hope to give you a taste of it, though,
and cannot encourage you enough to go on and read a proper DDD book:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The original "blue book," <em>Domain-Driven Design</em> by Eric Evans (Addison-Wesley Professional)</p>
</li>
<li>
<p>The "red book," <em>Implementing Domain-Driven Design</em>
by Vaughn Vernon (Addison-Wesley Professional)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>So it is in the mundane world of business. The terminology used by business
stakeholders represents a distilled understanding of the domain model, where
complex ideas and processes are boiled down to a single word or phrase.</p>
</div>
<div class="paragraph">
<p>When we hear our business stakeholders using unfamiliar words, or using terms
in a specific way, we should listen to understand the deeper meaning and encode
their hard-won experience into our software.</p>
</div>
<div class="paragraph">
<p>We&#8217;re going to use a real-world domain model throughout this book, specifically
a model from our current employment. MADE.com is a successful furniture
retailer. We source our furniture from manufacturers all over the world and
sell it across Europe.</p>
</div>
<div class="paragraph">
<p>When you buy a sofa or a coffee table, we have to figure out how best
to get your goods from Poland or China or Vietnam and into your living room.</p>
</div>
<div class="paragraph">
<p>At a high level, we have separate systems that are responsible for buying
stock, selling stock to customers, and shipping goods to customers. A
system in the middle needs to coordinate the process by allocating stock
to a customer&#8217;s orders; see <a href="#allocation_context_diagram">Context diagram for the allocation service</a>.</p>
</div>
<div id="allocation_context_diagram" class="imageblock">
<div class="content">
<img src="images/apwp_0102.png" alt="apwp 0102">
</div>
<div class="title">Figure 5. Context diagram for the allocation service</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_0102]
@startuml Allocation Context Diagram
!include images/C4_Context.puml
scale 2

System(systema, "Allocation", "Allocates stock to customer orders")

Person(customer, "Customer", "Wants to buy furniture")
Person(buyer, "Buying Team", "Needs to purchase furniture from suppliers")

System(procurement, "Purchasing", "Manages workflow for buying stock from suppliers")
System(ecom, "Ecommerce", "Sells goods online")
System(warehouse, "Warehouse", "Manages workflow for shipping goods to customers")

Rel(buyer, procurement, "Uses")
Rel(procurement, systema, "Notifies about shipments")
Rel(customer, ecom, "Buys from")
Rel(ecom, systema, "Asks for stock levels")
Rel(ecom, systema, "Notifies about orders")
Rel_R(systema, warehouse, "Sends instructions to")
Rel_U(warehouse, customer, "Dispatches goods to")

@enduml</pre>
</div>
</div>
<div class="paragraph">
<p>For the purposes of this book, we&#8217;re imagining that the business
decides to implement an exciting new way of allocating stock.  Until now, the
business has been presenting stock and lead times based on what is physically
available in the warehouse.  If and when the warehouse runs out, a product is
listed as "out of stock" until the next shipment arrives from the manufacturer.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the innovation: if we have a system that can keep track of all our shipments
and when they&#8217;re due to arrive, we can treat the goods on those ships as
real stock and part of our inventory, just with slightly longer lead times.
Fewer goods will appear to be out of stock, we&#8217;ll sell more, and the business
can save money by keeping lower inventory in the domestic warehouse.</p>
</div>
<div class="paragraph">
<p>But allocating orders is no longer a trivial matter of decrementing a single
quantity in the warehouse system. We need a more complex allocation mechanism.
Time for some domain modeling.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exploring_the_domain_language">1.2. Exploring the Domain Language</h3>
<div class="paragraph">
<p>Understanding the domain model takes time, and patience, and Post-it notes. We
have an initial conversation with our business experts and agree on a glossary
and some rules for the first minimal version of the domain model. Wherever
possible, we ask for concrete examples to illustrate each rule.</p>
</div>
<div class="paragraph">
<p>We make sure to express those rules in the business jargon (the <em>ubiquitous
language</em> in DDD terminology). We choose memorable identifiers for our objects
so that the examples are easier to talk about.</p>
</div>
<div class="paragraph">
<p><a data-type="xref" href="#allocation_notes" data-xrefstyle="select:nopage">#allocation_notes</a> shows some notes we might have taken while having a
conversation with our domain experts about allocation.</p>
</div>
<div id="allocation_notes" class="sidebarblock">
<div class="content">
<div class="title">Some Notes on Allocation</div>
<div class="paragraph">
<p>A <em>product</em> is identified by a <em>SKU</em>, pronounced "skew," which is short for <em>stock-keeping unit</em>. <em>Customers</em> place <em>orders</em>. An order is identified by an <em>order reference</em>
and comprises multiple <em>order lines</em>, where each line has a <em>SKU</em> and a <em>quantity</em>. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>10 units of RED-CHAIR</p>
</li>
<li>
<p>1 unit of TASTELESS-LAMP</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The purchasing department orders small <em>batches</em> of stock. A <em>batch</em> of stock has a unique ID called a <em>reference</em>, a <em>SKU</em>, and a <em>quantity</em>.</p>
</div>
<div class="paragraph">
<p>We need to <em>allocate</em> <em>order lines</em> to <em>batches</em>. When we&#8217;ve allocated an
order line to a batch, we will send stock from that specific batch to the
customer&#8217;s delivery address. When we allocate <em>x</em> units of stock to a batch, the <em>available quantity</em> is reduced by <em>x</em>. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We have a batch of 20 SMALL-TABLE, and we allocate an order line for 2 SMALL-TABLE.</p>
</li>
<li>
<p>The batch should have 18 SMALL-TABLE remaining.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We can&#8217;t allocate to a batch if the available quantity is less than the quantity of the order line. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We have a batch of 1 BLUE-CUSHION, and an order line for 2 BLUE-CUSHION.</p>
</li>
<li>
<p>We should not be able to allocate the line to the batch.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We can&#8217;t allocate the same line twice. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We have a batch of 10 BLUE-VASE, and we allocate an order line for 2 BLUE-VASE.</p>
</li>
<li>
<p>If we allocate the order line again to the same batch, the batch should still
have an available quantity of 8.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Batches have an <em>ETA</em> if they are currently shipping, or they may be in <em>warehouse stock</em>. We allocate to warehouse stock in preference to shipment batches. We allocate to shipment batches in order of which has the earliest ETA.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_unit_testing_domain_models">1.3. Unit Testing Domain Models</h3>
<div class="paragraph">
<p>We&#8217;re not going to show you how TDD works in this book, but we want to show you
how we would construct a model from this business conversation.</p>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Exercise for the Reader</div>
<div class="paragraph">
<p>Why not have a go at solving this problem yourself? Write a few unit tests to
see if you can capture the essence of these business rules in nice, clean
code.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll find some <a href="https://github.com/cosmicpython/code/tree/chapter_01_domain_model_exercise">placeholder unit tests on GitHub</a>, but you could just start from
scratch, or combine/rewrite them however you like.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s what one of our first tests might look like:</p>
</div>
<div id="first_test" class="exampleblock">
<div class="title">A first test for allocation (test_batches.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_allocating_to_a_batch_reduces_the_available_quantity</span><span class="tok-p">():</span>
    <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch-001&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;SMALL-TABLE&quot;</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-mi">20</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">date</span><span class="tok-o">.</span><span class="tok-n">today</span><span class="tok-p">())</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s1">&#39;order-ref&#39;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;SMALL-TABLE&quot;</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">)</span>

    <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>

    <span class="tok-k">assert</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">18</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The name of our unit test describes the behavior that we want to see from the
system, and the names of the classes and variables that we use are taken from the
business jargon. We could show this code to our nontechnical coworkers, and
they would agree that this correctly describes the behavior of the system.</p>
</div>
<div class="paragraph pagebreak-before">
<p>And here is a domain model that meets our requirements:</p>
</div>
<div id="domain_model_1" class="exampleblock">
<div class="title">First cut of a domain model for batches (model.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@dataclass</span><span class="tok-p">(</span><span class="tok-n">frozen</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-k">class</span> <span class="tok-nc">OrderLine</span><span class="tok-p">:</span>
    <span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span>


<span class="tok-k">class</span> <span class="tok-nc">Batch</span><span class="tok-p">:</span>
    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span>
        <span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">ref</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-p">:</span> <span class="tok-n">Optional</span><span class="tok-p">[</span><span class="tok-n">date</span><span class="tok-p">]</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">reference</span> <span class="tok-o">=</span> <span class="tok-n">ref</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">sku</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">eta</span> <span class="tok-o">=</span> <span class="tok-n">eta</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">=</span> <span class="tok-n">qty</span>

    <span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">-=</span> <span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">qty</span>  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>OrderLine</code> is an immutable dataclass
with no behavior.<sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We&#8217;re not showing imports in most code listings, in an attempt to keep them
clean. We&#8217;re hoping you can guess
that this came via <code>from dataclasses import dataclass</code>; likewise,
<code>typing.Optional</code> and <code>datetime.date</code>. If you want to double-check
anything, you can see the full working code for each chapter in
its branch (e.g.,
<a href="https://github.com/python-leap/code/tree/chapter_01_domain_model">chapter_01_domain_model</a>).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Type hints are still a matter of controversy in the Python world. For
domain models, they can sometimes help to clarify or document what the
expected arguments are, and people with IDEs are often grateful for them.
You may decide the price paid in terms of readability is too high.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Our implementation here is trivial: a <code>Batch</code> just wraps an integer
<code>available_quantity</code>, and we decrement that value on allocation. We&#8217;ve written
quite a lot of code just to subtract one number from another, but we think that modeling our
domain precisely will pay off.<sup class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnotedef_6" title="View footnote.">6</a>]</sup></p>
</div>
<div class="paragraph">
<p>Let&#8217;s write some new failing tests:</p>
</div>
<div id="test_can_allocate" class="exampleblock">
<div class="title">Testing logic for what we can allocate (test_batches.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">make_batch_and_line</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">batch_qty</span><span class="tok-p">,</span> <span class="tok-n">line_qty</span><span class="tok-p">):</span>
    <span class="tok-k">return</span> <span class="tok-p">(</span>
        <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch-001&quot;</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">batch_qty</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">date</span><span class="tok-o">.</span><span class="tok-n">today</span><span class="tok-p">()),</span>
        <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s2">&quot;order-123&quot;</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">line_qty</span><span class="tok-p">)</span>
    <span class="tok-p">)</span>


<span class="tok-k">def</span> <span class="tok-nf">test_can_allocate_if_available_greater_than_required</span><span class="tok-p">():</span>
    <span class="tok-n">large_batch</span><span class="tok-p">,</span> <span class="tok-n">small_line</span> <span class="tok-o">=</span> <span class="tok-n">make_batch_and_line</span><span class="tok-p">(</span><span class="tok-s2">&quot;ELEGANT-LAMP&quot;</span><span class="tok-p">,</span> <span class="tok-mi">20</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">large_batch</span><span class="tok-o">.</span><span class="tok-n">can_allocate</span><span class="tok-p">(</span><span class="tok-n">small_line</span><span class="tok-p">)</span>

<span class="tok-k">def</span> <span class="tok-nf">test_cannot_allocate_if_available_smaller_than_required</span><span class="tok-p">():</span>
    <span class="tok-n">small_batch</span><span class="tok-p">,</span> <span class="tok-n">large_line</span> <span class="tok-o">=</span> <span class="tok-n">make_batch_and_line</span><span class="tok-p">(</span><span class="tok-s2">&quot;ELEGANT-LAMP&quot;</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-mi">20</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">small_batch</span><span class="tok-o">.</span><span class="tok-n">can_allocate</span><span class="tok-p">(</span><span class="tok-n">large_line</span><span class="tok-p">)</span> <span class="tok-ow">is</span> <span class="tok-bp">False</span>

<span class="tok-k">def</span> <span class="tok-nf">test_can_allocate_if_available_equal_to_required</span><span class="tok-p">():</span>
    <span class="tok-n">batch</span><span class="tok-p">,</span> <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">make_batch_and_line</span><span class="tok-p">(</span><span class="tok-s2">&quot;ELEGANT-LAMP&quot;</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">can_allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>

<span class="tok-k">def</span> <span class="tok-nf">test_cannot_allocate_if_skus_do_not_match</span><span class="tok-p">():</span>
    <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch-001&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;UNCOMFORTABLE-CHAIR&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">)</span>
    <span class="tok-n">different_sku_line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s2">&quot;order-123&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;EXPENSIVE-TOASTER&quot;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">can_allocate</span><span class="tok-p">(</span><span class="tok-n">different_sku_line</span><span class="tok-p">)</span> <span class="tok-ow">is</span> <span class="tok-bp">False</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s nothing too unexpected here. We&#8217;ve refactored our test suite so that we
don&#8217;t keep repeating the same lines of code to create a batch and a line for
the same SKU; and we&#8217;ve written four simple tests for a new method
<code>can_allocate</code>. Again, notice that the names we use mirror the language of our
domain experts, and the examples we agreed upon are directly written into code.</p>
</div>
<div class="paragraph">
<p>We can implement this straightforwardly, too, by writing the <code>can_allocate</code>
method of <code>Batch</code>:</p>
</div>
<div id="can_allocate" class="exampleblock">
<div class="title">A new method in the model (model.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">can_allocate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">bool</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">==</span> <span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-ow">and</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">&gt;=</span> <span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">qty</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>So far, we can manage the implementation by just incrementing and decrementing
<code>Batch.available_quantity</code>, but as we get into <code>deallocate()</code> tests, we&#8217;ll be
forced into a more intelligent solution:</p>
</div>
<div id="test_deallocate_unallocated" class="exampleblock pagebreak-before">
<div class="title">This test is going to require a smarter model (test_batches.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_can_only_deallocate_allocated_lines</span><span class="tok-p">():</span>
    <span class="tok-n">batch</span><span class="tok-p">,</span> <span class="tok-n">unallocated_line</span> <span class="tok-o">=</span> <span class="tok-n">make_batch_and_line</span><span class="tok-p">(</span><span class="tok-s2">&quot;DECORATIVE-TRINKET&quot;</span><span class="tok-p">,</span> <span class="tok-mi">20</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
    <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">deallocate</span><span class="tok-p">(</span><span class="tok-n">unallocated_line</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">20</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In this test, we&#8217;re asserting that deallocating a line from a batch has no effect
unless the batch previously allocated the line. For this to work, our <code>Batch</code>
needs to understand which lines have been allocated. Let&#8217;s look at the
implementation:</p>
</div>
<div id="domain_model_complete" class="exampleblock">
<div class="title">The domain model now tracks allocations (model.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Batch</span><span class="tok-p">:</span>
    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span>
        <span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">ref</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-p">:</span> <span class="tok-n">Optional</span><span class="tok-p">[</span><span class="tok-n">date</span><span class="tok-p">]</span>
    <span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">reference</span> <span class="tok-o">=</span> <span class="tok-n">ref</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">sku</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">eta</span> <span class="tok-o">=</span> <span class="tok-n">eta</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_purchased_quantity</span> <span class="tok-o">=</span> <span class="tok-n">qty</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_allocations</span> <span class="tok-o">=</span> <span class="tok-nb">set</span><span class="tok-p">()</span>  <span class="tok-c1"># type: Set[OrderLine]</span>

    <span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">):</span>
        <span class="tok-k">if</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">can_allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">):</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_allocations</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">deallocate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">):</span>
        <span class="tok-k">if</span> <span class="tok-n">line</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_allocations</span><span class="tok-p">:</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_allocations</span><span class="tok-o">.</span><span class="tok-n">remove</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>

    <span class="tok-nd">@property</span>
    <span class="tok-k">def</span> <span class="tok-nf">allocated_quantity</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">int</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-nb">sum</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">qty</span> <span class="tok-k">for</span> <span class="tok-n">line</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_allocations</span><span class="tok-p">)</span>

    <span class="tok-nd">@property</span>
    <span class="tok-k">def</span> <span class="tok-nf">available_quantity</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">int</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_purchased_quantity</span> <span class="tok-o">-</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">allocated_quantity</span>

    <span class="tok-k">def</span> <span class="tok-nf">can_allocate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">bool</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">==</span> <span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-ow">and</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">&gt;=</span> <span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">qty</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><a href="#model_diagram">Our model in UML</a> shows the model in UML.</p>
</div>
<div id="model_diagram" class="imageblock">
<div class="content">
<img src="images/apwp_0103.png" alt="apwp 0103">
</div>
<div class="title">Figure 6. Our model in UML</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_0103, config=plantuml.cfg]
@startuml
scale 4

left to right direction
hide empty members

class Batch {
    reference
    sku
    eta
    _purchased_quantity
    _allocations
}

class OrderLine {
    orderid
    sku
    qty
}

Batch::_allocations o-- OrderLine</pre>
</div>
</div>
<div class="paragraph">
<p>Now we&#8217;re getting somewhere! A batch now keeps track of a set of allocated
<code>OrderLine</code> objects. When we allocate, if we have enough available quantity, we
just add to the set. Our <code>available_quantity</code> is now a calculated property:
purchased quantity minus allocated quantity.</p>
</div>
<div class="paragraph">
<p>Yes, there&#8217;s plenty more we could do. It&#8217;s a little disconcerting that
both <code>allocate()</code> and <code>deallocate()</code> can fail silently, but we have the
basics.</p>
</div>
<div class="paragraph">
<p>Incidentally, using a set for <code>._allocations</code> makes it simple for us
to handle the last test, because items in a set are unique:</p>
</div>
<div id="last_test" class="exampleblock">
<div class="title">Last batch test!  (test_batches.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_allocation_is_idempotent</span><span class="tok-p">():</span>
    <span class="tok-n">batch</span><span class="tok-p">,</span> <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">make_batch_and_line</span><span class="tok-p">(</span><span class="tok-s2">&quot;ANGULAR-DESK&quot;</span><span class="tok-p">,</span> <span class="tok-mi">20</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
    <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
    <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">18</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>At the moment, it&#8217;s probably a valid criticism to say that the domain model is
too trivial to bother with DDD (or even object orientation!). In real life,
any number of business rules and edge cases crop up: customers can ask for
delivery on specific future dates, which means we might not want to allocate
them to the earliest batch. Some SKUs aren&#8217;t in batches, but ordered on
demand directly from suppliers, so they have different logic. Depending on the
customer&#8217;s location, we can allocate to only a subset of warehouses and shipments
that are in their region—except for some SKUs we&#8217;re happy to deliver from a
warehouse in a different region if we&#8217;re out of stock in the home region. And
so on.  A real business in the real world knows how to pile on complexity faster
than we can show on the page!</p>
</div>
<div class="paragraph">
<p>But taking this simple domain model as a placeholder for something more complex, we&#8217;re going to extend our simple domain model in the rest of the book and
plug it into the real world of APIs and databases and spreadsheets. We&#8217;ll
see how sticking rigidly to our principles of encapsulation and careful
layering will help us to avoid a ball of mud.</p>
</div>
<div class="sidebarblock nobreakinside">
<div class="content">
<div class="title">More Types for More Type Hints</div>
<div class="paragraph">
<p>If you really want to go to town with type hints, you could go so far as
wrapping primitive types by using <code>typing.NewType</code>:</p>
</div>
<div id="too_many_types" class="exampleblock">
<div class="title">Just taking it way too far, Bob</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">dataclasses</span> <span class="tok-kn">import</span> <span class="tok-n">dataclass</span>
<span class="tok-kn">from</span> <span class="tok-nn">typing</span> <span class="tok-kn">import</span> <span class="tok-n">NewType</span>

<span class="tok-n">Quantity</span> <span class="tok-o">=</span> <span class="tok-n">NewType</span><span class="tok-p">(</span><span class="tok-s2">&quot;Quantity&quot;</span><span class="tok-p">,</span> <span class="tok-nb">int</span><span class="tok-p">)</span>
<span class="tok-n">Sku</span> <span class="tok-o">=</span> <span class="tok-n">NewType</span><span class="tok-p">(</span><span class="tok-s2">&quot;Sku&quot;</span><span class="tok-p">,</span> <span class="tok-nb">str</span><span class="tok-p">)</span>
<span class="tok-n">Reference</span> <span class="tok-o">=</span> <span class="tok-n">NewType</span><span class="tok-p">(</span><span class="tok-s2">&quot;Reference&quot;</span><span class="tok-p">,</span> <span class="tok-nb">str</span><span class="tok-p">)</span>
<span class="tok-o">...</span>

<span class="tok-k">class</span> <span class="tok-nc">Batch</span><span class="tok-p">:</span>
    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">ref</span><span class="tok-p">:</span> <span class="tok-n">Reference</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-n">Sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-n">Quantity</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">sku</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">reference</span> <span class="tok-o">=</span> <span class="tok-n">ref</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_purchased_quantity</span> <span class="tok-o">=</span> <span class="tok-n">qty</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That would allow our type checker to make sure that we don&#8217;t pass a <code>Sku</code> where a
<code>Reference</code> is expected, for example.</p>
</div>
<div class="paragraph">
<p>Whether you think this is wonderful or appalling is a matter of debate.<sup class="footnote">[<a id="_footnoteref_7" class="footnote" href="#_footnotedef_7" title="View footnote.">7</a>]</sup></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dataclasses_are_great_for_value_objects">1.3.1. Dataclasses Are Great for Value Objects</h4>
<div class="paragraph">
<p>We&#8217;ve used <code>line</code> liberally in the previous code listings, but what is a
line? In our business language, an <em>order</em> has multiple <em>line</em> items, where
each line has a SKU and a quantity. We can imagine that a simple YAML file
containing order information might look like this:</p>
</div>
<div id="yaml_order_example" class="exampleblock">
<div class="title">Order info as YAML</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Order_reference</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">12345</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Lines</span><span class="tok-p tok-p-Indicator">:</span>
  <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sku</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">RED-CHAIR</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">qty</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">25</span>
  <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sku</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">BLU-CHAIR</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">qty</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">25</span>
  <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sku</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">GRN-CHAIR</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">qty</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">25</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Notice that while an order has a <em>reference</em> that uniquely identifies it, a
<em>line</em> does not. (Even if we add the order reference to the <code>OrderLine</code> class,
it&#8217;s not something that uniquely identifies the line itself.)</p>
</div>
<div class="paragraph">
<p>Whenever we have a business concept that has data but no identity, we
often choose to represent it using the <em>Value Object</em> pattern. A <em>value object</em> is any
domain object that is uniquely identified by the data it holds; we usually
make them immutable:</p>
</div>
<div id="orderline_value_object" class="exampleblock">
<div class="title">OrderLine is a value object</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@dataclass</span><span class="tok-p">(</span><span class="tok-n">frozen</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>
<span class="tok-k">class</span> <span class="tok-nc">OrderLine</span><span class="tok-p">:</span>
    <span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-n">OrderReference</span>
    <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-n">ProductReference</span>
    <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-n">Quantity</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>One of the nice things that dataclasses (or namedtuples) give us is <em>value
equality</em>, which is the fancy way of saying, "Two lines with the same <code>orderid</code>,
<code>sku</code>, and <code>qty</code> are equal."</p>
</div>
<div id="more_value_objects" class="exampleblock">
<div class="title">More examples of value objects</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">dataclasses</span> <span class="tok-kn">import</span> <span class="tok-n">dataclass</span>
<span class="tok-kn">from</span> <span class="tok-nn">typing</span> <span class="tok-kn">import</span> <span class="tok-n">NamedTuple</span>
<span class="tok-kn">from</span> <span class="tok-nn">collections</span> <span class="tok-kn">import</span> <span class="tok-n">namedtuple</span>

<span class="tok-nd">@dataclass</span><span class="tok-p">(</span><span class="tok-n">frozen</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>
<span class="tok-k">class</span> <span class="tok-nc">Name</span><span class="tok-p">:</span>
    <span class="tok-n">first_name</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">surname</span><span class="tok-p">:</span> <span class="tok-nb">str</span>

<span class="tok-k">class</span> <span class="tok-nc">Money</span><span class="tok-p">(</span><span class="tok-n">NamedTuple</span><span class="tok-p">):</span>
    <span class="tok-n">currency</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">value</span><span class="tok-p">:</span> <span class="tok-nb">int</span>

<span class="tok-n">Line</span> <span class="tok-o">=</span> <span class="tok-n">namedtuple</span><span class="tok-p">(</span><span class="tok-s1">&#39;Line&#39;</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">])</span>

<span class="tok-k">def</span> <span class="tok-nf">test_equality</span><span class="tok-p">():</span>
    <span class="tok-k">assert</span> <span class="tok-n">Money</span><span class="tok-p">(</span><span class="tok-s1">&#39;gbp&#39;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-n">Money</span><span class="tok-p">(</span><span class="tok-s1">&#39;gbp&#39;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">Name</span><span class="tok-p">(</span><span class="tok-s1">&#39;Harry&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;Percival&#39;</span><span class="tok-p">)</span> <span class="tok-o">!=</span> <span class="tok-n">Name</span><span class="tok-p">(</span><span class="tok-s1">&#39;Bob&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;Gregory&#39;</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">Line</span><span class="tok-p">(</span><span class="tok-s1">&#39;RED-CHAIR&#39;</span><span class="tok-p">,</span> <span class="tok-mi">5</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-n">Line</span><span class="tok-p">(</span><span class="tok-s1">&#39;RED-CHAIR&#39;</span><span class="tok-p">,</span> <span class="tok-mi">5</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>These value objects match our real-world intuition about how their values
work. It doesn&#8217;t matter <em>which</em> £10 note we&#8217;re talking about, because they all
have the same value. Likewise, two names are equal if both the first and last
names match; and two lines are equivalent if they have the same customer order,
product code, and quantity. We can still have complex behavior on a value
object, though. In fact, it&#8217;s common to support operations on values; for
example, mathematical operators:</p>
</div>
<div id="value_object_maths" class="exampleblock">
<div class="title">Math with value objects</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">fiver</span> <span class="tok-o">=</span> <span class="tok-n">Money</span><span class="tok-p">(</span><span class="tok-s1">&#39;gbp&#39;</span><span class="tok-p">,</span> <span class="tok-mi">5</span><span class="tok-p">)</span>
<span class="tok-n">tenner</span> <span class="tok-o">=</span> <span class="tok-n">Money</span><span class="tok-p">(</span><span class="tok-s1">&#39;gbp&#39;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>

<span class="tok-k">def</span> <span class="tok-nf">can_add_money_values_for_the_same_currency</span><span class="tok-p">():</span>
    <span class="tok-k">assert</span> <span class="tok-n">fiver</span> <span class="tok-o">+</span> <span class="tok-n">fiver</span> <span class="tok-o">==</span> <span class="tok-n">tenner</span>

<span class="tok-k">def</span> <span class="tok-nf">can_subtract_money_values</span><span class="tok-p">():</span>
    <span class="tok-k">assert</span> <span class="tok-n">tenner</span> <span class="tok-o">-</span> <span class="tok-n">fiver</span> <span class="tok-o">==</span> <span class="tok-n">fiver</span>

<span class="tok-k">def</span> <span class="tok-nf">adding_different_currencies_fails</span><span class="tok-p">():</span>
    <span class="tok-k">with</span> <span class="tok-n">pytest</span><span class="tok-o">.</span><span class="tok-n">raises</span><span class="tok-p">(</span><span class="tok-ne">ValueError</span><span class="tok-p">):</span>
        <span class="tok-n">Money</span><span class="tok-p">(</span><span class="tok-s1">&#39;usd&#39;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span> <span class="tok-o">+</span> <span class="tok-n">Money</span><span class="tok-p">(</span><span class="tok-s1">&#39;gbp&#39;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>

<span class="tok-k">def</span> <span class="tok-nf">can_multiply_money_by_a_number</span><span class="tok-p">():</span>
    <span class="tok-k">assert</span> <span class="tok-n">fiver</span> <span class="tok-o">*</span> <span class="tok-mi">5</span> <span class="tok-o">==</span> <span class="tok-n">Money</span><span class="tok-p">(</span><span class="tok-s1">&#39;gbp&#39;</span><span class="tok-p">,</span> <span class="tok-mi">25</span><span class="tok-p">)</span>

<span class="tok-k">def</span> <span class="tok-nf">multiplying_two_money_values_is_an_error</span><span class="tok-p">():</span>
    <span class="tok-k">with</span> <span class="tok-n">pytest</span><span class="tok-o">.</span><span class="tok-n">raises</span><span class="tok-p">(</span><span class="tok-ne">TypeError</span><span class="tok-p">):</span>
        <span class="tok-n">tenner</span> <span class="tok-o">*</span> <span class="tok-n">fiver</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_value_objects_and_entities">1.3.2. Value Objects and Entities</h4>
<div class="paragraph">
<p>An order line is uniquely identified by its order ID, SKU, and quantity; if we
change one of those values, we now have a new line. That&#8217;s the definition of a
value object: any object that is identified only by its data and doesn&#8217;t have a
long-lived identity. What about a batch, though? That <em>is</em> identified by a
reference.</p>
</div>
<div class="paragraph">
<p>We use the term <em>entity</em> to describe a domain object that has long-lived
identity. On the previous page, we introduced a <code>Name</code> class as a value object.
If we take the name Harry Percival and change one letter, we have the new
<code>Name</code> object Barry Percival.</p>
</div>
<div class="paragraph">
<p>It should be clear that Harry Percival is not equal to Barry Percival:</p>
</div>
<div id="test_equality" class="exampleblock">
<div class="title">A name itself cannot change&#8230;&#8203;</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_name_equality</span><span class="tok-p">():</span>
    <span class="tok-k">assert</span> <span class="tok-n">Name</span><span class="tok-p">(</span><span class="tok-s2">&quot;Harry&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Percival&quot;</span><span class="tok-p">)</span> <span class="tok-o">!=</span> <span class="tok-n">Name</span><span class="tok-p">(</span><span class="tok-s2">&quot;Barry&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Percival&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But what about Harry as a <em>person</em>? People do change their names, and their
marital status, and even their gender, but we continue to recognize them as the
same individual. That&#8217;s because humans, unlike names, have a persistent
<em>identity</em>:</p>
</div>
<div id="person_identity" class="exampleblock">
<div class="title">But a person can!</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Person</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-p">:</span> <span class="tok-n">Name</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-n">name</span>


<span class="tok-k">def</span> <span class="tok-nf">test_barry_is_harry</span><span class="tok-p">():</span>
    <span class="tok-n">harry</span> <span class="tok-o">=</span> <span class="tok-n">Person</span><span class="tok-p">(</span><span class="tok-n">Name</span><span class="tok-p">(</span><span class="tok-s2">&quot;Harry&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Percival&quot;</span><span class="tok-p">))</span>
    <span class="tok-n">barry</span> <span class="tok-o">=</span> <span class="tok-n">harry</span>

    <span class="tok-n">barry</span><span class="tok-o">.</span><span class="tok-n">name</span> <span class="tok-o">=</span> <span class="tok-n">Name</span><span class="tok-p">(</span><span class="tok-s2">&quot;Barry&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;Percival&quot;</span><span class="tok-p">)</span>

    <span class="tok-k">assert</span> <span class="tok-n">harry</span> <span class="tok-ow">is</span> <span class="tok-n">barry</span> <span class="tok-ow">and</span> <span class="tok-n">barry</span> <span class="tok-ow">is</span> <span class="tok-n">harry</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Entities, unlike values, have <em>identity equality</em>. We can change their values,
and they are still recognizably the same thing. Batches, in our example, are
entities. We can allocate lines to a batch, or change the date that we expect
it to arrive, and it will still be the same entity.</p>
</div>
<div class="paragraph">
<p>We usually make this explicit in code by implementing equality operators on
entities:</p>
</div>
<div id="equality_on_batches" class="exampleblock">
<div class="title">Implementing equality operators (model.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Batch</span><span class="tok-p">:</span>
    <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-fm">__eq__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">other</span><span class="tok-p">):</span>
        <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-nb">isinstance</span><span class="tok-p">(</span><span class="tok-n">other</span><span class="tok-p">,</span> <span class="tok-n">Batch</span><span class="tok-p">):</span>
            <span class="tok-k">return</span> <span class="tok-bp">False</span>
        <span class="tok-k">return</span> <span class="tok-n">other</span><span class="tok-o">.</span><span class="tok-n">reference</span> <span class="tok-o">==</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">reference</span>

    <span class="tok-k">def</span> <span class="tok-fm">__hash__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-nb">hash</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">reference</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Python&#8217;s <code>__eq__</code> magic method
defines the behavior of the class for the <code>==</code> operator.<sup class="footnote">[<a id="_footnoteref_8" class="footnote" href="#_footnotedef_8" title="View footnote.">8</a>]</sup></p>
</div>
<div class="paragraph">
<p>For both entity and value objects, it&#8217;s also worth thinking through how
<code>__hash__</code> will work.  It&#8217;s the magic method Python uses to control the
behavior of objects when you add them to sets or use them as dict keys;
you can find more info <a href="https://oreil.ly/YUzg5">in the Python docs</a>.</p>
</div>
<div class="paragraph">
<p>For value objects, the hash should be based on all the value attributes,
and we should ensure that the objects are immutable.  We get this for
free by specifying <code>@frozen=True</code> on the dataclass.</p>
</div>
<div class="paragraph">
<p>For entities, the simplest option is to say that the hash is None, meaning
that the object is not hashable and cannot, for example, be used in a set.
If for some reason you decide you really do want to use set or dict operations
with entities, the hash should be based on the attribute(s), such as
<code>.reference</code>, that defines the entity&#8217;s unique identity over time. You should
also try to somehow make <em>that</em> attribute read-only.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This is tricky territory; you shouldn&#8217;t modify <code>__hash__</code> without
    also modifying <code>__eq__</code>.  If you&#8217;re not sure what you&#8217;re doing,
    further reading is suggested. <a href="https://oreil.ly/vxkgX">
    "Python Hashes and Equality"</a> by our tech reviewer Hynek Schlawack is a good place to start.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_not_everything_has_to_be_an_object_a_domain_service_function">1.4. Not Everything Has to Be an Object: A Domain Service Function</h3>
<div class="paragraph">
<p>We&#8217;ve made a model to represent batches, but what we actually need
to do is allocate order lines against a specific set of batches that
represent all our stock.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Sometimes, it just isn&#8217;t a thing.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Eric Evans<br>
<cite>Domain-Driven Design</cite>
</div>
</div>
<div class="paragraph">
<p>Evans discusses the idea of Domain Service
operations that don&#8217;t have a natural home in an entity or value object.<sup class="footnote">[<a id="_footnoteref_9" class="footnote" href="#_footnotedef_9" title="View footnote.">9</a>]</sup> A
thing that allocates an order line, given a set of batches, sounds a lot like a
function, and we can take advantage of the fact that Python is a multiparadigm
language and just make it a function.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see how we might test-drive such a function:</p>
</div>
<div id="test_allocate" class="exampleblock">
<div class="title">Testing our domain service (test_allocate.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_prefers_current_stock_batches_to_shipments</span><span class="tok-p">():</span>
    <span class="tok-n">in_stock_batch</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;in-stock-batch&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;RETRO-CLOCK&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">)</span>
    <span class="tok-n">shipment_batch</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;shipment-batch&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;RETRO-CLOCK&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">tomorrow</span><span class="tok-p">)</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s2">&quot;oref&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;RETRO-CLOCK&quot;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>

    <span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-n">in_stock_batch</span><span class="tok-p">,</span> <span class="tok-n">shipment_batch</span><span class="tok-p">])</span>

    <span class="tok-k">assert</span> <span class="tok-n">in_stock_batch</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">90</span>
    <span class="tok-k">assert</span> <span class="tok-n">shipment_batch</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">100</span>


<span class="tok-k">def</span> <span class="tok-nf">test_prefers_earlier_batches</span><span class="tok-p">():</span>
    <span class="tok-n">earliest</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;speedy-batch&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;MINIMALIST-SPOON&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">today</span><span class="tok-p">)</span>
    <span class="tok-n">medium</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;normal-batch&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;MINIMALIST-SPOON&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">tomorrow</span><span class="tok-p">)</span>
    <span class="tok-n">latest</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;slow-batch&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;MINIMALIST-SPOON&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">later</span><span class="tok-p">)</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s2">&quot;order1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;MINIMALIST-SPOON&quot;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>

    <span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-n">medium</span><span class="tok-p">,</span> <span class="tok-n">earliest</span><span class="tok-p">,</span> <span class="tok-n">latest</span><span class="tok-p">])</span>

    <span class="tok-k">assert</span> <span class="tok-n">earliest</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">90</span>
    <span class="tok-k">assert</span> <span class="tok-n">medium</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">100</span>
    <span class="tok-k">assert</span> <span class="tok-n">latest</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">100</span>


<span class="tok-k">def</span> <span class="tok-nf">test_returns_allocated_batch_ref</span><span class="tok-p">():</span>
    <span class="tok-n">in_stock_batch</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;in-stock-batch-ref&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;HIGHBROW-POSTER&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">)</span>
    <span class="tok-n">shipment_batch</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;shipment-batch-ref&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;HIGHBROW-POSTER&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">tomorrow</span><span class="tok-p">)</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s2">&quot;oref&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;HIGHBROW-POSTER&quot;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>
    <span class="tok-n">allocation</span> <span class="tok-o">=</span> <span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-n">in_stock_batch</span><span class="tok-p">,</span> <span class="tok-n">shipment_batch</span><span class="tok-p">])</span>
    <span class="tok-k">assert</span> <span class="tok-n">allocation</span> <span class="tok-o">==</span> <span class="tok-n">in_stock_batch</span><span class="tok-o">.</span><span class="tok-n">reference</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And our service might look like this:</p>
</div>
<div id="domain_service" class="exampleblock">
<div class="title">A standalone function for our domain service (model.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">:</span> <span class="tok-n">List</span><span class="tok-p">[</span><span class="tok-n">Batch</span><span class="tok-p">])</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
    <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-nb">next</span><span class="tok-p">(</span>
        <span class="tok-n">b</span> <span class="tok-k">for</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-nb">sorted</span><span class="tok-p">(</span><span class="tok-n">batches</span><span class="tok-p">)</span> <span class="tok-k">if</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">can_allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
    <span class="tok-p">)</span>
    <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">reference</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pythons_magic_methods_let_us_use_our_models_with_idiomatic_python">1.4.1. Python&#8217;s Magic Methods Let Us Use Our Models with Idiomatic Python</h4>
<div class="paragraph">
<p>You may or may not like the use of <code>next()</code> in the preceding code, but we&#8217;re pretty
sure you&#8217;ll agree that being able to use <code>sorted()</code> on our list of
batches is nice, idiomatic Python.</p>
</div>
<div class="paragraph">
<p>To make it work, we implement <code>__gt__</code> on our domain model:</p>
</div>
<div id="dunder_gt" class="exampleblock">
<div class="title">Magic methods can express domain semantics (model.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Batch</span><span class="tok-p">:</span>
    <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-fm">__gt__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">other</span><span class="tok-p">):</span>
        <span class="tok-k">if</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">eta</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
            <span class="tok-k">return</span> <span class="tok-bp">False</span>
        <span class="tok-k">if</span> <span class="tok-n">other</span><span class="tok-o">.</span><span class="tok-n">eta</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
            <span class="tok-k">return</span> <span class="tok-bp">True</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">eta</span> <span class="tok-o">&gt;</span> <span class="tok-n">other</span><span class="tok-o">.</span><span class="tok-n">eta</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s lovely.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exceptions_can_express_domain_concepts_too">1.4.2. Exceptions Can Express Domain Concepts Too</h4>
<div class="paragraph">
<p>We have one final concept to cover: exceptions
can be used to express domain concepts too. In our conversations
with domain experts, we&#8217;ve learned about the possibility that
an order cannot be allocated because we are <em>out of stock</em>, and
we can capture that by using a <em>domain exception</em>:</p>
</div>
<div id="test_out_of_stock" class="exampleblock">
<div class="title">Testing out-of-stock exception (test_allocate.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_raises_out_of_stock_exception_if_cannot_allocate</span><span class="tok-p">():</span>
    <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s1">&#39;batch1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;SMALL-FORK&#39;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">today</span><span class="tok-p">)</span>
    <span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s1">&#39;order1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;SMALL-FORK&#39;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">),</span> <span class="tok-p">[</span><span class="tok-n">batch</span><span class="tok-p">])</span>

    <span class="tok-k">with</span> <span class="tok-n">pytest</span><span class="tok-o">.</span><span class="tok-n">raises</span><span class="tok-p">(</span><span class="tok-n">OutOfStock</span><span class="tok-p">,</span> <span class="tok-n">match</span><span class="tok-o">=</span><span class="tok-s1">&#39;SMALL-FORK&#39;</span><span class="tok-p">):</span>
        <span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s1">&#39;order2&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;SMALL-FORK&#39;</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">),</span> <span class="tok-p">[</span><span class="tok-n">batch</span><span class="tok-p">])</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sidebarblock nobreakinside">
<div class="content">
<div class="title">Domain Modeling Recap</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Domain modeling</dt>
<dd>
<p>This is the part of your code that is closest to the business,
the most likely to change, and the place where you deliver the
most value to the business. Make it easy to understand and modify.</p>
</dd>
<dt class="hdlist1">Distinguish entities from value objects</dt>
<dd>
<p>A value object is defined by its attributes. It&#8217;s usually best
implemented as an immutable type. If you change an attribute on
a Value Object, it represents a different object. In contrast,
an entity has attributes that may vary over time and it will still be the
same entity. It&#8217;s important to define what <em>does</em> uniquely identify
an entity (usually some sort of name or reference field).</p>
</dd>
<dt class="hdlist1">Not everything has to be an object</dt>
<dd>
<p>Python is a multiparadigm language, so let the "verbs" in your
code be functions. For every <code>FooManager</code>, <code>BarBuilder</code>, or <code>BazFactory</code>,
there&#8217;s often a more expressive and readable <code>manage_foo()</code>, <code>build_bar()</code>,
or <code>get_baz()</code> waiting to happen.</p>
</dd>
<dt class="hdlist1">This is the time to apply your best OO design principles</dt>
<dd>
<p>Revisit the SOLID principles and all the other good heuristics like "has a versus is-a,"
"prefer composition over inheritance," and so on.</p>
</dd>
<dt class="hdlist1">You&#8217;ll also want to think about consistency boundaries and aggregates</dt>
<dd>
<p>But that&#8217;s a topic for <a href="#chapter_07_aggregate">Aggregates and Consistency Boundaries</a>.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>We won&#8217;t bore you too much with the implementation, but the main thing
to note is that we take care in naming our exceptions in the ubiquitous
language, just as we do our entities, value objects, and services:</p>
</div>
<div id="out_of_stock" class="exampleblock">
<div class="title">Raising a domain exception (model.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">OutOfStock</span><span class="tok-p">(</span><span class="tok-ne">Exception</span><span class="tok-p">):</span>
    <span class="tok-k">pass</span>


<span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">:</span> <span class="tok-n">List</span><span class="tok-p">[</span><span class="tok-n">Batch</span><span class="tok-p">])</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
    <span class="tok-k">try</span><span class="tok-p">:</span>
        <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-nb">next</span><span class="tok-p">(</span>
        <span class="tok-o">...</span>
    <span class="tok-k">except</span> <span class="tok-ne">StopIteration</span><span class="tok-p">:</span>
        <span class="tok-k">raise</span> <span class="tok-n">OutOfStock</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;Out of stock for sku {line.sku}&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><a href="#maps_chapter_01_withtext">Our domain model at the end of the chapter</a> is a visual representation of where we&#8217;ve ended up.</p>
</div>
<div id="maps_chapter_01_withtext" class="imageblock">
<div class="content">
<img src="images/apwp_0104.png" alt="apwp 0104">
</div>
<div class="title">Figure 7. Our domain model at the end of the chapter</div>
</div>
<div class="paragraph">
<p>That&#8217;ll probably do for now! We have a domain service that we can use for our
first use case. But first we&#8217;ll need a database&#8230;&#8203;</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_02_repository">2. Repository Pattern</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s time to make good on our promise to use the dependency inversion principle as
a way of decoupling our core logic from infrastructural concerns.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll introduce the <em>Repository</em> pattern, a simplifying abstraction over data storage,
allowing us to decouple our model layer from the data layer. We&#8217;ll present a
concrete example of how this simplifying abstraction makes our system more
testable by hiding the complexities of the database.</p>
</div>
<div class="paragraph">
<p><a href="#maps_chapter_02">Before and after the Repository pattern</a> shows a little preview of what we&#8217;re going to build:
a <code>Repository</code> object that sits between our domain model and the database.</p>
</div>
<div id="maps_chapter_02" class="imageblock">
<div class="content">
<img src="images/apwp_0201.png" alt="apwp 0201">
</div>
<div class="title">Figure 8. Before and after the Repository pattern</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The code for this chapter is in the
chapter_02_repository branch <a href="https://oreil.ly/6STDu">on GitHub</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/cosmicpython/code.git
cd code
git checkout chapter_02_repository
# or to code along, checkout the previous chapter:
git checkout chapter_01_domain_model</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_persisting_our_domain_model">2.1. Persisting Our Domain Model</h3>
<div class="paragraph">
<p>In <a href="#chapter_01_domain_model">Domain Modeling</a> we built a simple domain model that can allocate orders
to batches of stock. It&#8217;s easy for us to write tests against this code because
there aren&#8217;t any dependencies or infrastructure to set up. If we needed to run
a database or an API and create test data, our tests would be harder to write
and maintain.</p>
</div>
<div class="paragraph">
<p>Sadly, at some point we&#8217;ll need to put our perfect little model in the hands of
users and contend with the real world of spreadsheets and web
browsers and race conditions. For the next few chapters we&#8217;re going to look at
how we can connect our idealized domain model to external state.</p>
</div>
<div class="paragraph">
<p>We expect to be working in an agile manner, so our priority is to get to a
minimum viable product as quickly as possible. In our case, that&#8217;s going to be
a web API. In a real project, you might dive straight in with some end-to-end
tests and start plugging in a web framework, test-driving things outside-in.</p>
</div>
<div class="paragraph">
<p>But we know that, no matter what, we&#8217;re going to need some form of persistent
storage, and this is a textbook, so we can allow ourselves a tiny bit more
bottom-up development and start to think about storage and databases.</p>
</div>
</div>
<div class="sect2">
<h3 id="_some_pseudocode_what_are_we_going_to_need">2.2. Some Pseudocode: What Are We Going to Need?</h3>
<div class="paragraph">
<p>When we build our first API endpoint, we know we&#8217;re going to have
some code that looks more or less like the following.</p>
</div>
<div id="api_endpoint_pseudocode" class="exampleblock">
<div class="title">What our first API endpoint will look like</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@flask.route.gubbins</span>
<span class="tok-k">def</span> <span class="tok-nf">allocate_endpoint</span><span class="tok-p">():</span>
    <span class="tok-c1"># extract order line from request</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">params</span><span class="tok-p">,</span> <span class="tok-o">...</span><span class="tok-p">)</span>
    <span class="tok-c1"># load all batches from the DB</span>
    <span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-o">...</span>
    <span class="tok-c1"># call our domain service</span>
    <span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">)</span>
    <span class="tok-c1"># then save the allocation back to the database somehow</span>
    <span class="tok-k">return</span> <span class="tok-mi">201</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We&#8217;ve used Flask because it&#8217;s lightweight, but you don&#8217;t need
to be a Flask user to understand this book. In fact, we&#8217;ll show you how
to make your choice of framework a minor detail.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;ll need a way to retrieve batch info from the database and instantiate our domain
model objects from it, and we&#8217;ll also need a way of saving them back to the
database.</p>
</div>
<div class="paragraph">
<p><em>What? Oh, "gubbins" is a British word for "stuff." You can just ignore that. It&#8217;s pseudocode, OK?</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_applying_the_dip_to_data_access">2.3. Applying the DIP to Data Access</h3>
<div class="paragraph">
<p>As mentioned in the <a href="#introduction">introduction</a>, a layered architecture is a common
 approach to structuring a system that has a UI, some logic, and a database (see
<a href="#layered_architecture2">Layered architecture</a>).</p>
</div>
<div id="layered_architecture2" class="imageblock width-75">
<div class="content">
<img src="images/apwp_0202.png" alt="apwp 0202">
</div>
<div class="title">Figure 9. Layered architecture</div>
</div>
<div class="paragraph">
<p>Django&#8217;s Model-View-Template structure is closely related, as is
Model-View-Controller (MVC). In any case, the aim is to keep the layers
separate (which is a good thing), and to have each layer depend only on the one
below it.</p>
</div>
<div class="paragraph">
<p>But we want our domain model to have <em>no dependencies whatsoever</em>.<sup class="footnote">[<a id="_footnoteref_10" class="footnote" href="#_footnotedef_10" title="View footnote.">10</a>]</sup>
We don&#8217;t want infrastructure concerns bleeding over into our domain model and
slowing our unit tests or our ability to make changes.</p>
</div>
<div class="paragraph">
<p>Instead, as discussed in the introduction, we&#8217;ll think of our model as being on the
"inside," and dependencies flowing inward to it; this is what people sometimes call
<em>onion architecture</em> (see <a href="#onion_architecture">Onion architecture</a>).</p>
</div>
<div id="onion_architecture" class="imageblock width-75">
<div class="content">
<img src="images/apwp_0203.png" alt="apwp 0203">
</div>
<div class="title">Figure 10. Onion architecture</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[ditaa, apwp_0203]
+------------------------+
|   Presentation Layer   |
+------------------------+
           |
           V
+--------------------------------------------------+
|                  Domain Model                    |
+--------------------------------------------------+
                                        ^
                                        |
                             +---------------------+
                             |    Database Layer   |
                             +---------------------+</pre>
</div>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Is This Ports and Adapters?</div>
<div class="paragraph">
<p>If you&#8217;ve been reading about architectural patterns, you may be asking
yourself questions like this:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><em>Is this ports and adapters? Or is it hexagonal architecture? Is that the same as onion architecture? What about the clean architecture? What&#8217;s a port, and what&#8217;s an adapter? Why do you people have so many words for the same thing?</em></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Although some people like to nitpick over the differences, all these are
pretty much names for the same thing, and they all boil down to the
dependency inversion principle: high-level modules (the domain) should
not depend on low-level ones (the infrastructure).<sup class="footnote">[<a id="_footnoteref_11" class="footnote" href="#_footnotedef_11" title="View footnote.">11</a>]</sup></p>
</div>
<div class="paragraph">
<p>We&#8217;ll get into some of the nitty-gritty around "depending on abstractions,"
and whether there is a Pythonic equivalent of interfaces,
<a href="#depend_on_abstractions">later in the book</a>. See also <a href="#what_is_a_port_and_what_is_an_adapter">What Is a Port and What Is an Adapter, in Python?</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reminder_our_model">2.4. Reminder: Our Model</h3>
<div class="paragraph">
<p>Let&#8217;s remind ourselves of our domain model (see <a href="#model_diagram_reminder">Our model</a>):
an allocation is the concept of linking an <code>OrderLine</code> to a <code>Batch</code>.  We&#8217;re
storing the allocations as a collection on our <code>Batch</code> object.</p>
</div>
<div id="model_diagram_reminder" class="imageblock">
<div class="content">
<img src="images/apwp_0103.png" alt="apwp 0103">
</div>
<div class="title">Figure 11. Our model</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see how we might translate this to a relational database.</p>
</div>
<div class="sect3">
<h4 id="_the_normal_orm_way_model_depends_on_orm">2.4.1. The "Normal" ORM Way: Model Depends on ORM</h4>
<div class="paragraph">
<p>These days, it&#8217;s unlikely that your team members are hand-rolling their own SQL queries.
Instead, you&#8217;re almost certainly using some kind of framework to generate
SQL for you based on your model objects.</p>
</div>
<div class="paragraph">
<p>These frameworks are called <em>object-relational mappers</em> (ORMs) because they exist to
bridge the conceptual gap between the world of objects and domain modeling and
the world of databases and relational algebra.</p>
</div>
<div class="paragraph">
<p>The most important thing an ORM gives us is <em>persistence ignorance</em>: the idea
that our fancy domain model doesn&#8217;t need to know anything about how data is
loaded or persisted. This helps keep our domain clean of direct dependencies
on particular database technologies.<sup class="footnote">[<a id="_footnoteref_12" class="footnote" href="#_footnotedef_12" title="View footnote.">12</a>]</sup></p>
</div>
<div class="paragraph">
<p>But if you follow the typical SQLAlchemy tutorial, you&#8217;ll end up with something
like this:</p>
</div>
<div id="typical_sqlalchemy_example" class="exampleblock">
<div class="title">SQLAlchemy "declarative" syntax, model depends on ORM (orm.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">sqlalchemy</span> <span class="tok-kn">import</span> <span class="tok-n">Column</span><span class="tok-p">,</span> <span class="tok-n">ForeignKey</span><span class="tok-p">,</span> <span class="tok-n">Integer</span><span class="tok-p">,</span> <span class="tok-n">String</span>
<span class="tok-kn">from</span> <span class="tok-nn">sqlalchemy.ext.declarative</span> <span class="tok-kn">import</span> <span class="tok-n">declarative_base</span>
<span class="tok-kn">from</span> <span class="tok-nn">sqlalchemy.orm</span> <span class="tok-kn">import</span> <span class="tok-n">relationship</span>

<span class="tok-n">Base</span> <span class="tok-o">=</span> <span class="tok-n">declarative_base</span><span class="tok-p">()</span>

<span class="tok-k">class</span> <span class="tok-nc">Order</span><span class="tok-p">(</span><span class="tok-n">Base</span><span class="tok-p">):</span>
    <span class="tok-nb">id</span> <span class="tok-o">=</span> <span class="tok-n">Column</span><span class="tok-p">(</span><span class="tok-n">Integer</span><span class="tok-p">,</span> <span class="tok-n">primary_key</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>

<span class="tok-k">class</span> <span class="tok-nc">OrderLine</span><span class="tok-p">(</span><span class="tok-n">Base</span><span class="tok-p">):</span>
    <span class="tok-nb">id</span> <span class="tok-o">=</span> <span class="tok-n">Column</span><span class="tok-p">(</span><span class="tok-n">Integer</span><span class="tok-p">,</span> <span class="tok-n">primary_key</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>
    <span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">Column</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-p">(</span><span class="tok-mi">250</span><span class="tok-p">))</span>
    <span class="tok-n">qty</span> <span class="tok-o">=</span> <span class="tok-n">Integer</span><span class="tok-p">(</span><span class="tok-n">String</span><span class="tok-p">(</span><span class="tok-mi">250</span><span class="tok-p">))</span>
    <span class="tok-n">order_id</span> <span class="tok-o">=</span> <span class="tok-n">Column</span><span class="tok-p">(</span><span class="tok-n">Integer</span><span class="tok-p">,</span> <span class="tok-n">ForeignKey</span><span class="tok-p">(</span><span class="tok-s1">&#39;order.id&#39;</span><span class="tok-p">))</span>
    <span class="tok-n">order</span> <span class="tok-o">=</span> <span class="tok-n">relationship</span><span class="tok-p">(</span><span class="tok-n">Order</span><span class="tok-p">)</span>

<span class="tok-k">class</span> <span class="tok-nc">Allocation</span><span class="tok-p">(</span><span class="tok-n">Base</span><span class="tok-p">):</span>
    <span class="tok-o">...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You don&#8217;t need to understand SQLAlchemy to see that our pristine model is now
full of dependencies on the ORM and is starting to look ugly as hell besides.
Can we really say this model is ignorant of the database? How can it be
separate from storage concerns when our model properties are directly coupled
to database columns?</p>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Django&#8217;s ORM Is Essentially the Same, but More Restrictive</div>
<div class="paragraph">
<p>If you&#8217;re more used to Django, the preceding "declarative" SQLAlchemy snippet
translates to something like this:</p>
</div>
<div id="django_orm_example" class="exampleblock">
<div class="title">Django ORM example</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Order</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-k">pass</span>

<span class="tok-k">class</span> <span class="tok-nc">OrderLine</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">max_length</span><span class="tok-o">=</span><span class="tok-mi">255</span><span class="tok-p">)</span>
    <span class="tok-n">qty</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">IntegerField</span><span class="tok-p">()</span>
    <span class="tok-n">order</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">ForeignKey</span><span class="tok-p">(</span><span class="tok-n">Order</span><span class="tok-p">)</span>

<span class="tok-k">class</span> <span class="tok-nc">Allocation</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-o">...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The point is the same&#8212;&#8203;our model classes inherit directly from ORM
classes, so our model depends on the ORM.  We want it to be the other
way around.</p>
</div>
<div class="paragraph">
<p>Django doesn&#8217;t provide an equivalent for SQLAlchemy&#8217;s classical mapper,
but see <a href="#appendix_django">Repository and Unit of Work <span class="keep-together">Patterns with Django</span></a> for examples of how to apply dependency
inversion and the Repository pattern to Django.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_inverting_the_dependency_orm_depends_on_model">2.4.2. Inverting the Dependency: ORM Depends on Model</h4>
<div class="paragraph">
<p>Well, thankfully, that&#8217;s not the only way to use SQLAlchemy.  The alternative is
to define your schema separately, and to define an explicit <em>mapper</em> for how to convert
between the schema and our domain model, what SQLAlchemy calls a
<a href="https://oreil.ly/ZucTG">classical mapping</a>:</p>
</div>
<div id="sqlalchemy_classical_mapper" class="exampleblock nobreakinside less_space">
<div class="title">Explicit ORM mapping with SQLAlchemy Table objects (orm.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">sqlalchemy.orm</span> <span class="tok-kn">import</span> <span class="tok-n">mapper</span><span class="tok-p">,</span> <span class="tok-n">relationship</span>

<span class="tok-kn">import</span> <span class="tok-nn">model</span>  <i class="conum" data-value="1"></i><b>(1)</b>


<span class="tok-n">metadata</span> <span class="tok-o">=</span> <span class="tok-n">MetaData</span><span class="tok-p">()</span>

<span class="tok-n">order_lines</span> <span class="tok-o">=</span> <span class="tok-n">Table</span><span class="tok-p">(</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-s1">&#39;order_lines&#39;</span><span class="tok-p">,</span> <span class="tok-n">metadata</span><span class="tok-p">,</span>
    <span class="tok-n">Column</span><span class="tok-p">(</span><span class="tok-s1">&#39;id&#39;</span><span class="tok-p">,</span> <span class="tok-n">Integer</span><span class="tok-p">,</span> <span class="tok-n">primary_key</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span> <span class="tok-n">autoincrement</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">),</span>
    <span class="tok-n">Column</span><span class="tok-p">(</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">,</span> <span class="tok-n">String</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">)),</span>
    <span class="tok-n">Column</span><span class="tok-p">(</span><span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">,</span> <span class="tok-n">Integer</span><span class="tok-p">,</span> <span class="tok-n">nullable</span><span class="tok-o">=</span><span class="tok-bp">False</span><span class="tok-p">),</span>
    <span class="tok-n">Column</span><span class="tok-p">(</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">,</span> <span class="tok-n">String</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">)),</span>
<span class="tok-p">)</span>

<span class="tok-o">...</span>

<span class="tok-k">def</span> <span class="tok-nf">start_mappers</span><span class="tok-p">():</span>
    <span class="tok-n">lines_mapper</span> <span class="tok-o">=</span> <span class="tok-n">mapper</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">,</span> <span class="tok-n">order_lines</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The ORM imports (or "depends on" or "knows about") the domain model, and
not the other way around.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We define our database tables and columns by using SQLAlchemy&#8217;s
abstractions.<sup class="footnote">[<a id="_footnoteref_13" class="footnote" href="#_footnotedef_13" title="View footnote.">13</a>]</sup></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When we call the <code>mapper</code> function, SQLAlchemy does its magic to bind
our domain model classes to the various tables we&#8217;ve defined.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The end result will be that, if we call <code>start_mappers</code>, we will be able to
easily load and save domain model instances from and to the database. But if
we never call that function, our domain model classes stay blissfully
unaware of the database.</p>
</div>
<div class="paragraph">
<p>This gives us all the benefits of SQLAlchemy, including the ability to use
<code>alembic</code> for migrations, and the ability to transparently query using our
domain classes, as we&#8217;ll see.</p>
</div>
<div class="paragraph">
<p>When you&#8217;re first trying to build your ORM config, it can be useful to write
tests for it, as in the following example:</p>
</div>
<div id="orm_tests" class="exampleblock">
<div class="title">Testing the ORM directly (throwaway tests) (test_orm.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_orderline_mapper_can_load_lines</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span>
        <span class="tok-s1">&#39;INSERT INTO order_lines (orderid, sku, qty) VALUES &#39;</span>
        <span class="tok-s1">&#39;(&quot;order1&quot;, &quot;RED-CHAIR&quot;, 12),&#39;</span>
        <span class="tok-s1">&#39;(&quot;order1&quot;, &quot;RED-TABLE&quot;, 13),&#39;</span>
        <span class="tok-s1">&#39;(&quot;order2&quot;, &quot;BLUE-LIPSTICK&quot;, 14)&#39;</span>
    <span class="tok-p">)</span>
    <span class="tok-n">expected</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
        <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s2">&quot;order1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;RED-CHAIR&quot;</span><span class="tok-p">,</span> <span class="tok-mi">12</span><span class="tok-p">),</span>
        <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s2">&quot;order1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;RED-TABLE&quot;</span><span class="tok-p">,</span> <span class="tok-mi">13</span><span class="tok-p">),</span>
        <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s2">&quot;order2&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;BLUE-LIPSTICK&quot;</span><span class="tok-p">,</span> <span class="tok-mi">14</span><span class="tok-p">),</span>
    <span class="tok-p">]</span>
    <span class="tok-k">assert</span> <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">query</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()</span> <span class="tok-o">==</span> <span class="tok-n">expected</span>


<span class="tok-k">def</span> <span class="tok-nf">test_orderline_mapper_can_save_lines</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">):</span>
    <span class="tok-n">new_line</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s2">&quot;order1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;DECORATIVE-WIDGET&quot;</span><span class="tok-p">,</span> <span class="tok-mi">12</span><span class="tok-p">)</span>
    <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">new_line</span><span class="tok-p">)</span>
    <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>

    <span class="tok-n">rows</span> <span class="tok-o">=</span> <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span><span class="tok-s1">&#39;SELECT orderid, sku, qty FROM &quot;order_lines&quot;&#39;</span><span class="tok-p">))</span>
    <span class="tok-k">assert</span> <span class="tok-n">rows</span> <span class="tok-o">==</span> <span class="tok-p">[(</span><span class="tok-s2">&quot;order1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;DECORATIVE-WIDGET&quot;</span><span class="tok-p">,</span> <span class="tok-mi">12</span><span class="tok-p">)]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If you haven&#8217;t used pytest, the <code>session</code> argument to this test needs
explaining. You don&#8217;t need to worry about the details of pytest or its
fixtures for the purposes of this book, but the short explanation is that
you can define common dependencies for your tests as "fixtures," and
pytest will inject them to the tests that need them by looking at their
function arguments. In this case, it&#8217;s a SQLAlchemy database session.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You probably wouldn&#8217;t keep these tests around&#8212;&#8203;as you&#8217;ll see shortly, once
you&#8217;ve taken the step of inverting the dependency of ORM and domain model, it&#8217;s
only a small additional step to implement another abstraction called the
Repository pattern, which will be easier to write tests against and will
provide a simple interface for faking out later in tests.</p>
</div>
<div class="paragraph">
<p>But we&#8217;ve already achieved our objective of inverting the traditional
dependency: the domain model stays "pure" and free from infrastructure
concerns. We could throw away SQLAlchemy and use a different ORM, or a totally
different persistence system, and the domain model doesn&#8217;t need to change at
all.</p>
</div>
<div class="paragraph">
<p>Depending on what you&#8217;re doing in your domain model, and especially if you
stray far from the OO paradigm, you may find it increasingly hard to get the
ORM to produce the exact behavior you need, and you may need to modify your
domain model.<sup class="footnote">[<a id="_footnoteref_14" class="footnote" href="#_footnotedef_14" title="View footnote.">14</a>]</sup> As so often happens with
architectural decisions, you&#8217;ll need to consider a trade-off. As the
Zen of Python says, "Practicality beats purity!"</p>
</div>
<div class="paragraph">
<p>At this point, though, our API endpoint might look something like
the following, and we could get it to work just fine:</p>
</div>
<div id="api_endpoint_with_session" class="exampleblock">
<div class="title">Using SQLAlchemy directly in our API endpoint</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@flask.route.gubbins</span>
<span class="tok-k">def</span> <span class="tok-nf">allocate_endpoint</span><span class="tok-p">():</span>
    <span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-n">start_session</span><span class="tok-p">()</span>

    <span class="tok-c1"># extract order line from request</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span>
        <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">],</span>
        <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">],</span>
        <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">],</span>
    <span class="tok-p">)</span>

    <span class="tok-c1"># load all batches from the DB</span>
    <span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">query</span><span class="tok-p">(</span><span class="tok-n">Batch</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()</span>

    <span class="tok-c1"># call our domain service</span>
    <span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">)</span>

    <span class="tok-c1"># save the allocation back to the database</span>
    <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>

    <span class="tok-k">return</span> <span class="tok-mi">201</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_introducing_the_repository_pattern">2.5. Introducing the Repository Pattern</h3>
<div class="paragraph">
<p>The <em>Repository</em> pattern is an abstraction over persistent storage. It hides the
boring details of data access by pretending that all of our data is in memory.</p>
</div>
<div class="paragraph">
<p>If we had infinite memory in our laptops, we&#8217;d have no need for clumsy databases.
Instead, we could just use our objects whenever we liked. What would that look
like?</p>
</div>
<div id="all_my_data" class="exampleblock">
<div class="title">You have to get your data from somewhere</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">import</span> <span class="tok-nn">all_my_data</span>

<span class="tok-k">def</span> <span class="tok-nf">create_a_batch</span><span class="tok-p">():</span>
    <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-o">...</span><span class="tok-p">)</span>
    <span class="tok-n">all_my_data</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">batch</span><span class="tok-p">)</span>

<span class="tok-k">def</span> <span class="tok-nf">modify_a_batch</span><span class="tok-p">(</span><span class="tok-n">batch_id</span><span class="tok-p">,</span> <span class="tok-n">new_quantity</span><span class="tok-p">):</span>
    <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">all_my_data</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">batch_id</span><span class="tok-p">)</span>
    <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">change_initial_quantity</span><span class="tok-p">(</span><span class="tok-n">new_quantity</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Even though our objects are in memory, we need to put them <em>somewhere</em> so we can
find them again. Our in-memory data would let us add new objects, just like a
list or a set. Because the objects are in memory, we never need to call a
<code>.save()</code> method; we just fetch the object we care about and modify it in memory.</p>
</div>
<div class="sect3">
<h4 id="_the_repository_in_the_abstract">2.5.1. The Repository in the Abstract</h4>
<div class="paragraph">
<p>The simplest repository has just two methods: <code>add()</code> to put a new item in the
repository, and <code>get()</code> to return a previously added item.<sup class="footnote">[<a id="_footnoteref_15" class="footnote" href="#_footnotedef_15" title="View footnote.">15</a>]</sup>
We stick rigidly to using these methods for data access in our domain and our
service layer. This self-imposed simplicity stops us from coupling our domain
model to the database.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s what an abstract base class (ABC) for our repository would look like:</p>
</div>
<div id="abstract_repo" class="exampleblock">
<div class="title">The simplest possible repository (repository.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">AbstractRepository</span><span class="tok-p">(</span><span class="tok-n">abc</span><span class="tok-o">.</span><span class="tok-n">ABC</span><span class="tok-p">):</span>

    <span class="tok-nd">@abc.abstractmethod</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">def</span> <span class="tok-nf">add</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">batch</span><span class="tok-p">:</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">):</span>
        <span class="tok-k">raise</span> <span class="tok-ne">NotImplementedError</span>  <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-nd">@abc.abstractmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">reference</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">:</span>
        <span class="tok-k">raise</span> <span class="tok-ne">NotImplementedError</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Python tip: <code>@abc.abstractmethod</code> is one of the only things that makes
    ABCs actually "work" in Python. Python will refuse to let you instantiate
    a class that does not implement all the <code>abstractmethods</code> defined in its
    parent class.<sup class="footnote">[<a id="_footnoteref_16" class="footnote" href="#_footnotedef_16" title="View footnote.">16</a>]</sup></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>raise NotImplementedError</code> is nice, but it&#8217;s neither necessary nor sufficient. In fact, your abstract methods can have real behavior that subclasses
can call out to, if you really want.</td>
</tr>
</table>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Abstract Base Classes, Duck Typing, and Protocols</div>
<div class="paragraph">
<p>We&#8217;re using abstract base classes in this book for didactic reasons: we hope
they help explain what the interface of the repository abstraction is.</p>
</div>
<div class="paragraph">
<p>In real life, we&#8217;ve sometimes found ourselves deleting ABCs from our production
code, because Python makes it too easy to ignore them, and they end up
unmaintained and, at worst, misleading. In practice we often just rely on
Python&#8217;s duck typing to enable abstractions. To a Pythonista, a repository is
<em>any</em> object that has <code>add(<em>thing</em>)</code> and <code>get(<em>id</em>)</code> methods.</p>
</div>
<div class="paragraph">
<p>An alternative to look into is <a href="https://oreil.ly/q9EPC">PEP
544 protocols</a>. These give you typing without the possibility of inheritance,
which "prefer composition over inheritance" fans will particularly like.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_what_is_the_trade_off">2.5.2. What Is the Trade-Off?</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>You know they say economists know the price of everything and the value of
nothing?  Well, programmers know the benefits of everything and the trade-offs
of nothing.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Rich Hickey
</div>
</div>
<div class="paragraph">
<p>Whenever we introduce an architectural pattern in this book, we&#8217;ll always
ask, "What do we get for this?  And what does it cost us?"</p>
</div>
<div class="paragraph">
<p>Usually, at the very least, we&#8217;ll be introducing an extra layer of abstraction,
and although we may hope it will reduce complexity overall, it does add
complexity locally, and it has a cost in terms of the raw numbers of moving parts and
ongoing maintenance.</p>
</div>
<div class="paragraph">
<p>The Repository pattern is probably one of the easiest choices in the book, though,
if you&#8217;re already heading down the DDD and dependency inversion route.  As far
as our code is concerned, we&#8217;re really just swapping the SQLAlchemy abstraction
(<code>session.query(Batch)</code>) for a different one (<code>batches_repo.get</code>) that we
designed.</p>
</div>
<div class="paragraph">
<p>We will have to write a few lines of code in our repository class each time we
add a new domain object that we want to retrieve, but in return we get a
simple abstraction over our storage layer, which we control. The Repository pattern would make
it easy to make fundamental changes to the way we store things (see
<a href="#appendix_csvs">Swapping Out the Infrastructure: <span class="keep-together">Do Everything with CSVs</span></a>), and as we&#8217;ll see, it is easy to fake out for unit tests.</p>
</div>
<div class="paragraph">
<p>In addition, the Repository pattern is so common in the DDD world that, if you
do collaborate with programmers who have come to Python from the Java and C#
worlds, they&#8217;re likely to recognize it. <a href="#repository_pattern_diagram">Repository pattern</a> illustrates the pattern.</p>
</div>
<div id="repository_pattern_diagram" class="imageblock width-60">
<div class="content">
<img src="images/apwp_0205.png" alt="apwp 0205">
</div>
<div class="title">Figure 12. Repository pattern</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[ditaa, apwp_0205]
  +-----------------------------+
  |      Application Layer      |
  +-----------------------------+
                 |^
                 ||          /------------------\
                 ||----------|   Domain Model   |
                 ||          |      Objects     |
                 ||          \------------------/
                 V|
  +------------------------------+
  |          Repository          |
  +------------------------------+
                 |
                 V
  +------------------------------+
  |        Database Layer        |
  +------------------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>As always, we start with a test. This would probably be classified as an
integration test, since we&#8217;re checking that our code (the repository) is
correctly integrated with the database; hence, the tests tend to mix
raw SQL with calls and assertions on our own code.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Unlike the ORM tests from earlier, these tests are good candidates for
    staying part of your codebase longer term, particularly if any parts of
    your domain model mean the object-relational map is nontrivial.
</td>
</tr>
</table>
</div>
<div id="repo_test_save" class="exampleblock">
<div class="title">Repository test for saving an object (test_repository.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_repository_can_save_a_batch</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">):</span>
    <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;RUSTY-SOAPDISH&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">)</span>

    <span class="tok-n">repo</span> <span class="tok-o">=</span> <span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyRepository</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">)</span>
    <span class="tok-n">repo</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">batch</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>  <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-n">rows</span> <span class="tok-o">=</span> <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span>
        <span class="tok-s1">&#39;SELECT reference, sku, _purchased_quantity, eta FROM &quot;batches&quot;&#39;</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-p">))</span>
    <span class="tok-k">assert</span> <span class="tok-n">rows</span> <span class="tok-o">==</span> <span class="tok-p">[(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;RUSTY-SOAPDISH&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">)]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>repo.add()</code> is the method under test here.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We keep the <code>.commit()</code> outside of the repository and make
it the responsibility of the caller. There are pros and cons for
this; some of our reasons will become clearer when we get to
<a href="#chapter_06_uow">Unit of Work Pattern</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We use the raw SQL to verify that the right data has been saved.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next test involves retrieving batches and allocations, so it&#8217;s more
complex:</p>
</div>
<div id="repo_test_retrieve" class="exampleblock">
<div class="title">Repository test for retrieving a complex object (test_repository.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">insert_order_line</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">):</span>
    <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-s1">&#39;INSERT INTO order_lines (orderid, sku, qty)&#39;</span>
        <span class="tok-s1">&#39; VALUES (&quot;order1&quot;, &quot;GENERIC-SOFA&quot;, 12)&#39;</span>
    <span class="tok-p">)</span>
    <span class="tok-p">[[</span><span class="tok-n">orderline_id</span><span class="tok-p">]]</span> <span class="tok-o">=</span> <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span>
        <span class="tok-s1">&#39;SELECT id FROM order_lines WHERE orderid=:orderid AND sku=:sku&#39;</span><span class="tok-p">,</span>
        <span class="tok-nb">dict</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-o">=</span><span class="tok-s2">&quot;order1&quot;</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-s2">&quot;GENERIC-SOFA&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">orderline_id</span>

<span class="tok-k">def</span> <span class="tok-nf">insert_batch</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">,</span> <span class="tok-n">batch_id</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-o">...</span>

<span class="tok-k">def</span> <span class="tok-nf">test_repository_can_retrieve_a_batch_with_allocations</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">):</span>
    <span class="tok-n">orderline_id</span> <span class="tok-o">=</span> <span class="tok-n">insert_order_line</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">)</span>
    <span class="tok-n">batch1_id</span> <span class="tok-o">=</span> <span class="tok-n">insert_batch</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">,</span> <span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">insert_batch</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">,</span> <span class="tok-s2">&quot;batch2&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">insert_allocation</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">,</span> <span class="tok-n">orderline_id</span><span class="tok-p">,</span> <span class="tok-n">batch1_id</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="tok-n">repo</span> <span class="tok-o">=</span> <span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyRepository</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">)</span>
    <span class="tok-n">retrieved</span> <span class="tok-o">=</span> <span class="tok-n">repo</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">)</span>

    <span class="tok-n">expected</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;GENERIC-SOFA&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">retrieved</span> <span class="tok-o">==</span> <span class="tok-n">expected</span>  <span class="tok-c1"># Batch.__eq__ only compares reference  </span><i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-k">assert</span> <span class="tok-n">retrieved</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">==</span> <span class="tok-n">expected</span><span class="tok-o">.</span><span class="tok-n">sku</span>  <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-k">assert</span> <span class="tok-n">retrieved</span><span class="tok-o">.</span><span class="tok-n">_purchased_quantity</span> <span class="tok-o">==</span> <span class="tok-n">expected</span><span class="tok-o">.</span><span class="tok-n">_purchased_quantity</span>
    <span class="tok-k">assert</span> <span class="tok-n">retrieved</span><span class="tok-o">.</span><span class="tok-n">_allocations</span> <span class="tok-o">==</span> <span class="tok-p">{</span>  <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s2">&quot;order1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;GENERIC-SOFA&quot;</span><span class="tok-p">,</span> <span class="tok-mi">12</span><span class="tok-p">),</span>
    <span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This tests the read side, so the raw SQL is preparing data to be read
by the <code>repo.get()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We&#8217;ll spare you the details of <code>insert_batch</code> and <code>insert_allocation</code>;
the point is to create a couple of batches, and, for the
batch we&#8217;re interested in, to have one existing order line allocated to it.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>And that&#8217;s what we verify here. The first <code>assert ==</code> checks that the
types match, and that the reference is the same (because, as you remember,
<code>Batch</code> is an entity, and we have a custom __eq__ for it).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>So we also explicitly check on its major attributes, including
<code>._allocations</code>, which is a Python set of <code>OrderLine</code> value objects.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Whether or not you painstakingly write tests for every model is a judgment
call. Once you have one class tested for create/modify/save, you might be
happy to go on and do the others with a minimal round-trip test, or even nothing
at all, if they all follow a similar pattern. In our case, the ORM config
that sets up the <code>._allocations</code> set is a little complex, so it merited a
specific test.</p>
</div>
<div class="paragraph">
<p>You end up with something like this:</p>
</div>
<div id="batch_repository" class="exampleblock">
<div class="title">A typical repository (repository.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">SqlAlchemyRepository</span><span class="tok-p">(</span><span class="tok-n">AbstractRepository</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">session</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-n">session</span>

    <span class="tok-k">def</span> <span class="tok-nf">add</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">batch</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">batch</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">reference</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">query</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">filter_by</span><span class="tok-p">(</span><span class="tok-n">reference</span><span class="tok-o">=</span><span class="tok-n">reference</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">one</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-nf">list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">query</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And now our Flask endpoint might look something like the following:</p>
</div>
<div id="api_endpoint_with_repo" class="exampleblock">
<div class="title">Using our repository directly in our API endpoint</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@flask.route.gubbins</span>
<span class="tok-k">def</span> <span class="tok-nf">allocate_endpoint</span><span class="tok-p">():</span>
    <span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">SqlAlchemyRepository</span><span class="tok-o">.</span><span class="tok-n">list</span><span class="tok-p">()</span>
    <span class="tok-n">lines</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
        <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">l</span><span class="tok-p">[</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">],</span> <span class="tok-n">l</span><span class="tok-p">[</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">],</span> <span class="tok-n">l</span><span class="tok-p">[</span><span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">])</span>
         <span class="tok-k">for</span> <span class="tok-n">l</span> <span class="tok-ow">in</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">params</span><span class="tok-o">...</span>
    <span class="tok-p">]</span>
    <span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">lines</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">)</span>
    <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>
    <span class="tok-k">return</span> <span class="tok-mi">201</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Exercise for the Reader</div>
<div class="paragraph">
<p>We bumped into a friend at a DDD conference the other day who said, "I haven&#8217;t
used an ORM in 10 years." The Repository pattern and an ORM both act as abstractions
in front of raw SQL, so using one behind the other isn&#8217;t really necessary.  Why
not have a go at implementing our repository without using the ORM? You&#8217;ll find the code <a href="https://github.com/cosmicpython/code/tree/chapter_02_repository_exercise">on GitHub</a>.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve left the repository tests, but figuring out what SQL to write is up
to you. Perhaps it&#8217;ll be harder than you think; perhaps it&#8217;ll be easier.
But the nice thing is, the rest of your application just doesn&#8217;t care.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_a_fake_repository_for_tests_is_now_trivial">2.6. Building a Fake Repository for Tests Is Now Trivial!</h3>
<div class="paragraph">
<p>Here&#8217;s one of the biggest benefits of the Repository pattern:</p>
</div>
<div id="fake_repository" class="exampleblock">
<div class="title">A simple fake repository using a set (repository.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">FakeRepository</span><span class="tok-p">(</span><span class="tok-n">AbstractRepository</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_batches</span> <span class="tok-o">=</span> <span class="tok-nb">set</span><span class="tok-p">(</span><span class="tok-n">batches</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">add</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">batch</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_batches</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">batch</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">reference</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-nb">next</span><span class="tok-p">(</span><span class="tok-n">b</span> <span class="tok-k">for</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_batches</span> <span class="tok-k">if</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">reference</span> <span class="tok-o">==</span> <span class="tok-n">reference</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_batches</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Because it&#8217;s a simple wrapper around a <code>set</code>, all the methods are one-liners.</p>
</div>
<div class="paragraph">
<p>Using a fake repo in tests is really easy, and we have a simple
abstraction that&#8217;s easy to use and reason about:</p>
</div>
<div id="fake_repository_example" class="exampleblock">
<div class="title">Example usage of fake repository (test_api.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">fake_repo</span> <span class="tok-o">=</span> <span class="tok-n">FakeRepository</span><span class="tok-p">([</span><span class="tok-n">batch1</span><span class="tok-p">,</span> <span class="tok-n">batch2</span><span class="tok-p">,</span> <span class="tok-n">batch3</span><span class="tok-p">])</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll see this fake in action in the next chapter.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Building fakes for your abstractions is an excellent way to get design
    feedback: if it&#8217;s hard to fake, the abstraction is probably too
    complicated.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="what_is_a_port_and_what_is_an_adapter">2.7. What Is a Port and What Is an Adapter, in Python?</h3>
<div class="paragraph">
<p>We don&#8217;t want to dwell on the terminology too much here because the main thing
we want to focus on is dependency inversion, and the specifics of the
technique you use don&#8217;t matter too much. Also, we&#8217;re aware that different
people use slightly different definitions.</p>
</div>
<div class="paragraph">
<p>Ports and adapters came out of the OO world, and the definition we hold onto
is that the <em>port</em> is the <em>interface</em> between our application and whatever
it is we wish to abstract away, and the <em>adapter</em> is the <em>implementation</em>
behind that interface or abstraction.</p>
</div>
<div class="paragraph">
<p>Now Python doesn&#8217;t have interfaces per se, so although it&#8217;s
usually easy to identify an adapter, defining the port can be harder. If
you&#8217;re using an abstract base class, that&#8217;s the port. If not, the port
is just the duck type that your adapters conform to and that your core application
expects—the function and method names in use, and their argument names and types.</p>
</div>
<div class="paragraph">
<p>Concretely, in this chapter, <code>AbstractRepository</code> is the port, and
<code>SqlAlchemyRepository</code> and <code>FakeRepository</code> are the adapters.</p>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up">2.8. Wrap-Up</h3>
<div class="paragraph">
<p>Bearing the Rich Hickey quote in mind, in each chapter we
summarize the costs and benefits of each architectural pattern we introduce.
We want to be clear that we&#8217;re not saying every single application needs
to be built this way; only sometimes does the complexity of the app and domain
make it worth investing the time and effort in adding these extra layers of
indirection.</p>
</div>
<div class="paragraph">
<p>With that in mind, <a href="#chapter_02_repository_tradeoffs">Repository pattern and persistence ignorance: the trade-offs</a> shows
some of the pros and cons of the Repository pattern and our persistence-ignorant
model.</p>
</div>
<table id="chapter_02_repository_tradeoffs" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Repository pattern and persistence ignorance: the trade-offs</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pros</th>
<th class="tableblock halign-left valign-top">Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>We have a simple interface between persistent storage and our domain model.</p>
</li>
<li>
<p>It&#8217;s easy to make a fake version of the repository for unit testing, or to
swap out different storage solutions, because we&#8217;ve fully decoupled the model
from infrastructure concerns.</p>
</li>
<li>
<p>Writing the domain model before thinking about persistence helps us focus on
the business problem at hand. If we ever want to radically change our approach,
we can do that in our model, without needing to worry about foreign keys
or migrations until later.</p>
</li>
<li>
<p>Our database schema is really simple because we have complete control over
how we map our objects to tables.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>An ORM already buys you some decoupling. Changing foreign keys might be hard,
but it should be pretty easy to swap between MySQL and Postgres if you
ever need to.</p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p>Maintaining ORM mappings by hand requires extra work and extra code.</p>
</li>
<li>
<p>Any extra layer of indirection always increases maintenance costs and
adds a "WTF factor" for Python programmers who&#8217;ve never seen the Repository pattern
before.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="#domain_model_tradeoffs_diagram">Domain model trade-offs as a diagram</a> shows the basic thesis: yes, for simple
cases, a decoupled domain model is harder work than a simple ORM/ActiveRecord
pattern.<sup class="footnote">[<a id="_footnoteref_17" class="footnote" href="#_footnotedef_17" title="View footnote.">17</a>]</sup></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If your app is just a simple CRUD (create-read-update-delete) wrapper
    around a database, then you don&#8217;t need a domain model or a repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>But the more complex the domain, the more an investment in freeing
yourself from infrastructure concerns will pay off in terms of the ease of
making changes.</p>
</div>
<div id="domain_model_tradeoffs_diagram" class="imageblock">
<div class="content">
<img src="images/apwp_0206.png" alt="apwp 0206">
</div>
<div class="title">Figure 13. Domain model trade-offs as a diagram</div>
</div>
<div class="paragraph">
<p>Our example code isn&#8217;t complex enough to give more than a hint of what
the right-hand side of the graph looks like, but the hints are there.
Imagine, for example, if we decide one day that we want to change allocations
to live on the <code>OrderLine</code> instead of on the <code>Batch</code> object: if we were using
Django, say, we&#8217;d have to define and think through the database migration
before we could run any tests. As it is, because our model is just plain
old Python objects, we can change a <code>set()</code> to being a new attribute, without
needing to think about the database until later.</p>
</div>
<div class="sidebarblock nobreakinside">
<div class="content">
<div class="title">Repository Pattern Recap</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Apply dependency inversion to your ORM</dt>
<dd>
<p>Our domain model should be free of infrastructure concerns,
so your ORM should import your model, and not the other way
around.</p>
</dd>
<dt class="hdlist1">The Repository pattern is a simple abstraction around permanent storage</dt>
<dd>
<p>The repository gives you the illusion of a collection of in-memory
objects. It makes it easy to create a <code>FakeRepository</code> for
testing and to swap fundamental details of your
infrastructure without disrupting your core application. See
<a href="#appendix_csvs">Swapping Out the Infrastructure: <span class="keep-together">Do Everything with CSVs</span></a> for an example.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll be wondering, how do we instantiate these repositories, fake or
real? What will our Flask app actually look like? You&#8217;ll find out in the next
exciting installment, <a href="#chapter_04_service_layer">the Service Layer pattern</a>.</p>
</div>
<div class="paragraph">
<p>But first, a brief digression.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_03_abstractions">3. A Brief Interlude: On Coupling <span class="keep-together">and Abstractions</span></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Allow us a brief digression on the subject of abstractions, dear reader.
We&#8217;ve talked about <em>abstractions</em> quite a lot. The Repository pattern is an
abstraction over permanent storage, for example. But what makes a good
abstraction?  What do we want from abstractions?  And how do they relate to testing?</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The code for this chapter is in the
chapter_03_abstractions branch <a href="https://oreil.ly/k6MmV">on GitHub</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/cosmicpython/code.git
git checkout chapter_03_abstractions</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A key theme in this book, hidden among the fancy patterns, is that we can use
simple abstractions to hide messy details. When we&#8217;re writing code for fun, or
in a kata,<sup class="footnote">[<a id="_footnoteref_18" class="footnote" href="#_footnotedef_18" title="View footnote.">18</a>]</sup>
we get to play with ideas freely, hammering things out and refactoring
aggressively. In a large-scale system, though, we become constrained by the
decisions made elsewhere in the system.</p>
</div>
<div class="paragraph">
<p>When we&#8217;re unable to change component A for fear of breaking component B, we say
that the components have become <em>coupled</em>. Locally, coupling is a good thing: it&#8217;s
a sign that our code is working together, each component supporting the others, all of them
fitting in place like the gears of a watch. In jargon, we say this works when
there is high <em>cohesion</em> between the coupled elements.</p>
</div>
<div class="paragraph">
<p>Globally, coupling is a nuisance: it increases the risk and the cost of changing
our code, sometimes to the point where we feel unable to make any changes at
all. This is the problem with the Ball of Mud pattern: as the application grows,
if we&#8217;re unable to prevent coupling between elements that have no cohesion, that
coupling increases superlinearly until we are no longer able to effectively
change our systems.</p>
</div>
<div class="paragraph">
<p>We can reduce the degree of coupling within a system
(<a href="#coupling_illustration1">Lots of coupling</a>) by abstracting away the details
(<a href="#coupling_illustration2">Less coupling</a>).</p>
</div>
<div id="coupling_illustration1" class="imageblock width-50">
<div class="content">
<img src="images/apwp_0301.png" alt="apwp 0301">
</div>
<div class="title">Figure 14. Lots of coupling</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[ditaa, apwp_0301]
+--------+      +--------+
| System | ---&gt; | System |
|   A    | ---&gt; |   B    |
|        | ---&gt; |        |
|        | ---&gt; |        |
|        | ---&gt; |        |
+--------+      +--------+</pre>
</div>
</div>
<div id="coupling_illustration2" class="imageblock width-90">
<div class="content">
<img src="images/apwp_0302.png" alt="apwp 0302">
</div>
<div class="title">Figure 15. Less coupling</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[ditaa, apwp_0302]
+--------+                           +--------+
| System |      /-------------\      | System |
|   A    | ---&gt; |             | ---&gt; |   B    |
|        | ---&gt; | Abstraction | ---&gt; |        |
|        |      |             | ---&gt; |        |
|        |      \-------------/      |        |
+--------+                           +--------+</pre>
</div>
</div>
<div class="paragraph">
<p>In both diagrams, we have a pair of subsystems, with one dependent on
the other. In <a href="#coupling_illustration1">Lots of coupling</a>, there is a high degree of coupling between the
two; the number of arrows indicates lots of kinds of dependencies
between the two. If we need to change system B, there&#8217;s a good chance that the
change will ripple through to system A.</p>
</div>
<div class="paragraph">
<p>In <a href="#coupling_illustration2">Less coupling</a>, though, we have reduced the degree of coupling by inserting a
new, simpler abstraction. Because it is simpler, system A has fewer
kinds of dependencies on the abstraction. The abstraction serves to
protect us from change by hiding away the complex details of whatever system B
does—we can change the arrows on the right without changing the ones on the left.</p>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_abstracting_state_aids_testability">3.1. Abstracting State Aids Testability</h3>
<div class="paragraph">
<p>Let&#8217;s see an example. Imagine we want to write code for synchronizing two
file directories, which we&#8217;ll call the <em>source</em> and the <em>destination</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If a file exists in the source but not in the destination, copy the file over.</p>
</li>
<li>
<p>If a file exists in the source, but it has a different name than in the destination,
rename the destination file to match.</p>
</li>
<li>
<p>If a file exists in the destination but not in the source, remove it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Our first and third requirements are simple enough: we can just compare two
lists of paths. Our second is trickier, though. To detect renames,
we&#8217;ll have to inspect the content of files. For this, we can use a hashing
function like MD5 or SHA-1. The code to generate a SHA-1 hash from a file is simple
enough:</p>
</div>
<div id="hash_file" class="exampleblock">
<div class="title">Hashing a file (sync.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">BLOCKSIZE</span> <span class="tok-o">=</span> <span class="tok-mi">65536</span>

<span class="tok-k">def</span> <span class="tok-nf">hash_file</span><span class="tok-p">(</span><span class="tok-n">path</span><span class="tok-p">):</span>
    <span class="tok-n">hasher</span> <span class="tok-o">=</span> <span class="tok-n">hashlib</span><span class="tok-o">.</span><span class="tok-n">sha1</span><span class="tok-p">()</span>
    <span class="tok-k">with</span> <span class="tok-n">path</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-s2">&quot;rb&quot;</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-nb">file</span><span class="tok-p">:</span>
        <span class="tok-n">buf</span> <span class="tok-o">=</span> <span class="tok-nb">file</span><span class="tok-o">.</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">BLOCKSIZE</span><span class="tok-p">)</span>
        <span class="tok-k">while</span> <span class="tok-n">buf</span><span class="tok-p">:</span>
            <span class="tok-n">hasher</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span><span class="tok-n">buf</span><span class="tok-p">)</span>
            <span class="tok-n">buf</span> <span class="tok-o">=</span> <span class="tok-nb">file</span><span class="tok-o">.</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">BLOCKSIZE</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">hasher</span><span class="tok-o">.</span><span class="tok-n">hexdigest</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we need to write the bit that makes decisions about what to do—the business
logic, if you will.</p>
</div>
<div class="paragraph">
<p>When we have to tackle a problem from first principles, we usually try to write
a simple implementation and then refactor toward better design. We&#8217;ll use
this approach throughout the book, because it&#8217;s how we write code in the real
world: start with a solution to the smallest part of the problem, and then
iteratively make the solution richer and better designed.</p>
</div>
<div class="paragraph">
<p>Our first hackish approach looks something like this:</p>
</div>
<div id="sync_first_cut" class="exampleblock">
<div class="title">Basic sync algorithm (sync.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">import</span> <span class="tok-nn">hashlib</span>
<span class="tok-kn">import</span> <span class="tok-nn">os</span>
<span class="tok-kn">import</span> <span class="tok-nn">shutil</span>
<span class="tok-kn">from</span> <span class="tok-nn">pathlib</span> <span class="tok-kn">import</span> <span class="tok-n">Path</span>

<span class="tok-k">def</span> <span class="tok-nf">sync</span><span class="tok-p">(</span><span class="tok-n">source</span><span class="tok-p">,</span> <span class="tok-n">dest</span><span class="tok-p">):</span>
    <span class="tok-c1"># Walk the source folder and build a dict of filenames and their hashes</span>
    <span class="tok-n">source_hashes</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>
    <span class="tok-k">for</span> <span class="tok-n">folder</span><span class="tok-p">,</span> <span class="tok-n">_</span><span class="tok-p">,</span> <span class="tok-n">files</span> <span class="tok-ow">in</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">walk</span><span class="tok-p">(</span><span class="tok-n">source</span><span class="tok-p">):</span>
        <span class="tok-k">for</span> <span class="tok-n">fn</span> <span class="tok-ow">in</span> <span class="tok-n">files</span><span class="tok-p">:</span>
            <span class="tok-n">source_hashes</span><span class="tok-p">[</span><span class="tok-n">hash_file</span><span class="tok-p">(</span><span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">folder</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-n">fn</span><span class="tok-p">)]</span> <span class="tok-o">=</span> <span class="tok-n">fn</span>

    <span class="tok-n">seen</span> <span class="tok-o">=</span> <span class="tok-nb">set</span><span class="tok-p">()</span>  <span class="tok-c1"># Keep track of the files we&#39;ve found in the target</span>

    <span class="tok-c1"># Walk the target folder and get the filenames and hashes</span>
    <span class="tok-k">for</span> <span class="tok-n">folder</span><span class="tok-p">,</span> <span class="tok-n">_</span><span class="tok-p">,</span> <span class="tok-n">files</span> <span class="tok-ow">in</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">walk</span><span class="tok-p">(</span><span class="tok-n">dest</span><span class="tok-p">):</span>
        <span class="tok-k">for</span> <span class="tok-n">fn</span> <span class="tok-ow">in</span> <span class="tok-n">files</span><span class="tok-p">:</span>
            <span class="tok-n">dest_path</span> <span class="tok-o">=</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">folder</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-n">fn</span>
            <span class="tok-n">dest_hash</span> <span class="tok-o">=</span> <span class="tok-n">hash_file</span><span class="tok-p">(</span><span class="tok-n">dest_path</span><span class="tok-p">)</span>
            <span class="tok-n">seen</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">dest_hash</span><span class="tok-p">)</span>

            <span class="tok-c1"># if there&#39;s a file in target that&#39;s not in source, delete it</span>
            <span class="tok-k">if</span> <span class="tok-n">dest_hash</span> <span class="tok-ow">not</span> <span class="tok-ow">in</span> <span class="tok-n">source_hashes</span><span class="tok-p">:</span>
                <span class="tok-n">dest_path</span><span class="tok-o">.</span><span class="tok-n">remove</span><span class="tok-p">()</span>

            <span class="tok-c1"># if there&#39;s a file in target that has a different path in source,</span>
            <span class="tok-c1"># move it to the correct path</span>
            <span class="tok-k">elif</span> <span class="tok-n">dest_hash</span> <span class="tok-ow">in</span> <span class="tok-n">source_hashes</span> <span class="tok-ow">and</span> <span class="tok-n">fn</span> <span class="tok-o">!=</span> <span class="tok-n">source_hashes</span><span class="tok-p">[</span><span class="tok-n">dest_hash</span><span class="tok-p">]:</span>
                <span class="tok-n">shutil</span><span class="tok-o">.</span><span class="tok-n">move</span><span class="tok-p">(</span><span class="tok-n">dest_path</span><span class="tok-p">,</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">folder</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-n">source_hashes</span><span class="tok-p">[</span><span class="tok-n">dest_hash</span><span class="tok-p">])</span>

    <span class="tok-c1"># for every file that appears in source but not target, copy the file to</span>
    <span class="tok-c1"># the target</span>
    <span class="tok-k">for</span> <span class="tok-n">src_hash</span><span class="tok-p">,</span> <span class="tok-n">fn</span> <span class="tok-ow">in</span> <span class="tok-n">source_hashes</span><span class="tok-o">.</span><span class="tok-n">items</span><span class="tok-p">():</span>
        <span class="tok-k">if</span> <span class="tok-n">src_hash</span> <span class="tok-ow">not</span> <span class="tok-ow">in</span> <span class="tok-n">seen</span><span class="tok-p">:</span>
            <span class="tok-n">shutil</span><span class="tok-o">.</span><span class="tok-n">copy</span><span class="tok-p">(</span><span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">source</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-n">fn</span><span class="tok-p">,</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">dest</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-n">fn</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Fantastic! We have some code and it <em>looks</em> OK, but before we run it on our
hard drive, maybe we should test it. How do we go about testing this sort of thing?</p>
</div>
<div id="ugly_sync_tests" class="exampleblock">
<div class="title">Some end-to-end tests (test_sync.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_when_a_file_exists_in_the_source_but_not_the_destination</span><span class="tok-p">():</span>
    <span class="tok-k">try</span><span class="tok-p">:</span>
        <span class="tok-n">source</span> <span class="tok-o">=</span> <span class="tok-n">tempfile</span><span class="tok-o">.</span><span class="tok-n">mkdtemp</span><span class="tok-p">()</span>
        <span class="tok-n">dest</span> <span class="tok-o">=</span> <span class="tok-n">tempfile</span><span class="tok-o">.</span><span class="tok-n">mkdtemp</span><span class="tok-p">()</span>

        <span class="tok-n">content</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;I am a very useful file&quot;</span>
        <span class="tok-p">(</span><span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">source</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-s1">&#39;my-file&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">write_text</span><span class="tok-p">(</span><span class="tok-n">content</span><span class="tok-p">)</span>

        <span class="tok-n">sync</span><span class="tok-p">(</span><span class="tok-n">source</span><span class="tok-p">,</span> <span class="tok-n">dest</span><span class="tok-p">)</span>

        <span class="tok-n">expected_path</span> <span class="tok-o">=</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">dest</span><span class="tok-p">)</span> <span class="tok-o">/</span>  <span class="tok-s1">&#39;my-file&#39;</span>
        <span class="tok-k">assert</span> <span class="tok-n">expected_path</span><span class="tok-o">.</span><span class="tok-n">exists</span><span class="tok-p">()</span>
        <span class="tok-k">assert</span> <span class="tok-n">expected_path</span><span class="tok-o">.</span><span class="tok-n">read_text</span><span class="tok-p">()</span> <span class="tok-o">==</span> <span class="tok-n">content</span>

    <span class="tok-k">finally</span><span class="tok-p">:</span>
        <span class="tok-n">shutil</span><span class="tok-o">.</span><span class="tok-n">rmtree</span><span class="tok-p">(</span><span class="tok-n">source</span><span class="tok-p">)</span>
        <span class="tok-n">shutil</span><span class="tok-o">.</span><span class="tok-n">rmtree</span><span class="tok-p">(</span><span class="tok-n">dest</span><span class="tok-p">)</span>


<span class="tok-k">def</span> <span class="tok-nf">test_when_a_file_has_been_renamed_in_the_source</span><span class="tok-p">():</span>
    <span class="tok-k">try</span><span class="tok-p">:</span>
        <span class="tok-n">source</span> <span class="tok-o">=</span> <span class="tok-n">tempfile</span><span class="tok-o">.</span><span class="tok-n">mkdtemp</span><span class="tok-p">()</span>
        <span class="tok-n">dest</span> <span class="tok-o">=</span> <span class="tok-n">tempfile</span><span class="tok-o">.</span><span class="tok-n">mkdtemp</span><span class="tok-p">()</span>

        <span class="tok-n">content</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;I am a file that was renamed&quot;</span>
        <span class="tok-n">source_path</span> <span class="tok-o">=</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">source</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-s1">&#39;source-filename&#39;</span>
        <span class="tok-n">old_dest_path</span> <span class="tok-o">=</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">dest</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-s1">&#39;dest-filename&#39;</span>
        <span class="tok-n">expected_dest_path</span> <span class="tok-o">=</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">dest</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-s1">&#39;source-filename&#39;</span>
        <span class="tok-n">source_path</span><span class="tok-o">.</span><span class="tok-n">write_text</span><span class="tok-p">(</span><span class="tok-n">content</span><span class="tok-p">)</span>
        <span class="tok-n">old_dest_path</span><span class="tok-o">.</span><span class="tok-n">write_text</span><span class="tok-p">(</span><span class="tok-n">content</span><span class="tok-p">)</span>

        <span class="tok-n">sync</span><span class="tok-p">(</span><span class="tok-n">source</span><span class="tok-p">,</span> <span class="tok-n">dest</span><span class="tok-p">)</span>

        <span class="tok-k">assert</span> <span class="tok-n">old_dest_path</span><span class="tok-o">.</span><span class="tok-n">exists</span><span class="tok-p">()</span> <span class="tok-ow">is</span> <span class="tok-bp">False</span>
        <span class="tok-k">assert</span> <span class="tok-n">expected_dest_path</span><span class="tok-o">.</span><span class="tok-n">read_text</span><span class="tok-p">()</span> <span class="tok-o">==</span> <span class="tok-n">content</span>


    <span class="tok-k">finally</span><span class="tok-p">:</span>
        <span class="tok-n">shutil</span><span class="tok-o">.</span><span class="tok-n">rmtree</span><span class="tok-p">(</span><span class="tok-n">source</span><span class="tok-p">)</span>
        <span class="tok-n">shutil</span><span class="tok-o">.</span><span class="tok-n">rmtree</span><span class="tok-p">(</span><span class="tok-n">dest</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Wowsers, that&#8217;s a lot of setup for two simple cases! The problem is that
our domain logic, "figure out the difference between two directories," is tightly
coupled to the I/O code. We can&#8217;t run our difference algorithm without calling
the <code>pathlib</code>, <code>shutil</code>, and <code>hashlib</code> modules.</p>
</div>
<div class="paragraph">
<p>And the trouble is, even with our current requirements, we haven&#8217;t written
enough tests: the current implementation has several bugs (the
<code>shutil.move()</code> is wrong, for example).  Getting decent coverage and revealing
these bugs means writing more tests, but if they&#8217;re all as unwieldy as the preceding
ones, that&#8217;s going to get real painful real quickly.</p>
</div>
<div class="paragraph">
<p>On top of that, our code isn&#8217;t very extensible. Imagine trying to implement
a <code>--dry-run</code> flag that gets our code to just print out what it&#8217;s going to
do, rather than actually do it.  Or what if we wanted to sync to a remote server,
or to cloud storage?</p>
</div>
<div class="paragraph">
<p>Our high-level code is coupled to low-level details, and it&#8217;s making life hard.
As the scenarios we consider get more complex, our tests will get more unwieldy.
We can definitely refactor these tests (some of the cleanup could go into pytest
fixtures, for example) but as long as we&#8217;re doing filesystem operations, they&#8217;re
going to stay slow and be hard to read and write.</p>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_choosing_the_right_abstractions">3.2. Choosing the Right Abstraction(s)</h3>
<div class="paragraph">
<p>What could we do to rewrite our code to make it more testable?</p>
</div>
<div class="paragraph">
<p>First, we need to think about what our code needs from the filesystem.
Reading through the code, we can see that three distinct things are happening.
We can think of these as three distinct <em>responsibilities</em> that the code has:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We interrogate the filesystem by using <code>os.walk</code> and determine hashes for a
series of paths. This is similar in both the source and the
destination cases.</p>
</li>
<li>
<p>We decide whether a file is new, renamed, or redundant.</p>
</li>
<li>
<p>We copy, move, or delete files to match the source.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Remember that we want to find <em>simplifying abstractions</em> for each of these
responsibilities. That will let us hide the messy details so we can
focus on the interesting logic.<sup class="footnote">[<a id="_footnoteref_19" class="footnote" href="#_footnotedef_19" title="View footnote.">19</a>]</sup></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this chapter, we&#8217;re refactoring some gnarly code into a more testable
    structure by identifying the separate tasks that need to be done and giving
    each task to a clearly defined actor, along similar lines to <a href="#ddg_example">the <code>duckduckgo</code>
    example</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For steps 1 and 2, we&#8217;ve already intuitively started using an abstraction, a
dictionary of hashes to paths. You may already have been thinking, "Why not build up a dictionary for the destination folder as well as the source, and
then we just compare two dicts?" That seems like a nice way to abstract
the current state of the filesystem:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>source_files = {'hash1': 'path1', 'hash2': 'path2'}
dest_files = {'hash1': 'path1', 'hash2': 'pathX'}</pre>
</div>
</div>
<div class="paragraph">
<p>What about moving from step 2 to step 3?  How can we abstract out the
actual move/copy/delete filesystem interaction?</p>
</div>
<div class="paragraph">
<p>We&#8217;ll apply a trick here that we&#8217;ll employ on a grand scale later in
the book. We&#8217;re going to separate <em>what</em> we want to do from <em>how</em> to do it.
We&#8217;re going to make our program output a list of commands that look like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>("COPY", "sourcepath", "destpath"),
("MOVE", "old", "new"),</pre>
</div>
</div>
<div class="paragraph">
<p>Now we could write tests that just use two filesystem dicts as inputs, and we would
expect lists of tuples of strings representing actions as outputs.</p>
</div>
<div class="paragraph">
<p>Instead of saying, "Given this actual filesystem, when I run my function,
check what actions have happened," we say, "Given this <em>abstraction</em> of a filesystem,
what <em>abstraction</em> of filesystem actions will happen?"</p>
</div>
<div id="better_tests" class="exampleblock">
<div class="title">Simplified inputs and outputs in our tests (test_sync.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">test_when_a_file_exists_in_the_source_but_not_the_destination</span><span class="tok-p">():</span>
        <span class="tok-n">src_hashes</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s1">&#39;hash1&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;fn1&#39;</span><span class="tok-p">}</span>
        <span class="tok-n">dst_hashes</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>
        <span class="tok-n">expected_actions</span> <span class="tok-o">=</span> <span class="tok-p">[(</span><span class="tok-s1">&#39;COPY&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;/src/fn1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;/dst/fn1&#39;</span><span class="tok-p">)]</span>
        <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_when_a_file_has_been_renamed_in_the_source</span><span class="tok-p">():</span>
        <span class="tok-n">src_hashes</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s1">&#39;hash1&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;fn1&#39;</span><span class="tok-p">}</span>
        <span class="tok-n">dst_hashes</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s1">&#39;hash1&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;fn2&#39;</span><span class="tok-p">}</span>
        <span class="tok-n">expected_actions</span> <span class="tok-o">==</span> <span class="tok-p">[(</span><span class="tok-s1">&#39;MOVE&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;/dst/fn2&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;/dst/fn1&#39;</span><span class="tok-p">)]</span>
        <span class="tok-o">...</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_our_chosen_abstractions">3.3. Implementing Our Chosen Abstractions</h3>
<div class="paragraph">
<p>That&#8217;s all very well, but how do we <em>actually</em> write those new
tests, and how do we change our implementation to make it all work?</p>
</div>
<div class="paragraph">
<p>Our goal is to isolate the clever part of our system, and to be able to test it
thoroughly without needing to set up a real filesystem. We&#8217;ll create a "core"
of code that has no dependencies on external state and then see how it responds
when we give it input from the outside world (this kind of approach was characterized
by Gary Bernhardt as
<a href="https://oreil.ly/wnad4">Functional
Core, Imperative Shell</a>, or FCIS).</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start off by splitting the code to separate the stateful parts from
the logic.</p>
</div>
<div class="paragraph">
<p>And our top-level function will contain almost no logic at all; it&#8217;s just an
imperative series of steps: gather inputs, call our logic, apply outputs:</p>
</div>
<div id="three_parts" class="exampleblock">
<div class="title">Split our code into three  (sync.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">sync</span><span class="tok-p">(</span><span class="tok-n">source</span><span class="tok-p">,</span> <span class="tok-n">dest</span><span class="tok-p">):</span>
    <span class="tok-c1"># imperative shell step 1, gather inputs</span>
    <span class="tok-n">source_hashes</span> <span class="tok-o">=</span> <span class="tok-n">read_paths_and_hashes</span><span class="tok-p">(</span><span class="tok-n">source</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">dest_hashes</span> <span class="tok-o">=</span> <span class="tok-n">read_paths_and_hashes</span><span class="tok-p">(</span><span class="tok-n">dest</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-c1"># step 2: call functional core</span>
    <span class="tok-n">actions</span> <span class="tok-o">=</span> <span class="tok-n">determine_actions</span><span class="tok-p">(</span><span class="tok-n">source_hashes</span><span class="tok-p">,</span> <span class="tok-n">dest_hashes</span><span class="tok-p">,</span> <span class="tok-n">source</span><span class="tok-p">,</span> <span class="tok-n">dest</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-c1"># imperative shell step 3, apply outputs</span>
    <span class="tok-k">for</span> <span class="tok-n">action</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">paths</span> <span class="tok-ow">in</span> <span class="tok-n">actions</span><span class="tok-p">:</span>
        <span class="tok-k">if</span> <span class="tok-n">action</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;copy&#39;</span><span class="tok-p">:</span>
            <span class="tok-n">shutil</span><span class="tok-o">.</span><span class="tok-n">copyfile</span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">paths</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-n">action</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;move&#39;</span><span class="tok-p">:</span>
            <span class="tok-n">shutil</span><span class="tok-o">.</span><span class="tok-n">move</span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">paths</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-n">action</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;delete&#39;</span><span class="tok-p">:</span>
            <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">remove</span><span class="tok-p">(</span><span class="tok-n">paths</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">])</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here&#8217;s the first function we factor out, <code>read_paths_and_hashes()</code>, which
isolates the I/O part of our application.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here is where carve out the functional core, the business logic.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The code to build up the dictionary of paths and hashes is now trivially easy
to write:</p>
</div>
<div id="read_paths_and_hashes" class="exampleblock">
<div class="title">A function that just does I/O (sync.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">read_paths_and_hashes</span><span class="tok-p">(</span><span class="tok-n">root</span><span class="tok-p">):</span>
    <span class="tok-n">hashes</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>
    <span class="tok-k">for</span> <span class="tok-n">folder</span><span class="tok-p">,</span> <span class="tok-n">_</span><span class="tok-p">,</span> <span class="tok-n">files</span> <span class="tok-ow">in</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">walk</span><span class="tok-p">(</span><span class="tok-n">root</span><span class="tok-p">):</span>
        <span class="tok-k">for</span> <span class="tok-n">fn</span> <span class="tok-ow">in</span> <span class="tok-n">files</span><span class="tok-p">:</span>
            <span class="tok-n">hashes</span><span class="tok-p">[</span><span class="tok-n">hash_file</span><span class="tok-p">(</span><span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">folder</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-n">fn</span><span class="tok-p">)]</span> <span class="tok-o">=</span> <span class="tok-n">fn</span>
    <span class="tok-k">return</span> <span class="tok-n">hashes</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>determine_actions()</code> function will be the core of our business logic,
which says, "Given these two sets of hashes and filenames, what should we
copy/move/delete?".  It takes simple data structures and returns simple data
structures:</p>
</div>
<div id="determine_actions" class="exampleblock">
<div class="title">A function that just does business logic (sync.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">determine_actions</span><span class="tok-p">(</span><span class="tok-n">src_hashes</span><span class="tok-p">,</span> <span class="tok-n">dst_hashes</span><span class="tok-p">,</span> <span class="tok-n">src_folder</span><span class="tok-p">,</span> <span class="tok-n">dst_folder</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">sha</span><span class="tok-p">,</span> <span class="tok-n">filename</span> <span class="tok-ow">in</span> <span class="tok-n">src_hashes</span><span class="tok-o">.</span><span class="tok-n">items</span><span class="tok-p">():</span>
        <span class="tok-k">if</span> <span class="tok-n">sha</span> <span class="tok-ow">not</span> <span class="tok-ow">in</span> <span class="tok-n">dst_hashes</span><span class="tok-p">:</span>
            <span class="tok-n">sourcepath</span> <span class="tok-o">=</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">src_folder</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-n">filename</span>
            <span class="tok-n">destpath</span> <span class="tok-o">=</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">dst_folder</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-n">filename</span>
            <span class="tok-k">yield</span> <span class="tok-s1">&#39;copy&#39;</span><span class="tok-p">,</span> <span class="tok-n">sourcepath</span><span class="tok-p">,</span> <span class="tok-n">destpath</span>

        <span class="tok-k">elif</span> <span class="tok-n">dst_hashes</span><span class="tok-p">[</span><span class="tok-n">sha</span><span class="tok-p">]</span> <span class="tok-o">!=</span> <span class="tok-n">filename</span><span class="tok-p">:</span>
            <span class="tok-n">olddestpath</span> <span class="tok-o">=</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">dst_folder</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-n">dst_hashes</span><span class="tok-p">[</span><span class="tok-n">sha</span><span class="tok-p">]</span>
            <span class="tok-n">newdestpath</span> <span class="tok-o">=</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">dst_folder</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-n">filename</span>
            <span class="tok-k">yield</span> <span class="tok-s1">&#39;move&#39;</span><span class="tok-p">,</span> <span class="tok-n">olddestpath</span><span class="tok-p">,</span> <span class="tok-n">newdestpath</span>

    <span class="tok-k">for</span> <span class="tok-n">sha</span><span class="tok-p">,</span> <span class="tok-n">filename</span> <span class="tok-ow">in</span> <span class="tok-n">dst_hashes</span><span class="tok-o">.</span><span class="tok-n">items</span><span class="tok-p">():</span>
        <span class="tok-k">if</span> <span class="tok-n">sha</span> <span class="tok-ow">not</span> <span class="tok-ow">in</span> <span class="tok-n">src_hashes</span><span class="tok-p">:</span>
            <span class="tok-k">yield</span> <span class="tok-s1">&#39;delete&#39;</span><span class="tok-p">,</span> <span class="tok-n">dst_folder</span> <span class="tok-o">/</span> <span class="tok-n">filename</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Our tests now act directly on the <code>determine_actions()</code> function:</p>
</div>
<div id="harry_tests" class="exampleblock">
<div class="title">Nicer-looking tests (test_sync.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_when_a_file_exists_in_the_source_but_not_the_destination</span><span class="tok-p">():</span>
    <span class="tok-n">src_hashes</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s1">&#39;hash1&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;fn1&#39;</span><span class="tok-p">}</span>
    <span class="tok-n">dst_hashes</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>
    <span class="tok-n">actions</span> <span class="tok-o">=</span> <span class="tok-n">determine_actions</span><span class="tok-p">(</span><span class="tok-n">src_hashes</span><span class="tok-p">,</span> <span class="tok-n">dst_hashes</span><span class="tok-p">,</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-s1">&#39;/src&#39;</span><span class="tok-p">),</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-s1">&#39;/dst&#39;</span><span class="tok-p">))</span>
    <span class="tok-k">assert</span> <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-n">actions</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-p">[(</span><span class="tok-s1">&#39;copy&#39;</span><span class="tok-p">,</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-s1">&#39;/src/fn1&#39;</span><span class="tok-p">),</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-s1">&#39;/dst/fn1&#39;</span><span class="tok-p">))]</span>

<span class="tok-k">def</span> <span class="tok-nf">test_when_a_file_has_been_renamed_in_the_source</span><span class="tok-p">():</span>
    <span class="tok-n">src_hashes</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s1">&#39;hash1&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;fn1&#39;</span><span class="tok-p">}</span>
    <span class="tok-n">dst_hashes</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s1">&#39;hash1&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;fn2&#39;</span><span class="tok-p">}</span>
    <span class="tok-n">actions</span> <span class="tok-o">=</span> <span class="tok-n">determine_actions</span><span class="tok-p">(</span><span class="tok-n">src_hashes</span><span class="tok-p">,</span> <span class="tok-n">dst_hashes</span><span class="tok-p">,</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-s1">&#39;/src&#39;</span><span class="tok-p">),</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-s1">&#39;/dst&#39;</span><span class="tok-p">))</span>
    <span class="tok-k">assert</span> <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-n">actions</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-p">[(</span><span class="tok-s1">&#39;move&#39;</span><span class="tok-p">,</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-s1">&#39;/dst/fn2&#39;</span><span class="tok-p">),</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-s1">&#39;/dst/fn1&#39;</span><span class="tok-p">))]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Because we&#8217;ve disentangled the logic of our program&#8212;&#8203;the code for identifying
changes&#8212;&#8203;from the low-level details of I/O, we can easily test the core of our code.</p>
</div>
<div class="paragraph">
<p>With this approach, we&#8217;ve switched from testing our main entrypoint function,
<code>sync()</code>, to testing a lower-level function, <code>determine_actions()</code>. You might
decide that&#8217;s fine because <code>sync()</code> is now so simple. Or you might decide to
keep some integration/acceptance tests to test that <code>sync()</code>. But there&#8217;s
another option, which is to modify the <code>sync()</code> function so it can
be unit tested <em>and</em> end-to-end tested; it&#8217;s an approach Bob calls
<em>edge-to-edge testing</em>.</p>
</div>
<div class="sect3">
<h4 id="_testing_edge_to_edge_with_fakes_and_dependency_injection">3.3.1. Testing Edge to Edge with Fakes and Dependency Injection</h4>
<div class="paragraph">
<p>When we start writing a new system, we often focus on the core logic first,
driving it with direct unit tests. At some point, though, we want to test bigger
chunks of the system together.</p>
</div>
<div class="paragraph">
<p>We <em>could</em> return to our end-to-end tests, but those are still as tricky to
write and maintain as before. Instead, we often write tests that invoke a whole
system together but fake the I/O, sort of <em>edge to edge</em>:</p>
</div>
<div id="di_version" class="exampleblock">
<div class="title">Explicit dependencies (sync.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">sync</span><span class="tok-p">(</span><span class="tok-n">reader</span><span class="tok-p">,</span> <span class="tok-n">filesystem</span><span class="tok-p">,</span> <span class="tok-n">source_root</span><span class="tok-p">,</span> <span class="tok-n">dest_root</span><span class="tok-p">):</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-n">source_hashes</span> <span class="tok-o">=</span> <span class="tok-n">reader</span><span class="tok-p">(</span><span class="tok-n">source_root</span><span class="tok-p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">dest_hashes</span> <span class="tok-o">=</span> <span class="tok-n">reader</span><span class="tok-p">(</span><span class="tok-n">dest_root</span><span class="tok-p">)</span>

    <span class="tok-k">for</span> <span class="tok-n">sha</span><span class="tok-p">,</span> <span class="tok-n">filename</span> <span class="tok-ow">in</span> <span class="tok-n">src_hashes</span><span class="tok-o">.</span><span class="tok-n">items</span><span class="tok-p">():</span>
        <span class="tok-k">if</span> <span class="tok-n">sha</span> <span class="tok-ow">not</span> <span class="tok-ow">in</span> <span class="tok-n">dest_hashes</span><span class="tok-p">:</span>
            <span class="tok-n">sourcepath</span> <span class="tok-o">=</span> <span class="tok-n">source_root</span> <span class="tok-o">/</span> <span class="tok-n">filename</span>
            <span class="tok-n">destpath</span> <span class="tok-o">=</span> <span class="tok-n">dest_root</span> <span class="tok-o">/</span> <span class="tok-n">filename</span>
            <span class="tok-n">filesystem</span><span class="tok-o">.</span><span class="tok-n">copy</span><span class="tok-p">(</span><span class="tok-n">destpath</span><span class="tok-p">,</span> <span class="tok-n">sourcepath</span><span class="tok-p">)</span> <i class="conum" data-value="3"></i><b>(3)</b>

        <span class="tok-k">elif</span> <span class="tok-n">dest_hashes</span><span class="tok-p">[</span><span class="tok-n">sha</span><span class="tok-p">]</span> <span class="tok-o">!=</span> <span class="tok-n">filename</span><span class="tok-p">:</span>
            <span class="tok-n">olddestpath</span> <span class="tok-o">=</span> <span class="tok-n">dest_root</span> <span class="tok-o">/</span> <span class="tok-n">dest_hashes</span><span class="tok-p">[</span><span class="tok-n">sha</span><span class="tok-p">]</span>
            <span class="tok-n">newdestpath</span> <span class="tok-o">=</span> <span class="tok-n">dest_root</span> <span class="tok-o">/</span> <span class="tok-n">filename</span>
            <span class="tok-n">filesystem</span><span class="tok-o">.</span><span class="tok-n">move</span><span class="tok-p">(</span><span class="tok-n">olddestpath</span><span class="tok-p">,</span> <span class="tok-n">newdestpath</span><span class="tok-p">)</span>

    <span class="tok-k">for</span> <span class="tok-n">sha</span><span class="tok-p">,</span> <span class="tok-n">filename</span> <span class="tok-ow">in</span> <span class="tok-n">dst_hashes</span><span class="tok-o">.</span><span class="tok-n">items</span><span class="tok-p">():</span>
        <span class="tok-k">if</span> <span class="tok-n">sha</span> <span class="tok-ow">not</span> <span class="tok-ow">in</span> <span class="tok-n">source_hashes</span><span class="tok-p">:</span>
            <span class="tok-n">filesystem</span><span class="tok-o">.</span><span class="tok-n">delete</span><span class="tok-p">(</span><span class="tok-n">dest_root</span><span class="tok-o">/</span><span class="tok-n">filename</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Our top-level function now exposes two new dependencies, a <code>reader</code> and a
<code>filesystem</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We invoke the <code>reader</code> to produce our files dict.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We invoke the <code>filesystem</code> to apply the changes we detect.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Although we&#8217;re using dependency injection, there is no need
    to define an abstract base class or any kind of explicit interface. In this
    book, we often show ABCs because we hope they help you understand what the
    abstraction is, but they&#8217;re not necessary. Python&#8217;s dynamic nature means
    we can always rely on duck typing.
</td>
</tr>
</table>
</div>
<div id="bob_tests" class="exampleblock">
<div class="title">Tests using DI</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">FakeFileSystem</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-p">):</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-k">def</span> <span class="tok-nf">copy</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">src</span><span class="tok-p">,</span> <span class="tok-n">dest</span><span class="tok-p">):</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">((</span><span class="tok-s1">&#39;COPY&#39;</span><span class="tok-p">,</span> <span class="tok-n">src</span><span class="tok-p">,</span> <span class="tok-n">dest</span><span class="tok-p">))</span>

    <span class="tok-k">def</span> <span class="tok-nf">move</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">src</span><span class="tok-p">,</span> <span class="tok-n">dest</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">((</span><span class="tok-s1">&#39;MOVE&#39;</span><span class="tok-p">,</span> <span class="tok-n">src</span><span class="tok-p">,</span> <span class="tok-n">dest</span><span class="tok-p">))</span>

    <span class="tok-k">def</span> <span class="tok-nf">delete</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">dest</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">((</span><span class="tok-s1">&#39;DELETE&#39;</span><span class="tok-p">,</span> <span class="tok-n">src</span><span class="tok-p">,</span> <span class="tok-n">dest</span><span class="tok-p">))</span>


<span class="tok-k">def</span> <span class="tok-nf">test_when_a_file_exists_in_the_source_but_not_the_destination</span><span class="tok-p">():</span>
    <span class="tok-n">source</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s2">&quot;sha1&quot;</span><span class="tok-p">:</span> <span class="tok-s2">&quot;my-file&quot;</span> <span class="tok-p">}</span>
    <span class="tok-n">dest</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>
    <span class="tok-n">filesystem</span> <span class="tok-o">=</span> <span class="tok-n">FakeFileSystem</span><span class="tok-p">()</span>

    <span class="tok-n">reader</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s2">&quot;/source&quot;</span><span class="tok-p">:</span> <span class="tok-n">source</span><span class="tok-p">,</span> <span class="tok-s2">&quot;/dest&quot;</span><span class="tok-p">:</span> <span class="tok-n">dest</span><span class="tok-p">}</span>
    <span class="tok-n">synchronise_dirs</span><span class="tok-p">(</span><span class="tok-n">reader</span><span class="tok-o">.</span><span class="tok-n">pop</span><span class="tok-p">,</span> <span class="tok-n">filesystem</span><span class="tok-p">,</span> <span class="tok-s2">&quot;/source&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;/dest&quot;</span><span class="tok-p">)</span>

    <span class="tok-k">assert</span> <span class="tok-n">filesystem</span> <span class="tok-o">==</span> <span class="tok-p">[(</span><span class="tok-s2">&quot;COPY&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;/source/my-file&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;/dest/my-file&quot;</span><span class="tok-p">)]</span>


<span class="tok-k">def</span> <span class="tok-nf">test_when_a_file_has_been_renamed_in_the_source</span><span class="tok-p">():</span>
    <span class="tok-n">source</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s2">&quot;sha1&quot;</span><span class="tok-p">:</span> <span class="tok-s2">&quot;renamed-file&quot;</span> <span class="tok-p">}</span>
    <span class="tok-n">dest</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s2">&quot;sha1&quot;</span><span class="tok-p">:</span> <span class="tok-s2">&quot;original-file&quot;</span> <span class="tok-p">}</span>
    <span class="tok-n">filesystem</span> <span class="tok-o">=</span> <span class="tok-n">FakeFileSystem</span><span class="tok-p">()</span>

    <span class="tok-n">reader</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s2">&quot;/source&quot;</span><span class="tok-p">:</span> <span class="tok-n">source</span><span class="tok-p">,</span> <span class="tok-s2">&quot;/dest&quot;</span><span class="tok-p">:</span> <span class="tok-n">dest</span><span class="tok-p">}</span>
    <span class="tok-n">synchronise_dirs</span><span class="tok-p">(</span><span class="tok-n">reader</span><span class="tok-o">.</span><span class="tok-n">pop</span><span class="tok-p">,</span> <span class="tok-n">filesystem</span><span class="tok-p">,</span> <span class="tok-s2">&quot;/source&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;/dest&quot;</span><span class="tok-p">)</span>

    <span class="tok-k">assert</span> <span class="tok-n">filesystem</span> <span class="tok-o">==</span> <span class="tok-p">[(</span><span class="tok-s2">&quot;MOVE&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;/dest/original-file&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;/dest/renamed-file&quot;</span><span class="tok-p">)]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Bob <em>loves</em> using lists to build simple test doubles, even though his
coworkers get mad. It means we can write tests like
assert 'foo' not in database.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Each method in our <code>FakeFileSystem</code> just appends something to the list so we
can inspect it later. This is an example of a spy object.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The advantage of this approach is that our tests act on the exact same function
that&#8217;s used by our production code. The disadvantage is that we have to make
our stateful components explicit and pass them around.
David Heinemeier Hansson, the creator of Ruby on Rails, famously described this
as "test-induced design damage."</p>
</div>
<div class="paragraph">
<p>In either case, we can now work on fixing all the bugs in our implementation;
enumerating tests for all the edge cases is now much easier.</p>
</div>
</div>
<div class="sect3">
<h4 id="_why_not_just_patch_it_out">3.3.2. Why Not Just Patch It Out?</h4>
<div class="paragraph">
<p>At this point you may be scratching your head and thinking,
"Why don&#8217;t you just use <code>mock.patch</code> and save yourself the effort?""</p>
</div>
<div class="paragraph">
<p>We avoid using mocks in this book and in our production code too. We&#8217;re not
going to enter into a Holy War, but our instinct is that mocking frameworks,
particularly monkeypatching, are a code smell.</p>
</div>
<div class="paragraph">
<p>Instead, we like to clearly identify the responsibilities in our codebase, and to
separate those responsibilities into small, focused objects that are easy to
replace with a test double.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can see an example in <a href="#chapter_08_events_and_message_bus">Events and the Message Bus</a>,
    where we <code>mock.patch()</code> out an email-sending module, but eventually we
    replace that with an explicit bit of dependency injection in
    <a href="#chapter_13_dependency_injection">Dependency Injection (and Bootstrapping)</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have three closely related reasons for our preference:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Patching out the dependency you&#8217;re using makes it possible to unit test the
code, but it does nothing to improve the design. Using <code>mock.patch</code> won&#8217;t let your
code work with a <code>--dry-run</code> flag, nor will it help you run against an FTP
server. For that, you&#8217;ll need to introduce abstractions.</p>
</li>
<li>
<p>Tests that use mocks <em>tend</em> to be more coupled to the implementation details
of the codebase. That&#8217;s because mock tests verify the interactions between
things: did we call <code>shutil.copy</code> with the right arguments? This coupling between
code and test <em>tends</em> to make tests more brittle, in our experience.</p>
</li>
<li>
<p>Overuse of mocks leads to complicated test suites that fail to explain the
code.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Designing for testability really means designing for
    extensibility. We trade off a little more complexity for a cleaner design
    that admits novel use cases.
</td>
</tr>
</table>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Mocks Versus Fakes; Classic-Style Versus London-School TDD</div>
<div class="paragraph">
<p>Here&#8217;s a short and somewhat simplistic definition of the difference between
mocks and fakes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mocks are used to verify <em>how</em> something gets used;  they have methods
like <code>assert_called_once_with()</code>. They&#8217;re associated with London-school
TDD.</p>
</li>
<li>
<p>Fakes are working implementations of the thing they&#8217;re replacing, but
  they&#8217;re designed for use only in tests. They wouldn&#8217;t work "in real life";
our in-memory repository is a good example. But you can use them to make assertions about
  the end state of a system rather than the behaviors along the way, so
  they&#8217;re associated with classic-style TDD.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We&#8217;re slightly conflating mocks with spies and fakes with stubs here, and you
can read the long, correct answer in Martin Fowler&#8217;s classic essay on the subject
called <a href="https://oreil.ly/yYjBN">"Mocks Aren&#8217;t Stubs"</a>.</p>
</div>
<div class="paragraph">
<p>It also probably doesn&#8217;t help that the <code>MagicMock</code> objects provided by
<code>unittest.mock</code> aren&#8217;t, strictly speaking, mocks; they&#8217;re spies, if anything.
But they&#8217;re also often used as stubs or dummies. There, we promise we&#8217;re done with
the test double terminology nitpicks now.</p>
</div>
<div class="paragraph">
<p>What about London-school versus classic-style TDD? You can read more about those
two in Martin Fowler&#8217;s article that we just cited, as well as on the
<a href="https://oreil.ly/H2im_">Software Engineering Stack Exchange site</a>,
but in this book we&#8217;re pretty firmly in the classicist camp.  We like to
build our tests around state both in setup and in assertions, and we like
to work at the highest level of abstraction possible rather than doing
checks on the behavior of intermediary collaborators.<sup class="footnote">[<a id="_footnoteref_20" class="footnote" href="#_footnotedef_20" title="View footnote.">20</a>]</sup></p>
</div>
<div class="paragraph">
<p>Read more on this in <a href="#kinds_of_tests">On Deciding What Kind of Tests to Write</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>We view TDD as a design practice first and a testing practice second. The tests
act as a record of our design choices and serve to explain the system to us
when we return to the code after a long absence.</p>
</div>
<div class="paragraph">
<p>Tests that use too many mocks get overwhelmed with setup code that hides the
story we care about.</p>
</div>
<div class="paragraph">
<p>Steve Freeman has a great example of overmocked tests in his talk
<a href="https://oreil.ly/jAmtr">"Test-Driven Development"</a>.
You should also check out this PyCon talk, <a href="https://oreil.ly/s3e05">"Mocking and Patching Pitfalls"</a>,
by our esteemed tech reviewer, Ed Jung, which also addresses mocking and its
alternatives. And while we&#8217;re recommending talks, don&#8217;t miss Brandon Rhodes talking about
<a href="https://oreil.ly/oiXJM">"Hoisting Your I/O"</a>,
which really nicely covers the issues we&#8217;re talking about, using another simple example.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In this chapter, we&#8217;ve spent a lot of time replacing end-to-end tests with
    unit tests. That doesn&#8217;t mean we think you should never use E2E tests!
    In this book we&#8217;re showing techniques to get you to a decent test
    pyramid with as many unit tests as possible, and with the minimum number of E2E
    tests you need to feel confident. Read on to <a href="#types_of_test_rules_of_thumb">Recap: Rules of Thumb for Different Types of Test</a>
    for more details.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">So Which Do We Use In This Book? Functional or Object-Oriented Composition?</div>
<div class="paragraph">
<p>Both. Our domain model is entirely free of dependencies and side effects,
so that&#8217;s our functional core. The service layer that we build around it
(in <a href="#chapter_04_service_layer">Our First Use Case: <span class="keep-together">Flask API and Service Layer</span></a>) allows us to drive the system edge to edge,
and we use dependency injection to provide those services with stateful
components, so we can still unit test them.</p>
</div>
<div class="paragraph">
<p>See <a href="#chapter_13_dependency_injection">Dependency Injection (and Bootstrapping)</a> for more exploration of making our
dependency injection more explicit and centralized.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up_2">3.4. Wrap-Up</h3>
<div class="paragraph">
<p>We&#8217;ll see this idea come up again and again in the book: we can make our
systems easier to test and maintain by simplifying the interface between our
business logic and messy I/O. Finding the right abstraction is tricky, but here are
a few heuristics and questions to ask yourself:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Can I choose a familiar Python data structure to represent the state of the
messy system and then try to imagine a single function that can return that
state?</p>
</li>
<li>
<p>Where can I draw a line between my systems, where can I carve out a
<a href="https://oreil.ly/zNUGG">seam</a>
to stick that abstraction in?</p>
</li>
<li>
<p>What is a sensible way of dividing things into components with different
responsibilities?  What implicit concepts can I make explicit?</p>
</li>
<li>
<p>What are the dependencies, and what is the core business logic?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Practice makes less imperfect! And now back to our regular programming&#8230;&#8203;</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_04_service_layer">4. Our First Use Case: <span class="keep-together">Flask API and Service Layer</span></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Back to our allocations project! <a href="#maps_service_layer_before">Before: we drive our app by talking to repositories and the domain model</a> shows the point we reached at the end of <a href="#chapter_02_repository">Repository Pattern</a>, which covered the Repository pattern.</p>
</div>
<div id="maps_service_layer_before" class="imageblock width-75">
<div class="content">
<img src="images/apwp_0401.png" alt="apwp 0401">
</div>
<div class="title">Figure 16. Before: we drive our app by talking to repositories and the domain model</div>
</div>
<div class="paragraph">
<p>In this chapter, we discuss the differences between orchestration logic,
business logic, and interfacing code, and we introduce the <em>Service Layer</em>
pattern to take care of orchestrating our workflows and defining the use
cases of our system.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll also discuss testing: by combining the Service Layer with our repository
abstraction over the database, we&#8217;re able to write fast tests, not just of
our domain model but of the entire workflow for a use case.</p>
</div>
<div class="paragraph">
<p><a href="#maps_service_layer_after">The service layer will become the main way into our app</a> shows what we&#8217;re aiming for: we&#8217;re going to
add a Flask API that will talk to the service layer, which will serve as the
entrypoint to our domain model. Because our service layer depends on the
<code>AbstractRepository</code>, we can unit test it by using <code>FakeRepository</code> but run our production code using <code>SqlAlchemyRepository</code>.</p>
</div>
<div id="maps_service_layer_after" class="imageblock">
<div class="content">
<img src="images/apwp_0402.png" alt="apwp 0402">
</div>
<div class="title">Figure 17. The service layer will become the main way into our app</div>
</div>
<div class="paragraph">
<p>In our diagrams, we are using the convention that new components
    are highlighted with bold text/lines (and yellow/orange color, if you&#8217;re
    reading a digital version).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The code for this chapter is in the
chapter_04_service_layer branch <a href="https://oreil.ly/TBRuy">on GitHub</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/cosmicpython/code.git
cd code
git checkout chapter_04_service_layer
# or to code along, checkout Chapter 2:
git checkout chapter_02_repository</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_connecting_our_application_to_the_real_world">4.1. Connecting Our Application to the Real World</h3>
<div class="paragraph">
<p>Like any good agile team, we&#8217;re hustling to try to get an MVP out and
in front of the users to start gathering feedback. We have the core
of our domain model and the domain service we need to allocate orders,
and we have the repository interface for permanent storage.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s plug all the moving parts together as quickly as we
can and then refactor toward a cleaner architecture. Here&#8217;s our
plan:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use Flask to put an API endpoint in front of our <code>allocate</code> domain service.
Wire up the database session and our repository. Test it with
an end-to-end test and some quick-and-dirty SQL to prepare test
data.</p>
</li>
<li>
<p>Refactor out a service layer that can serve as an abstraction to
capture the use case and that will sit between Flask and our domain model.
Build some service-layer tests and show how they can use
<code>FakeRepository</code>.</p>
</li>
<li>
<p>Experiment with different types of parameters for our service layer
functions; show that using primitive data types allows the service layer&#8217;s
clients (our tests and our Flask API) to be decoupled from the model layer.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_a_first_end_to_end_test">4.2. A First End-to-End Test</h3>
<div class="paragraph">
<p>No one is interested in getting into a long terminology debate about what
counts as an end-to-end (E2E) test versus a functional test versus an acceptance test versus
an integration test versus a unit test. Different projects need different
combinations of tests, and we&#8217;ve seen perfectly successful projects just split
things into "fast tests" and "slow tests."</p>
</div>
<div class="paragraph">
<p>For now, we want to write one or maybe two tests that are going to exercise
a "real" API endpoint (using HTTP) and talk to a real database. Let&#8217;s call
them <em>end-to-end tests</em> because it&#8217;s one of the most self-explanatory names.</p>
</div>
<div class="paragraph">
<p>The following shows a first cut:</p>
</div>
<div id="first_api_test" class="exampleblock">
<div class="title">A first API test (test_api.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@pytest.mark.usefixtures</span><span class="tok-p">(</span><span class="tok-s1">&#39;restart_api&#39;</span><span class="tok-p">)</span>
<span class="tok-k">def</span> <span class="tok-nf">test_api_returns_allocation</span><span class="tok-p">(</span><span class="tok-n">add_stock</span><span class="tok-p">):</span>
    <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">othersku</span> <span class="tok-o">=</span> <span class="tok-n">random_sku</span><span class="tok-p">(),</span> <span class="tok-n">random_sku</span><span class="tok-p">(</span><span class="tok-s1">&#39;other&#39;</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">earlybatch</span> <span class="tok-o">=</span> <span class="tok-n">random_batchref</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span>
    <span class="tok-n">laterbatch</span> <span class="tok-o">=</span> <span class="tok-n">random_batchref</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span>
    <span class="tok-n">otherbatch</span> <span class="tok-o">=</span> <span class="tok-n">random_batchref</span><span class="tok-p">(</span><span class="tok-mi">3</span><span class="tok-p">)</span>
    <span class="tok-n">add_stock</span><span class="tok-p">([</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-p">(</span><span class="tok-n">laterbatch</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-s1">&#39;2011-01-02&#39;</span><span class="tok-p">),</span>
        <span class="tok-p">(</span><span class="tok-n">earlybatch</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-s1">&#39;2011-01-01&#39;</span><span class="tok-p">),</span>
        <span class="tok-p">(</span><span class="tok-n">otherbatch</span><span class="tok-p">,</span> <span class="tok-n">othersku</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">),</span>
    <span class="tok-p">])</span>
    <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">:</span> <span class="tok-n">random_orderid</span><span class="tok-p">(),</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">:</span> <span class="tok-mi">3</span><span class="tok-p">}</span>
    <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-n">get_api_url</span><span class="tok-p">()</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-n">requests</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;{url}/allocate&#39;</span><span class="tok-p">,</span> <span class="tok-n">json</span><span class="tok-o">=</span><span class="tok-n">data</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">status_code</span> <span class="tok-o">==</span> <span class="tok-mi">201</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">()[</span><span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">earlybatch</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>random_sku()</code>, <code>random_batchref()</code>, and so on are little helper functions that
generate randomized characters by using the <code>uuid</code> module. Because
we&#8217;re running against an actual database now, this is one way to prevent
various tests and runs from interfering with each other.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>add_stock</code> is a helper fixture that just hides away the details of
manually inserting rows into the database using SQL. We&#8217;ll show a nicer
way of doing this later in the chapter.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><em>config.py</em> is a module in which we keep configuration information.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Everyone solves these problems in different ways, but you&#8217;re going to need some
way of spinning up Flask, possibly in a container, and of talking to a
Postgres database. If you want to see how we did it, check out
<a href="#appendix_project_structure">A Template Project Structure</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_straightforward_implementation">4.3. The Straightforward Implementation</h3>
<div class="paragraph">
<p>Implementing things in the most obvious way, you might get something like this:</p>
</div>
<div id="first_cut_flask_app" class="exampleblock">
<div class="title">First cut of Flask app (flask_app.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">flask</span> <span class="tok-kn">import</span> <span class="tok-n">Flask</span><span class="tok-p">,</span> <span class="tok-n">jsonify</span><span class="tok-p">,</span> <span class="tok-n">request</span>
<span class="tok-kn">from</span> <span class="tok-nn">sqlalchemy</span> <span class="tok-kn">import</span> <span class="tok-n">create_engine</span>
<span class="tok-kn">from</span> <span class="tok-nn">sqlalchemy.orm</span> <span class="tok-kn">import</span> <span class="tok-n">sessionmaker</span>

<span class="tok-kn">import</span> <span class="tok-nn">config</span>
<span class="tok-kn">import</span> <span class="tok-nn">model</span>
<span class="tok-kn">import</span> <span class="tok-nn">orm</span>
<span class="tok-kn">import</span> <span class="tok-nn">repository</span>


<span class="tok-n">orm</span><span class="tok-o">.</span><span class="tok-n">start_mappers</span><span class="tok-p">()</span>
<span class="tok-n">get_session</span> <span class="tok-o">=</span> <span class="tok-n">sessionmaker</span><span class="tok-p">(</span><span class="tok-n">bind</span><span class="tok-o">=</span><span class="tok-n">create_engine</span><span class="tok-p">(</span><span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-n">get_postgres_uri</span><span class="tok-p">()))</span>
<span class="tok-n">app</span> <span class="tok-o">=</span> <span class="tok-n">Flask</span><span class="tok-p">(</span><span class="tok-vm">__name__</span><span class="tok-p">)</span>

<span class="tok-nd">@app.route</span><span class="tok-p">(</span><span class="tok-s2">&quot;/allocate&quot;</span><span class="tok-p">,</span> <span class="tok-n">methods</span><span class="tok-o">=</span><span class="tok-p">[</span><span class="tok-s1">&#39;POST&#39;</span><span class="tok-p">])</span>
<span class="tok-k">def</span> <span class="tok-nf">allocate_endpoint</span><span class="tok-p">():</span>
    <span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-n">get_session</span><span class="tok-p">()</span>
    <span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyRepository</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">list</span><span class="tok-p">()</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span>
        <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">],</span>
        <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">],</span>
        <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">],</span>
    <span class="tok-p">)</span>

    <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">)</span>

    <span class="tok-k">return</span> <span class="tok-n">jsonify</span><span class="tok-p">({</span><span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">:</span> <span class="tok-n">batchref</span><span class="tok-p">}),</span> <span class="tok-mi">201</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>So far, so good. No need for too much more of your "architecture astronaut"
nonsense, Bob and Harry, you may be thinking.</p>
</div>
<div class="paragraph">
<p>But hang on a minute&#8212;&#8203;there&#8217;s no commit. We&#8217;re not actually saving our
allocation to the database. Now we need a second test, either one that will
inspect the database state after (not very black-boxy), or maybe one that
checks that we can&#8217;t allocate a second line if a first should have already
depleted the batch:</p>
</div>
<div id="second_api_test" class="exampleblock">
<div class="title">Test allocations are persisted (test_api.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@pytest.mark.usefixtures</span><span class="tok-p">(</span><span class="tok-s1">&#39;restart_api&#39;</span><span class="tok-p">)</span>
<span class="tok-k">def</span> <span class="tok-nf">test_allocations_are_persisted</span><span class="tok-p">(</span><span class="tok-n">add_stock</span><span class="tok-p">):</span>
    <span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">random_sku</span><span class="tok-p">()</span>
    <span class="tok-n">batch1</span><span class="tok-p">,</span> <span class="tok-n">batch2</span> <span class="tok-o">=</span> <span class="tok-n">random_batchref</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">),</span> <span class="tok-n">random_batchref</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span>
    <span class="tok-n">order1</span><span class="tok-p">,</span> <span class="tok-n">order2</span> <span class="tok-o">=</span> <span class="tok-n">random_orderid</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">),</span> <span class="tok-n">random_orderid</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span>
    <span class="tok-n">add_stock</span><span class="tok-p">([</span>
        <span class="tok-p">(</span><span class="tok-n">batch1</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-s1">&#39;2011-01-01&#39;</span><span class="tok-p">),</span>
        <span class="tok-p">(</span><span class="tok-n">batch2</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-s1">&#39;2011-01-02&#39;</span><span class="tok-p">),</span>
    <span class="tok-p">])</span>
    <span class="tok-n">line1</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">:</span> <span class="tok-n">order1</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">:</span> <span class="tok-mi">10</span><span class="tok-p">}</span>
    <span class="tok-n">line2</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">:</span> <span class="tok-n">order2</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">:</span> <span class="tok-mi">10</span><span class="tok-p">}</span>
    <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-n">get_api_url</span><span class="tok-p">()</span>

    <span class="tok-c1"># first order uses up all stock in batch 1</span>
    <span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-n">requests</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;{url}/allocate&#39;</span><span class="tok-p">,</span> <span class="tok-n">json</span><span class="tok-o">=</span><span class="tok-n">line1</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">status_code</span> <span class="tok-o">==</span> <span class="tok-mi">201</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">()[</span><span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">batch1</span>

    <span class="tok-c1"># second order should go to batch 2</span>
    <span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-n">requests</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;{url}/allocate&#39;</span><span class="tok-p">,</span> <span class="tok-n">json</span><span class="tok-o">=</span><span class="tok-n">line2</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">status_code</span> <span class="tok-o">==</span> <span class="tok-mi">201</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">()[</span><span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">batch2</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Not quite so lovely, but that will force us to add the commit.</p>
</div>
</div>
<div class="sect2">
<h3 id="_error_conditions_that_require_database_checks">4.4. Error Conditions That Require Database Checks</h3>
<div class="paragraph">
<p>If we keep going like this, though, things are going to get uglier and uglier.</p>
</div>
<div class="paragraph">
<p>Suppose we want to add a bit of error handling. What if the domain raises an
error, for a SKU that&#8217;s out of stock?  Or what about a SKU that doesn&#8217;t even
exist? That&#8217;s not something the domain even knows about, nor should it. It&#8217;s
more of a sanity check that we should implement at the database layer, before
we even invoke the domain service.</p>
</div>
<div class="paragraph">
<p>Now we&#8217;re looking at two more end-to-end tests:</p>
</div>
<div id="test_error_cases" class="exampleblock">
<div class="title">Yet more tests at the E2E layer (test_api.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@pytest.mark.usefixtures</span><span class="tok-p">(</span><span class="tok-s1">&#39;restart_api&#39;</span><span class="tok-p">)</span>
<span class="tok-k">def</span> <span class="tok-nf">test_400_message_for_out_of_stock</span><span class="tok-p">(</span><span class="tok-n">add_stock</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">smalL_batch</span><span class="tok-p">,</span> <span class="tok-n">large_order</span> <span class="tok-o">=</span> <span class="tok-n">random_sku</span><span class="tok-p">(),</span> <span class="tok-n">random_batchref</span><span class="tok-p">(),</span> <span class="tok-n">random_orderid</span><span class="tok-p">()</span>
    <span class="tok-n">add_stock</span><span class="tok-p">([</span>
        <span class="tok-p">(</span><span class="tok-n">smalL_batch</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-s1">&#39;2011-01-01&#39;</span><span class="tok-p">),</span>
    <span class="tok-p">])</span>
    <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">:</span> <span class="tok-n">large_order</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">:</span> <span class="tok-mi">20</span><span class="tok-p">}</span>
    <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-n">get_api_url</span><span class="tok-p">()</span>
    <span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-n">requests</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;{url}/allocate&#39;</span><span class="tok-p">,</span> <span class="tok-n">json</span><span class="tok-o">=</span><span class="tok-n">data</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">status_code</span> <span class="tok-o">==</span> <span class="tok-mi">400</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">()[</span><span class="tok-s1">&#39;message&#39;</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">f</span><span class="tok-s1">&#39;Out of stock for sku {sku}&#39;</span>


<span class="tok-nd">@pytest.mark.usefixtures</span><span class="tok-p">(</span><span class="tok-s1">&#39;restart_api&#39;</span><span class="tok-p">)</span>
<span class="tok-k">def</span> <span class="tok-nf">test_400_message_for_invalid_sku</span><span class="tok-p">():</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">unknown_sku</span><span class="tok-p">,</span> <span class="tok-n">orderid</span> <span class="tok-o">=</span> <span class="tok-n">random_sku</span><span class="tok-p">(),</span> <span class="tok-n">random_orderid</span><span class="tok-p">()</span>
    <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">:</span> <span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-n">unknown_sku</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">:</span> <span class="tok-mi">20</span><span class="tok-p">}</span>
    <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-n">get_api_url</span><span class="tok-p">()</span>
    <span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-n">requests</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;{url}/allocate&#39;</span><span class="tok-p">,</span> <span class="tok-n">json</span><span class="tok-o">=</span><span class="tok-n">data</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">status_code</span> <span class="tok-o">==</span> <span class="tok-mi">400</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">()[</span><span class="tok-s1">&#39;message&#39;</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">f</span><span class="tok-s1">&#39;Invalid sku {unknown_sku}&#39;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In the first test, we&#8217;re trying to allocate more units than we have in stock.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In the second, the SKU just doesn&#8217;t exist (because we never called <code>add_stock</code>),
so it&#8217;s invalid as far as our app is concerned.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And sure, we could implement it in the Flask app too:</p>
</div>
<div id="flask_error_handling" class="exampleblock">
<div class="title">Flask app starting to get crufty (flask_app.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">is_valid_sku</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">):</span>
    <span class="tok-k">return</span> <span class="tok-n">sku</span> <span class="tok-ow">in</span> <span class="tok-p">{</span><span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-k">for</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-n">batches</span><span class="tok-p">}</span>

<span class="tok-nd">@app.route</span><span class="tok-p">(</span><span class="tok-s2">&quot;/allocate&quot;</span><span class="tok-p">,</span> <span class="tok-n">methods</span><span class="tok-o">=</span><span class="tok-p">[</span><span class="tok-s1">&#39;POST&#39;</span><span class="tok-p">])</span>
<span class="tok-k">def</span> <span class="tok-nf">allocate_endpoint</span><span class="tok-p">():</span>
    <span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-n">get_session</span><span class="tok-p">()</span>
    <span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyRepository</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">list</span><span class="tok-p">()</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span>
        <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">],</span>
        <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">],</span>
        <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">],</span>
    <span class="tok-p">)</span>

    <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">is_valid_sku</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">jsonify</span><span class="tok-p">({</span><span class="tok-s1">&#39;message&#39;</span><span class="tok-p">:</span> <span class="tok-n">f</span><span class="tok-s1">&#39;Invalid sku {line.sku}&#39;</span><span class="tok-p">}),</span> <span class="tok-mi">400</span>

    <span class="tok-k">try</span><span class="tok-p">:</span>
        <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">)</span>
    <span class="tok-k">except</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span> <span class="tok-k">as</span> <span class="tok-n">e</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-n">jsonify</span><span class="tok-p">({</span><span class="tok-s1">&#39;message&#39;</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">)}),</span> <span class="tok-mi">400</span>

    <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>
    <span class="tok-k">return</span> <span class="tok-n">jsonify</span><span class="tok-p">({</span><span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">:</span> <span class="tok-n">batchref</span><span class="tok-p">}),</span> <span class="tok-mi">201</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But our Flask app is starting to look a bit unwieldy.  And our number of
E2E tests is starting to get out of control, and soon we&#8217;ll end up with an
inverted test pyramid (or "ice-cream cone model," as Bob likes to call it).</p>
</div>
</div>
<div class="sect2">
<h3 id="_introducing_a_service_layer_and_using_fakerepository_to_unit_test_it">4.5. Introducing a Service Layer, and Using FakeRepository to Unit Test It</h3>
<div class="paragraph">
<p>If we look at what our Flask app is doing, there&#8217;s quite a lot of what we
might call <em>orchestration</em>—fetching stuff out of our repository, validating
our input against database state, handling errors, and committing in the
happy path. Most of these things don&#8217;t have anything to do with having a
web API endpoint (you&#8217;d need them if you were building a CLI, for example; see
<a href="#appendix_csvs">Swapping Out the Infrastructure: <span class="keep-together">Do Everything with CSVs</span></a>), and they&#8217;re not really things that need to be tested by
end-to-end tests.</p>
</div>
<div class="paragraph">
<p>It often makes sense to split out a service layer, sometimes called an
<em>orchestration layer</em> or a <em>use-case layer</em>.</p>
</div>
<div class="paragraph">
<p>Do you remember the <code>FakeRepository</code> that we prepared in <a href="#chapter_03_abstractions">A Brief Interlude: On Coupling <span class="keep-together">and Abstractions</span></a>?</p>
</div>
<div id="fake_repo" class="exampleblock">
<div class="title">Our fake repository, an in-memory collection of batches (test_services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">FakeRepository</span><span class="tok-p">(</span><span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">AbstractRepository</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_batches</span> <span class="tok-o">=</span> <span class="tok-nb">set</span><span class="tok-p">(</span><span class="tok-n">batches</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">add</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">batch</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_batches</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">batch</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">reference</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-nb">next</span><span class="tok-p">(</span><span class="tok-n">b</span> <span class="tok-k">for</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_batches</span> <span class="tok-k">if</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">reference</span> <span class="tok-o">==</span> <span class="tok-n">reference</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_batches</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s where it will come in useful; it lets us test our service layer with
nice, fast unit tests:</p>
</div>
<div id="first_services_tests" class="exampleblock">
<div class="title">Unit testing with fakes at the service layer (test_services.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_returns_allocation</span><span class="tok-p">():</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s2">&quot;o1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;COMPLICATED-LAMP&quot;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>
    <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;b1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;COMPLICATED-LAMP&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">)</span>
    <span class="tok-n">repo</span> <span class="tok-o">=</span> <span class="tok-n">FakeRepository</span><span class="tok-p">([</span><span class="tok-n">batch</span><span class="tok-p">])</span>  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">FakeSession</span><span class="tok-p">())</span>  <i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-k">assert</span> <span class="tok-n">result</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;b1&quot;</span>


<span class="tok-k">def</span> <span class="tok-nf">test_error_for_invalid_sku</span><span class="tok-p">():</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s2">&quot;o1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;NONEXISTENTSKU&quot;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>
    <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;b1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;AREALSKU&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">)</span>
    <span class="tok-n">repo</span> <span class="tok-o">=</span> <span class="tok-n">FakeRepository</span><span class="tok-p">([</span><span class="tok-n">batch</span><span class="tok-p">])</span>  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-k">with</span> <span class="tok-n">pytest</span><span class="tok-o">.</span><span class="tok-n">raises</span><span class="tok-p">(</span><span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">InvalidSku</span><span class="tok-p">,</span> <span class="tok-n">match</span><span class="tok-o">=</span><span class="tok-s2">&quot;Invalid sku NONEXISTENTSKU&quot;</span><span class="tok-p">):</span>
        <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">FakeSession</span><span class="tok-p">())</span>  <i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>FakeRepository</code> holds the <code>Batch</code> objects that will be used by our test.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Our services module (<em>services.py</em>) will define an <code>allocate()</code>
service-layer function. It will sit between our <code>allocate_endpoint()</code>
function in the API layer and the <code>allocate()</code> domain service function from
our domain model.<sup class="footnote">[<a id="_footnoteref_21" class="footnote" href="#_footnotedef_21" title="View footnote.">21</a>]</sup></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We also need a <code>FakeSession</code> to fake out the database session, as shown in the following code snippet.</td>
</tr>
</table>
</div>
<div id="fake_session" class="exampleblock">
<div class="title">A fake database session (test_services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">FakeSession</span><span class="tok-p">():</span>
    <span class="tok-n">committed</span> <span class="tok-o">=</span> <span class="tok-bp">False</span>

    <span class="tok-k">def</span> <span class="tok-nf">commit</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">committed</span> <span class="tok-o">=</span> <span class="tok-bp">True</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This fake session is only a temporary solution.  We&#8217;ll get rid of it and make
things even nicer soon, in <a href="#chapter_06_uow">Unit of Work Pattern</a>. But in the meantime
the fake <code>.commit()</code> lets us migrate a third test from the E2E layer:</p>
</div>
<div id="second_services_test" class="exampleblock">
<div class="title">A second test at the service layer (test_services.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_commits</span><span class="tok-p">():</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s1">&#39;o1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;OMINOUS-MIRROR&#39;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>
    <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s1">&#39;b1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;OMINOUS-MIRROR&#39;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">)</span>
    <span class="tok-n">repo</span> <span class="tok-o">=</span> <span class="tok-n">FakeRepository</span><span class="tok-p">([</span><span class="tok-n">batch</span><span class="tok-p">])</span>
    <span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-n">FakeSession</span><span class="tok-p">()</span>

    <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">session</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">committed</span> <span class="tok-ow">is</span> <span class="tok-bp">True</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_a_typical_service_function">4.5.1. A Typical Service Function</h4>
<div class="paragraph">
<p>We&#8217;ll write a service function that looks something like this:</p>
</div>
<div id="service_function" class="exampleblock">
<div class="title">Basic allocation service (services.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">InvalidSku</span><span class="tok-p">(</span><span class="tok-ne">Exception</span><span class="tok-p">):</span>
    <span class="tok-k">pass</span>


<span class="tok-k">def</span> <span class="tok-nf">is_valid_sku</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">):</span>
    <span class="tok-k">return</span> <span class="tok-n">sku</span> <span class="tok-ow">in</span> <span class="tok-p">{</span><span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-k">for</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-n">batches</span><span class="tok-p">}</span>

<span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">:</span> <span class="tok-n">AbstractRepository</span><span class="tok-p">,</span> <span class="tok-n">session</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
    <span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">repo</span><span class="tok-o">.</span><span class="tok-n">list</span><span class="tok-p">()</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">is_valid_sku</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-k">raise</span> <span class="tok-n">InvalidSku</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;Invalid sku {line.sku}&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>  <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-k">return</span> <span class="tok-n">batchref</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Typical service-layer functions have similar steps:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We fetch some objects from the repository.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We make some checks or assertions about the request against
the current state of the world.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We call a domain service.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If all is well, we save/update any state we&#8217;ve changed.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That last step is a little unsatisfactory at the moment, as our service
layer is tightly coupled to our database layer. We&#8217;ll improve
that in <a href="#chapter_06_uow">Unit of Work Pattern</a> with the Unit of Work pattern.</p>
</div>
<div id="depend_on_abstractions" class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Depend on Abstractions</div>
<div class="paragraph">
<p>Notice one more thing about our service-layer function:</p>
</div>
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">:</span> <span class="tok-n">AbstractRepository</span><span class="tok-p">,</span> <span class="tok-n">session</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It depends on a repository.  We&#8217;ve chosen to make the dependency explicit,
and we&#8217;ve used the type hint to say that we depend on <code>AbstractRepository</code>.
This means it&#8217;ll work both when the tests give it a <code>FakeRepository</code> and
when the Flask app gives it a <code>SqlAlchemyRepository</code>.</p>
</div>
<div class="paragraph">
<p>If you remember <a href="#dip">The Dependency Inversion Principle</a>,
this is what we mean when we say we should "depend on abstractions." Our
<em>high-level module</em>, the service layer, depends on the repository abstraction.
And the <em>details</em> of the implementation for our specific choice of persistent
storage also depend on that same abstraction. See Figures <a data-type="xref" href="#service_layer_diagram_abstract_dependencies" data-xrefstyle="select:labelnumber">#service_layer_diagram_abstract_dependencies</a> and <a data-type="xref" href="#service_layer_diagram_test_dependencies" data-xrefstyle="select:labelnumber">#service_layer_diagram_test_dependencies</a>.</p>
</div>
<div class="paragraph">
<p>See also in <a href="#appendix_csvs">Swapping Out the Infrastructure: <span class="keep-together">Do Everything with CSVs</span></a> a worked example of swapping out the
<em>details</em> of which persistent storage system to use while leaving the
abstractions intact.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>But the essentials of the service layer are there, and our Flask
app now looks a lot cleaner:</p>
</div>
<div id="flask_app_using_service_layer" class="exampleblock">
<div class="title">Flask app delegating to service layer (flask_app.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@app.route</span><span class="tok-p">(</span><span class="tok-s2">&quot;/allocate&quot;</span><span class="tok-p">,</span> <span class="tok-n">methods</span><span class="tok-o">=</span><span class="tok-p">[</span><span class="tok-s1">&#39;POST&#39;</span><span class="tok-p">])</span>
<span class="tok-k">def</span> <span class="tok-nf">allocate_endpoint</span><span class="tok-p">():</span>
    <span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-n">get_session</span><span class="tok-p">()</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">repo</span> <span class="tok-o">=</span> <span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyRepository</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span>
        <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">],</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">],</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">],</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-p">)</span>
    <span class="tok-k">try</span><span class="tok-p">:</span>
        <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">session</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-k">except</span> <span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">,</span> <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">InvalidSku</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-n">e</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-n">jsonify</span><span class="tok-p">({</span><span class="tok-s1">&#39;message&#39;</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">)}),</span> <span class="tok-mi">400</span>  <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="tok-k">return</span> <span class="tok-n">jsonify</span><span class="tok-p">({</span><span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">:</span> <span class="tok-n">batchref</span><span class="tok-p">}),</span> <span class="tok-mi">201</span>  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We instantiate a database session and some repository objects.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We extract the user&#8217;s commands from the web request and pass them
to a domain service.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We return some JSON responses with the appropriate status codes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The responsibilities of the Flask app are just standard web stuff: per-request
session management, parsing information out of POST parameters, response status
codes, and JSON. All the orchestration logic is in the use case/service layer,
and the domain logic stays in the domain.</p>
</div>
<div class="paragraph">
<p>Finally, we can confidently strip down our E2E tests to just two, one for
the happy path and one for the unhappy path:</p>
</div>
<div id="fewer_e2e_tests" class="exampleblock">
<div class="title">E2E tests only happy and unhappy paths (test_api.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@pytest.mark.usefixtures</span><span class="tok-p">(</span><span class="tok-s1">&#39;restart_api&#39;</span><span class="tok-p">)</span>
<span class="tok-k">def</span> <span class="tok-nf">test_happy_path_returns_201_and_allocated_batch</span><span class="tok-p">(</span><span class="tok-n">add_stock</span><span class="tok-p">):</span>
    <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">othersku</span> <span class="tok-o">=</span> <span class="tok-n">random_sku</span><span class="tok-p">(),</span> <span class="tok-n">random_sku</span><span class="tok-p">(</span><span class="tok-s1">&#39;other&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">earlybatch</span> <span class="tok-o">=</span> <span class="tok-n">random_batchref</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span>
    <span class="tok-n">laterbatch</span> <span class="tok-o">=</span> <span class="tok-n">random_batchref</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span>
    <span class="tok-n">otherbatch</span> <span class="tok-o">=</span> <span class="tok-n">random_batchref</span><span class="tok-p">(</span><span class="tok-mi">3</span><span class="tok-p">)</span>
    <span class="tok-n">add_stock</span><span class="tok-p">([</span>
        <span class="tok-p">(</span><span class="tok-n">laterbatch</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-s1">&#39;2011-01-02&#39;</span><span class="tok-p">),</span>
        <span class="tok-p">(</span><span class="tok-n">earlybatch</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-s1">&#39;2011-01-01&#39;</span><span class="tok-p">),</span>
        <span class="tok-p">(</span><span class="tok-n">otherbatch</span><span class="tok-p">,</span> <span class="tok-n">othersku</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">),</span>
    <span class="tok-p">])</span>
    <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">:</span> <span class="tok-n">random_orderid</span><span class="tok-p">(),</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">:</span> <span class="tok-mi">3</span><span class="tok-p">}</span>
    <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-n">get_api_url</span><span class="tok-p">()</span>
    <span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-n">requests</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;{url}/allocate&#39;</span><span class="tok-p">,</span> <span class="tok-n">json</span><span class="tok-o">=</span><span class="tok-n">data</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">status_code</span> <span class="tok-o">==</span> <span class="tok-mi">201</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">()[</span><span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">earlybatch</span>


<span class="tok-nd">@pytest.mark.usefixtures</span><span class="tok-p">(</span><span class="tok-s1">&#39;restart_api&#39;</span><span class="tok-p">)</span>
<span class="tok-k">def</span> <span class="tok-nf">test_unhappy_path_returns_400_and_error_message</span><span class="tok-p">():</span>
    <span class="tok-n">unknown_sku</span><span class="tok-p">,</span> <span class="tok-n">orderid</span> <span class="tok-o">=</span> <span class="tok-n">random_sku</span><span class="tok-p">(),</span> <span class="tok-n">random_orderid</span><span class="tok-p">()</span>
    <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">:</span> <span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-n">unknown_sku</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">:</span> <span class="tok-mi">20</span><span class="tok-p">}</span>
    <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-n">get_api_url</span><span class="tok-p">()</span>
    <span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-n">requests</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;{url}/allocate&#39;</span><span class="tok-p">,</span> <span class="tok-n">json</span><span class="tok-o">=</span><span class="tok-n">data</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">status_code</span> <span class="tok-o">==</span> <span class="tok-mi">400</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">()[</span><span class="tok-s1">&#39;message&#39;</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">f</span><span class="tok-s1">&#39;Invalid sku {unknown_sku}&#39;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve successfully split our tests into two broad categories: tests about web
stuff, which we implement end to end; and tests about orchestration stuff, which
we can test against the service layer in memory.</p>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Exercise for the Reader</div>
<div class="paragraph">
<p>Now that we have an allocate service, why not build out a service for
<code>deallocate</code>? We&#8217;ve added <a href="https://github.com/cosmicpython/code/tree/chapter_04_service_layer_exercise">an E2E test and a few stub service-layer tests</a> for
you to get started on GitHub.</p>
</div>
<div class="paragraph">
<p>If that&#8217;s not enough, continue into the E2E tests and <em>flask_app.py</em>, and
refactor the Flask adapter to be more RESTful. Notice how doing so doesn&#8217;t
require any change to our service layer or domain layer!</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you decide you want to build a read-only endpoint for retrieving allocation
    info, just do "the simplest thing that can possibly work," which is
    <code>repo.get()</code> right in the Flask handler. We&#8217;ll talk more about reads versus
    writes in <a href="#chapter_12_cqrs">Command-Query Responsibility Segregation (CQRS)</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="why_is_everything_a_service">4.6. Why Is Everything Called a Service?</h3>
<div class="paragraph">
<p>Some of you are probably scratching your heads at this point trying to figure
out exactly what the difference is between a domain service and a service layer.</p>
</div>
<div class="paragraph">
<p>We&#8217;re sorry—we didn&#8217;t choose the names, or we&#8217;d have much cooler and friendlier
ways to talk about this stuff.</p>
</div>
<div class="paragraph">
<p>We&#8217;re using two things called a <em>service</em> in this chapter. The first is an
<em>application service</em> (our service layer). Its job is to handle requests from the
outside world and to <em>orchestrate</em> an operation. What we mean is that the
service layer <em>drives</em> the application by following a bunch of simple steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get some data from the database</p>
</li>
<li>
<p>Update the domain model</p>
</li>
<li>
<p>Persist any changes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is the kind of boring work that has to happen for every operation in your
system, and keeping it separate from business logic helps to keep things tidy.</p>
</div>
<div class="paragraph">
<p>The second type of service is a <em>domain service</em>. This is the name for a piece of
logic that belongs in the domain model but doesn&#8217;t sit naturally inside a
stateful entity or value object. For example, if you were building a shopping
cart application, you might choose to build taxation rules as a domain service.
Calculating tax is a separate job from updating the cart, and it&#8217;s an important
part of the model, but it doesn&#8217;t seem right to have a persisted entity for
the job. Instead a stateless TaxCalculator class or a <code>calculate_tax</code> function
can do the job.</p>
</div>
</div>
<div class="sect2">
<h3 id="_putting_things_in_folders_to_see_where_it_all_belongs">4.7. Putting Things in Folders to See Where It All Belongs</h3>
<div class="paragraph">
<p>As our application gets bigger, we&#8217;ll need to keep tidying our directory
structure. The layout of our project gives us useful hints about what kinds of
object we&#8217;ll find in each file.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s one way we could organize things:</p>
</div>
<div id="nested_folder_tree" class="exampleblock">
<div class="title">Some subfolders</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="text"><span></span>.
├── config.py
├── domain  <i class="conum" data-value="1"></i><b>(1)</b>
│   ├── __init__.py
│   └── model.py
├── service_layer  <i class="conum" data-value="2"></i><b>(2)</b>
│   ├── __init__.py
│   └── services.py
├── adapters  <i class="conum" data-value="3"></i><b>(3)</b>
│   ├── __init__.py
│   ├── orm.py
│   └── repository.py
├── entrypoints  <i class="conum" data-value="4"></i><b>(4)</b>
│   ├── __init__.py
│   └── flask_app.py
└── tests
    ├── __init__.py
    ├── conftest.py
    ├── unit
    │   ├── test_allocate.py
    │   ├── test_batches.py
    │   └── test_services.py
    ├── integration
    │   ├── test_orm.py
    │   └── test_repository.py
    └── e2e
        └── test_api.py</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Let&#8217;s have a folder for our domain model.  Currently that&#8217;s just one file,
but for a more complex application, you might have one file per class; you
might have helper parent classes for <code>Entity</code>, <code>ValueObject</code>, and
<code>Aggregate</code>, and you might add an <em>exceptions.py</em> for domain-layer exceptions
and, as you&#8217;ll see in <a href="#part2">Event-Driven Architecture</a>, <span class="keep-together"><em>commands.py</em></span> and <em>events.py</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We&#8217;ll distinguish the service layer. Currently that&#8217;s just one file
called <em>services.py</em> for our service-layer functions.  You could
add service-layer exceptions here, and as you&#8217;ll see in <a href="#chapter_05_high_gear_low_gear">TDD in High Gear and Low Gear</a>, we&#8217;ll add <em>unit_of_work.py</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><em>Adapters</em> is a nod to the ports and adapters terminology. This will fill
up with any other abstractions around external I/O (e.g., a <em>redis_client.py</em>).
Strictly speaking, you would call these <em>secondary</em> adapters or <em>driven</em>
adapters, or sometimes <em>inward-facing</em> adapters.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Entrypoints are the places we drive our application from. In the
official ports and adapters terminology, these are adapters too, and are
referred to as <em>primary</em>, <em>driving</em>, or <em>outward-facing</em> adapters.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>What about ports?  As you may remember, they are the abstract interfaces that the
adapters implement. We tend to keep them in the same file as the adapters that
implement them.</p>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up_3">4.8. Wrap-Up</h3>
<div class="paragraph">
<p>Adding the service layer has really bought us quite a lot:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Our Flask API endpoints become very thin and easy to write: their
only responsibility is doing "web stuff," such as parsing JSON
and producing the right HTTP codes for happy or unhappy cases.</p>
</li>
<li>
<p>We&#8217;ve defined a clear API for our domain, a set of use cases or
entrypoints that can be used by any adapter without needing to know anything
about our domain model classes&#8212;&#8203;whether that&#8217;s an API, a CLI (see
<a href="#appendix_csvs">Swapping Out the Infrastructure: <span class="keep-together">Do Everything with CSVs</span></a>), or the tests! They&#8217;re an adapter for our domain too.</p>
</li>
<li>
<p>We can write tests in "high gear" by using the service layer, leaving us
free to refactor the domain model in any way we see fit. As long as
we can still deliver the same use cases, we can experiment with new
designs without needing to rewrite a load of tests.</p>
</li>
<li>
<p>And our test pyramid is looking good&#8212;&#8203;the bulk of our tests
are fast unit tests, with just the bare minimum of E2E and integration
tests.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_the_dip_in_action">4.8.1. The DIP in Action</h4>
<div class="paragraph">
<p><a href="#service_layer_diagram_abstract_dependencies">Abstract dependencies of the service layer</a> shows the
dependencies of our service layer: the domain model
and <code>AbstractRepository</code> (the port, in ports and adapters terminology).</p>
</div>
<div class="paragraph">
<p>When we run the tests, <a href="#service_layer_diagram_test_dependencies">Tests provide an implementation of the abstract dependency</a> shows
how we implement the abstract dependencies by using <code>FakeRepository</code> (the
adapter).</p>
</div>
<div class="paragraph">
<p>And when we actually run our app, we swap in the "real" dependency shown in
<a href="#service_layer_diagram_runtime_dependencies">Dependencies at runtime</a>.</p>
</div>
<div id="service_layer_diagram_abstract_dependencies" class="imageblock width-75">
<div class="content">
<img src="images/apwp_0403.png" alt="apwp 0403">
</div>
<div class="title">Figure 18. Abstract dependencies of the service layer</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[ditaa, apwp_0403]
        +-----------------------------+
        |         Service Layer       |
        +-----------------------------+
           |                   |
           |                   | depends on abstraction
           V                   V
+------------------+     +--------------------+
|   Domain Model   |     | AbstractRepository |
|                  |     |       (Port)       |
+------------------+     +--------------------+</pre>
</div>
</div>
<div id="service_layer_diagram_test_dependencies" class="imageblock width-75">
<div class="content">
<img src="images/apwp_0404.png" alt="apwp 0404">
</div>
<div class="title">Figure 19. Tests provide an implementation of the abstract dependency</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[ditaa, apwp_0404]
        +-----------------------------+
        |           Tests             |-------------\
        +-----------------------------+             |
                       |                            |
                       V                            |
        +-----------------------------+             |
        |         Service Layer       |    provides |
        +-----------------------------+             |
           |                     |                  |
           V                     V                  |
+------------------+     +--------------------+     |
|   Domain Model   |     | AbstractRepository |     |
+------------------+     +--------------------+     |
                                    ^               |
                         implements |               |
                                    |               |
                         +----------------------+   |
                         |    FakeRepository    |&lt;--/
                         |     (in–memory)      |
                         +----------------------+</pre>
</div>
</div>
<div id="service_layer_diagram_runtime_dependencies" class="imageblock width-75">
<div class="content">
<img src="images/apwp_0405.png" alt="apwp 0405">
</div>
<div class="title">Figure 20. Dependencies at runtime</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[ditaa, apwp_0405]
       +--------------------------------+
       | Flask API (Presentation Layer) |-----------\
       +--------------------------------+           |
                       |                            |
                       V                            |
        +-----------------------------+             |
        |         Service Layer       |             |
        +-----------------------------+             |
           |                     |                  |
           V                     V                  |
+------------------+     +--------------------+     |
|   Domain Model   |     | AbstractRepository |     |
+------------------+     +--------------------+     |
              ^                     ^               |
              |                     |               |
       gets   |          +----------------------+   |
       model  |          | SqlAlchemyRepository |&lt;--/
   definitions|          +----------------------+
       from   |                | uses
              |                V
           +-----------------------+
           |          ORM          |
           | (another abstraction) |
           +-----------------------+
                       |
                       | talks to
                       V
           +------------------------+
           |       Database         |
           +------------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>Wonderful.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s pause for <a href="#chapter_04_service_layer_tradeoffs">Service layer: the trade-offs</a>,
in which we consider the pros and cons of having a service layer at all.</p>
</div>
<table id="chapter_04_service_layer_tradeoffs" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Service layer: the trade-offs</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pros</th>
<th class="tableblock halign-left valign-top">Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>We have a single place to capture all the use cases for our application.</p>
</li>
<li>
<p>We&#8217;ve placed our clever domain logic behind an API, which leaves us free to
refactor.</p>
</li>
<li>
<p>We have cleanly separated "stuff that talks HTTP" from "stuff that talks
allocation."</p>
</li>
<li>
<p>When combined with the Repository pattern and <code>FakeRepository</code>, we have
a nice way of writing tests at a higher level than the domain layer;
we can test more of our workflow without needing to use integration tests
(read on to <a href="#chapter_05_high_gear_low_gear">TDD in High Gear and Low Gear</a> for more elaboration on this).</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>If your app is <em>purely</em> a web app, your controllers/view functions can be
the single place to capture all the use cases.</p>
</li>
<li>
<p>It&#8217;s yet another layer of abstraction.</p>
</li>
<li>
<p>Putting too much logic into the service layer can lead to the <em>Anemic Domain</em>
anti-pattern. It&#8217;s better to introduce this layer after you spot orchestration
logic creeping into your controllers.</p>
</li>
<li>
<p>You can get a lot of the benefits that come from having rich domain models
by simply pushing logic out of your controllers and down to the model layer,
without needing to add an extra layer in between (aka "fat models, thin
controllers").</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>But there are still some bits of awkwardness to tidy up:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The service layer is still tightly coupled to the domain, because
its API is expressed in terms of <code>OrderLine</code> objects. In
<a href="#chapter_05_high_gear_low_gear">TDD in High Gear and Low Gear</a>, we&#8217;ll fix that and talk about
the way that the service layer enables more productive TDD.</p>
</li>
<li>
<p>The service layer is tightly coupled to a <code>session</code> object. In <a href="#chapter_06_uow">Unit of Work Pattern</a>,
we&#8217;ll introduce one more pattern that works closely with the Repository and
Service Layer patterns, the Unit of Work pattern, and everything will be absolutely lovely.
You&#8217;ll see!</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_05_high_gear_low_gear">5. TDD in High Gear and Low Gear</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ve introduced the service layer to capture some of the additional
orchestration responsibilities we need from a working application. The service layer helps us
clearly define our use cases and the workflow for each: what
we need to get from our repositories, what pre-checks and current state
validation we should do, and what we save at the end.</p>
</div>
<div class="paragraph">
<p>But currently, many of our unit tests operate at a lower level, acting
directly on the model. In this chapter we&#8217;ll discuss the trade-offs
involved in moving those tests up to the service-layer level, and
some more general testing guidelines.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Harry Says: Seeing a Test Pyramid in Action Was a Light-Bulb Moment</div>
<div class="paragraph">
<p>Here are a few words from Harry directly:</p>
</div>
<div class="paragraph">
<p><em>I was initially skeptical of all Bob&#8217;s architectural patterns, but seeing
an actual test pyramid made me a convert.</em></p>
</div>
<div class="paragraph">
<p><em>Once you implement domain modeling and the service layer, you really actually can
get to a stage where unit tests outnumber integration and end-to-end tests by
an order of magnitude.  Having worked in places where the E2E test build would
take hours ("wait &#x27;til tomorrow," essentially), I can&#8217;t tell you what a
difference it makes to be able to run all your tests in minutes or seconds.</em></p>
</div>
<div class="paragraph">
<p><em>Read on for some guidelines on how to decide what kinds of tests to write
and at which level. The high gear versus low gear way of thinking really changed
my testing life.</em></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_is_our_test_pyramid_looking">5.1. How Is Our Test Pyramid Looking?</h3>
<div class="paragraph">
<p>Let&#8217;s see what this move to using a service layer, with its own service-layer tests,
does to our test pyramid:</p>
</div>
<div id="test_pyramid" class="exampleblock">
<div class="title">Counting types of tests</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span>$ grep -c test_ test_*.py
tests/unit/test_allocate.py:4
tests/unit/test_batches.py:8
tests/unit/test_services.py:3

tests/integration/test_orm.py:6
tests/integration/test_repository.py:2

tests/e2e/test_api.py:2</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Not bad! We have 15 unit tests, 8 integration tests, and just 2 end-to-end tests.  That&#8217;s
already a healthy-looking test pyramid.</p>
</div>
</div>
<div class="sect2">
<h3 id="_should_domain_layer_tests_move_to_the_service_layer">5.2. Should Domain Layer Tests Move to the Service Layer?</h3>
<div class="paragraph">
<p>Let&#8217;s see what happens if we take this a step further. Since we can test our
software against the service layer, we don&#8217;t really need tests for the domain
model anymore. Instead, we could rewrite all of the domain-level tests from
<a href="#chapter_01_domain_model">Domain Modeling</a> in terms of the service layer:</p>
</div>
<div class="exampleblock">
<div class="title">Rewriting a domain test at the service layer (tests/unit/test_services.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-c1"># domain-layer test:</span>
<span class="tok-k">def</span> <span class="tok-nf">test_prefers_current_stock_batches_to_shipments</span><span class="tok-p">():</span>
    <span class="tok-n">in_stock_batch</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;in-stock-batch&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;RETRO-CLOCK&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">)</span>
    <span class="tok-n">shipment_batch</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;shipment-batch&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;RETRO-CLOCK&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">tomorrow</span><span class="tok-p">)</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s2">&quot;oref&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;RETRO-CLOCK&quot;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>

    <span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-n">in_stock_batch</span><span class="tok-p">,</span> <span class="tok-n">shipment_batch</span><span class="tok-p">])</span>

    <span class="tok-k">assert</span> <span class="tok-n">in_stock_batch</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">90</span>
    <span class="tok-k">assert</span> <span class="tok-n">shipment_batch</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">100</span>


<span class="tok-c1"># service-layer test:</span>
<span class="tok-k">def</span> <span class="tok-nf">test_prefers_warehouse_batches_to_shipments</span><span class="tok-p">():</span>
    <span class="tok-n">in_stock_batch</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;in-stock-batch&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;RETRO-CLOCK&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">)</span>
    <span class="tok-n">shipment_batch</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;shipment-batch&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;RETRO-CLOCK&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">tomorrow</span><span class="tok-p">)</span>
    <span class="tok-n">repo</span> <span class="tok-o">=</span> <span class="tok-n">FakeRepository</span><span class="tok-p">([</span><span class="tok-n">in_stock_batch</span><span class="tok-p">,</span> <span class="tok-n">shipment_batch</span><span class="tok-p">])</span>
    <span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-n">FakeSession</span><span class="tok-p">()</span>

    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s1">&#39;oref&#39;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;RETRO-CLOCK&quot;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>

    <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">session</span><span class="tok-p">)</span>

    <span class="tok-k">assert</span> <span class="tok-n">in_stock_batch</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">90</span>
    <span class="tok-k">assert</span> <span class="tok-n">shipment_batch</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">100</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Why would we want to do that?</p>
</div>
<div class="paragraph">
<p>Tests are supposed to help us change our system fearlessly, but often
we see teams writing too many tests against their domain model. This causes
problems when they come to change their codebase and find that they need to
update tens or even hundreds of unit tests.</p>
</div>
<div class="paragraph">
<p>This makes sense if you stop to think about the purpose of automated tests. We
use tests to enforce that a property of the system doesn&#8217;t change while we&#8217;re
working. We use tests to check that the API continues to return 200, that the
database session continues to commit, and that orders are still being allocated.</p>
</div>
<div class="paragraph">
<p>If we accidentally change one of those behaviors, our tests will break. The
flip side, though, is that if we want to change the design of our code, any
tests relying directly on that code will also fail.</p>
</div>
<div class="paragraph">
<p>As we get further into the book, you&#8217;ll see how the service layer forms an API
for our system that we can drive in multiple ways. Testing against this API
reduces the amount of code that we need to change when we refactor our domain
model. If we restrict ourselves to testing only against the service layer,
we won&#8217;t have any tests that directly interact with "private" methods or
attributes on our model objects, which leaves us freer to refactor them.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Every line of code that we put in a test is like a blob of glue, holding
    the system in a particular shape. The more low-level tests we have, the
    harder it will be to change things.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="kinds_of_tests">5.3. On Deciding What Kind of Tests to Write</h3>
<div class="paragraph">
<p>You might be asking yourself, "Should I rewrite all my unit tests, then? Is it
wrong to write tests against the domain model?" To answer those questions, it&#8217;s
important to understand the trade-off between coupling and design feedback (see
<a href="#test_spectrum_diagram">The test spectrum</a>).</p>
</div>
<div id="test_spectrum_diagram" class="imageblock">
<div class="content">
<img src="images/apwp_0501.png" alt="apwp 0501">
</div>
<div class="title">Figure 21. The test spectrum</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[ditaa, apwp_0501]
| Low feedback                                                   High feedback |
| Low barrier to change                                 High barrier to change |
| High system coverage                                        Focused coverage |
|                                                                              |
| &lt;---------                                                       ----------&gt; |
|                                                                              |
| API Tests                  Service–Layer Tests                  Domain Tests |</pre>
</div>
</div>
<div class="paragraph">
<p>Extreme programming (XP) exhorts us to "listen to the code." When we&#8217;re writing
tests, we might find that the code is hard to use or notice a code smell. This
is a trigger for us to refactor, and to reconsider our design.</p>
</div>
<div class="paragraph">
<p>We only get that feedback, though, when we&#8217;re working closely with the target
code. A test for the HTTP API tells us nothing about the fine-grained design of
our objects, because it sits at a much higher level of abstraction.</p>
</div>
<div class="paragraph">
<p>On the other hand, we can rewrite our entire application and, so long as we
don&#8217;t change the URLs or request formats, our HTTP tests will continue to pass.
This gives us confidence that large-scale changes, like changing the database schema,
haven&#8217;t broken our code.</p>
</div>
<div class="paragraph">
<p>At the other end of the spectrum, the tests we wrote in <a href="#chapter_01_domain_model">Domain Modeling</a> helped us to
flesh out our understanding of the objects we need. The tests guided us to a
design that makes sense and reads in the domain language. When our tests read
in the domain language, we feel comfortable that our code matches our intuition
about the problem we&#8217;re trying to solve.</p>
</div>
<div class="paragraph">
<p>Because the tests are written in the domain language, they act as living
documentation for our model. A new team member can read these tests to quickly
understand how the system works and how the core concepts interrelate.</p>
</div>
<div class="paragraph">
<p>We often "sketch" new behaviors by writing tests at this level to see how the
code might look. When we want to improve the design of the code, though, we will need to replace
or delete these tests, because they are tightly coupled to a particular
<span class="keep-together">implementation</span>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_high_and_low_gear">5.4. High and Low Gear</h3>
<div class="paragraph">
<p>Most of the time, when we are adding a new feature or fixing a bug, we don&#8217;t
need to make extensive changes to the domain model. In these cases, we prefer
to write tests against services because of the lower coupling and higher coverage.</p>
</div>
<div class="paragraph">
<p>For example, when writing an <code>add_stock</code> function or a <code>cancel_order</code> feature,
we can work more quickly and with less coupling by writing tests against the
service layer.</p>
</div>
<div class="paragraph">
<p>When starting a new project or when hitting a particularly gnarly problem,
we will drop back down to writing tests against the domain model so we
get better feedback and executable documentation of our intent.</p>
</div>
<div class="paragraph">
<p>The metaphor we use is that of shifting gears. When starting a journey, the
bicycle needs to be in a low gear so that it can overcome inertia. Once we&#8217;re off
and running, we can go faster and more efficiently by changing into a high gear;
but if we suddenly encounter a steep hill or are forced to slow down by a
hazard, we again drop down to a low gear until we can pick up speed again.</p>
</div>
</div>
<div class="sect2">
<h3 id="primitive_obsession">5.5. Fully Decoupling the Service-Layer Tests from the Domain</h3>
<div class="paragraph">
<p>We still have direct dependencies on the domain in our service-layer
tests, because we use domain objects to set up our test data and to invoke
our service-layer functions.</p>
</div>
<div class="paragraph">
<p>To have a service layer that&#8217;s fully decoupled from the domain, we need to
rewrite its API to work in terms of primitives.</p>
</div>
<div class="paragraph">
<p>Our service layer currently takes an <code>OrderLine</code> domain object:</p>
</div>
<div id="service_domain" class="exampleblock">
<div class="title">Before: allocate takes a domain object (service_layer/services.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">:</span> <span class="tok-n">AbstractRepository</span><span class="tok-p">,</span> <span class="tok-n">session</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>How would it look if its parameters were all primitive types?</p>
</div>
<div id="service_takes_primitives" class="exampleblock">
<div class="title">After: allocate takes strings and ints (service_layer/services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span>
        <span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">:</span> <span class="tok-n">AbstractRepository</span><span class="tok-p">,</span> <span class="tok-n">session</span>
<span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We rewrite the tests in those terms as well:</p>
</div>
<div id="tests_call_with_primitives" class="exampleblock">
<div class="title">Tests now use primitives in function call (tests/unit/test_services.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_returns_allocation</span><span class="tok-p">():</span>
    <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;COMPLICATED-LAMP&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">)</span>
    <span class="tok-n">repo</span> <span class="tok-o">=</span> <span class="tok-n">FakeRepository</span><span class="tok-p">([</span><span class="tok-n">batch</span><span class="tok-p">])</span>

    <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-s2">&quot;o1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;COMPLICATED-LAMP&quot;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">FakeSession</span><span class="tok-p">())</span>
    <span class="tok-k">assert</span> <span class="tok-n">result</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;batch1&quot;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But our tests still depend on the domain, because we still manually instantiate
<code>Batch</code> objects.  So, if one day we decide to massively refactor how our <code>Batch</code>
model works, we&#8217;ll have to change a bunch of tests.</p>
</div>
<div class="sect3">
<h4 id="_mitigation_keep_all_domain_dependencies_in_fixture_functions">5.5.1. Mitigation: Keep All Domain Dependencies in Fixture Functions</h4>
<div class="paragraph">
<p>We could at least abstract that out to a helper function or a fixture
in our tests.  Here&#8217;s one way you could do that, adding a factory
function on <code>FakeRepository</code>:</p>
</div>
<div id="services_factory_function" class="exampleblock">
<div class="title">Factory functions for fixtures are one possibility (tests/unit/test_services.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">FakeRepository</span><span class="tok-p">(</span><span class="tok-nb">set</span><span class="tok-p">):</span>

    <span class="tok-nd">@staticmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">for_batch</span><span class="tok-p">(</span><span class="tok-n">ref</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">FakeRepository</span><span class="tok-p">([</span>
            <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-n">ref</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-p">),</span>
        <span class="tok-p">])</span>

    <span class="tok-o">...</span>


<span class="tok-k">def</span> <span class="tok-nf">test_returns_allocation</span><span class="tok-p">():</span>
    <span class="tok-n">repo</span> <span class="tok-o">=</span> <span class="tok-n">FakeRepository</span><span class="tok-o">.</span><span class="tok-n">for_batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;COMPLICATED-LAMP&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">)</span>
    <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-s2">&quot;o1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;COMPLICATED-LAMP&quot;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">FakeSession</span><span class="tok-p">())</span>
    <span class="tok-k">assert</span> <span class="tok-n">result</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;batch1&quot;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>At least that would move all of our tests' dependencies on the domain
into one place.</p>
</div>
</div>
<div class="sect3">
<h4 id="_adding_a_missing_service">5.5.2. Adding a Missing Service</h4>
<div class="paragraph">
<p>We could go one step further, though. If we had a service to add stock,
we could use that and make our service-layer tests fully expressed
in terms of the service layer&#8217;s official use cases, removing all dependencies
on the domain:</p>
</div>
<div id="test_add_batch" class="exampleblock">
<div class="title">Test for new add_batch service (tests/unit/test_services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_add_batch</span><span class="tok-p">():</span>
    <span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-n">FakeRepository</span><span class="tok-p">([]),</span> <span class="tok-n">FakeSession</span><span class="tok-p">()</span>
    <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">add_batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;b1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;CRUNCHY-ARMCHAIR&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">session</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">repo</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;b1&quot;</span><span class="tok-p">)</span> <span class="tok-ow">is</span> <span class="tok-ow">not</span> <span class="tok-bp">None</span>
    <span class="tok-k">assert</span> <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">committed</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In general, if you find yourself needing to do domain-layer stuff directly
    in your service-layer tests, it may be an indication that your service
    layer is incomplete.
</td>
</tr>
</table>
</div>
<div class="paragraph pagebreak-before">
<p>And the implementation is just two lines:</p>
</div>
<div id="add_batch_service" class="exampleblock">
<div class="title">A new service for add_batch (service_layer/services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">add_batch</span><span class="tok-p">(</span>
        <span class="tok-n">ref</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-p">:</span> <span class="tok-n">Optional</span><span class="tok-p">[</span><span class="tok-n">date</span><span class="tok-p">],</span>
        <span class="tok-n">repo</span><span class="tok-p">:</span> <span class="tok-n">AbstractRepository</span><span class="tok-p">,</span> <span class="tok-n">session</span><span class="tok-p">,</span>
<span class="tok-p">):</span>
    <span class="tok-n">repo</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-n">ref</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-p">))</span>
    <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>


<span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span>
        <span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">:</span> <span class="tok-n">AbstractRepository</span><span class="tok-p">,</span> <span class="tok-n">session</span>
<span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
    <span class="tok-o">...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Should you write a new service just because it would help remove
    dependencies from your tests?  Probably not.  But in this case, we
    almost definitely would need an <code>add_batch</code> service one day <span class="keep-together">anyway</span>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That now allows us to rewrite <em>all</em> of our service-layer tests purely
in terms of the services themselves, using only primitives, and without
any dependencies on the model:</p>
</div>
<div id="services_tests_all_services" class="exampleblock">
<div class="title">Services tests now use only services (tests/unit/test_services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_allocate_returns_allocation</span><span class="tok-p">():</span>
    <span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-n">FakeRepository</span><span class="tok-p">([]),</span> <span class="tok-n">FakeSession</span><span class="tok-p">()</span>
    <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">add_batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;COMPLICATED-LAMP&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">session</span><span class="tok-p">)</span>
    <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-s2">&quot;o1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;COMPLICATED-LAMP&quot;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">session</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">result</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;batch1&quot;</span>


<span class="tok-k">def</span> <span class="tok-nf">test_allocate_errors_for_invalid_sku</span><span class="tok-p">():</span>
    <span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-n">FakeRepository</span><span class="tok-p">([]),</span> <span class="tok-n">FakeSession</span><span class="tok-p">()</span>
    <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">add_batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;b1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;AREALSKU&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">session</span><span class="tok-p">)</span>

    <span class="tok-k">with</span> <span class="tok-n">pytest</span><span class="tok-o">.</span><span class="tok-n">raises</span><span class="tok-p">(</span><span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">InvalidSku</span><span class="tok-p">,</span> <span class="tok-n">match</span><span class="tok-o">=</span><span class="tok-s2">&quot;Invalid sku NONEXISTENTSKU&quot;</span><span class="tok-p">):</span>
        <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-s2">&quot;o1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;NONEXISTENTSKU&quot;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">FakeSession</span><span class="tok-p">())</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is a really nice place to be in.  Our service-layer tests depend on only
the service layer itself, leaving us completely free to refactor the model as
we see fit.</p>
</div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_carrying_the_improvement_through_to_the_e2e_tests">5.6. Carrying the Improvement Through to the E2E Tests</h3>
<div class="paragraph">
<p>In the same way that adding <code>add_batch</code> helped decouple our service-layer
tests from the model, adding an API endpoint to add a batch would remove
the need for the ugly <code>add_stock</code> fixture, and our E2E tests could be free
of those hardcoded SQL queries and the direct dependency on the database.</p>
</div>
<div class="paragraph">
<p>Thanks to our service function, adding the endpoint is easy, with just a little
JSON wrangling and a single function call required:</p>
</div>
<div id="api_for_add_batch" class="exampleblock">
<div class="title">API for adding a batch (entrypoints/flask_app.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@app.route</span><span class="tok-p">(</span><span class="tok-s2">&quot;/add_batch&quot;</span><span class="tok-p">,</span> <span class="tok-n">methods</span><span class="tok-o">=</span><span class="tok-p">[</span><span class="tok-s1">&#39;POST&#39;</span><span class="tok-p">])</span>
<span class="tok-k">def</span> <span class="tok-nf">add_batch</span><span class="tok-p">():</span>
    <span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-n">get_session</span><span class="tok-p">()</span>
    <span class="tok-n">repo</span> <span class="tok-o">=</span> <span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyRepository</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">)</span>
    <span class="tok-n">eta</span> <span class="tok-o">=</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;eta&#39;</span><span class="tok-p">]</span>
    <span class="tok-k">if</span> <span class="tok-n">eta</span> <span class="tok-ow">is</span> <span class="tok-ow">not</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
        <span class="tok-n">eta</span> <span class="tok-o">=</span> <span class="tok-n">datetime</span><span class="tok-o">.</span><span class="tok-n">fromisoformat</span><span class="tok-p">(</span><span class="tok-n">eta</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">date</span><span class="tok-p">()</span>
    <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">add_batch</span><span class="tok-p">(</span>
        <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;ref&#39;</span><span class="tok-p">],</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">],</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">],</span> <span class="tok-n">eta</span><span class="tok-p">,</span>
        <span class="tok-n">repo</span><span class="tok-p">,</span> <span class="tok-n">session</span>
    <span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-s1">&#39;OK&#39;</span><span class="tok-p">,</span> <span class="tok-mi">201</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Are you thinking to yourself, POST to <em>/add_batch</em>? That&#8217;s not
    very RESTful!  You&#8217;re quite right.  We&#8217;re being happily sloppy, but
    if you&#8217;d like to make it all more RESTy, maybe a POST to <em>/batches</em>,
    then knock yourself out!  Because Flask is a thin adapter, it&#8217;ll be
    easy. See <a href="#types_of_test_rules_of_thumb">the next sidebar</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And our hardcoded SQL queries from <em>conftest.py</em> get replaced with some
API calls, meaning the API tests have no dependencies other than the API,
which is also nice:</p>
</div>
<div id="api_tests_with_no_sql" class="exampleblock">
<div class="title">API tests can now add their own batches (tests/e2e/test_api.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">post_to_add_batch</span><span class="tok-p">(</span><span class="tok-n">ref</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-p">):</span>
    <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-n">get_api_url</span><span class="tok-p">()</span>
    <span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-n">requests</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span>
        <span class="tok-n">f</span><span class="tok-s1">&#39;{url}/add_batch&#39;</span><span class="tok-p">,</span>
        <span class="tok-n">json</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s1">&#39;ref&#39;</span><span class="tok-p">:</span> <span class="tok-n">ref</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">:</span> <span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-s1">&#39;eta&#39;</span><span class="tok-p">:</span> <span class="tok-n">eta</span><span class="tok-p">}</span>
    <span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">status_code</span> <span class="tok-o">==</span> <span class="tok-mi">201</span>


<span class="tok-nd">@pytest.mark.usefixtures</span><span class="tok-p">(</span><span class="tok-s1">&#39;postgres_db&#39;</span><span class="tok-p">)</span>
<span class="tok-nd">@pytest.mark.usefixtures</span><span class="tok-p">(</span><span class="tok-s1">&#39;restart_api&#39;</span><span class="tok-p">)</span>
<span class="tok-k">def</span> <span class="tok-nf">test_happy_path_returns_201_and_allocated_batch</span><span class="tok-p">():</span>
    <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">othersku</span> <span class="tok-o">=</span> <span class="tok-n">random_sku</span><span class="tok-p">(),</span> <span class="tok-n">random_sku</span><span class="tok-p">(</span><span class="tok-s1">&#39;other&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">earlybatch</span> <span class="tok-o">=</span> <span class="tok-n">random_batchref</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span>
    <span class="tok-n">laterbatch</span> <span class="tok-o">=</span> <span class="tok-n">random_batchref</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span>
    <span class="tok-n">otherbatch</span> <span class="tok-o">=</span> <span class="tok-n">random_batchref</span><span class="tok-p">(</span><span class="tok-mi">3</span><span class="tok-p">)</span>
    <span class="tok-n">post_to_add_batch</span><span class="tok-p">(</span><span class="tok-n">laterbatch</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-s1">&#39;2011-01-02&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">post_to_add_batch</span><span class="tok-p">(</span><span class="tok-n">earlybatch</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-s1">&#39;2011-01-01&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">post_to_add_batch</span><span class="tok-p">(</span><span class="tok-n">otherbatch</span><span class="tok-p">,</span> <span class="tok-n">othersku</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">)</span>
    <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">:</span> <span class="tok-n">random_orderid</span><span class="tok-p">(),</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">:</span> <span class="tok-mi">3</span><span class="tok-p">}</span>
    <span class="tok-n">url</span> <span class="tok-o">=</span> <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-n">get_api_url</span><span class="tok-p">()</span>
    <span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-n">requests</span><span class="tok-o">.</span><span class="tok-n">post</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;{url}/allocate&#39;</span><span class="tok-p">,</span> <span class="tok-n">json</span><span class="tok-o">=</span><span class="tok-n">data</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">status_code</span> <span class="tok-o">==</span> <span class="tok-mi">201</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">()[</span><span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">earlybatch</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up_4">5.7. Wrap-Up</h3>
<div class="paragraph">
<p>Once you have a service layer in place, you really can move the majority
of your test coverage to unit tests and develop a healthy test pyramid.</p>
</div>
<div id="types_of_test_rules_of_thumb" class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Recap: Rules of Thumb for Different Types of Test</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Aim for one end-to-end test per feature</dt>
<dd>
<p>This might be written against an HTTP API, for example.  The objective
is to demonstrate that the feature works, and that all the moving parts
are glued together correctly.</p>
</dd>
<dt class="hdlist1">Write the bulk of your tests against the service layer</dt>
<dd>
<p>    These edge-to-edge tests offer a good trade-off between coverage,
    runtime, and efficiency. Each test tends to cover one code path of a
    feature and use fakes for I/O. This is the place to exhaustively
    cover all the edge cases and the ins and outs of your business logic.<sup class="footnote">[<a id="_footnoteref_22" class="footnote" href="#_footnotedef_22" title="View footnote.">22</a>]</sup></p>
</dd>
<dt class="hdlist1">Maintain a small core of tests written against your domain model</dt>
<dd>
<p>These tests have highly focused coverage and are more brittle, but they have
the highest feedback. Don&#8217;t be afraid to delete these tests if the
functionality is later covered by tests at the service layer.</p>
</dd>
<dt class="hdlist1">Error handling counts as a feature</dt>
<dd>
<p>Ideally, your application will be structured such that all errors that
bubble up to your entrypoints (e.g., Flask) are handled in the same way.
This means you need to test only the happy path for each feature, and to
reserve one end-to-end test for all unhappy paths (and many unhappy path
unit tests, of course).</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>A few
things will help along the way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Express your service layer in terms of primitives rather than domain objects.</p>
</li>
<li>
<p>In an ideal world, you&#8217;ll have all the services you need to be able to test
entirely against the service layer, rather than hacking state via
repositories or the database. This pays off in your end-to-end tests as well.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Onto the next chapter!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_06_uow">6. Unit of Work Pattern</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we&#8217;ll introduce the final piece of the puzzle that ties
together the Repository and Service Layer patterns: the <em>Unit of Work</em> pattern.</p>
</div>
<div class="paragraph">
<p>If the Repository pattern is our abstraction over the idea of persistent storage,
the Unit of Work (UoW) pattern is our abstraction over the idea of <em>atomic operations</em>. It
will allow us to finally and fully decouple our service layer from the data layer.</p>
</div>
<div class="paragraph">
<p><a href="#before_uow_diagram">Without UoW: API talks directly to three layers</a> shows that, currently, a lot of communication occurs
across the layers of our infrastructure: the API talks directly to the database
layer to start a session, it talks to the repository layer to initialize
<code>SQLAlchemyRepository</code>, and it talks to the service layer to ask it to allocate.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The code for this chapter is in the
chapter_06_uow branch <a href="https://oreil.ly/MoWdZ">on <span class="keep-together">GitHub</span></a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/cosmicpython/code.git
cd code
git checkout chapter_06_uow
# or to code along, checkout Chapter 4:
git checkout chapter_04_service_layer</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div id="before_uow_diagram" class="imageblock width-75">
<div class="content">
<img src="images/apwp_0601.png" alt="apwp 0601">
</div>
<div class="title">Figure 22. Without UoW: API talks directly to three layers</div>
</div>
<div class="paragraph">
<p><a href="#after_uow_diagram">With UoW: UoW now manages database state</a> shows our target state. The Flask API now does only two
things: it initializes a unit of work, and it invokes a service. The service
collaborates with the UoW (we like to think of the UoW as being part of the
service layer), but neither the service function itself nor Flask now needs
to talk directly to the database.</p>
</div>
<div class="paragraph">
<p>And we&#8217;ll do it all using a lovely piece of Python syntax, a context manager.</p>
</div>
<div id="after_uow_diagram" class="imageblock width-75">
<div class="content">
<img src="images/apwp_0602.png" alt="apwp 0602">
</div>
<div class="title">Figure 23. With UoW: UoW now manages database state</div>
</div>
<div class="sect2">
<h3 id="_the_unit_of_work_collaborates_with_the_repository">6.1. The Unit of Work Collaborates with the Repository</h3>
<div class="paragraph">
<p>Let&#8217;s see the unit of work (or UoW, which we pronounce "you-wow") in action. Here&#8217;s how the service layer will look when we&#8217;re finished:</p>
</div>
<div id="uow_preview" class="exampleblock">
<div class="title">Preview of unit of work in action (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span>
        <span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span>
        <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>
<span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">)</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">list</span><span class="tok-p">()</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-o">...</span>
        <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">)</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We&#8217;ll start a UoW as a context manager.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>uow.batches</code> is the batches repo, so the UoW provides us
access to our permanent storage.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When we&#8217;re done, we commit or roll back our work, using the UoW.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The UoW acts as a single entrypoint to our persistent storage, and it
 keeps track of what objects were loaded and of the latest state.<sup class="footnote">[<a id="_footnoteref_23" class="footnote" href="#_footnotedef_23" title="View footnote.">23</a>]</sup></p>
</div>
<div class="paragraph">
<p>This gives us three useful things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A stable snapshot of the database to work with, so the
objects we use aren&#8217;t changing halfway through an operation</p>
</li>
<li>
<p>A way to persist all of our changes at once, so if something
goes wrong, we don&#8217;t end up in an inconsistent state</p>
</li>
<li>
<p>A simple API to our persistence concerns and a handy place
to get a repository</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_test_driving_a_uow_with_integration_tests">6.2. Test-Driving a UoW with Integration Tests</h3>
<div class="paragraph">
<p>Here are our integration tests for the UOW:</p>
</div>
<div id="test_unit_of_work" class="exampleblock">
<div class="title">A basic "round-trip" test for a UoW (tests/integration/test_uow.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_uow_can_retrieve_a_batch_and_allocate_to_it</span><span class="tok-p">(</span><span class="tok-n">session_factory</span><span class="tok-p">):</span>
    <span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-n">session_factory</span><span class="tok-p">()</span>
    <span class="tok-n">insert_batch</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">,</span> <span class="tok-s1">&#39;batch1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;HIPSTER-WORKBENCH&#39;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">)</span>
    <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>

    <span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">session_factory</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">reference</span><span class="tok-o">=</span><span class="tok-s1">&#39;batch1&#39;</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s1">&#39;o1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;HIPSTER-WORKBENCH&#39;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>
        <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>  <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">get_allocated_batch_ref</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">,</span> <span class="tok-s1">&#39;o1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;HIPSTER-WORKBENCH&#39;</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">batchref</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;batch1&#39;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We initialize the UoW by using our custom session factory
and get back a <code>uow</code> object to use in our <code>with</code> block.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The UoW gives us access to the batches repository via
<code>uow.batches</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We call <code>commit()</code> on it when we&#8217;re done.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For the curious, the <code>insert_batch</code> and <code>get_allocated_batch_ref</code> helpers
look like this:</p>
</div>
<div id="sql_helpers" class="exampleblock">
<div class="title">Helpers for doing SQL stuff (tests/integration/test_uow.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">insert_batch</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">,</span> <span class="tok-n">ref</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-p">):</span>
    <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span>
        <span class="tok-s1">&#39;INSERT INTO batches (reference, sku, _purchased_quantity, eta)&#39;</span>
        <span class="tok-s1">&#39; VALUES (:ref, :sku, :qty, :eta)&#39;</span><span class="tok-p">,</span>
        <span class="tok-nb">dict</span><span class="tok-p">(</span><span class="tok-n">ref</span><span class="tok-o">=</span><span class="tok-n">ref</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">eta</span><span class="tok-p">)</span>
    <span class="tok-p">)</span>


<span class="tok-k">def</span> <span class="tok-nf">get_allocated_batch_ref</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">,</span> <span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">):</span>
    <span class="tok-p">[[</span><span class="tok-n">orderlineid</span><span class="tok-p">]]</span> <span class="tok-o">=</span> <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span>
        <span class="tok-s1">&#39;SELECT id FROM order_lines WHERE orderid=:orderid AND sku=:sku&#39;</span><span class="tok-p">,</span>
        <span class="tok-nb">dict</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-o">=</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">)</span>
    <span class="tok-p">)</span>
    <span class="tok-p">[[</span><span class="tok-n">batchref</span><span class="tok-p">]]</span> <span class="tok-o">=</span> <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span>
        <span class="tok-s1">&#39;SELECT b.reference FROM allocations JOIN batches AS b ON batch_id = b.id&#39;</span>
        <span class="tok-s1">&#39; WHERE orderline_id=:orderlineid&#39;</span><span class="tok-p">,</span>
        <span class="tok-nb">dict</span><span class="tok-p">(</span><span class="tok-n">orderlineid</span><span class="tok-o">=</span><span class="tok-n">orderlineid</span><span class="tok-p">)</span>
    <span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">batchref</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_unit_of_work_and_its_context_manager">6.3. Unit of Work and Its Context Manager</h3>
<div class="paragraph">
<p>In our tests we&#8217;ve implicitly defined an interface for what a UoW needs to do. Let&#8217;s make that explicit by using an abstract
base class:</p>
</div>
<div id="abstract_unit_of_work" class="exampleblock">
<div class="title">Abstract UoW context manager (src/allocation/service_layer/unit_of_work.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">AbstractUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">abc</span><span class="tok-o">.</span><span class="tok-n">ABC</span><span class="tok-p">):</span>
    <span class="tok-n">batches</span><span class="tok-p">:</span> <span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">AbstractRepository</span>  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-k">def</span> <span class="tok-fm">__exit__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rollback</span><span class="tok-p">()</span>  <i class="conum" data-value="4"></i><b>(4)</b>

    <span class="tok-nd">@abc.abstractmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">commit</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-k">raise</span> <span class="tok-ne">NotImplementedError</span>

    <span class="tok-nd">@abc.abstractmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">rollback</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>  <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-k">raise</span> <span class="tok-ne">NotImplementedError</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The UoW provides an attribute called <code>.batches</code>, which will give us access
to the batches repository.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If you&#8217;ve never seen a context manager, <code>__enter__</code> and <code>__exit__</code> are
the two magic methods that execute when we enter the <code>with</code> block and
when we exit it, respectively. They&#8217;re our setup and teardown phases.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We&#8217;ll call this method to explicitly commit our work when we&#8217;re ready.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If we don&#8217;t commit, or if we exit the context manager by raising an error,
we do a <code>rollback</code>. (The rollback has no effect if <code>commit()</code> has been
called. Read on for more discussion of this.)</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_the_real_unit_of_work_uses_sqlalchemy_sessions">6.3.1. The Real Unit of Work Uses SQLAlchemy Sessions</h4>
<div class="paragraph">
<p>The main thing that our concrete implementation adds is the
database session:</p>
</div>
<div id="unit_of_work" class="exampleblock">
<div class="title">The real SQLAlchemy UoW (src/allocation/service_layer/unit_of_work.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">DEFAULT_SESSION_FACTORY</span> <span class="tok-o">=</span> <span class="tok-n">sessionmaker</span><span class="tok-p">(</span><span class="tok-n">bind</span><span class="tok-o">=</span><span class="tok-n">create_engine</span><span class="tok-p">(</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-n">get_postgres_uri</span><span class="tok-p">(),</span>
<span class="tok-p">))</span>

<span class="tok-k">class</span> <span class="tok-nc">SqlAlchemyUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">session_factory</span><span class="tok-o">=</span><span class="tok-n">DEFAULT_SESSION_FACTORY</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session_factory</span> <span class="tok-o">=</span> <span class="tok-n">session_factory</span>  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-k">def</span> <span class="tok-fm">__enter__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session_factory</span><span class="tok-p">()</span>  <span class="tok-c1"># type: Session  </span><i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyRepository</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-k">return</span> <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__enter__</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-fm">__exit__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__exit__</span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">close</span><span class="tok-p">()</span>  <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="tok-k">def</span> <span class="tok-nf">commit</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>  <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-nf">rollback</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>  <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">rollback</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The module defines a default session factory that will connect to Postgres,
but we allow that to be overridden in our integration tests so that we
can use SQLite instead.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>__enter__</code> method is responsible for starting a database session and instantiating
a real repository that can use that session.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We close the session on exit.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Finally, we provide concrete <code>commit()</code> and <code>rollback()</code> methods that
use our database session.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_fake_unit_of_work_for_testing">6.3.2. Fake Unit of Work for Testing</h4>
<div class="paragraph">
<p>Here&#8217;s how we use a fake UoW in our service-layer tests:</p>
</div>
<div id="fake_unit_of_work" class="exampleblock">
<div class="title">Fake UoW (tests/unit/test_services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">FakeUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">FakeRepository</span><span class="tok-p">([])</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">committed</span> <span class="tok-o">=</span> <span class="tok-bp">False</span>  <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-k">def</span> <span class="tok-nf">commit</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">committed</span> <span class="tok-o">=</span> <span class="tok-bp">True</span>  <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-k">def</span> <span class="tok-nf">rollback</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">pass</span>



<span class="tok-k">def</span> <span class="tok-nf">test_add_batch</span><span class="tok-p">():</span>
    <span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">FakeUnitOfWork</span><span class="tok-p">()</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">add_batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;b1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;CRUNCHY-ARMCHAIR&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-k">assert</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;b1&quot;</span><span class="tok-p">)</span> <span class="tok-ow">is</span> <span class="tok-ow">not</span> <span class="tok-bp">None</span>
    <span class="tok-k">assert</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">committed</span>


<span class="tok-k">def</span> <span class="tok-nf">test_allocate_returns_allocation</span><span class="tok-p">():</span>
    <span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">FakeUnitOfWork</span><span class="tok-p">()</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">add_batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;COMPLICATED-LAMP&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-s2">&quot;o1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;COMPLICATED-LAMP&quot;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-k">assert</span> <span class="tok-n">result</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;batch1&quot;</span>
<span class="tok-o">...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>FakeUnitOfWork</code> and <code>FakeRepository</code> are tightly coupled,
just like the real <code>UnitofWork</code> and <code>Repository</code> classes.
That&#8217;s fine because we recognize that the objects are collaborators.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Notice the similarity with the fake <code>commit()</code> function
from <code>FakeSession</code> (which we can now get rid of). But it&#8217;s
a substantial improvement because we&#8217;re now <span class="keep-together">faking</span> out
code that we wrote rather than third-party code. Some
people say, <a href="https://oreil.ly/0LVj3">"Don&#8217;t mock what you don&#8217;t own"</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>In our tests, we can instantiate a UoW and pass it to
our service layer, rather than passing a repository and a session.
This is considerably less cumbersome.</td>
</tr>
</table>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Don&#8217;t Mock What You Don&#8217;t Own</div>
<div class="paragraph">
<p>Why do we feel more comfortable mocking the UoW than the session?
Both of our fakes achieve the same thing: they give us a way to swap out our
persistence layer so we can run tests in memory instead of needing to
talk to a real database. The difference is in the resulting design.</p>
</div>
<div class="paragraph">
<p>If we cared only about writing tests that run quickly, we could create mocks
that replace SQLAlchemy and use those throughout our codebase. The problem is
that <code>Session</code> is a complex object that exposes lots of persistence-related
functionality. It&#8217;s easy to use <code>Session</code> to make arbitrary queries against
the database, but that quickly leads to data access code being sprinkled all
over the codebase. To avoid that, we want to limit access to our persistence
layer so each component has exactly what it needs and nothing more.</p>
</div>
<div class="paragraph">
<p>By coupling to the <code>Session</code> interface, you&#8217;re choosing to couple to all the
complexity of SQLAlchemy. Instead, we want to choose a simpler abstraction and
use that to clearly separate responsibilities. Our UoW is much simpler
than a session, and we feel comfortable with the service layer being able to
start and stop units of work.</p>
</div>
<div class="paragraph">
<p>"Don&#8217;t mock what you don&#8217;t own" is a rule of thumb that forces us to build
these simple abstractions over messy subsystems. This has the same performance
benefit as mocking the SQLAlchemy session but encourages us to think carefully
about our designs.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_uow_in_the_service_layer">6.4. Using the UoW in the Service Layer</h3>
<div class="paragraph">
<p>Here&#8217;s what our new service layer looks like:</p>
</div>
<div id="service_layer_with_uow" class="exampleblock">
<div class="title">Service layer using UoW (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">add_batch</span><span class="tok-p">(</span>
        <span class="tok-n">ref</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-p">:</span> <span class="tok-n">Optional</span><span class="tok-p">[</span><span class="tok-n">date</span><span class="tok-p">],</span>
        <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-p">):</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-n">ref</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-p">))</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>


<span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span>
        <span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span>
        <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">)</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">list</span><span class="tok-p">()</span>
        <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">is_valid_sku</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">):</span>
            <span class="tok-k">raise</span> <span class="tok-n">InvalidSku</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;Invalid sku {line.sku}&#39;</span><span class="tok-p">)</span>
        <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">)</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>
    <span class="tok-k">return</span> <span class="tok-n">batchref</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Our service layer now has only the one dependency, once again
on an <em>abstract</em> UoW.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_explicit_tests_for_commitrollback_behavior">6.5. Explicit Tests for Commit/Rollback Behavior</h3>
<div class="paragraph">
<p>To convince ourselves that the commit/rollback behavior works, we wrote
a couple of tests:</p>
</div>
<div id="testing_rollback" class="exampleblock">
<div class="title">Integration tests for rollback behavior (tests/integration/test_uow.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_rolls_back_uncommitted_work_by_default</span><span class="tok-p">(</span><span class="tok-n">session_factory</span><span class="tok-p">):</span>
    <span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">session_factory</span><span class="tok-p">)</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">insert_batch</span><span class="tok-p">(</span><span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-p">,</span> <span class="tok-s1">&#39;batch1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;MEDIUM-PLINTH&#39;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">)</span>

    <span class="tok-n">new_session</span> <span class="tok-o">=</span> <span class="tok-n">session_factory</span><span class="tok-p">()</span>
    <span class="tok-n">rows</span> <span class="tok-o">=</span> <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-n">new_session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span><span class="tok-s1">&#39;SELECT * FROM &quot;batches&quot;&#39;</span><span class="tok-p">))</span>
    <span class="tok-k">assert</span> <span class="tok-n">rows</span> <span class="tok-o">==</span> <span class="tok-p">[]</span>


<span class="tok-k">def</span> <span class="tok-nf">test_rolls_back_on_error</span><span class="tok-p">(</span><span class="tok-n">session_factory</span><span class="tok-p">):</span>
    <span class="tok-k">class</span> <span class="tok-nc">MyException</span><span class="tok-p">(</span><span class="tok-ne">Exception</span><span class="tok-p">):</span>
        <span class="tok-k">pass</span>

    <span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">session_factory</span><span class="tok-p">)</span>
    <span class="tok-k">with</span> <span class="tok-n">pytest</span><span class="tok-o">.</span><span class="tok-n">raises</span><span class="tok-p">(</span><span class="tok-n">MyException</span><span class="tok-p">):</span>
        <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
            <span class="tok-n">insert_batch</span><span class="tok-p">(</span><span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-p">,</span> <span class="tok-s1">&#39;batch1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;LARGE-FORK&#39;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">)</span>
            <span class="tok-k">raise</span> <span class="tok-n">MyException</span><span class="tok-p">()</span>

    <span class="tok-n">new_session</span> <span class="tok-o">=</span> <span class="tok-n">session_factory</span><span class="tok-p">()</span>
    <span class="tok-n">rows</span> <span class="tok-o">=</span> <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-n">new_session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span><span class="tok-s1">&#39;SELECT * FROM &quot;batches&quot;&#39;</span><span class="tok-p">))</span>
    <span class="tok-k">assert</span> <span class="tok-n">rows</span> <span class="tok-o">==</span> <span class="tok-p">[]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
We haven&#8217;t shown it here, but it can be worth testing some of the more
    "obscure" database behavior, like transactions, against the "real"
    database—that is, the same engine. For now, we&#8217;re getting away with using
    SQLite instead of Postgres, but in <a href="#chapter_07_aggregate">Aggregates and Consistency Boundaries</a>, we&#8217;ll switch
    some of the tests to using the real database. It&#8217;s convenient that our UoW
    class makes that easy!
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_explicit_versus_implicit_commits">6.6. Explicit Versus Implicit Commits</h3>
<div class="paragraph">
<p>Now we briefly digress on different ways of implementing the UoW pattern.</p>
</div>
<div class="paragraph">
<p>We could imagine a slightly different version of the UoW that commits by default
and rolls back only if it spots an exception:</p>
</div>
<div id="uow_implicit_commit" class="exampleblock">
<div class="title">A UoW with implicit commit&#8230;&#8203; (src/allocation/unit_of_work.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>
<span class="tok-k">class</span> <span class="tok-nc">AbstractUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">abc</span><span class="tok-o">.</span><span class="tok-n">ABC</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__enter__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span>

    <span class="tok-k">def</span> <span class="tok-fm">__exit__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">exn_type</span><span class="tok-p">,</span> <span class="tok-n">exn_value</span><span class="tok-p">,</span> <span class="tok-n">traceback</span><span class="tok-p">):</span>
        <span class="tok-k">if</span> <span class="tok-n">exn_type</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-k">else</span><span class="tok-p">:</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rollback</span><span class="tok-p">()</span>  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Should we have an implicit commit in the happy path?</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And roll back only on exception?</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It would allow us to save a line of code and to remove the explicit commit from our
client code:</p>
</div>
<div id="add_batch_nocommit" class="exampleblock">
<div class="title">...would save us a line of code (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">add_batch</span><span class="tok-p">(</span><span class="tok-n">ref</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-p">:</span> <span class="tok-n">Optional</span><span class="tok-p">[</span><span class="tok-n">date</span><span class="tok-p">],</span> <span class="tok-n">uow</span><span class="tok-p">):</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-n">ref</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-p">))</span>
        <span class="tok-c1"># uow.commit()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This is a judgment call, but we tend to prefer requiring the explicit commit
so that we have to choose when to flush state.</p>
</div>
<div class="paragraph">
<p>Although we use an extra line of code, this makes the software safe by default.
The default behavior is to <em>not change anything</em>. In turn, that makes our code
easier to reason about because there&#8217;s only one code path that leads to changes
in the system: total success and an explicit commit. Any other code path, any
exception, any early exit from the UoW&#8217;s scope leads to a safe state.</p>
</div>
<div class="paragraph">
<p>Similarly, we prefer to roll back by default because
it&#8217;s easier to understand; this rolls back to the last commit,
so either the user did one, or we blow their changes away. Harsh but simple.</p>
</div>
</div>
<div class="sect2">
<h3 id="_examples_using_uow_to_group_multiple_operations_into_an_atomic_unit">6.7. Examples: Using UoW to Group Multiple Operations into an Atomic Unit</h3>
<div class="paragraph">
<p>Here are a few examples showing the Unit of Work pattern in use. You can
see how it leads to simple reasoning about what blocks of code happen
together.</p>
</div>
<div class="sect3">
<h4 id="_example_1_reallocate">6.7.1. Example 1: Reallocate</h4>
<div class="paragraph">
<p>Suppose we want to be able to deallocate and then reallocate orders:</p>
</div>
<div id="reallocate" class="exampleblock">
<div class="title">Reallocate service function</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">reallocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-n">batch</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
            <span class="tok-k">raise</span> <span class="tok-n">InvalidSku</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;Invalid sku {line.sku}&#39;</span><span class="tok-p">)</span>
        <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">deallocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If <code>deallocate()</code> fails, we don&#8217;t want to call <code>allocate()</code>, obviously.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If <code>allocate()</code> fails, we probably don&#8217;t want to actually commit
the <code>deallocate()</code> either.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_example_2_change_batch_quantity">6.7.2. Example 2: Change Batch Quantity</h4>
<div class="paragraph">
<p>Our shipping company gives us a call to say that one of the container doors
opened, and half our sofas have fallen into the Indian Ocean. Oops!</p>
</div>
<div id="change_batch_quantity" class="exampleblock">
<div class="title">Change quantity</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">change_batch_quantity</span><span class="tok-p">(</span><span class="tok-n">batchref</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">new_qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">):</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">reference</span><span class="tok-o">=</span><span class="tok-n">batchref</span><span class="tok-p">)</span>
        <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">change_purchased_quantity</span><span class="tok-p">(</span><span class="tok-n">new_qty</span><span class="tok-p">)</span>
        <span class="tok-k">while</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">&lt;</span> <span class="tok-mi">0</span><span class="tok-p">:</span>
            <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">deallocate_one</span><span class="tok-p">()</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here we may need to deallocate any number of lines. If we get a failure
at any stage, we probably want to commit none of the changes.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tidying_up_the_integration_tests">6.8. Tidying Up the Integration Tests</h3>
<div class="paragraph">
<p>We now have three sets of tests, all essentially pointing at the database:
<em>test_orm.py</em>, <em>test_repository.py</em>, and <em>test_uow.py</em>. Should we throw any
away?</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock tree">
<div class="content">
<pre class="pygments highlight"><code data-lang="text"><span></span>└── tests
    ├── conftest.py
    ├── e2e
    │   └── test_api.py
    ├── integration
    │   ├── test_orm.py
    │   ├── test_repository.py
    │   └── test_uow.py
    ├── pytest.ini
    └── unit
        ├── test_allocate.py
        ├── test_batches.py
        └── test_services.py</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You should always feel free to throw away tests if you think they&#8217;re not going to
add value longer term. We&#8217;d say that <em>test_orm.py</em> was primarily a tool to help
us learn SQLAlchemy, so we won&#8217;t need that long term, especially if the main things
it&#8217;s doing are covered in <em>test_repository.py</em>. That last test, you might keep around,
but we could certainly see an argument for just keeping everything at the highest
possible level of abstraction (just as we did for the unit tests).</p>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Exercise for the Reader</div>
<div class="paragraph">
<p>For this chapter, probably the best thing to try is to implement a
UoW from scratch. The code, as always, is <a href="https://github.com/cosmicpython/code/tree/chapter_06_uow_exercise">on GitHub</a>. You could either follow the model we have quite closely,
or perhaps experiment with separating the UoW (whose responsibilities are
<code>commit()</code>, <code>rollback()</code>, and providing the <code>.batches</code> repository) from the
context manager, whose job is to initialize things, and then do the commit
or rollback on exit. If you feel like going all-functional rather than
messing about with all these classes, you could use <code>@contextmanager</code> from
<code>contextlib</code>.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve stripped out both the actual UoW and the fakes, as well as paring back
the abstract UoW. Why not send us a link to your repo if you come up with
something you&#8217;re particularly proud of?</p>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This is another example of the lesson from <a href="#chapter_05_high_gear_low_gear">TDD in High Gear and Low Gear</a>:
    as we build better abstractions, we can move our tests to run against them,
    which leaves us free to change the underlying details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up_5">6.9. Wrap-Up</h3>
<div class="paragraph">
<p>Hopefully we&#8217;ve convinced you that the Unit of Work pattern is useful, and
that the context manager is a really nice Pythonic way
of visually grouping code into blocks that we want to happen atomically.</p>
</div>
<div class="paragraph">
<p>This pattern is so useful, in fact, that SQLAlchemy already uses a UoW
in the shape of the <code>Session</code> object. The <code>Session</code> object in SQLAlchemy is the way
that your application loads data from the database.</p>
</div>
<div class="paragraph">
<p>Every time you load a new entity from the database, the session begins to <em>track</em>
changes to the entity, and when the session is <em>flushed</em>, all your changes are
persisted together. Why do we go to the effort of abstracting away the SQLAlchemy session if it already implements the pattern we want?</p>
</div>
<div class="paragraph">
<p><a href="#chapter_06_uow_tradeoffs">Unit of Work pattern: the trade-offs</a> discusses some of the trade-offs.</p>
</div>
<table id="chapter_06_uow_tradeoffs" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Unit of Work pattern: the trade-offs</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pros</th>
<th class="tableblock halign-left valign-top">Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>We have a nice abstraction over the concept of atomic operations, and the
context manager makes it easy to see, visually, what blocks of code are
grouped together atomically.</p>
</li>
<li>
<p>We have explicit control over when a transaction starts and finishes, and our
application fails in a way that is safe by default. We never have to worry
that an operation is partially committed.</p>
</li>
<li>
<p>It&#8217;s a nice place to put all your repositories so client code can access them.</p>
</li>
<li>
<p>As you&#8217;ll see in later chapters, atomicity isn&#8217;t only about transactions; it
can help us work with events and the message bus.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Your ORM probably already has some perfectly good abstractions around
atomicity. SQLAlchemy even has context managers. You can go a long way
just passing a session around.</p>
</li>
<li>
<p>We&#8217;ve made it look easy, but you have to think quite carefully about
things like rollbacks, multithreading, and nested transactions. Perhaps just
sticking to what Django or Flask-SQLAlchemy gives you will keep your life
simpler.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For one thing, the Session API is rich and supports operations that we don&#8217;t
want or need in our domain. Our <code>UnitOfWork</code> simplifies the session to its
essential core: it can be started, committed, or thrown away.</p>
</div>
<div class="paragraph">
<p>For another, we&#8217;re using the <code>UnitOfWork</code> to access our <code>Repository</code> objects.
This is a neat bit of developer usability that we couldn&#8217;t do with a plain
SQLAlchemy <code>Session</code>.</p>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Unit of Work Pattern Recap</div>
<div class="dlist">
<dl>
<dt class="hdlist1">The Unit of Work pattern is an abstraction around data integrity</dt>
<dd>
<p>It helps to enforce the consistency of our domain model, and improves
performance, by letting us perform a single <em>flush</em> operation at the
end of an operation.</p>
</dd>
<dt class="hdlist1">It works closely with the Repository and Service Layer patterns</dt>
<dd>
<p>The Unit of Work pattern completes our abstractions over data access by
representing atomic updates. Each of our service-layer use cases runs in a
single unit of work that succeeds or fails as a block.</p>
</dd>
<dt class="hdlist1">This is a lovely case for a context manager</dt>
<dd>
<p>Context managers are an idiomatic way of defining scope in Python. We can use a
context manager to automatically roll back our work at the end of a request,
which means the system is safe by default.</p>
</dd>
<dt class="hdlist1">SQLAlchemy already implements this pattern</dt>
<dd>
<p>We introduce an even simpler abstraction over the SQLAlchemy <code>Session</code> object
in order to "narrow" the interface between the ORM and our code. This helps
to keep us loosely coupled.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>Lastly, we&#8217;re motivated again by the dependency inversion principle: our
service layer depends on a thin abstraction, and we attach a concrete
implementation at the outside edge of the system. This lines up nicely with
SQLAlchemy&#8217;s own
<a href="https://oreil.ly/tS0E0">recommendations</a>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Keep the life cycle of the session (and usually the transaction) separate and
external. The most comprehensive approach, recommended for more substantial
applications, will try to keep the details of session, transaction, and
exception management as far as possible from the details of the program doing
its work.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; SQLALchemy "Session Basics" Documentation
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_07_aggregate">7. Aggregates and Consistency Boundaries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter, we&#8217;d like to revisit our domain model to talk about invariants
and constraints, and see how our domain objects can maintain their own
internal consistency, both conceptually and in persistent storage.  We&#8217;ll
discuss the concept of a <em>consistency boundary</em> and show how making it
explicit can help us to build high-performance software without compromising
maintainability.</p>
</div>
<div class="paragraph">
<p><a href="#maps_chapter_06">Adding the Product aggregate</a> shows a preview of where we&#8217;re headed: we&#8217;ll introduce
a new model object called <code>Product</code> to wrap multiple batches, and we&#8217;ll make
the old <code>allocate()</code> domain service available as a method on <code>Product</code> instead.</p>
</div>
<div id="maps_chapter_06" class="imageblock">
<div class="content">
<img src="images/apwp_0701.png" alt="apwp 0701">
</div>
<div class="title">Figure 24. Adding the Product aggregate</div>
</div>
<div class="paragraph">
<p>Why? Let&#8217;s find out.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The code for this chapter is in the appendix_csvs branch
<a href="https://oreil.ly/vlnGg">on <span class="keep-together">GitHub</span></a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/cosmicpython/code.git
cd code
git checkout appendix_csvs
# or to code along, checkout the previous chapter:
git checkout chapter_06_uow</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_why_not_just_run_everything_in_a_spreadsheet">7.1. Why Not Just Run Everything in a Spreadsheet?</h3>
<div class="paragraph">
<p>What&#8217;s the point of a domain model, anyway? What&#8217;s the fundamental problem
we&#8217;re trying to address?</p>
</div>
<div class="paragraph">
<p>Couldn&#8217;t we just run everything in a spreadsheet? Many of our users would be
<span class="keep-together">delighted</span> by that. Business users <em>like</em> spreadsheets because they&#8217;re simple,
familiar, and yet enormously powerful.</p>
</div>
<div class="paragraph">
<p>In fact, an enormous number of business processes do operate by manually sending
spreadsheets back and forth over email. This "CSV over SMTP" architecture has
low initial complexity but tends not to scale very well because it&#8217;s difficult
to apply logic and maintain consistency.</p>
</div>
<div class="paragraph">
<p>Who is allowed to view this particular field? Who&#8217;s allowed to update it? What
happens when we try to order –350 chairs, or 10,000,000 tables? Can an employee
have a negative salary?</p>
</div>
<div class="paragraph">
<p>These are the constraints of a system. Much of the domain logic we write exists
to enforce these constraints in order to maintain the invariants of the
system. The <em>invariants</em> are the things that have to be true whenever we finish
an operation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_invariants_constraints_and_consistency">7.2. Invariants, Constraints, and Consistency</h3>
<div class="paragraph">
<p>The two words are somewhat interchangeable, but a <em>constraint</em> is a
rule that restricts the possible states our model can get into, while an <em>invariant</em>
is defined a little more precisely as a condition that is always true.</p>
</div>
<div class="paragraph">
<p>If we were writing a hotel-booking system, we might have the constraint that double
bookings are not allowed. This supports the invariant that a room cannot have more
than one booking for the same night.</p>
</div>
<div class="paragraph">
<p>Of course, sometimes we might need to temporarily <em>bend</em> the rules. Perhaps we
need to shuffle the rooms around because of a VIP booking. While we&#8217;re moving
bookings around in memory, we might be double booked, but our domain model
should ensure that, when we&#8217;re finished, we end up in a final consistent state,
where the invariants are met. If we can&#8217;t find a way to accommodate all our guests,
we should raise an error and refuse to complete the operation.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at a couple of concrete examples from our business requirements; we&#8217;ll start with this one:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>An order line can be allocated to only one batch at a time.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; The business
</div>
</div>
<div class="paragraph">
<p>This is a business rule that imposes an invariant. The invariant is that an
order line is allocated to either zero or one batch, but never more than one.
We need to make sure that our code never accidentally calls <code>Batch.allocate()</code>
on two different batches for the same line, and currently, there&#8217;s nothing
there to explicitly stop us from doing that.</p>
</div>
<div class="sect3">
<h4 id="_invariants_concurrency_and_locks">7.2.1. Invariants, Concurrency, and Locks</h4>
<div class="paragraph">
<p>Let&#8217;s look at another one of our business rules:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>We can&#8217;t allocate to a batch if the available quantity is less than the
  quantity of the order line.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; The business
</div>
</div>
<div class="paragraph">
<p>Here the constraint is that we can&#8217;t allocate more stock than is available to a
batch, so we never oversell stock by allocating two customers to the same
physical cushion, for example. Every time we update the state of the system, our code needs
to ensure that we don&#8217;t break the invariant, which is that the available
quantity must be greater than or equal to zero.</p>
</div>
<div class="paragraph">
<p>In a single-threaded, single-user application, it&#8217;s relatively easy for us to
maintain this invariant. We can just allocate stock one line at a time, and
raise an error if there&#8217;s no stock available.</p>
</div>
<div class="paragraph">
<p>This gets much harder when we introduce the idea of <em>concurrency</em>. Suddenly we
might be allocating stock for multiple order lines simultaneously. We might
even be allocating order lines at the same time as processing changes to the
batches <span class="keep-together">themselves</span>.</p>
</div>
<div class="paragraph">
<p>We usually solve this problem by applying <em>locks</em> to our database tables. This
prevents two operations from happening simultaneously on the same row or same
table.</p>
</div>
<div class="paragraph">
<p>As we start to think about scaling up our app, we realize that our model
of allocating lines against all available batches may not scale. If we process
tens of thousands of orders per hour, and hundreds of thousands of
order lines, we can&#8217;t hold a lock over the whole <code>batches</code> table for
every single one&#8212;&#8203;we&#8217;ll get deadlocks or performance problems at the very least.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_what_is_an_aggregate">7.3. What Is an Aggregate?</h3>
<div class="paragraph">
<p>OK, so if we can&#8217;t lock the whole database every time we want to allocate an
order line, what should we do instead? We want to protect the invariants of our
system but allow for the greatest degree of concurrency. Maintaining our
invariants inevitably means preventing concurrent writes; if multiple users can
allocate <code>DEADLY-SPOON</code> at the same time, we run the risk of overallocating.</p>
</div>
<div class="paragraph">
<p>On the other hand, there&#8217;s no reason we can&#8217;t allocate <code>DEADLY-SPOON</code> at the
same time as <code>FLIMSY-DESK</code>. It&#8217;s safe to allocate two products at the
same time because there&#8217;s no invariant that covers them both. We don&#8217;t need them
to be consistent with each other.</p>
</div>
<div class="paragraph">
<p>The <em>Aggregate</em> pattern is a design pattern from the DDD community that helps us
to resolve this tension. An <em>aggregate</em> is just a domain object that contains
other domain objects and lets us treat the whole collection as a single unit.</p>
</div>
<div class="paragraph">
<p>The only way to modify the objects inside the aggregate is to load the whole
thing, and to call methods on the aggregate itself.</p>
</div>
<div class="paragraph">
<p>As a model gets more complex and grows more entity and value objects,
referencing each other in a tangled graph, it can be hard to keep track of who
can modify what. Especially when we have <em>collections</em> in the model as we do
(our batches are a collection), it&#8217;s a good idea to nominate some entities to be
the single entrypoint for modifying their related objects. It makes the system
conceptually simpler and easy to reason about if you nominate some objects to be
in charge of consistency for the others.</p>
</div>
<div class="paragraph">
<p>For example, if we&#8217;re building a shopping site, the Cart might make a good
aggregate: it&#8217;s a collection of items that we can treat as a single unit.
Importantly, we want to load the entire basket as a single blob from our data
store. We don&#8217;t want two requests to modify the basket at the same time, or we
run the risk of weird concurrency errors. Instead, we want each change to the
basket to run in a single database transaction.</p>
</div>
<div class="paragraph">
<p>We don&#8217;t want to modify multiple baskets in a transaction, because there&#8217;s no
use case for changing the baskets of several customers at the same time. Each
basket is a single <em>consistency boundary</em> responsible for maintaining its own
invariants.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>An AGGREGATE is a cluster of associated objects that we treat as a unit for the
purpose of data changes.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Eric Evans<br>
<cite>Domain-Driven Design blue book</cite>
</div>
</div>
<div class="paragraph">
<p>Per Evans, our aggregate has a root entity (the Cart) that encapsulates access
to items. Each item has its own identity, but other parts of the system will always
refer to the Cart only as an indivisible whole.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Just as we sometimes use <code><em>_leading_underscores</em></code> to mark methods or functions
    as "private," you can think of aggregates as being the "public" classes of our
    model, and the rest of the entities and value objects as "private."
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_choosing_an_aggregate">7.4. Choosing an Aggregate</h3>
<div class="paragraph">
<p>What aggregate should we use for our system? The choice is somewhat arbitrary,
but it&#8217;s important. The aggregate will be the boundary where we make sure
every operation ends in a consistent state. This helps us to reason about our
software and prevent weird race issues. We want to draw a boundary around a
small number of objects—the smaller, the better, for performance—that have to
be consistent with one another, and we need to give this boundary a good name.</p>
</div>
<div class="paragraph">
<p>The object we&#8217;re manipulating under the covers is <code>Batch</code>. What do we call a
collection of batches? How should we divide all the batches in the system into
discrete islands of consistency?</p>
</div>
<div class="paragraph">
<p>We <em>could</em> use <code>Shipment</code> as our boundary. Each shipment contains several
batches, and they all travel to our warehouse at the same time. Or perhaps we
could use <code>Warehouse</code> as our boundary: each warehouse contains many batches,
and counting all the stock at the same time could make sense.</p>
</div>
<div class="paragraph">
<p>Neither of these concepts really satisfies us, though. We should be able to
allocate <code>DEADLY-SPOONs</code> and <code>FLIMSY-DESKs</code> at the same time, even if they&#8217;re in the
same warehouse or the same shipment. These concepts have the wrong granularity.</p>
</div>
<div class="paragraph">
<p>When we allocate an order line, we&#8217;re interested only in batches
that have the same SKU as the order line. Some sort of concept like
<code>GlobalSkuStock</code> could work: a collection of all the batches for a given SKU.</p>
</div>
<div class="paragraph">
<p>It&#8217;s an unwieldy name, though, so after some bikeshedding via <code>SkuStock</code>, <code>Stock</code>,
<code>ProductStock</code>, and so on, we decided to simply call it <code>Product</code>—after all, that was the first concept we came across in our exploration of the
domain language back in <a href="#chapter_01_domain_model">Domain Modeling</a>.</p>
</div>
<div class="paragraph">
<p>So the plan is this: when we want to allocate an order line, instead of
<a href="#before_aggregates_diagram">Before: allocate against all batches using the domain service</a>, where we look up all the <code>Batch</code> objects in
the world and pass them to the <code>allocate()</code> domain service&#8230;&#8203;</p>
</div>
<div id="before_aggregates_diagram" class="imageblock width-60">
<div class="content">
<img src="images/apwp_0702.png" alt="apwp 0702">
</div>
<div class="title">Figure 25. Before: allocate against all batches using the domain service</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_0702, config=plantuml.cfg]
@startuml
scale 4

hide empty members

package "Service Layer" as services {
    class "allocate()" as allocate {
    }
    hide allocate circle
    hide allocate members
}



package "Domain Model" as domain_model {

  class Batch {
  }

  class "allocate()" as allocate_domain_service {
  }
    hide allocate_domain_service circle
    hide allocate_domain_service members
}


package Repositories {

  class BatchRepository {
    list()
  }

}

allocate -&gt; BatchRepository: list all batches
allocate --&gt; allocate_domain_service: allocate(orderline, batches)

@enduml</pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;we&#8217;ll move to the world of <a href="#after_aggregates_diagram">After: ask Product to allocate against its batches</a>, in which there is a new
<code>Product</code> object for the particular SKU of our order line, and it will be in charge
of all the batches <em>for that SKU</em>, and we can call a <code>.allocate()</code> method on that
instead.</p>
</div>
<div id="after_aggregates_diagram" class="imageblock width-75">
<div class="content">
<img src="images/apwp_0703.png" alt="apwp 0703">
</div>
<div class="title">Figure 26. After: ask Product to allocate against its batches</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_0703, config=plantuml.cfg]
@startuml
scale 4

hide empty members

package "Service Layer" as services {
    class "allocate()" as allocate {
    }
}

hide allocate circle
hide allocate members


package "Domain Model" as domain_model {

  class Product {
    allocate()
  }

  class Batch {
  }
}


package Repositories {

  class ProductRepository {
    get()
  }

}

allocate -&gt; ProductRepository: get me the product for this SKU
allocate --&gt; Product: product.allocate(orderline)
Product o- Batch: has

@enduml</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s see how that looks in code form:</p>
</div>
<div id="product_aggregate" class="exampleblock pagebreak-before">
<div class="title">Our chosen aggregate, Product (src/allocation/domain/model.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Product</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">:</span> <span class="tok-n">List</span><span class="tok-p">[</span><span class="tok-n">Batch</span><span class="tok-p">]):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">sku</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">batches</span>  <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-nb">next</span><span class="tok-p">(</span>
                <span class="tok-n">b</span> <span class="tok-k">for</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-nb">sorted</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-p">)</span> <span class="tok-k">if</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">can_allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
            <span class="tok-p">)</span>
            <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
            <span class="tok-k">return</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">reference</span>
        <span class="tok-k">except</span> <span class="tok-ne">StopIteration</span><span class="tok-p">:</span>
            <span class="tok-k">raise</span> <span class="tok-n">OutOfStock</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;Out of stock for sku {line.sku}&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>Product&#8217;s main identifier is the `sku</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Our <code>Product</code> class holds a reference to a collection of <code>batches</code> for that SKU.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Finally, we can move the <code>allocate()</code> domain service to
be a method on the <code><span class="keep-together">Product</span></code> aggregate.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This <code>Product</code> might not look like what you&#8217;d expect a <code>Product</code>
    model to look like.  No price, no description, no dimensions.
    Our allocation service doesn&#8217;t care about any of those things.
    This is the power of bounded contexts; the concept
    of a product in one app can be very different from another.
    See the following sidebar for more
    discussion.
</td>
</tr>
</table>
</div>
<div id="bounded_contexts_sidebar" class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Aggregates, Bounded Contexts, and Microservices</div>
<div class="paragraph">
<p>One of the most important contributions from Evans and the DDD community
is the concept of
<a href="https://martinfowler.com/bliki/BoundedContext.html"><em>bounded contexts</em></a>.</p>
</div>
<div class="paragraph">
<p>In essence, this was a reaction against attempts to capture entire businesses
into a single model. The word <em>customer</em> means different things to people
in sales, customer service, logistics, support, and so on. Attributes
needed in one context are irrelevant in another; more perniciously, concepts
with the same name can have entirely different meanings in different contexts.
Rather than trying to build a single model (or class, or database) to capture
all the use cases, it&#8217;s better to have several models, draw boundaries
around each context, and handle the translation between different contexts
explicitly.</p>
</div>
<div class="paragraph">
<p>This concept translates very well to the world of microservices, where each
microservice is free to have its own concept of "customer" and its own rules for
translating that to and from other microservices it integrates with.</p>
</div>
<div class="paragraph">
<p>In our example, the allocation service has <code>Product(sku, batches)</code>,
whereas the ecommerce will have <code>Product(sku, description, price, image_url,
dimensions, etc&#8230;&#8203;)</code>. As a rule of thumb, your domain models should
include only the data that they need for performing calculations.</p>
</div>
<div class="paragraph">
<p>Whether or not you have a microservices architecture, a key consideration
in choosing your aggregates is also choosing the bounded context that they
will operate in. By restricting the context, you can keep your number of
aggregates low and their size manageable.</p>
</div>
<div class="paragraph">
<p>Once again, we find ourselves forced to say that we can&#8217;t give this issue
the treatment it deserves here, and we can only encourage you to read up on it
elsewhere. The Fowler link at the start of this sidebar is a good starting point, and either
(or indeed, any) DDD book will have a chapter or more on bounded contexts.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_one_aggregate_one_repository">7.5. One Aggregate = One Repository</h3>
<div class="paragraph">
<p>Once you define certain entities to be aggregates, we need to apply the rule
that they are the only entities that are publicly accessible to the outside
world.  In other words, the only repositories we are allowed should be
repositories that return aggregates.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The rule that repositories should only return aggregates is the main place
    where we enforce the convention that aggregates are the only way into our
    domain model.  Be wary of breaking it!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In our case, we&#8217;ll switch from <code>BatchRepository</code> to <code>ProductRepository</code>:</p>
</div>
<div id="new_uow_and_repository" class="exampleblock">
<div class="title">Our new UoW and repository (unit_of_work.py and repository.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">AbstractUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">abc</span><span class="tok-o">.</span><span class="tok-n">ABC</span><span class="tok-p">):</span>
    <span class="tok-n">products</span><span class="tok-p">:</span> <span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">AbstractProductRepository</span>

<span class="tok-o">...</span>

<span class="tok-k">class</span> <span class="tok-nc">AbstractProductRepository</span><span class="tok-p">(</span><span class="tok-n">abc</span><span class="tok-o">.</span><span class="tok-n">ABC</span><span class="tok-p">):</span>

    <span class="tok-nd">@abc.abstractmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">add</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">product</span><span class="tok-p">):</span>
        <span class="tok-o">...</span>

    <span class="tok-nd">@abc.abstractmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">:</span>
        <span class="tok-o">...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The ORM layer will need some tweaks so that the right batches automatically get
loaded and associated with <code>Product</code> objects. The nice thing is, the Repository
pattern means we don&#8217;t have to worry about that yet. We can just use
our <code>FakeRepository</code> and then feed through the new model into our service
layer to see how it looks with <code>Product</code> as its main entrypoint:</p>
</div>
<div id="service_layer_uses_products" class="exampleblock">
<div class="title">Service layer (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">add_batch</span><span class="tok-p">(</span>
        <span class="tok-n">ref</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-p">:</span> <span class="tok-n">Optional</span><span class="tok-p">[</span><span class="tok-n">date</span><span class="tok-p">],</span>
        <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>
<span class="tok-p">):</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-n">product</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
            <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-o">=</span><span class="tok-p">[])</span>
            <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">product</span><span class="tok-p">)</span>
        <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-n">ref</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-p">))</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>


<span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span>
        <span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span>
        <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>
<span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">)</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-n">product</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
            <span class="tok-k">raise</span> <span class="tok-n">InvalidSku</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;Invalid sku {line.sku}&#39;</span><span class="tok-p">)</span>
        <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>
    <span class="tok-k">return</span> <span class="tok-n">batchref</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_what_about_performance">7.6. What About Performance?</h3>
<div class="paragraph">
<p>We&#8217;ve mentioned a few times that we&#8217;re modeling with aggregates because we want
to have high-performance software, but here we are loading <em>all</em> the batches when
we only need one. You might expect that to be inefficient, but there are a few
reasons why we&#8217;re comfortable here.</p>
</div>
<div class="paragraph">
<p>First, we&#8217;re purposefully modeling our data so that we can make a single
query to the database to read, and a single update to persist our changes. This
tends to perform much better than systems that issue lots of ad hoc queries. In
systems that don&#8217;t model this way, we often find that transactions slowly
get longer and more complex as the software evolves.</p>
</div>
<div class="paragraph">
<p>Second, our data structures are minimal and comprise a few strings and
integers per row. We can easily load tens or even hundreds of batches in a few
milliseconds.</p>
</div>
<div class="paragraph">
<p>Third, we expect to have only 20 or so batches of each product at a time.
Once a batch is used up, we can discount it from our calculations. This means
that the amount of data we&#8217;re fetching shouldn&#8217;t get out of control over time.</p>
</div>
<div class="paragraph">
<p>If we <em>did</em> expect to have thousands of active batches for a product, we&#8217;d have
a couple of options. For one, we could use lazy-loading for the batches in a
product. From the perspective of our code, nothing would change, but in the
background, SQLAlchemy would page through data for us. This would lead to more
requests, each fetching a smaller number of rows. Because we need to find only a
single batch with enough capacity for our order, this might work pretty well.</p>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Exercise for the Reader</div>
<div class="paragraph">
<p>You&#8217;ve just seen the main top layers of the code, so this shouldn&#8217;t be too hard,
but we&#8217;d like you to implement the <code>Product</code> aggregate starting from <code>Batch</code>,
just as we did.</p>
</div>
<div class="paragraph">
<p>Of course, you could cheat and copy/paste from the previous listings, but even
if you do that, you&#8217;ll still have to solve a few challenges on your own,
like adding the model to the ORM and making sure all the moving parts can
talk to each other, which we hope will be instructive.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll find the code <a href="https://github.com/cosmicpython/code/tree/chapter_07_aggregate_exercise">on GitHub</a>. We&#8217;ve put in a "cheating" implementation in the delegates to the existing
<code>allocate()</code> function, so you should be able to evolve that toward the real
thing.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve marked a couple of tests with <code>@pytest.skip()</code>. After you&#8217;ve read the rest of this chapter, come back to these tests to have a go
at implementing version numbers. Bonus points if you can get SQLAlchemy to
do them for you by magic!</p>
</div>
</div>
</div>
<div class="paragraph">
<p>If all else failed, we&#8217;d just look for a different aggregate. Maybe we could
split up batches by region or by warehouse. Maybe we could redesign our data
access strategy around the shipment concept. The Aggregate pattern is designed
to help manage some technical constraints around consistency and performance.
There isn&#8217;t <em>one</em> correct aggregate, and we should feel comfortable changing our
minds if we find our boundaries are causing performance woes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_optimistic_concurrency_with_version_numbers">7.7. Optimistic Concurrency with Version Numbers</h3>
<div class="paragraph">
<p>We have our new aggregate, so we&#8217;ve solved the conceptual problem of choosing
an object to be in charge of consistency boundaries.  Let&#8217;s now spend a little
time talking about how to enforce data integrity at the database level.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This section has a lot of implementation details; for example, some of it is Postgres-specific. But more generally, we&#8217;re showing one way of managing concurrency issues, but it is just one approach. Real requirements in this area vary a lot from project to project. You
    shouldn&#8217;t expect to be able to copy and paste code from here into production.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We don&#8217;t want to hold a lock over the entire <code>batches</code> table, but how will we
implement holding a lock over just the rows for a particular SKU?</p>
</div>
<div class="paragraph">
<p>One answer is to have a single attribute on the <code>Product</code> model that acts as a marker for
the whole state change being complete and to use it as the single resource
that concurrent workers can fight over. If two transactions read the
state of the world for <code>batches</code> at the same time, and both want to update
the <code>allocations</code> tables, we force both to also try to update the
<code>version_number</code> in the <code>products</code> table, in such a way that only one of them
can win and the world stays consistent.</p>
</div>
<div class="paragraph">
<p><a href="#version_numbers_sequence_diagram">Sequence diagram: two transactions attempting a concurrent update on <code><span class="keep-together">Product</span></code></a> illustrates two concurrent
transactions doing their read operations at the same time, so they see
a <code>Product</code> with, for example, <code>version=3</code>.  They both call <code>Product.allocate()</code>
in order to modify a state. But we set up our database integrity
rules such that only one of them is allowed to <code>commit</code> the new <code>Product</code>
with <code>version=4</code>, and the other update is rejected.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Version numbers are just one way to implement optimistic locking. You
    could achieve the same thing by setting the Postgres transaction isolation
    level to <code>SERIALIZABLE</code>, but that often comes at a severe performance cost.
    Version numbers also make implicit concepts explicit.
</td>
</tr>
</table>
</div>
<div id="version_numbers_sequence_diagram" class="imageblock">
<div class="content">
<img src="images/apwp_0704.png" alt="apwp 0704">
</div>
<div class="title">Figure 27. Sequence diagram: two transactions attempting a concurrent update on <code><span class="keep-together">Product</span></code></div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_0704, config=plantuml.cfg]
@startuml
scale 4

entity Model
collections Transaction1
collections Transaction2
database Database


Transaction1 -&gt; Database: get product
Database -&gt; Transaction1: Product(version=3)
Transaction2 -&gt; Database: get product
Database -&gt; Transaction2: Product(version=3)
Transaction1 -&gt; Model: Product.allocate()
Model -&gt; Transaction1: Product(version=4)
Transaction2 -&gt; Model: Product.allocate()
Model -&gt; Transaction2: Product(version=4)
Transaction1 -&gt; Database: commit Product(version=4)
Database -[#green]&gt; Transaction1: OK
Transaction2 -&gt; Database: commit Product(version=4)
Database -[#red]&gt;x Transaction2: Error! version is already 4

@enduml</pre>
</div>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Optimistic Concurrency Control and Retries</div>
<div class="paragraph">
<p>What we&#8217;ve implemented here is called <em>optimistic</em> concurrency control because
our default assumption is that everything will be fine when two users want to
make changes to the database. We think it&#8217;s unlikely that they will conflict
with each other, so we let them go ahead and just make sure we have a way to
notice if there is a <span class="keep-together">problem</span>.</p>
</div>
<div class="paragraph">
<p><em>Pessimistic</em> concurrency control works under the assumption that two users
are going to cause conflicts, and we want to prevent conflicts in all cases, so
we lock everything just to be safe. In our example, that would mean locking
the whole <code>batches</code> table, or using SELECT FOR UPDATE—we&#8217;re pretending
that we&#8217;ve ruled those out for performance reasons, but in real life you&#8217;d
want to do some evaluations and measurements of your own.</p>
</div>
<div class="paragraph">
<p>With pessimistic locking, you don&#8217;t need to think about handling failures
because the database will prevent them for you (although you do need to think
about deadlocks). With optimistic locking, you need to explicitly handle
the possibility of failures in the (hopefully unlikely) case of a clash.</p>
</div>
<div class="paragraph">
<p>The usual way to handle a failure is to retry the failed operation from the
beginning. Imagine we have two customers, Harry and Bob, and each submits an order
for <code>SHINY-TABLE</code>. Both threads load the product at version 1 and allocate
stock. The database prevents the concurrent update, and Bob&#8217;s order fails with
an error. When we <em>retry</em> the operation, Bob&#8217;s order loads the product at
version 2 and tries to allocate again. If there is enough stock left, all is
well; otherwise, he&#8217;ll receive <code>OutOfStock</code>. Most operations can be retried this
way in the case of a concurrency problem.</p>
</div>
<div class="paragraph">
<p>Read more on retries in <a href="#recovering_from_errors">Recovering from Errors Synchronously</a> and <a href="#footguns">Footguns</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_implementation_options_for_version_numbers">7.7.1. Implementation Options for Version Numbers</h4>
<div class="paragraph">
<p>There are essentially three options for implementing version numbers:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>version_number</code> lives in the domain; we add it to the <code>Product</code> constructor,
and <code>Product.allocate()</code> is responsible for incrementing it.</p>
</li>
<li>
<p>The service layer could do it!  The version number isn&#8217;t <em>strictly</em> a domain
concern, so instead our service layer could assume that the current version number
is attached to <code>Product</code> by the repository, and the service layer will increment it
before it does the <code>commit()</code>.</p>
</li>
<li>
<p>Since it&#8217;s arguably an infrastructure concern, the UoW and repository
could do it by magic.  The repository has access to version numbers for any
products it retrieves, and when the UoW does a commit, it can increment the
version number for any products it knows about, assuming them to have changed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Option 3 isn&#8217;t ideal, because there&#8217;s no real way of doing it without having to
assume that <em>all</em> products have changed, so we&#8217;ll be incrementing version numbers
when we don&#8217;t have to.<sup class="footnote">[<a id="_footnoteref_24" class="footnote" href="#_footnotedef_24" title="View footnote.">24</a>]</sup></p>
</div>
<div class="paragraph">
<p>Option 2 involves mixing the responsibility for mutating state between the service
layer and the domain layer, so it&#8217;s a little messy as well.</p>
</div>
<div class="paragraph">
<p>So in the end, even though version numbers don&#8217;t <em>have</em> to be a domain concern,
you might decide the cleanest trade-off is to put them in the domain:</p>
</div>
<div id="product_aggregate_with_version_number" class="exampleblock">
<div class="title">Our chosen aggregate, Product (src/allocation/domain/model.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Product</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">:</span> <span class="tok-n">List</span><span class="tok-p">[</span><span class="tok-n">Batch</span><span class="tok-p">],</span> <span class="tok-n">version_number</span><span class="tok-p">:</span> <span class="tok-nb">int</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">sku</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">batches</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">version_number</span> <span class="tok-o">=</span> <span class="tok-n">version_number</span>  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-nb">next</span><span class="tok-p">(</span>
                <span class="tok-n">b</span> <span class="tok-k">for</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-nb">sorted</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-p">)</span> <span class="tok-k">if</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">can_allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
            <span class="tok-p">)</span>
            <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">version_number</span> <span class="tok-o">+=</span> <span class="tok-mi">1</span>  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-k">return</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">reference</span>
        <span class="tok-k">except</span> <span class="tok-ne">StopIteration</span><span class="tok-p">:</span>
            <span class="tok-k">raise</span> <span class="tok-n">OutOfStock</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;Out of stock for sku {line.sku}&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>There it is!</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you&#8217;re scratching your head at this version number business, it might
    help to remember that the <em>number</em> isn&#8217;t important. What&#8217;s important is
    that the <code>Product</code> database row is modified whenever we make a change to the
    <code>Product</code> aggregate. The version number is a simple, human-comprehensible way
    to model a thing that changes on every write, but it could equally be a
    random UUID every time.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_for_our_data_integrity_rules">7.8. Testing for Our Data Integrity Rules</h3>
<div class="paragraph">
<p>Now to make sure we can get the behavior we want: if we have two
concurrent attempts to do allocation against the same <code>Product</code>, one of them
should fail, because they can&#8217;t both update the version number.</p>
</div>
<div class="paragraph">
<p>First, let&#8217;s simulate a "slow" transaction using a function that does
allocation and then does an explicit sleep:<sup class="footnote">[<a id="_footnoteref_25" class="footnote" href="#_footnotedef_25" title="View footnote.">25</a>]</sup></p>
</div>
<div id="time_sleep_thread" class="exampleblock">
<div class="title">time.sleep can reproduce concurrency behavior (tests/integration/test_uow.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">try_to_allocate</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">exceptions</span><span class="tok-p">):</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>
    <span class="tok-k">try</span><span class="tok-p">:</span>
        <span class="tok-k">with</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">()</span> <span class="tok-k">as</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
            <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">)</span>
            <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
            <span class="tok-n">time</span><span class="tok-o">.</span><span class="tok-n">sleep</span><span class="tok-p">(</span><span class="tok-mf">0.2</span><span class="tok-p">)</span>
            <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>
    <span class="tok-k">except</span> <span class="tok-ne">Exception</span> <span class="tok-k">as</span> <span class="tok-n">e</span><span class="tok-p">:</span>
        <span class="tok-k">print</span><span class="tok-p">(</span><span class="tok-n">traceback</span><span class="tok-o">.</span><span class="tok-n">format_exc</span><span class="tok-p">())</span>
        <span class="tok-n">exceptions</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then we have our test invoke this slow allocation twice, concurrently, using
threads:</p>
</div>
<div id="data_integrity_test" class="exampleblock">
<div class="title">An integration test for concurrency behavior (tests/integration/test_uow.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_concurrent_updates_to_version_are_not_allowed</span><span class="tok-p">(</span><span class="tok-n">postgres_session_factory</span><span class="tok-p">):</span>
    <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">random_sku</span><span class="tok-p">(),</span> <span class="tok-n">random_batchref</span><span class="tok-p">()</span>
    <span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-n">postgres_session_factory</span><span class="tok-p">()</span>
    <span class="tok-n">insert_batch</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">,</span> <span class="tok-n">batch</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">,</span> <span class="tok-n">product_version</span><span class="tok-o">=</span><span class="tok-mi">1</span><span class="tok-p">)</span>
    <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>

    <span class="tok-n">order1</span><span class="tok-p">,</span> <span class="tok-n">order2</span> <span class="tok-o">=</span> <span class="tok-n">random_orderid</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">),</span> <span class="tok-n">random_orderid</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span>
    <span class="tok-n">exceptions</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>  <span class="tok-c1"># type: List[Exception]</span>
    <span class="tok-n">try_to_allocate_order1</span> <span class="tok-o">=</span> <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-n">try_to_allocate</span><span class="tok-p">(</span><span class="tok-n">order1</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">exceptions</span><span class="tok-p">)</span>
    <span class="tok-n">try_to_allocate_order2</span> <span class="tok-o">=</span> <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-n">try_to_allocate</span><span class="tok-p">(</span><span class="tok-n">order2</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">exceptions</span><span class="tok-p">)</span>
    <span class="tok-n">thread1</span> <span class="tok-o">=</span> <span class="tok-n">threading</span><span class="tok-o">.</span><span class="tok-n">Thread</span><span class="tok-p">(</span><span class="tok-n">target</span><span class="tok-o">=</span><span class="tok-n">try_to_allocate_order1</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">thread2</span> <span class="tok-o">=</span> <span class="tok-n">threading</span><span class="tok-o">.</span><span class="tok-n">Thread</span><span class="tok-p">(</span><span class="tok-n">target</span><span class="tok-o">=</span><span class="tok-n">try_to_allocate_order2</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">thread1</span><span class="tok-o">.</span><span class="tok-n">start</span><span class="tok-p">()</span>
    <span class="tok-n">thread2</span><span class="tok-o">.</span><span class="tok-n">start</span><span class="tok-p">()</span>
    <span class="tok-n">thread1</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">()</span>
    <span class="tok-n">thread2</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">()</span>

    <span class="tok-p">[[</span><span class="tok-n">version</span><span class="tok-p">]]</span> <span class="tok-o">=</span> <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span>
        <span class="tok-s2">&quot;SELECT version_number FROM products WHERE sku=:sku&quot;</span><span class="tok-p">,</span>
        <span class="tok-nb">dict</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">),</span>
    <span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">version</span> <span class="tok-o">==</span> <span class="tok-mi">2</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-p">[</span><span class="tok-n">exception</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">exceptions</span>
    <span class="tok-k">assert</span> <span class="tok-s1">&#39;could not serialize access due to concurrent update&#39;</span> <span class="tok-ow">in</span> <span class="tok-nb">str</span><span class="tok-p">(</span><span class="tok-n">exception</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="tok-n">orders</span> <span class="tok-o">=</span> <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span>
        <span class="tok-s2">&quot;SELECT orderid FROM allocations&quot;</span>
        <span class="tok-s2">&quot; JOIN batches ON allocations.batch_id = batches.id&quot;</span>
        <span class="tok-s2">&quot; JOIN order_lines ON allocations.orderline_id = order_lines.id&quot;</span>
        <span class="tok-s2">&quot; WHERE order_lines.sku=:sku&quot;</span><span class="tok-p">,</span>
        <span class="tok-nb">dict</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">),</span>
    <span class="tok-p">))</span>
    <span class="tok-k">assert</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">orders</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-mi">1</span>  <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-k">with</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">()</span> <span class="tok-k">as</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span><span class="tok-s1">&#39;select 1&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We start two threads that will reliably produce the concurrency behavior we
want: <code>read1, read2, write1, write2</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We assert that the version number has been incremented only once.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We can also check on the specific exception if we like.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>And we double-check that only one allocation has gotten through.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_enforcing_concurrency_rules_by_using_database_transaction_isolation_levels">7.8.1. Enforcing Concurrency Rules by Using Database Transaction <span class="keep-together">Isolation Levels</span></h4>
<div class="paragraph">
<p>To get the test to pass as it is, we can set the transaction isolation level
on our session:</p>
</div>
<div id="isolation_repeatable_read" class="exampleblock">
<div class="title">Set isolation level for session (src/allocation/service_layer/unit_of_work.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">DEFAULT_SESSION_FACTORY</span> <span class="tok-o">=</span> <span class="tok-n">sessionmaker</span><span class="tok-p">(</span><span class="tok-n">bind</span><span class="tok-o">=</span><span class="tok-n">create_engine</span><span class="tok-p">(</span>
    <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-n">get_postgres_uri</span><span class="tok-p">(),</span>
    <span class="tok-n">isolation_level</span><span class="tok-o">=</span><span class="tok-s2">&quot;REPEATABLE READ&quot;</span><span class="tok-p">,</span>
<span class="tok-p">))</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Transaction isolation levels are tricky stuff, so it&#8217;s worth spending time
understanding <a href="https://oreil.ly/5vxJA">the Postgres documentation</a>.<sup class="footnote">[<a id="_footnoteref_26" class="footnote" href="#_footnotedef_26" title="View footnote.">26</a>]</sup>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_pessimistic_concurrency_control_example_select_for_update">7.8.2. Pessimistic Concurrency Control Example: SELECT FOR UPDATE</h4>
<div class="paragraph">
<p>There are multiple ways to approach this, but we&#8217;ll show one. <a href="https://oreil.ly/i8wKL"><code>SELECT FOR UPDATE</code></a>
produces different behavior; two concurrent transactions will not be allowed to
do a read on the same rows at the same time:</p>
</div>
<div class="paragraph">
<p><code>SELECT FOR UPDATE</code> is a way of picking a row or rows to use as a lock
(although those rows don&#8217;t have to be the ones you update).  If two
transactions both try to <code>SELECT FOR UPDATE</code> a row at the same time, one will
win, and the other will wait until the lock is released. So this is an example
of pessimistic concurrency control.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s how you can use the SQLAlchemy DSL to specify <code>FOR UPDATE</code> at
query time:</p>
</div>
<div id="with_for_update" class="exampleblock">
<div class="title">SQLAlchemy with_for_update (src/allocation/adapters/repository.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">query</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">)</span> \
                           <span class="tok-o">.</span><span class="tok-n">filter_by</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">)</span> \
                           <span class="tok-o">.</span><span class="tok-n">with_for_update</span><span class="tok-p">()</span> \
                           <span class="tok-o">.</span><span class="tok-n">first</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This will have the effect of changing the concurrency pattern from</p>
</div>
<div class="listingblock skip">
<div class="content">
<pre>read1, read2, write1, write2(fail)</pre>
</div>
</div>
<div class="paragraph">
<p>to</p>
</div>
<div class="listingblock skip">
<div class="content">
<pre>read1, write1, read2, write2(succeed)</pre>
</div>
</div>
<div class="paragraph">
<p>Some people refer to this as the "read-modify-write" failure mode.
Read <a href="https://oreil.ly/uXeZI">"PostgreSQL Anti-Patterns: Read-Modify-Write Cycles"</a> for a good <span class="keep-together">overview</span>.</p>
</div>
<div class="paragraph">
<p>We don&#8217;t really have time to discuss all the trade-offs between <code>REPEATABLE READ</code>
and <code>SELECT FOR UPDATE</code>, or optimistic versus pessimistic locking in general.
But if you have a test like the one we&#8217;ve shown, you can specify the behavior
you want and see how it changes. You can also use the test as a basis for
performing some performance experiments.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up_6">7.9. Wrap-Up</h3>
<div class="paragraph">
<p>Specific choices around concurrency control vary a lot based on business
circumstances and storage technology choices, but we&#8217;d like to bring this
chapter back to the conceptual idea of an aggregate: we explicitly model an
object as being the main entrypoint to some subset of our model, and as being in
charge of enforcing the invariants and business rules that apply across all of
those objects.</p>
</div>
<div class="paragraph">
<p>Choosing the right aggregate is key, and it&#8217;s a decision you may revisit
over time. You can read more about it in multiple DDD books.
We also recommend these three online papers on
<a href="https://dddcommunity.org/library/vernon_2011">effective aggregate design</a>
by Vaughn Vernon (the "red book" author).</p>
</div>
<div class="paragraph">
<p><a href="#chapter_07_aggregate_tradoffs">Aggregates: the trade-offs</a> has some thoughts on the trade-offs of implementing the Aggregate pattern.</p>
</div>
<table id="chapter_07_aggregate_tradoffs" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Aggregates: the trade-offs</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pros</th>
<th class="tableblock halign-left valign-top">Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Python might not have "official" public and private methods, but we do have
the underscores convention, because it&#8217;s often useful to try to indicate what&#8217;s for
"internal" use and what&#8217;s for "outside code" to use. Choosing aggregates is
just the next level up: it lets you decide which of your domain model classes
are the public ones, and which aren&#8217;t.</p>
</li>
<li>
<p>Modeling our operations around explicit consistency boundaries helps us avoid
performance problems with our ORM.</p>
</li>
<li>
<p>Putting the aggregate in sole charge of state changes to its subsidiary models
makes the system easier to reason about, and makes it easier to control invariants.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Yet another new concept for new developers to take on. Explaining entities versus
value objects was already a mental load; now there&#8217;s a third type of domain
model object?</p>
</li>
<li>
<p>Sticking rigidly to the rule that we modify only one aggregate at a time is a
big mental shift.</p>
</li>
<li>
<p>Dealing with eventual consistency between aggregates can be complex.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Aggregates and Consistency Boundaries Recap</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Aggregates are your entrypoints into the domain model</dt>
<dd>
<p>By restricting the number of ways that things can be changed,
we make the system easier to reason about.</p>
</dd>
<dt class="hdlist1">Aggregates are in charge of a consistency boundary</dt>
<dd>
<p>An aggregate&#8217;s job is to be able to manage our business rules
about invariants as they apply to a group of related objects.
It&#8217;s the aggregate&#8217;s job to check that the objects within its
remit are consistent with each other and with our rules, and
to reject changes that would break the rules.</p>
</dd>
<dt class="hdlist1">Aggregates and concurrency issues go together</dt>
<dd>
<p>When thinking about implementing these consistency checks, we
end up thinking about transactions and locks.  Choosing the
right aggregate is about performance as well as conceptual
organization of your domain.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_part_i_recap">7.10. Part I Recap</h3>
<div class="paragraph">
<p>Do you remember <a href="#recap_components_diagram">A component diagram for our app at the end of Part I</a>, the diagram we showed at the
beginning of <a href="#part1">Building an Architecture to Support Domain Modeling</a> to preview where we were heading?</p>
</div>
<div id="recap_components_diagram" class="imageblock width-75">
<div class="content">
<img src="images/apwp_0705.png" alt="apwp 0705">
</div>
<div class="title">Figure 28. A component diagram for our app at the end of Part I</div>
</div>
<div class="paragraph">
<p>So that&#8217;s where we are at the end of Part I. What have we achieved? We&#8217;ve
seen how to build a domain model that&#8217;s exercised by a set of
high-level unit tests. Our tests are living documentation: they describe the
behavior of our system&#8212;&#8203;the rules upon which we agreed with our business
stakeholders&#8212;&#8203;in nice readable code. When our business requirements change, we
have confidence that our tests will help us to prove the new functionality, and
when new developers join the project, they can read our tests to understand how
things work.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve decoupled the infrastructural parts of our system, like the database and
API handlers, so that we can plug them into the outside of our application.
This helps us to keep our codebase well organized and stops us from building a
big ball of mud.</p>
</div>
<div class="paragraph">
<p>By applying the dependency inversion principle, and by using ports-and-adapters-inspired patterns like Repository and Unit of Work, we&#8217;ve made it possible to
do TDD in both high gear and low gear and to maintain a healthy test pyramid.
We can test our system edge to edge, and the need for integration and
end-to-end tests is kept to a minimum.</p>
</div>
<div class="paragraph">
<p>Lastly, we&#8217;ve talked about the idea of consistency boundaries. We don&#8217;t want to
lock our entire system whenever we make a change, so we have to choose which
parts are consistent with one another.</p>
</div>
<div class="paragraph">
<p>For a small system, this is everything you need to go and play with the ideas of
domain-driven design. You now have the tools to build database-agnostic domain
models that represent the shared language of your business experts. Hurrah!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
At the risk of laboring the point&#8212;&#8203;we&#8217;ve been at pains to point out that
    each pattern comes at a cost. Each layer of indirection has a price in terms
    of complexity and duplication in our code and will be confusing to programmers
    who&#8217;ve never seen these patterns before. If your app is essentially a simple CRUD
    wrapper around a database and isn&#8217;t likely to be anything more than that
    in the foreseeable future, <em>you don&#8217;t need these patterns</em>. Go ahead and
    use Django, and save yourself a lot of bother.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In Part II, we&#8217;ll zoom out and talk about a bigger topic: if aggregates are our
boundary, and we can update only one at a time, how do we model processes that
cross consistency boundaries?</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="part2">Event-Driven Architecture</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>I&#8217;m sorry that I long ago coined the term "objects" for this topic because it
gets many people to focus on the lesser idea.</p>
</div>
<div class="paragraph">
<p>The big idea is "messaging."&#8230;&#8203;The key in making great and growable systems is
much more to design how its modules communicate rather than what their internal
properties and behaviors should be.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Alan Kay
</div>
</div>
<div class="paragraph">
<p>It&#8217;s all very well being able to write <em>one</em> domain model to manage a single bit
of business process, but what happens when we need to write <em>many</em> models? In
the real world, our applications sit within an organization and need to exchange
information with other parts of the system. You may remember our context
diagram shown in <a href="#allocation_context_diagram_again">But exactly how will all these systems talk to each other?</a>.</p>
</div>
<div class="paragraph">
<p>Faced with this requirement, many teams reach for microservices integrated
via HTTP APIs. But if they&#8217;re not careful, they&#8217;ll end up producing the most
chaotic mess of all: the distributed big ball of mud.</p>
</div>
<div class="paragraph">
<p>In Part II, we&#8217;ll show how the techniques from <a href="#part1">Building an Architecture to Support Domain Modeling</a> can be extended to
distributed systems. We&#8217;ll zoom out to look at how we can compose a system from
many small components that interact through asynchronous message passing.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll see how our Service Layer and Unit of Work patterns allow us to reconfigure our app
to run as an asynchronous message processor, and how event-driven systems help
us to decouple aggregates and applications from one another.</p>
</div>
<div id="allocation_context_diagram_again" class="imageblock">
<div class="content">
<img src="images/apwp_0102.png" alt="apwp 0102">
</div>
<div class="title">Figure 29. But exactly how will all these systems talk to each other?</div>
</div>
<div class="paragraph">
<p>We&#8217;ll look at the following patterns and techniques:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Domain Events</dt>
<dd>
<p>Trigger workflows that cross consistency boundaries.</p>
</dd>
<dt class="hdlist1">Message Bus</dt>
<dd>
<p>Provide a unified way of invoking use cases from any endpoint.</p>
</dd>
<dt class="hdlist1">CQRS</dt>
<dd>
<p>Separating reads and writes avoids awkward compromises in an event-driven
architecture and enables performance and scalability improvements.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Plus, we&#8217;ll add a dependency injection framework. This has nothing to do with
event-driven architecture per se, but it tidies up an awful lot of loose
ends.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_08_events_and_message_bus">8. Events and the Message Bus</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far we&#8217;ve spent a lot of time and energy on a simple problem that we could
easily have solved with Django. You might be asking if the increased testability
and expressiveness are <em>really</em> worth all the effort.</p>
</div>
<div class="paragraph">
<p>In practice, though, we find that it&#8217;s not the obvious features that make a mess
of our codebases: it&#8217;s the goop around the edge. It&#8217;s reporting, and permissions,
and workflows that touch a zillion objects.</p>
</div>
<div class="paragraph">
<p>Our example will be a typical notification requirement: when we can&#8217;t allocate
an order because we&#8217;re out of stock, we should alert the buying team. They&#8217;ll
go and fix the problem by buying more stock, and all will be well.</p>
</div>
<div class="paragraph">
<p>For a first version, our product owner says we can just send the alert by email.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see how our architecture holds up when we need to plug in some of the
mundane stuff that makes up so much of our systems.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll start by doing the simplest, most expeditious thing, and talk about
why it&#8217;s exactly this kind of decision that leads us to the Big Ball of Mud.</p>
</div>
<div class="paragraph">
<p>Then we&#8217;ll show how to use the <em>Domain Events</em> pattern to separate side effects from our
use cases, and how to use a simple <em>Message Bus</em> pattern for triggering behavior
based on those events. We&#8217;ll show a few options for creating
those events and how to pass them to the message bus, and finally we&#8217;ll show
how the Unit of Work pattern can be modified to connect the two together elegantly,
as previewed in <a href="#message_bus_diagram">Events flowing through the system</a>.</p>
</div>
<div id="message_bus_diagram" class="imageblock">
<div class="content">
<img src="images/apwp_0801.png" alt="apwp 0801">
</div>
<div class="title">Figure 30. Events flowing through the system</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The code for this chapter is in the
chapter_08_events_and_message_bus branch <a href="https://oreil.ly/M-JuL">on GitHub</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/cosmicpython/code.git
cd code
git checkout chapter_08_events_and_message_bus
# or to code along, checkout the previous chapter:
git checkout chapter_07_aggregate</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_avoiding_making_a_mess">8.1. Avoiding Making a Mess</h3>
<div class="paragraph">
<p>So. Email alerts when we run out of stock. When we have new requirements like ones that <em>really</em> have nothing to do with the core domain, it&#8217;s all too easy to
start dumping these things into our web controllers.</p>
</div>
<div class="sect3">
<h4 id="_first_lets_avoid_making_a_mess_of_our_web_controllers">8.1.1. First, Let&#8217;s Avoid Making a Mess of Our Web Controllers</h4>
<div class="paragraph">
<p>As a one-off hack, this <em>might</em> be OK:</p>
</div>
<div id="email_in_flask" class="exampleblock">
<div class="title">Just whack it in the endpoint—what could go wrong? (src/allocation/entrypoints/flask_app.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@app.route</span><span class="tok-p">(</span><span class="tok-s2">&quot;/allocate&quot;</span><span class="tok-p">,</span> <span class="tok-n">methods</span><span class="tok-o">=</span><span class="tok-p">[</span><span class="tok-s1">&#39;POST&#39;</span><span class="tok-p">])</span>
<span class="tok-k">def</span> <span class="tok-nf">allocate_endpoint</span><span class="tok-p">():</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span>
        <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">],</span>
        <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">],</span>
        <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">[</span><span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">],</span>
    <span class="tok-p">)</span>
    <span class="tok-k">try</span><span class="tok-p">:</span>
        <span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">()</span>
        <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">)</span>
    <span class="tok-k">except</span> <span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">,</span> <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">InvalidSku</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-n">e</span><span class="tok-p">:</span>
        <span class="tok-n">send_mail</span><span class="tok-p">(</span>
            <span class="tok-s1">&#39;out of stock&#39;</span><span class="tok-p">,</span>
            <span class="tok-s1">&#39;stock_admin@made.com&#39;</span><span class="tok-p">,</span>
            <span class="tok-n">f</span><span class="tok-s1">&#39;{line.orderid} - {line.sku}&#39;</span>
        <span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-n">jsonify</span><span class="tok-p">({</span><span class="tok-s1">&#39;message&#39;</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">)}),</span> <span class="tok-mi">400</span>

    <span class="tok-k">return</span> <span class="tok-n">jsonify</span><span class="tok-p">({</span><span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">:</span> <span class="tok-n">batchref</span><span class="tok-p">}),</span> <span class="tok-mi">201</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;but it&#8217;s easy to see how we can quickly end up in a mess by patching things up
like this. Sending email isn&#8217;t the job of our HTTP layer, and we&#8217;d like to be
able to unit test this new feature.</p>
</div>
</div>
<div class="sect3">
<h4 id="_and_lets_not_make_a_mess_of_our_model_either">8.1.2. And Let&#8217;s Not Make a Mess of Our Model Either</h4>
<div class="paragraph">
<p>Assuming we don&#8217;t want to put this code into our web controllers, because
we want them to be as thin as possible, we may look at putting it right at
the source, in the model:</p>
</div>
<div id="email_in_model" class="exampleblock">
<div class="title">Email-sending code in our model isn&#8217;t lovely either (src/allocation/domain/model.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-nb">next</span><span class="tok-p">(</span>
                <span class="tok-n">b</span> <span class="tok-k">for</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-nb">sorted</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-p">)</span> <span class="tok-k">if</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">can_allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
            <span class="tok-p">)</span>
            <span class="tok-c1">#...</span>
        <span class="tok-k">except</span> <span class="tok-ne">StopIteration</span><span class="tok-p">:</span>
            <span class="tok-n">email</span><span class="tok-o">.</span><span class="tok-n">send_mail</span><span class="tok-p">(</span><span class="tok-s1">&#39;stock@made.com&#39;</span><span class="tok-p">,</span> <span class="tok-n">f</span><span class="tok-s1">&#39;Out of stock for {line.sku}&#39;</span><span class="tok-p">)</span>
            <span class="tok-k">raise</span> <span class="tok-n">OutOfStock</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;Out of stock for sku {line.sku}&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But that&#8217;s even worse! We don&#8217;t want our model to have any dependencies on
infrastructure concerns like <code>email.send_mail</code>.</p>
</div>
<div class="paragraph">
<p>This email-sending thing is unwelcome <em>goop</em> messing up the nice clean flow
of our system. What we&#8217;d like is to keep our domain model focused on the rule
"You can&#8217;t allocate more stuff than is actually available."</p>
</div>
<div class="paragraph">
<p>The domain model&#8217;s job is to know that we&#8217;re out of stock, but the
responsibility of sending an alert belongs elsewhere. We should be able to turn
this feature on or off, or to switch to SMS notifications instead, without
needing to change the rules of our domain model.</p>
</div>
</div>
<div class="sect3">
<h4 id="_or_the_service_layer">8.1.3. Or the Service Layer!</h4>
<div class="paragraph">
<p>The requirement "Try to allocate some stock, and send an email if it fails" is
an example of workflow orchestration: it&#8217;s a set of steps that the system has
to follow to <span class="keep-together">achieve</span> a goal.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve written a service layer to manage orchestration for us, but even here
the feature feels out of place:</p>
</div>
<div id="email_in_services" class="exampleblock">
<div class="title">And in the service layer, it&#8217;s out of place (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span>
        <span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span>
        <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>
<span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">)</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-n">product</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
            <span class="tok-k">raise</span> <span class="tok-n">InvalidSku</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;Invalid sku {line.sku}&#39;</span><span class="tok-p">)</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
            <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>
            <span class="tok-k">return</span> <span class="tok-n">batchref</span>
        <span class="tok-k">except</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">:</span>
            <span class="tok-n">email</span><span class="tok-o">.</span><span class="tok-n">send_mail</span><span class="tok-p">(</span><span class="tok-s1">&#39;stock@made.com&#39;</span><span class="tok-p">,</span> <span class="tok-n">f</span><span class="tok-s1">&#39;Out of stock for {line.sku}&#39;</span><span class="tok-p">)</span>
            <span class="tok-k">raise</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Catching an exception and reraising it? It could be worse, but it&#8217;s
definitely making us unhappy. Why is it so hard to find a suitable home for
this code?</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_single_responsibility_principle">8.2. Single Responsibility Principle</h3>
<div class="paragraph">
<p>Really, this is a violation of the <em>single responsibility principle</em> (SRP).<sup class="footnote">[<a id="_footnoteref_27" class="footnote" href="#_footnotedef_27" title="View footnote.">27</a>]</sup>
Our use case is allocation. Our endpoint, service function, and domain methods
are all called <code><span class="keep-together">allocate</span></code>, not <code>allocate_and_send_mail_if_out_of_stock</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Rule of thumb: if you can&#8217;t describe what your function does without using
    words like "then" or "and," you might be violating the SRP.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>One formulation of the SRP is that each class should have only a single reason
to change. When we switch from email to SMS, we shouldn&#8217;t have to update our
<code>allocate()</code> function, because that&#8217;s clearly a separate responsibility.</p>
</div>
<div class="paragraph">
<p>To solve the problem, we&#8217;re going to split the orchestration
into separate steps so that the different concerns don&#8217;t get tangled up.<sup class="footnote">[<a id="_footnoteref_28" class="footnote" href="#_footnotedef_28" title="View footnote.">28</a>]</sup> The
domain model&#8217;s job is to know that we&#8217;re out of stock, but the responsibility
of sending an alert belongs elsewhere. We should be able to turn this feature
on or off, or to switch to SMS notifications instead, without needing to change
the rules of our domain model.</p>
</div>
<div class="paragraph">
<p>We&#8217;d also like to keep the service layer free of implementation details. We
want to apply the dependency inversion principle to notifications so that our
service layer depends on an abstraction, in the same way as we avoid depending
on the database by using a unit of work.</p>
</div>
</div>
<div class="sect2">
<h3 id="_all_aboard_the_message_bus">8.3. All Aboard the Message Bus!</h3>
<div class="paragraph">
<p>The patterns we&#8217;re going to introduce here are <em>Domain Events</em> and the <em>Message Bus</em>.
We can implement them in a few ways, so we&#8217;ll show a couple before settling on the one we like most.</p>
</div>
<div class="sect3">
<h4 id="_the_model_records_events">8.3.1. The Model Records Events</h4>
<div class="paragraph">
<p>First, rather than being concerned about emails, our model will be in charge of
recording <em>events</em>—facts about things that have happened. We&#8217;ll use a message bus to respond to events and invoke a new operation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_events_are_simple_dataclasses">8.3.2. Events Are Simple Dataclasses</h4>
<div class="paragraph">
<p>An <em>event</em> is a kind of <em>value object</em>. Events don&#8217;t have any behavior, because
they&#8217;re pure data structures. We always name events in the language of the
domain, and we think of them as part of our domain model.</p>
</div>
<div class="paragraph">
<p>We could store them in <em>model.py</em>, but we may as well keep them in their own file
 (this might be a good time to consider refactoring out a directory called
<em>domain</em> so that we have <em>domain/model.py</em> and <em>domain/events.py</em>):</p>
</div>
<div id="events_dot_py" class="exampleblock nobreakinside less_space">
<div class="title">Event classes (src/allocation/domain/events.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">dataclasses</span> <span class="tok-kn">import</span> <span class="tok-n">dataclass</span>

<span class="tok-k">class</span> <span class="tok-nc">Event</span><span class="tok-p">:</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">pass</span>

<span class="tok-nd">@dataclass</span>
<span class="tok-k">class</span> <span class="tok-nc">OutOfStock</span><span class="tok-p">(</span><span class="tok-n">Event</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Once we have a number of events, we&#8217;ll find it useful to have a parent
class that can store common attributes. It&#8217;s also useful for type
hints in our message bus, as you&#8217;ll see shortly.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>dataclasses</code> are great for domain events too.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_the_model_raises_events">8.3.3. The Model Raises Events</h4>
<div class="paragraph">
<p>When our domain model records a fact that happened, we say it <em>raises</em> an event.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s what it will look like from the outside; if we ask <code>Product</code> to allocate
but it can&#8217;t, it should <em>raise</em> an event:</p>
</div>
<div id="test_raising_event" class="exampleblock">
<div class="title">Test our aggregate to raise events (tests/unit/test_product.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_records_out_of_stock_event_if_cannot_allocate</span><span class="tok-p">():</span>
    <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s1">&#39;batch1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;SMALL-FORK&#39;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">today</span><span class="tok-p">)</span>
    <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">Product</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-s2">&quot;SMALL-FORK&quot;</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-o">=</span><span class="tok-p">[</span><span class="tok-n">batch</span><span class="tok-p">])</span>
    <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s1">&#39;order1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;SMALL-FORK&#39;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">))</span>

    <span class="tok-n">allocation</span> <span class="tok-o">=</span> <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s1">&#39;order2&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;SMALL-FORK&#39;</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">))</span>
    <span class="tok-k">assert</span> <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">events</span><span class="tok-p">[</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-s2">&quot;SMALL-FORK&quot;</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">assert</span> <span class="tok-n">allocation</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Our aggregate will expose a new attribute called <code>.events</code> that will contain
a list of facts about what has happened, in the form of <code>Event</code> objects.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here&#8217;s what the model looks like on the inside:</p>
</div>
<div id="domain_event" class="exampleblock">
<div class="title">The model raises a domain event (src/allocation/domain/model.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Product</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">:</span> <span class="tok-n">List</span><span class="tok-p">[</span><span class="tok-n">Batch</span><span class="tok-p">],</span> <span class="tok-n">version_number</span><span class="tok-p">:</span> <span class="tok-nb">int</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">sku</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">batches</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">version_number</span> <span class="tok-o">=</span> <span class="tok-n">version_number</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">events</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>  <span class="tok-c1"># type: List[events.Event]  </span><i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-c1">#...</span>
        <span class="tok-k">except</span> <span class="tok-ne">StopIteration</span><span class="tok-p">:</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">))</span>  <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-c1"># raise OutOfStock(f&#39;Out of stock for sku {line.sku}&#39;)  </span><i class="conum" data-value="3"></i><b>(3)</b>
            <span class="tok-k">return</span> <span class="tok-bp">None</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here&#8217;s our new <code>.events</code> attribute in use.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Rather than invoking some email-sending code directly, we record those
events at the place they occur, using only the language of the domain.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We&#8217;re also going to stop raising an exception for the out-of-stock
case. The event will do the job the exception was doing.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We&#8217;re actually addressing a code smell we had until now, which is that we were
    <a href="https://oreil.ly/IQB51">using
    exceptions for control flow</a>. In general, if you&#8217;re implementing domain
    events, don&#8217;t raise exceptions to describe the same domain concept.
    As you&#8217;ll see later when we handle events in the Unit of Work pattern, it&#8217;s
    confusing to have to reason about events and exceptions together.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_the_message_bus_maps_events_to_handlers">8.3.4. The Message Bus Maps Events to Handlers</h4>
<div class="paragraph">
<p>A message bus basically says, "When I see this event, I should invoke the following
handler function." In other words, it&#8217;s a simple publish-subscribe system.
Handlers are <em>subscribed</em> to receive events, which we publish to the bus. It
sounds harder than it is, and we usually implement it with a dict:</p>
</div>
<div id="messagebus" class="exampleblock">
<div class="title">Simple message bus (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">handle</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Event</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">handler</span> <span class="tok-ow">in</span> <span class="tok-n">HANDLERS</span><span class="tok-p">[</span><span class="tok-nb">type</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)]:</span>
        <span class="tok-n">handler</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)</span>


<span class="tok-k">def</span> <span class="tok-nf">send_out_of_stock_notification</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">):</span>
    <span class="tok-n">email</span><span class="tok-o">.</span><span class="tok-n">send_mail</span><span class="tok-p">(</span>
        <span class="tok-s1">&#39;stock@made.com&#39;</span><span class="tok-p">,</span>
        <span class="tok-n">f</span><span class="tok-s1">&#39;Out of stock for {event.sku}&#39;</span><span class="tok-p">,</span>
    <span class="tok-p">)</span>


<span class="tok-n">HANDLERS</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-n">send_out_of_stock_notification</span><span class="tok-p">],</span>

<span class="tok-p">}</span>  <span class="tok-c1"># type: Dict[Type[events.Event], List[Callable]]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that the message bus as implemented doesn&#8217;t give us concurrency because
    only one handler will run at a time.
    Our objective isn&#8217;t to support parallel threads but to separate
    tasks conceptually, and to keep each UoW as small as possible.
    This helps us to understand the codebase because the "recipe" for how to
    run each use case is written in a single place.
    See the following sidebar.
</td>
</tr>
</table>
</div>
<div id="celery_sidebar" class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Is This Like Celery?</div>
<div class="paragraph">
<p><em>Celery</em> is a popular tool in the Python world for deferring self-contained
chunks of work to an asynchronous task queue. The message bus we&#8217;re
presenting here is very different, so the short answer to the above question is no; our message bus
has more in common with a Node.js app, a UI event loop, or an actor framework.</p>
</div>
<div class="paragraph">
<p>If you do have a requirement for moving work off the main thread, you
can still use our event-based metaphors, but we suggest you
use <em>external events</em> for that. There&#8217;s more discussion in
<a href="#chapter_11_external_events_tradeoffs">Event-based microservices integration: the trade-offs</a>, but essentially, if you
implement a way of persisting events to a centralized store, you
can subscribe other containers or other microservices to them. Then
that same concept of using events to separate responsibilities
across units of work within a single process/service can be extended across
multiple processes&#8212;&#8203;which may be different containers within the same
service, or totally different microservices.</p>
</div>
<div class="paragraph">
<p>If you follow us in this approach, your API for distributing tasks
is your event <span class="keep-together">classes—</span>or a JSON representation of them. This allows
you a lot of flexibility in who you distribute tasks to; they need not
necessarily be Python services. Celery&#8217;s API for distributing tasks is
essentially "function name plus arguments," which is more restrictive,
and Python-only.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_option_1_the_service_layer_takes_events_from_the_model_and_puts_them_on_the_message_bus">8.4. Option 1: The Service Layer Takes Events from the Model and Puts Them on the Message Bus</h3>
<div class="paragraph">
<p>Our domain model raises events, and our message bus will call the right
handlers whenever an event happens. Now all we need is to connect the two. We
need something to catch events from the model and pass them to the message
bus&#8212;&#8203;the <em>publishing</em> step.</p>
</div>
<div class="paragraph">
<p>The simplest way to do this is by adding some code into our service layer:</p>
</div>
<div id="service_talks_to_messagebus" class="exampleblock">
<div class="title">The service layer with an explicit message bus (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">.</span> <span class="tok-kn">import</span> <span class="tok-n">messagebus</span>
<span class="tok-o">...</span>

<span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span>
        <span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span>
        <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>
<span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">)</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-n">product</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
            <span class="tok-k">raise</span> <span class="tok-n">InvalidSku</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;Invalid sku {line.sku}&#39;</span><span class="tok-p">)</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
            <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>
            <span class="tok-k">return</span> <span class="tok-n">batchref</span>
        <span class="tok-k">finally</span><span class="tok-p">:</span>  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">events</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We keep the <code>try/finally</code> from our ugly earlier implementation (we haven&#8217;t
gotten rid of <em>all</em> exceptions yet, just <code>OutOfStock</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>But now, instead of depending directly on an email infrastructure,
the service layer is just in charge of passing events from the model
up to the message bus.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That already avoids some of the ugliness that we had in our naive
implementation, and we have several systems that work like this one, in which the
service layer explicitly collects events from aggregates and passes them to
the message bus.</p>
</div>
</div>
<div class="sect2">
<h3 id="_option_2_the_service_layer_raises_its_own_events">8.5. Option 2: The Service Layer Raises Its Own Events</h3>
<div class="paragraph">
<p>Another variant on this that we&#8217;ve used is to have the service layer
in charge of creating and raising events directly, rather than having them
raised by the domain model:</p>
</div>
<div id="service_layer_raises_events" class="exampleblock">
<div class="title">Service layer calls messagebus.handle directly (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span>
        <span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span>
        <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>
<span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">)</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-n">product</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
            <span class="tok-k">raise</span> <span class="tok-n">InvalidSku</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;Invalid sku {line.sku}&#39;</span><span class="tok-p">)</span>
        <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span> <i class="conum" data-value="1"></i><b>(1)</b>

        <span class="tok-k">if</span> <span class="tok-n">batchref</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
            <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">))</span>
        <span class="tok-k">return</span> <span class="tok-n">batchref</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>As before, we commit even if we fail to allocate because the code is simpler this way
and it&#8217;s easier to reason about: we always commit unless something goes
wrong. Committing when we haven&#8217;t changed anything is safe and keeps the
code uncluttered.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Again, we have applications in production that implement the pattern in this
way.  What works for you will depend on the particular trade-offs you face, but
we&#8217;d like to show you what we think is the most elegant solution, in which we
put the unit of work in charge of collecting and raising events.</p>
</div>
</div>
<div class="sect2">
<h3 id="_option_3_the_uow_publishes_events_to_the_message_bus">8.6. Option 3: The UoW Publishes Events to the Message Bus</h3>
<div class="paragraph">
<p>The UoW already has a <code>try/finally</code>, and it knows about all the aggregates
currently in play because it provides access to the repository. So it&#8217;s
a good place to spot events and pass them to the message bus:</p>
</div>
<div id="uow_with_messagebus" class="exampleblock">
<div class="title">The UoW meets the message bus (src/allocation/service_layer/unit_of_work.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">AbstractUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">abc</span><span class="tok-o">.</span><span class="tok-n">ABC</span><span class="tok-p">):</span>
    <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-nf">commit</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_commit</span><span class="tok-p">()</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">publish_events</span><span class="tok-p">()</span>  <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-k">def</span> <span class="tok-nf">publish_events</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-k">for</span> <span class="tok-n">product</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">seen</span><span class="tok-p">:</span>  <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="tok-k">while</span> <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">events</span><span class="tok-p">:</span>
                <span class="tok-n">event</span> <span class="tok-o">=</span> <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">pop</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">)</span>
                <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)</span>

    <span class="tok-nd">@abc.abstractmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">_commit</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">raise</span> <span class="tok-ne">NotImplementedError</span>

<span class="tok-o">...</span>

<span class="tok-k">class</span> <span class="tok-nc">SqlAlchemyUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">):</span>
    <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-nf">_commit</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We&#8217;ll change our commit method to require a private <code>._commit()</code>
method from subclasses.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>After committing, we run through all the objects that our
repository has seen and pass their events to the message bus.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>That relies on the repository keeping track of aggregates that have been loaded
using a new attribute, <code>.seen</code>, as you&#8217;ll see in the next listing.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Are you wondering what happens if one of the
    handlers fails?  We&#8217;ll discuss error handling in detail in <a href="#chapter_10_commands">Commands and Command Handler</a>.
</td>
</tr>
</table>
</div>
<div id="repository_tracks_seen" class="exampleblock">
<div class="title">Repository tracks aggregates that pass through it (src/allocation/adapters/repository.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">AbstractRepository</span><span class="tok-p">(</span><span class="tok-n">abc</span><span class="tok-o">.</span><span class="tok-n">ABC</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">seen</span> <span class="tok-o">=</span> <span class="tok-nb">set</span><span class="tok-p">()</span>  <span class="tok-c1"># type: Set[model.Product]  </span><i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-k">def</span> <span class="tok-nf">add</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">product</span><span class="tok-p">:</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_add</span><span class="tok-p">(</span><span class="tok-n">product</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">seen</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">product</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">:</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-n">product</span><span class="tok-p">:</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">seen</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">product</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-n">product</span>

    <span class="tok-nd">@abc.abstractmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">_add</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">product</span><span class="tok-p">:</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-k">raise</span> <span class="tok-ne">NotImplementedError</span>

    <span class="tok-nd">@abc.abstractmethod</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-k">def</span> <span class="tok-nf">_get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">:</span>
        <span class="tok-k">raise</span> <span class="tok-ne">NotImplementedError</span>



<span class="tok-k">class</span> <span class="tok-nc">SqlAlchemyRepository</span><span class="tok-p">(</span><span class="tok-n">AbstractRepository</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">session</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__init__</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-n">session</span>

    <span class="tok-k">def</span> <span class="tok-nf">_add</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">product</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">product</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">_get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">):</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">query</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">filter_by</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">first</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For the UoW to be able to publish new events, it needs to be able to ask
the repository for which <code>Product</code> objects have been used during this session.
We use a <code>set</code> called <code>.seen</code> to store them. That means our implementations
need to call <code>super().__init__()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The parent <code>add()</code> method adds things to <code>.seen</code>, and now requires subclasses
to implement <code>._add()</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Similarly, <code>.get()</code> delegates to a <code>._get()</code> function, to be implemented by
subclasses, in order to capture objects seen.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The use of <code><em>._underscorey()</em></code> methods and subclassing is definitely not
    the only way you could implement these patterns. Have a go at the
    <a href="#get_rid_of_commit">"Exercise for the Reader"</a> in this chapter and experiment
    with some alternatives.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After the UoW and repository collaborate in this way to automatically keep
track of live objects and process their events, the service layer can be
totally free of event-handling concerns:</p>
</div>
<div id="services_clean" class="exampleblock">
<div class="title">Service layer is clean again (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span>
        <span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span>
        <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>
<span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">)</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-n">product</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
            <span class="tok-k">raise</span> <span class="tok-n">InvalidSku</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;Invalid sku {line.sku}&#39;</span><span class="tok-p">)</span>
        <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>
        <span class="tok-k">return</span> <span class="tok-n">batchref</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We do also have to remember to change the fakes in the service layer and make them
call <code>super()</code> in the right places, and to implement underscorey methods, but the
changes are minimal:</p>
</div>
<div id="services_tests_ugly_fake_messagebus" class="exampleblock">
<div class="title">Service-layer fakes need tweaking (tests/unit/test_services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">FakeRepository</span><span class="tok-p">(</span><span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">AbstractRepository</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">products</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__init__</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_products</span> <span class="tok-o">=</span> <span class="tok-nb">set</span><span class="tok-p">(</span><span class="tok-n">products</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">_add</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">product</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_products</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">product</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">_get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-nb">next</span><span class="tok-p">((</span><span class="tok-n">p</span> <span class="tok-k">for</span> <span class="tok-n">p</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_products</span> <span class="tok-k">if</span> <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">==</span> <span class="tok-n">sku</span><span class="tok-p">),</span> <span class="tok-bp">None</span><span class="tok-p">)</span>

<span class="tok-o">...</span>

<span class="tok-k">class</span> <span class="tok-nc">FakeUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">):</span>
    <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-nf">_commit</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">committed</span> <span class="tok-o">=</span> <span class="tok-bp">True</span></code></pre>
</div>
</div>
</div>
</div>
<div id="get_rid_of_commit" class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Exercise for the Reader</div>
<div class="paragraph">
<p>Are you finding all those <code>._add()</code> and <code>._commit()</code> methods "super-gross," in
the words of our beloved tech reviewer Hynek? Does it "make you want to beat
Harry around the head with a plushie snake"? Hey, our code listings are
only meant to be examples, not the perfect solution! Why not go see if you
can do better?</p>
</div>
<div class="paragraph">
<p>One <em>composition over inheritance</em> way to go would be to implement a
wrapper class:</p>
</div>
<div id="tracking_repo_wrapper" class="exampleblock">
<div class="title">A wrapper adds functionality and then delegates (src/adapters/repository.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">TrackingRepository</span><span class="tok-p">:</span>
    <span class="tok-n">seen</span><span class="tok-p">:</span> <span class="tok-n">Set</span><span class="tok-p">[</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">]</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">repo</span><span class="tok-p">:</span> <span class="tok-n">AbstractRepository</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">seen</span> <span class="tok-o">=</span> <span class="tok-nb">set</span><span class="tok-p">()</span>  <span class="tok-c1"># type: Set[model.Product]</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_repo</span> <span class="tok-o">=</span> <span class="tok-n">repo</span>

    <span class="tok-k">def</span> <span class="tok-nf">add</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">product</span><span class="tok-p">:</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_repo</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">product</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">seen</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">product</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">:</span>
        <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_repo</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-n">product</span><span class="tok-p">:</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">seen</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">product</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-n">product</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>By wrapping the repository, we can call the actual <code>.add()</code>
and <code>.get()</code> methods, avoiding weird underscorey methods.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See if you can apply a similar pattern to our UoW class in
order to get rid of those Java-y <code>_commit()</code> methods too. You can find the code on <a href="https://github.com/cosmicpython/code/tree/chapter_08_events_and_message_bus_exercise">GitHub</a>.</p>
</div>
<div class="paragraph">
<p>Switching all the ABCs to <code>typing.Protocol</code> is a good way to force yourself to avoid using inheritance. Let us know if you come up with something nice!</p>
</div>
</div>
</div>
<div class="paragraph">
<p>You might be starting to worry that maintaining these fakes is going to be a
maintenance burden. There&#8217;s no doubt that it is work, but in our experience
it&#8217;s not a lot of work. Once your project is up and running, the interface for
your repository and UoW abstractions really don&#8217;t change much. And if you&#8217;re
using ABCs, they&#8217;ll help remind you when things get out of sync.</p>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up_7">8.7. Wrap-Up</h3>
<div class="paragraph">
<p>Domain events give us a way to handle workflows in our system. We often find,
listening to our domain experts, that they express requirements in a causal or
temporal way—for example, "When we try to allocate stock but there&#8217;s none
available, then we should send an email to the buying team."</p>
</div>
<div class="paragraph">
<p>The magic words "When X, then Y" often tell us about an event that we can make
concrete in our system. Treating events as first-class things in our model helps
us make our code more testable and observable, and it helps isolate concerns.</p>
</div>
<div class="paragraph">
<p>And <a href="#chapter_08_events_and_message_bus_tradeoffs">Domain events: the trade-offs</a> shows the trade-offs as we
see them.</p>
</div>
<table id="chapter_08_events_and_message_bus_tradeoffs" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Domain events: the trade-offs</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pros</th>
<th class="tableblock halign-left valign-top">Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>A message bus gives us a nice way to separate responsibilities when we have
to take multiple actions in response to a request.</p>
</li>
<li>
<p>Event handlers are nicely decoupled from the "core" application logic,
making it easy to change their implementation later.</p>
</li>
<li>
<p>Domain events are a great way to model the real world, and we can use them
as part of our business language when modeling with stakeholders.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>The message bus is an additional thing to wrap your head around; the implementation
in which the unit of work raises events for us is <em>neat</em> but also magic. It&#8217;s not
obvious when we call <code>commit</code> that we&#8217;re also going to go and send email to
people.</p>
</li>
<li>
<p>What&#8217;s more, that hidden event-handling code executes <em>synchronously</em>,
meaning your service-layer function
doesn&#8217;t finish until all the handlers for any events are finished. That
could cause unexpected performance problems in your web endpoints
(adding asynchronous processing is possible but makes things even <em>more</em> confusing).</p>
</li>
<li>
<p>More generally, event-driven workflows can be confusing because after things
are split across a chain of multiple handlers, there is no single place
in the system where you can understand how a request will be fulfilled.</p>
</li>
<li>
<p>You also open yourself up to the possibility of circular dependencies between your
event handlers, and infinite loops.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Events are useful for more than just sending email, though. In <a href="#chapter_07_aggregate">Aggregates and Consistency Boundaries</a> we
spent a lot of time convincing you that you should define aggregates, or
boundaries where we guarantee consistency. People often ask, "What
should I do if I need to change multiple aggregates as part of a request?" Now
we have the tools we need to answer that question.</p>
</div>
<div class="paragraph">
<p>If we have two things that can be transactionally isolated (e.g., an order and a
<span class="keep-together">product</span>), then we can make them <em>eventually consistent</em> by using events. When an
order is canceled, we should find the products that were allocated to it
and remove the <span class="keep-together">allocations</span>.</p>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Domain Events and the Message Bus Recap</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Events can help with the single responsibility principle</dt>
<dd>
<p>Code gets tangled up when we mix multiple concerns in one place. Events can
help us to keep things tidy by separating primary use cases from secondary
ones.
We also use events for communicating between aggregates so that we don&#8217;t
need to run long-running transactions that lock against multiple tables.</p>
</dd>
<dt class="hdlist1">A message bus routes messages to handlers</dt>
<dd>
<p>You can think of a message bus as a dict that maps from events to their
consumers. It doesn&#8217;t "know" anything about the meaning of events; it&#8217;s just
a piece of dumb infrastructure for getting messages around the system.</p>
</dd>
<dt class="hdlist1">Option 1: Service layer raises events and passes them to message bus</dt>
<dd>
<p>The simplest way to start using events in your system is to raise them from
handlers by calling <code>bus.handle(some_new_event)</code> after you commit your
unit of work.</p>
</dd>
<dt class="hdlist1">Option 2: Domain model raises events, service layer passes them to message bus</dt>
<dd>
<p>The logic about when to raise an event really should live with the model, so
we can improve our system&#8217;s design and testability by raising events from
the domain model. It&#8217;s easy for our handlers to collect events off the model
objects after <code>commit</code> and pass them to the bus.</p>
</dd>
<dt class="hdlist1">Option 3: UoW collects events from aggregates and passes them to message bus</dt>
<dd>
<p>Adding <code>bus.handle(aggregate.events)</code> to every handler is annoying, so we
can tidy up by making our unit of work responsible for raising events that
were raised by loaded objects.
This is the most complex design and might rely on ORM magic, but it&#8217;s clean
and easy to use once it&#8217;s set up.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="paragraph">
<p>In <a href="#chapter_09_all_messagebus">Going to Town on the Message Bus</a>, we&#8217;ll look at this idea in more
detail as we build a more complex workflow with our new message bus.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_09_all_messagebus">9. Going to Town on the Message Bus</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter, we&#8217;ll start to make events more fundamental to the internal
structure of our application. We&#8217;ll move from the current state in
<a href="#maps_chapter_08_before">Before: the message bus is an optional add-on</a>, where events are an optional
side effect&#8230;&#8203;</p>
</div>
<div id="maps_chapter_08_before" class="imageblock">
<div class="content">
<img src="images/apwp_0901.png" alt="apwp 0901">
</div>
<div class="title">Figure 31. Before: the message bus is an optional add-on</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;to the situation in <a href="#map_chapter_08_after">The message bus is now the main entrypoint to the service layer</a>, where
everything goes via the message bus, and our app has been transformed
fundamentally into a message processor.</p>
</div>
<div id="map_chapter_08_after" class="imageblock">
<div class="content">
<img src="images/apwp_0902.png" alt="apwp 0902">
</div>
<div class="title">Figure 32. The message bus is now the main entrypoint to the service layer</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The code for this chapter is in the
chapter_09_all_messagebus branch <a href="https://oreil.ly/oKNkn">on GitHub</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/cosmicpython/code.git
cd code
git checkout chapter_09_all_messagebus
# or to code along, checkout the previous chapter:
git checkout chapter_08_events_and_message_bus</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_a_new_requirement_leads_us_to_a_new_architecture">9.1. A New Requirement Leads Us to a New Architecture</h3>
<div class="paragraph">
<p>Rich Hickey talks about <em>situated software,</em> meaning software that runs for
extended periods of time, managing a real-world process. Examples include
warehouse-management systems, logistics schedulers, and payroll systems.</p>
</div>
<div class="paragraph">
<p>This software is tricky to write because unexpected things happen all the time
in the real world of physical objects and unreliable humans. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>During a stock-take, we discover that three <code>SPRINGY-MATTRESS</code>es have been
water damaged by a leaky roof.</p>
</li>
<li>
<p>A consignment of <code>RELIABLE-FORK</code>s is missing the required documentation and is
held in customs for several weeks. Three <code>RELIABLE-FORK</code>s subsequently fail safety
testing and are destroyed.</p>
</li>
<li>
<p>A global shortage of sequins means we&#8217;re unable to manufacture our next batch
of <code>SPARKLY-BOOKCASE</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In these types of situations, we learn about the need to change batch quantities
when they&#8217;re already in the system. Perhaps someone made a mistake on the number
in the manifest, or perhaps some sofas fell off a truck. Following a
conversation with the business,<sup class="footnote">[<a id="_footnoteref_29" class="footnote" href="#_footnotedef_29" title="View footnote.">29</a>]</sup> we model the situation as in
<a href="#batch_changed_events_flow_diagram">Batch quantity changed means deallocate and reallocate</a>.</p>
</div>
<div id="batch_changed_events_flow_diagram" class="imageblock">
<div class="content">
<img src="images/apwp_0903.png" alt="apwp 0903">
</div>
<div class="title">Figure 33. Batch quantity changed means deallocate and reallocate</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[ditaa, apwp_0903]
+----------+    /----\      +------------+       +--------------------+
| Batch    |--&gt; |RULE| --&gt;  | Deallocate | ----&gt; | AllocationRequired |
| Quantity |    \----/      +------------+-+     +--------------------+-+
| Changed  |                  | Deallocate | ----&gt; | AllocationRequired |
+----------+                  +------------+-+     +--------------------+-+
                                | Deallocate | ----&gt; | AllocationRequired |
                                +------------+       +--------------------+</pre>
</div>
</div>
<div class="paragraph">
<p>An event we&#8217;ll call <code>BatchQuantityChanged</code> should lead us to change the
quantity on the batch, yes, but also to apply a <em>business rule</em>: if the new
quantity drops to less than the total already allocated, we need to
<em>deallocate</em>  those orders from that batch. Then each one will require
a new allocation, which we can capture as an event called <code>AllocationRequired</code>.</p>
</div>
<div class="paragraph">
<p>Perhaps you&#8217;re already anticipating that our internal message bus and events can
help implement this requirement. We could define a service called
<code>change_batch_quantity</code> that knows how to adjust batch quantities and also how
to <em>deallocate</em> any excess order lines, and then each deallocation can emit an
<code>AllocationRequired</code> event that can be forwarded to the existing <code>allocate</code>
service, in separate transactions. Once again, our message bus helps us to
enforce the single responsibility principle, and it allows us to make choices about
transactions and data integrity.</p>
</div>
<div class="sect3">
<h4 id="_imagining_an_architecture_change_everything_will_be_an_event_handler">9.1.1. Imagining an Architecture Change: Everything Will Be an <span class="keep-together">Event Handler</span></h4>
<div class="paragraph">
<p>But before we jump in, think about where we&#8217;re headed.  There are two
kinds of flows through our system:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>API calls that are handled by a service-layer function</p>
</li>
<li>
<p>Internal events (which might be raised as a side effect of a service-layer function)
and their handlers (which in turn call service-layer functions)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Wouldn&#8217;t it be easier if everything was an event handler?  If we rethink our API
calls as capturing events, the service-layer functions can be event handlers
too, and we no longer need to make a distinction between internal and external
event handlers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>services.allocate()</code> could be the handler for an
<code>AllocationRequired</code> event and could emit <code>Allocated</code> events as its output.</p>
</li>
<li>
<p><code>services.add_batch()</code> could be the handler for a <code>BatchCreated</code>
event.<sup class="footnote">[<a id="_footnoteref_30" class="footnote" href="#_footnotedef_30" title="View footnote.">30</a>]</sup></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Our new requirement will fit the same pattern:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An event called <code>BatchQuantityChanged</code> can invoke a handler called
<code>change_batch_quantity()</code>.</p>
</li>
<li>
<p>And the new <code>AllocationRequired</code> events that it may raise can be passed on to
<code>services.allocate()</code> too, so there is no conceptual difference between a
brand-new allocation coming from the API and a reallocation that&#8217;s
internally triggered by a deallocation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All sound like a bit much? Let&#8217;s work toward it all gradually.  We&#8217;ll
follow the
<a href="https://oreil.ly/W3RZM">Preparatory
Refactoring</a> workflow, aka "Make the change easy; then make the easy change":</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We refactor our service layer into event handlers. We can
get used to the idea of events being the way we describe inputs to the
system. In particular, the existing <code>services.allocate()</code> function will
become the handler for an event called <code>AllocationRequired</code>.</p>
</li>
<li>
<p>We build an end-to-end test that puts <code>BatchQuantityChanged</code> events
into the system and looks for <code>Allocated</code> events coming out.</p>
</li>
<li>
<p>Our implementation will conceptually be very simple: a new
handler for <code>BatchQuantityChanged</code> events, whose implementation will emit
<code>AllocationRequired</code> events, which in turn will be handled by the exact same
handler for allocations that the API uses.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Along the way, we&#8217;ll make a small tweak to the message bus and UoW, moving the
responsibility for putting new events on the message bus into the message bus itself.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_refactoring_service_functions_to_message_handlers">9.2. Refactoring Service Functions to Message Handlers</h3>
<div class="paragraph">
<p>We start by defining the two events that capture our current API inputs—<code>AllocationRequired</code> and <code>BatchCreated</code>:</p>
</div>
<div id="two_new_events" class="exampleblock">
<div class="title">BatchCreated and AllocationRequired events (src/allocation/domain/events.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@dataclass</span>
<span class="tok-k">class</span> <span class="tok-nc">BatchCreated</span><span class="tok-p">(</span><span class="tok-n">Event</span><span class="tok-p">):</span>
    <span class="tok-n">ref</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span>
    <span class="tok-n">eta</span><span class="tok-p">:</span> <span class="tok-n">Optional</span><span class="tok-p">[</span><span class="tok-n">date</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-bp">None</span>

<span class="tok-o">...</span>

<span class="tok-nd">@dataclass</span>
<span class="tok-k">class</span> <span class="tok-nc">AllocationRequired</span><span class="tok-p">(</span><span class="tok-n">Event</span><span class="tok-p">):</span>
    <span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Then we rename <em>services.py</em> to <em>handlers.py</em>; we add the existing message handler
for <code>send_out_of_stock_notification</code>; and most importantly, we change all the
handlers so that they have the same inputs, an event and a UoW:</p>
</div>
<div id="services_to_handlers" class="exampleblock">
<div class="title">Handlers and services are the same thing (src/allocation/service_layer/handlers.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">add_batch</span><span class="tok-p">(</span>
        <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">BatchCreated</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>
<span class="tok-p">):</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">)</span>
        <span class="tok-o">...</span>


<span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span>
        <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">AllocationRequired</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>
<span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">qty</span><span class="tok-p">)</span>
    <span class="tok-o">...</span>


<span class="tok-k">def</span> <span class="tok-nf">send_out_of_stock_notification</span><span class="tok-p">(</span>
        <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">,</span>
<span class="tok-p">):</span>
    <span class="tok-n">email</span><span class="tok-o">.</span><span class="tok-n">send</span><span class="tok-p">(</span>
        <span class="tok-s1">&#39;stock@made.com&#39;</span><span class="tok-p">,</span>
        <span class="tok-n">f</span><span class="tok-s1">&#39;Out of stock for {event.sku}&#39;</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The change might be clearer as a diff:</p>
</div>
<div id="services_to_handlers_diff" class="exampleblock">
<div class="title">Changing from services to handlers (src/allocation/service_layer/handlers.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span> def add_batch(
<span class="tok-gd">-        ref: str, sku: str, qty: int, eta: Optional[date],</span>
<span class="tok-gd">-        uow: unit_of_work.AbstractUnitOfWork</span>
<span class="tok-gi">+        event: events.BatchCreated, uow: unit_of_work.AbstractUnitOfWork</span>
 ):
     with uow:
<span class="tok-gd">-        product = uow.products.get(sku=sku)</span>
<span class="tok-gi">+        product = uow.products.get(sku=event.sku)</span>
     ...


 def allocate(
<span class="tok-gd">-        orderid: str, sku: str, qty: int,</span>
<span class="tok-gd">-        uow: unit_of_work.AbstractUnitOfWork</span>
<span class="tok-gi">+        event: events.AllocationRequired, uow: unit_of_work.AbstractUnitOfWork</span>
 ) -&gt; str:
<span class="tok-gd">-    line = OrderLine(orderid, sku, qty)</span>
<span class="tok-gi">+    line = OrderLine(event.orderid, event.sku, event.qty)</span>
     ...

<span class="tok-gi">+</span>
<span class="tok-gi">+def send_out_of_stock_notification(</span>
<span class="tok-gi">+        event: events.OutOfStock, uow: unit_of_work.AbstractUnitOfWork,</span>
<span class="tok-gi">+):</span>
<span class="tok-gi">+    email.send(</span>
     ...</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Along the way, we&#8217;ve made our service-layer&#8217;s API more structured and more consistent. It was a scattering of
primitives, and now it uses well-defined objects (see the following sidebar).</p>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">From Domain Objects, via Primitive Obsession, to <span class="keep-together">Events as an Interface</span></div>
<div class="paragraph">
<p>Some of you may remember <a href="#primitive_obsession">Fully Decoupling the Service-Layer Tests from the Domain</a>, in which we changed our service-layer API
from being in terms of domain objects to primitives. And now we&#8217;re moving
back, but to different objects?  What gives?</p>
</div>
<div class="paragraph">
<p>In OO circles, people talk about <em>primitive obsession</em> as an anti-pattern: avoid
primitives in public APIs, and instead wrap them with custom value classes, they
would say. In the Python world, a lot of people would be quite skeptical of
that as a rule of thumb. When mindlessly applied, it&#8217;s certainly a recipe for
unnecessary complexity. So that&#8217;s not what we&#8217;re doing per se.</p>
</div>
<div class="paragraph">
<p>The move from domain objects to primitives bought us a nice bit of decoupling:
our client code was no longer coupled directly to the domain, so the service
layer could present an API that stays the same even if we decide to make changes
to our model, and vice versa.</p>
</div>
<div class="paragraph">
<p>So have we gone backward? Well, our core domain model objects are still free to
vary, but instead we&#8217;ve coupled the external world to our event classes.
They&#8217;re part of the domain too, but the hope is that they vary less often, so
they&#8217;re a sensible artifact to couple on.</p>
</div>
<div class="paragraph">
<p>And what have we bought ourselves? Now, when invoking a use case in our application,
we no longer need to remember a particular combination of primitives, but just a single
event class that represents the input to our application. That&#8217;s conceptually
quite nice. On top of that, as you&#8217;ll see in <a href="#appendix_validation">Validation</a>, those
event classes can be a nice place to do some input validation.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_message_bus_now_collects_events_from_the_uow">9.2.1. The Message Bus Now Collects Events from the UoW</h4>
<div class="paragraph">
<p>Our event handlers now need a UoW. In addition, as our message bus becomes
more central to our application, it makes sense to put it explicitly in charge of
collecting and processing new events. There was a bit of a circular dependency
between the UoW and message bus until now, so this will make it one-way:</p>
</div>
<div id="handle_has_uow_and_queue" class="exampleblock">
<div class="title">Handle takes a UoW and manages a queue (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">handle</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Event</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">queue</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-n">event</span><span class="tok-p">]</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-k">while</span> <span class="tok-n">queue</span><span class="tok-p">:</span>
        <span class="tok-n">event</span> <span class="tok-o">=</span> <span class="tok-n">queue</span><span class="tok-o">.</span><span class="tok-n">pop</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-k">for</span> <span class="tok-n">handler</span> <span class="tok-ow">in</span> <span class="tok-n">HANDLERS</span><span class="tok-p">[</span><span class="tok-nb">type</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)]:</span>  <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="tok-n">handler</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-o">=</span><span class="tok-n">uow</span><span class="tok-p">)</span>  <i class="conum" data-value="4"></i><b>(4)</b>
            <span class="tok-n">queue</span><span class="tok-o">.</span><span class="tok-n">extend</span><span class="tok-p">(</span><span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">collect_new_events</span><span class="tok-p">())</span>  <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The message bus now gets passed the UoW each time it starts up.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When we begin handling our first event, we start a queue.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We pop events from the front of the queue and invoke their handlers (the
<span class="keep-together"><code>HANDLERS</code></span> dict hasn&#8217;t changed; it still maps event types to handler functions).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The message bus passes the UoW down to each handler.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>After each handler finishes, we collect any new events that have been
generated and add them to the queue.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In <em>unit_of_work.py</em>, <code>publish_events()</code> becomes a less active method,
<code>collect_new_events()</code>:</p>
</div>
<div id="uow_collect_new_events" class="exampleblock">
<div class="title">UoW no longer puts events directly on the bus (src/allocation/service_layer/unit_of_work.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gd">-from . import messagebus  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-gd">-</span>


 class AbstractUnitOfWork(abc.ABC):
<span class="tok-gu">@@ -23,13 +21,11 @@ class AbstractUnitOfWork(abc.ABC):</span>

     def commit(self):
         self._commit()
<span class="tok-gd">-        self.publish_events()  </span><i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-gd">-    def publish_events(self):</span>
<span class="tok-gi">+    def collect_new_events(self):</span>
         for product in self.products.seen:
             while product.events:
<span class="tok-gd">-                event = product.events.pop(0)</span>
<span class="tok-gd">-                messagebus.handle(event)</span>
<span class="tok-gi">+                yield product.events.pop(0)  </span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>unit_of_work</code> module now no longer depends on <code>messagebus</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We no longer <code>publish_events</code> automatically on commit. The message bus
is keeping track of the event queue instead.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>And the UoW no longer actively puts events on the message bus; it
just makes them available.</td>
</tr>
</table>
</div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_our_tests_are_all_written_in_terms_of_events_too">9.2.2. Our Tests Are All Written in Terms of Events Too</h4>
<div class="paragraph">
<p>Our tests now operate by creating events and putting them on the
message bus, rather than invoking service-layer functions directly:</p>
</div>
<div id="handler_tests" class="exampleblock">
<div class="title">Handler tests use events (tests/unit/test_handlers.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span>class TestAddBatch:

     def test_for_new_product(self):
         uow = FakeUnitOfWork()
<span class="tok-gd">-        services.add_batch(&quot;b1&quot;, &quot;CRUNCHY-ARMCHAIR&quot;, 100, None, uow)</span>
<span class="tok-gi">+        messagebus.handle(</span>
<span class="tok-gi">+            events.BatchCreated(&quot;b1&quot;, &quot;CRUNCHY-ARMCHAIR&quot;, 100, None), uow</span>
<span class="tok-gi">+        )</span>
         assert uow.products.get(&quot;CRUNCHY-ARMCHAIR&quot;) is not None
         assert uow.committed

...

 class TestAllocate:

     def test_returns_allocation(self):
         uow = FakeUnitOfWork()
<span class="tok-gd">-        services.add_batch(&quot;batch1&quot;, &quot;COMPLICATED-LAMP&quot;, 100, None, uow)</span>
<span class="tok-gd">-        result = services.allocate(&quot;o1&quot;, &quot;COMPLICATED-LAMP&quot;, 10, uow)</span>
<span class="tok-gi">+        messagebus.handle(</span>
<span class="tok-gi">+            events.BatchCreated(&quot;batch1&quot;, &quot;COMPLICATED-LAMP&quot;, 100, None), uow</span>
<span class="tok-gi">+        )</span>
<span class="tok-gi">+        result = messagebus.handle(</span>
<span class="tok-gi">+            events.AllocationRequired(&quot;o1&quot;, &quot;COMPLICATED-LAMP&quot;, 10), uow</span>
<span class="tok-gi">+        )</span>
         assert result == &quot;batch1&quot;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="temporary_ugly_hack">9.2.3. A Temporary Ugly Hack: The Message Bus Has to Return Results</h4>
<div class="paragraph">
<p>Our API and our service layer currently want to know the allocated batch reference
when they invoke our <code>allocate()</code> handler. This means we need to put in
a temporary hack on our message bus to let it return events:</p>
</div>
<div id="hack_messagebus_results" class="exampleblock">
<div class="title">Message bus returns results (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span> def handle(event: events.Event, uow: unit_of_work.AbstractUnitOfWork):
<span class="tok-gi">+    results = []</span>
     queue = [event]
     while queue:
         event = queue.pop(0)
         for handler in HANDLERS[type(event)]:
<span class="tok-gd">-            handler(event, uow=uow)</span>
<span class="tok-gi">+            results.append(handler(event, uow=uow))</span>
             queue.extend(uow.collect_new_events())
<span class="tok-gi">+    return results</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s because we&#8217;re mixing the read and write responsibilities in our system.
We&#8217;ll come back to fix this wart in <a href="#chapter_12_cqrs">Command-Query Responsibility Segregation (CQRS)</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_modifying_our_api_to_work_with_events">9.2.4. Modifying Our API to Work with Events</h4>
<div id="flask_uses_messagebus" class="exampleblock">
<div class="title">Flask changing to message bus as a diff (src/allocation/entrypoints/flask_app.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span> @app.route(&quot;/allocate&quot;, methods=[&#39;POST&#39;])
 def allocate_endpoint():
     try:
<span class="tok-gd">-        batchref = services.allocate(</span>
<span class="tok-gd">-            request.json[&#39;orderid&#39;],  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-gd">-            request.json[&#39;sku&#39;],</span>
<span class="tok-gd">-            request.json[&#39;qty&#39;],</span>
<span class="tok-gd">-            unit_of_work.SqlAlchemyUnitOfWork(),</span>
<span class="tok-gi">+        event = events.AllocationRequired(  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-gi">+            request.json[&#39;orderid&#39;], request.json[&#39;sku&#39;], request.json[&#39;qty&#39;],</span>
         )
<span class="tok-gi">+        results = messagebus.handle(event, unit_of_work.SqlAlchemyUnitOfWork())  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-gi">+        batchref = results.pop(0)</span>
     except InvalidSku as e:</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Instead of calling the service layer with a bunch of primitives extracted
from the request JSON&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We instantiate an event.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Then we pass it to the message bus.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And we should be back to a fully functional application, but one that&#8217;s now
fully event-driven:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What used to be service-layer functions are now event handlers.</p>
</li>
<li>
<p>That makes them the same as the functions we invoke for handling internal events raised by
our domain model.</p>
</li>
<li>
<p>We use events as our data structure for capturing inputs to the system,
as well as for handing off of internal work packages.</p>
</li>
<li>
<p>The entire app is now best described as a message processor, or an event processor
if you prefer.  We&#8217;ll talk about the distinction in the
<a href="#chapter_10_commands">next chapter</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_our_new_requirement">9.3. Implementing Our New Requirement</h3>
<div class="paragraph">
<p>We&#8217;re done with our refactoring phase. Let&#8217;s see if we really have "made the
change easy."  Let&#8217;s implement our new requirement, shown in <a href="#reallocation_sequence_diagram">Sequence diagram for reallocation flow</a>: we&#8217;ll receive as our
inputs some new <code>BatchQuantityChanged</code> events and pass them to a handler, which in
turn might emit some <code>AllocationRequired</code> events, and those in turn will go
back to our existing handler for reallocation.</p>
</div>
<div id="reallocation_sequence_diagram" class="imageblock width-75">
<div class="content">
<img src="images/apwp_0904.png" alt="apwp 0904">
</div>
<div class="title">Figure 34. Sequence diagram for reallocation flow</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_0904, config=plantuml.cfg]
@startuml
scale 4

API -&gt; MessageBus : BatchQuantityChanged event

group BatchQuantityChanged Handler + Unit of Work 1
    MessageBus -&gt; Domain_Model : change batch quantity
    Domain_Model -&gt; MessageBus : emit AllocationRequired event(s)
end


group AllocationRequired Handler + Unit of Work 2 (or more)
    MessageBus -&gt; Domain_Model : allocate
end

@enduml</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
When you split things out like this across two units of work,
    you now have two database transactions, so you are opening yourself up
    to integrity issues: something could happen that means the first transaction completes
    but the second one does not. You&#8217;ll need to think about whether this is acceptable,
    and whether you need to notice when it happens and do something about it.
    See <a href="#footguns">Footguns</a> for more discussion.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_our_new_event">9.3.1. Our New Event</h4>
<div class="paragraph">
<p>The event that tells us a batch quantity has changed is simple; it just
needs a batch reference and a new quantity:</p>
</div>
<div id="batch_quantity_changed_event" class="exampleblock">
<div class="title">New event (src/allocation/domain/events.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@dataclass</span>
<span class="tok-k">class</span> <span class="tok-nc">BatchQuantityChanged</span><span class="tok-p">(</span><span class="tok-n">Event</span><span class="tok-p">):</span>
    <span class="tok-n">ref</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="test-driving-ch9">9.4. Test-Driving a New Handler</h3>
<div class="paragraph">
<p>Following the lessons learned in <a href="#chapter_04_service_layer">Our First Use Case: <span class="keep-together">Flask API and Service Layer</span></a>,
we can operate in "high gear" and write our unit tests at the highest
possible level of abstraction, in terms of events. Here&#8217;s what they might
look like:</p>
</div>
<div id="test_change_batch_quantity_handler" class="exampleblock">
<div class="title">Handler tests for change_batch_quantity (tests/unit/test_handlers.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">TestChangeBatchQuantity</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-nf">test_changes_available_quantity</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">FakeUnitOfWork</span><span class="tok-p">()</span>
        <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span>
            <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">BatchCreated</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;ADORABLE-SETTEE&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">),</span> <span class="tok-n">uow</span>
        <span class="tok-p">)</span>
        <span class="tok-p">[</span><span class="tok-n">batch</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-s2">&quot;ADORABLE-SETTEE&quot;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">batches</span>
        <span class="tok-k">assert</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">100</span>  <i class="conum" data-value="1"></i><b>(1)</b>

        <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">BatchQuantityChanged</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">,</span> <span class="tok-mi">50</span><span class="tok-p">),</span> <span class="tok-n">uow</span><span class="tok-p">)</span>

        <span class="tok-k">assert</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">50</span>  <i class="conum" data-value="1"></i><b>(1)</b>


    <span class="tok-k">def</span> <span class="tok-nf">test_reallocates_if_necessary</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">FakeUnitOfWork</span><span class="tok-p">()</span>
        <span class="tok-n">event_history</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
            <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">BatchCreated</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="tok-p">,</span> <span class="tok-mi">50</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">),</span>
            <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">BatchCreated</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch2&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="tok-p">,</span> <span class="tok-mi">50</span><span class="tok-p">,</span> <span class="tok-n">date</span><span class="tok-o">.</span><span class="tok-n">today</span><span class="tok-p">()),</span>
            <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">AllocationRequired</span><span class="tok-p">(</span><span class="tok-s2">&quot;order1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="tok-p">,</span> <span class="tok-mi">20</span><span class="tok-p">),</span>
            <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">AllocationRequired</span><span class="tok-p">(</span><span class="tok-s2">&quot;order2&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="tok-p">,</span> <span class="tok-mi">20</span><span class="tok-p">),</span>
        <span class="tok-p">]</span>
        <span class="tok-k">for</span> <span class="tok-n">e</span> <span class="tok-ow">in</span> <span class="tok-n">event_history</span><span class="tok-p">:</span>
            <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">)</span>
        <span class="tok-p">[</span><span class="tok-n">batch1</span><span class="tok-p">,</span> <span class="tok-n">batch2</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">batches</span>
        <span class="tok-k">assert</span> <span class="tok-n">batch1</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">10</span>
        <span class="tok-k">assert</span> <span class="tok-n">batch2</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">50</span>

        <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">BatchQuantityChanged</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">,</span> <span class="tok-mi">25</span><span class="tok-p">),</span> <span class="tok-n">uow</span><span class="tok-p">)</span>

        <span class="tok-c1"># order1 or order2 will be deallocated, so we&#39;ll have 25 - 20</span>
        <span class="tok-k">assert</span> <span class="tok-n">batch1</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">5</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-c1"># and 20 will be reallocated to the next batch</span>
        <span class="tok-k">assert</span> <span class="tok-n">batch2</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">30</span>  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The simple case would be trivially easy to implement; we just
modify a quantity.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>But if we try to change the quantity to less than
has been allocated, we&#8217;ll need to deallocate at least one order,
and we expect to reallocate it to a new batch.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_implementation">9.4.1. Implementation</h4>
<div class="paragraph">
<p>Our new handler is very simple:</p>
</div>
<div id="change_quantity_handler" class="exampleblock">
<div class="title">Handler delegates to model layer (src/allocation/service_layer/handlers.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">change_batch_quantity</span><span class="tok-p">(</span>
        <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">BatchQuantityChanged</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>
<span class="tok-p">):</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get_by_batchref</span><span class="tok-p">(</span><span class="tok-n">batchref</span><span class="tok-o">=</span><span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">ref</span><span class="tok-p">)</span>
        <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">change_batch_quantity</span><span class="tok-p">(</span><span class="tok-n">ref</span><span class="tok-o">=</span><span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">ref</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">qty</span><span class="tok-p">)</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We realize we&#8217;ll need a new query type on our repository:</p>
</div>
<div id="get_by_batchref" class="exampleblock">
<div class="title">A new query type on our repository (src/allocation/adapters/repository.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">AbstractRepository</span><span class="tok-p">(</span><span class="tok-n">abc</span><span class="tok-o">.</span><span class="tok-n">ABC</span><span class="tok-p">):</span>
    <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-nf">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">:</span>
        <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-nf">get_by_batchref</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">batchref</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">:</span>
        <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_get_by_batchref</span><span class="tok-p">(</span><span class="tok-n">batchref</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-n">product</span><span class="tok-p">:</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">seen</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">product</span><span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-n">product</span>

    <span class="tok-nd">@abc.abstractmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">_add</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">product</span><span class="tok-p">:</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">):</span>
        <span class="tok-k">raise</span> <span class="tok-ne">NotImplementedError</span>

    <span class="tok-nd">@abc.abstractmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">_get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">:</span>
        <span class="tok-k">raise</span> <span class="tok-ne">NotImplementedError</span>

    <span class="tok-nd">@abc.abstractmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">_get_by_batchref</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">batchref</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">:</span>
        <span class="tok-k">raise</span> <span class="tok-ne">NotImplementedError</span>
    <span class="tok-o">...</span>

<span class="tok-k">class</span> <span class="tok-nc">SqlAlchemyRepository</span><span class="tok-p">(</span><span class="tok-n">AbstractRepository</span><span class="tok-p">):</span>
    <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-nf">_get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">query</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">filter_by</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">first</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-nf">_get_by_batchref</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">batchref</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">query</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">filter</span><span class="tok-p">(</span>
            <span class="tok-n">orm</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">c</span><span class="tok-o">.</span><span class="tok-n">reference</span> <span class="tok-o">==</span> <span class="tok-n">batchref</span><span class="tok-p">,</span>
        <span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">first</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And on our <code>FakeRepository</code> too:</p>
</div>
<div id="fakerepo_get_by_batchref" class="exampleblock">
<div class="title">Updating the fake repo too (tests/unit/test_handlers.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">FakeRepository</span><span class="tok-p">(</span><span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">AbstractRepository</span><span class="tok-p">):</span>
    <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-nf">_get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-nb">next</span><span class="tok-p">((</span><span class="tok-n">p</span> <span class="tok-k">for</span> <span class="tok-n">p</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_products</span> <span class="tok-k">if</span> <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">==</span> <span class="tok-n">sku</span><span class="tok-p">),</span> <span class="tok-bp">None</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">_get_by_batchref</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">batchref</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-nb">next</span><span class="tok-p">((</span>
            <span class="tok-n">p</span> <span class="tok-k">for</span> <span class="tok-n">p</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_products</span> <span class="tok-k">for</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-n">batches</span>
            <span class="tok-k">if</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">reference</span> <span class="tok-o">==</span> <span class="tok-n">batchref</span>
        <span class="tok-p">),</span> <span class="tok-bp">None</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We&#8217;re adding a query to our repository to make this use case easier to
implement. So long as our query is returning a single aggregate, we&#8217;re not
bending any rules. If you find yourself writing complex queries on your
repositories, you might want to consider a different design. Methods like <code>get_most_popular_products</code> or <code>find_products_by_order_id</code> in particular would
definitely trigger our spidey sense. <a href="#chapter_11_external_events">Event-Driven Architecture: Using Events to Integrate Microservices</a> and the <a href="#epilogue_1_how_to_get_there_from_here">epilogue</a> have some tips on managing complex queries.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_a_new_method_on_the_domain_model">9.4.2. A New Method on the Domain Model</h4>
<div class="paragraph">
<p>We add the new method to the model, which does the quantity change and
deallocation(s) inline and publishes a new event.  We also modify the existing
allocate function to publish an event:</p>
</div>
<div id="change_batch_model_layer" class="exampleblock">
<div class="title">Our model evolves to capture the new requirement (src/allocation/domain/model.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Product</span><span class="tok-p">:</span>
    <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-nf">change_batch_quantity</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">ref</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">):</span>
        <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-nb">next</span><span class="tok-p">(</span><span class="tok-n">b</span> <span class="tok-k">for</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span> <span class="tok-k">if</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">reference</span> <span class="tok-o">==</span> <span class="tok-n">ref</span><span class="tok-p">)</span>
        <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">_purchased_quantity</span> <span class="tok-o">=</span> <span class="tok-n">qty</span>
        <span class="tok-k">while</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">&lt;</span> <span class="tok-mi">0</span><span class="tok-p">:</span>
            <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">deallocate_one</span><span class="tok-p">()</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span>
                <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">AllocationRequired</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">qty</span><span class="tok-p">)</span>
            <span class="tok-p">)</span>
<span class="tok-o">...</span>

<span class="tok-k">class</span> <span class="tok-nc">Batch</span><span class="tok-p">:</span>
    <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-nf">deallocate_one</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">OrderLine</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_allocations</span><span class="tok-o">.</span><span class="tok-n">pop</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We wire up our new handler:</p>
</div>
<div id="full_messagebus" class="exampleblock">
<div class="title">The message bus grows (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">HANDLERS</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">BatchCreated</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">add_batch</span><span class="tok-p">],</span>
    <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">BatchQuantityChanged</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">change_batch_quantity</span><span class="tok-p">],</span>
    <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">AllocationRequired</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">],</span>
    <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">send_out_of_stock_notification</span><span class="tok-p">],</span>

<span class="tok-p">}</span>  <span class="tok-c1"># type: Dict[Type[events.Event], List[Callable]]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And our new requirement is fully implemented.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="fake_message_bus">9.5. Optionally: Unit Testing Event Handlers in Isolation with a Fake Message Bus</h3>
<div class="paragraph">
<p>Our main test for the reallocation workflow is <em>edge-to-edge</em>
(see the example code in <a href="#test-driving-ch9">Test-Driving a New Handler</a>). It uses
the real message bus, and it tests the whole flow, where the <code>BatchQuantityChanged</code>
event handler triggers deallocation, and emits new <code>AllocationRequired</code> events, which in
turn are handled by their own handlers. One test covers a chain of multiple
events and handlers.</p>
</div>
<div class="paragraph">
<p>Depending on the complexity of your chain of events, you may decide that you
want to test some handlers in isolation from one another. You can do this
using a "fake" message bus.</p>
</div>
<div class="paragraph">
<p>In our case, we actually intervene by modifying the <code>publish_events()</code> method
on <code>FakeUnitOfWork</code> and decoupling it from the real message bus, instead making
it record what events it sees:</p>
</div>
<div id="fake_messagebus" class="exampleblock">
<div class="title">Fake message bus implemented in UoW (tests/unit/test_handlers.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">FakeUnitOfWorkWithFakeMessageBus</span><span class="tok-p">(</span><span class="tok-n">FakeUnitOfWork</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__init__</span><span class="tok-p">()</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">events_published</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>  <span class="tok-c1"># type: List[events.Event]</span>

    <span class="tok-k">def</span> <span class="tok-nf">publish_events</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">for</span> <span class="tok-n">product</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">seen</span><span class="tok-p">:</span>
            <span class="tok-k">while</span> <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">events</span><span class="tok-p">:</span>
                <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">events_published</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">pop</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">))</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now when we invoke <code>messagebus.handle()</code> using the <code>FakeUnitOfWorkWithFakeMessageBus</code>,
it runs only the handler for that event. So we can write a more isolated unit
test: instead of checking all the side effects, we just check that
<code>BatchQuantityChanged</code> leads to <code>AllocationRequired</code> if the quantity drops
below the total already allocated:</p>
</div>
<div id="test_handler_in_isolation" class="exampleblock nobreakinside less_space">
<div class="title">Testing reallocation in isolation (tests/unit/test_handlers.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_reallocates_if_necessary_isolated</span><span class="tok-p">():</span>
    <span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">FakeUnitOfWorkWithFakeMessageBus</span><span class="tok-p">()</span>

    <span class="tok-c1"># test setup as before</span>
    <span class="tok-n">event_history</span> <span class="tok-o">=</span> <span class="tok-p">[</span>
        <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">BatchCreated</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="tok-p">,</span> <span class="tok-mi">50</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">),</span>
        <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">BatchCreated</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch2&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="tok-p">,</span> <span class="tok-mi">50</span><span class="tok-p">,</span> <span class="tok-n">date</span><span class="tok-o">.</span><span class="tok-n">today</span><span class="tok-p">()),</span>
        <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">AllocationRequired</span><span class="tok-p">(</span><span class="tok-s2">&quot;order1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="tok-p">,</span> <span class="tok-mi">20</span><span class="tok-p">),</span>
        <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">AllocationRequired</span><span class="tok-p">(</span><span class="tok-s2">&quot;order2&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="tok-p">,</span> <span class="tok-mi">20</span><span class="tok-p">),</span>
    <span class="tok-p">]</span>
    <span class="tok-k">for</span> <span class="tok-n">e</span> <span class="tok-ow">in</span> <span class="tok-n">event_history</span><span class="tok-p">:</span>
        <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">)</span>
    <span class="tok-p">[</span><span class="tok-n">batch1</span><span class="tok-p">,</span> <span class="tok-n">batch2</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-s2">&quot;INDIFFERENT-TABLE&quot;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">batches</span>
    <span class="tok-k">assert</span> <span class="tok-n">batch1</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">10</span>
    <span class="tok-k">assert</span> <span class="tok-n">batch2</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">50</span>

    <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">BatchQuantityChanged</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">,</span> <span class="tok-mi">25</span><span class="tok-p">),</span> <span class="tok-n">uow</span><span class="tok-p">)</span>

    <span class="tok-c1"># assert on new events emitted rather than downstream side-effects</span>
    <span class="tok-p">[</span><span class="tok-n">reallocation_event</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">events_published</span>
    <span class="tok-k">assert</span> <span class="tok-nb">isinstance</span><span class="tok-p">(</span><span class="tok-n">reallocation_event</span><span class="tok-p">,</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">AllocationRequired</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">reallocation_event</span><span class="tok-o">.</span><span class="tok-n">orderid</span> <span class="tok-ow">in</span> <span class="tok-p">{</span><span class="tok-s1">&#39;order1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;order2&#39;</span><span class="tok-p">}</span>
    <span class="tok-k">assert</span> <span class="tok-n">reallocation_event</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;INDIFFERENT-TABLE&#39;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Whether you want to do this or not depends on the complexity of your chain of
events. We say, start out with edge-to-edge testing, and resort to
this only if necessary.</p>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Exercise for the Reader</div>
<div class="paragraph">
<p>A great way to force yourself to really understand some code is to refactor it.
In the discussion of testing handlers in isolation, we used something called
<code>FakeUnitOfWorkWithFakeMessageBus</code>, which is unnecessarily complicated and
violates the SRP.</p>
</div>
<div class="paragraph">
<p>If we change the message bus to being a class,<sup class="footnote">[<a id="_footnoteref_31" class="footnote" href="#_footnotedef_31" title="View footnote.">31</a>]</sup>
then building a <code>FakeMessageBus</code> is more straightforward:</p>
</div>
<div id="abc_for_fake_messagebus" class="exampleblock">
<div class="title">An abstract message bus and its real and fake versions</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">AbstractMessageBus</span><span class="tok-p">:</span>
    <span class="tok-n">HANDLERS</span><span class="tok-p">:</span> <span class="tok-n">Dict</span><span class="tok-p">[</span><span class="tok-n">Type</span><span class="tok-p">[</span><span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Event</span><span class="tok-p">],</span> <span class="tok-n">List</span><span class="tok-p">[</span><span class="tok-n">Callable</span><span class="tok-p">]]</span>

    <span class="tok-k">def</span> <span class="tok-nf">handle</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Event</span><span class="tok-p">):</span>
        <span class="tok-k">for</span> <span class="tok-n">handler</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">HANDLERS</span><span class="tok-p">[</span><span class="tok-nb">type</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)]:</span>
            <span class="tok-n">handler</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)</span>


<span class="tok-k">class</span> <span class="tok-nc">MessageBus</span><span class="tok-p">(</span><span class="tok-n">AbstractMessageBus</span><span class="tok-p">):</span>
    <span class="tok-n">HANDLERS</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
        <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-n">send_out_of_stock_notification</span><span class="tok-p">],</span>

    <span class="tok-p">}</span>


<span class="tok-k">class</span> <span class="tok-nc">FakeMessageBus</span><span class="tok-p">(</span><span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">AbstractMessageBus</span><span class="tok-p">):</span>
    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">events_published</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>  <span class="tok-c1"># type: List[events.Event]</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">handlers</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
            <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-k">lambda</span> <span class="tok-n">e</span><span class="tok-p">:</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">events_published</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">)]</span>
        <span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>So jump into the code on
<a href="https://github.com/cosmicpython/code/tree/chapter_09_all_messagebus">GitHub</a> and see if you can get a class-based version
working, and then write a version of <code>test_reallocates_if_necessary_isolated()</code>
from earlier.</p>
</div>
<div class="paragraph">
<p>We use a class-based message bus in <a href="#chapter_13_dependency_injection">Dependency Injection (and Bootstrapping)</a>,
if you need more inspiration.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up_8">9.6. Wrap-Up</h3>
<div class="paragraph">
<p>Let&#8217;s look back at what we&#8217;ve achieved, and think about why we did it.</p>
</div>
<div class="sect3">
<h4 id="_what_have_we_achieved">9.6.1. What Have We Achieved?</h4>
<div class="paragraph">
<p>Events are simple dataclasses that define the data structures for inputs
  and internal messages within our system. This is quite powerful from a DDD
  standpoint, since events often translate really well into business language
  (look up <em>event storming</em> if you haven&#8217;t already).</p>
</div>
<div class="paragraph">
<p>Handlers are the way we react to events. They can call down to our
  model or call out to external services.  We can define multiple
  handlers for a single event if we want to. Handlers can also raise other
  events. This allows us to be very granular about what a handler does
  and really stick to the SRP.</p>
</div>
</div>
<div class="sect3">
<h4 id="_why_have_we_achieved">9.6.2. Why Have We Achieved?</h4>
<div class="paragraph">
<p>Our ongoing objective with these architectural patterns is to try to have
the complexity of our application grow more slowly than its size.  When we
go all in on the message bus, as always we pay a price in terms of architectural
complexity (see <a href="#chapter_09_all_messagebus_tradeoffs">Whole app is a message bus: the trade-offs</a>), but we buy ourselves a
pattern that can handle almost arbitrarily complex requirements without needing
any further conceptual or architectural change to the way we do things.</p>
</div>
<div class="paragraph">
<p>Here we&#8217;ve added quite a complicated use case (change quantity, deallocate,
start new transaction, reallocate, publish external notification), but
architecturally, there&#8217;s been no cost in terms of complexity. We&#8217;ve added new
events, new handlers, and a new external adapter (for email), all of which are
existing categories of <em>things</em> in our architecture that we understand and know
how to reason about, and that are easy to explain to newcomers.  Our moving
parts each have one job, they&#8217;re connected to each other in well-defined ways,
and there are no unexpected side effects.</p>
</div>
<table id="chapter_09_all_messagebus_tradeoffs" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Whole app is a message bus: the trade-offs</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pros</th>
<th class="tableblock halign-left valign-top">Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Handlers and services are the same thing, so that&#8217;s simpler.</p>
</li>
<li>
<p>We have a nice data structure for inputs to the system.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>A message bus is still a slightly unpredictable way of doing things from
a web point of view. You don&#8217;t know in advance when things are going to end.</p>
</li>
<li>
<p>There will be duplication of fields and structure between model objects and events, which will have a maintenance cost. Adding a field to one usually means adding a field to at least
one of the others.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Now, you may be wondering, where are those <code>BatchQuantityChanged</code> events
going to come from? The answer is revealed in a couple chapters' time.  But
first, let&#8217;s talk about <a href="#chapter_10_commands">events versus commands</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_10_commands">10. Commands and Command Handler</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the previous chapter, we talked about using events as a way of representing
the inputs to our system, and we turned our application into a message-processing
machine.</p>
</div>
<div class="paragraph">
<p>To achieve that, we converted all our use-case functions to event handlers.
When the API receives a POST to create a new batch, it builds a new <code>BatchCreated</code>
event and handles it as if it were an internal event.
This might feel counterintuitive. After all, the batch <em>hasn&#8217;t</em> been
created yet; that&#8217;s why we called the API. We&#8217;re going to fix that conceptual
wart by introducing commands and showing how they can be handled by the same
message bus but with slightly different rules.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The code for this chapter is in the
chapter_10_commands branch <a href="https://oreil.ly/U_VGa">on GitHub</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/cosmicpython/code.git
cd code
git checkout chapter_10_commands
# or to code along, checkout the previous chapter:
git checkout chapter_09_all_messagebus</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_commands_and_events">10.1. Commands and Events</h3>
<div class="paragraph">
<p>Like events, <em>commands</em> are a type of message&#8212;&#8203;instructions sent by one part of
a system to another. We usually represent commands with dumb data
structures and can handle them in much the same way as events.</p>
</div>
<div class="paragraph">
<p>The differences between commands and events, though, are important.</p>
</div>
<div class="paragraph">
<p>Commands are sent by one actor to another specific actor with the expectation that
a particular thing will happen as a result. When we post a form to an API handler,
we are sending a command. We name commands with imperative mood verb phrases like
"allocate stock" or "delay shipment."</p>
</div>
<div class="paragraph">
<p>Commands capture <em>intent</em>. They express our wish for the system to do something.
As a result, when they fail, the sender needs to receive error information.</p>
</div>
<div class="paragraph">
<p><em>Events</em> are broadcast by an actor to all interested listeners. When we publish
<code>BatchQuantityChanged</code>, we don&#8217;t know who&#8217;s going to pick it up. We name events
with past-tense verb phrases like "order allocated to stock" or "shipment delayed."</p>
</div>
<div class="paragraph">
<p>We often use events to spread the knowledge about successful commands.</p>
</div>
<div class="paragraph">
<p>Events capture <em>facts</em> about things that happened in the past. Since we don&#8217;t
know who&#8217;s handling an event, senders should not care whether the receivers
succeeded or failed. <a href="#events_vs_commands_table">Events versus commands</a> recaps the differences.</p>
</div>
<table id="events_vs_commands_table" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Events versus commands</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Event</th>
<th class="tableblock halign-left valign-top">Command</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Named</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Past tense</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Imperative mood</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error handling</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fail independently</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fail noisily</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sent to</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All listeners</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One recipient</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>What kinds of commands do we have in our system right now?</p>
</div>
<div id="commands_dot_py" class="exampleblock">
<div class="title">Pulling out some commands (src/allocation/domain/commands.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Command</span><span class="tok-p">:</span>
    <span class="tok-k">pass</span>

<span class="tok-nd">@dataclass</span>
<span class="tok-k">class</span> <span class="tok-nc">Allocate</span><span class="tok-p">(</span><span class="tok-n">Command</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span>

<span class="tok-nd">@dataclass</span>
<span class="tok-k">class</span> <span class="tok-nc">CreateBatch</span><span class="tok-p">(</span><span class="tok-n">Command</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">ref</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span>
    <span class="tok-n">eta</span><span class="tok-p">:</span> <span class="tok-n">Optional</span><span class="tok-p">[</span><span class="tok-n">date</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-bp">None</span>

<span class="tok-nd">@dataclass</span>
<span class="tok-k">class</span> <span class="tok-nc">ChangeBatchQuantity</span><span class="tok-p">(</span><span class="tok-n">Command</span><span class="tok-p">):</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">ref</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>commands.Allocate</code> will replace <code>events.AllocationRequired</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>commands.CreateBatch</code> will replace <code>events.BatchCreated</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>commands.ChangeBatchQuantity</code> will replace <code>events.BatchQuantityChanged</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_differences_in_exception_handling">10.2. Differences in Exception Handling</h3>
<div class="paragraph">
<p>Just changing the names and verbs is all very well, but that won&#8217;t
change the behavior of our system.  We want to treat events and commands similarly,
but not exactly the same.  Let&#8217;s see how our message bus changes:</p>
</div>
<div id="messagebus_dispatches_differently" class="exampleblock">
<div class="title">Dispatch events and commands differently (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">Message</span> <span class="tok-o">=</span> <span class="tok-n">Union</span><span class="tok-p">[</span><span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Command</span><span class="tok-p">,</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Event</span><span class="tok-p">]</span>


<span class="tok-k">def</span> <span class="tok-nf">handle</span><span class="tok-p">(</span><span class="tok-n">message</span><span class="tok-p">:</span> <span class="tok-n">Message</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">results</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>
    <span class="tok-n">queue</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-n">message</span><span class="tok-p">]</span>
    <span class="tok-k">while</span> <span class="tok-n">queue</span><span class="tok-p">:</span>
        <span class="tok-n">message</span> <span class="tok-o">=</span> <span class="tok-n">queue</span><span class="tok-o">.</span><span class="tok-n">pop</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-nb">isinstance</span><span class="tok-p">(</span><span class="tok-n">message</span><span class="tok-p">,</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Event</span><span class="tok-p">):</span>
            <span class="tok-n">handle_event</span><span class="tok-p">(</span><span class="tok-n">message</span><span class="tok-p">,</span> <span class="tok-n">queue</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-k">elif</span> <span class="tok-nb">isinstance</span><span class="tok-p">(</span><span class="tok-n">message</span><span class="tok-p">,</span> <span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Command</span><span class="tok-p">):</span>
            <span class="tok-n">cmd_result</span> <span class="tok-o">=</span> <span class="tok-n">handle_command</span><span class="tok-p">(</span><span class="tok-n">message</span><span class="tok-p">,</span> <span class="tok-n">queue</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-n">results</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">cmd_result</span><span class="tok-p">)</span>
        <span class="tok-k">else</span><span class="tok-p">:</span>
            <span class="tok-k">raise</span> <span class="tok-ne">Exception</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;{message} was not an Event or Command&#39;</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">results</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>It still has a main <code>handle()</code> entrypoint that takes a <code>message</code>, which may
be a command or an event.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We dispatch events and commands to two different helper functions, shown next.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here&#8217;s how we handle events:</p>
</div>
<div id="handle_event" class="exampleblock">
<div class="title">Events cannot interrupt the flow (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">handle_event</span><span class="tok-p">(</span>
    <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Event</span><span class="tok-p">,</span>
    <span class="tok-n">queue</span><span class="tok-p">:</span> <span class="tok-n">List</span><span class="tok-p">[</span><span class="tok-n">Message</span><span class="tok-p">],</span>
    <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>
<span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">handler</span> <span class="tok-ow">in</span> <span class="tok-n">EVENT_HANDLERS</span><span class="tok-p">[</span><span class="tok-nb">type</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)]:</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-n">debug</span><span class="tok-p">(</span><span class="tok-s1">&#39;handling event </span><span class="tok-si">%s</span><span class="tok-s1"> with handler </span><span class="tok-si">%s</span><span class="tok-s1">&#39;</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">,</span> <span class="tok-n">handler</span><span class="tok-p">)</span>
            <span class="tok-n">handler</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-o">=</span><span class="tok-n">uow</span><span class="tok-p">)</span>
            <span class="tok-n">queue</span><span class="tok-o">.</span><span class="tok-n">extend</span><span class="tok-p">(</span><span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">collect_new_events</span><span class="tok-p">())</span>
        <span class="tok-k">except</span> <span class="tok-ne">Exception</span><span class="tok-p">:</span>
            <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-n">exception</span><span class="tok-p">(</span><span class="tok-s1">&#39;Exception handling event </span><span class="tok-si">%s</span><span class="tok-s1">&#39;</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">)</span>
            <span class="tok-k">continue</span>  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Events go to a dispatcher that can delegate to multiple handlers per
event.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It catches and logs errors but doesn&#8217;t let them interrupt
message processing.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And here&#8217;s how we do commands:</p>
</div>
<div id="handle_command" class="exampleblock">
<div class="title">Commands reraise exceptions (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">handle_command</span><span class="tok-p">(</span>
    <span class="tok-n">command</span><span class="tok-p">:</span> <span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Command</span><span class="tok-p">,</span>
    <span class="tok-n">queue</span><span class="tok-p">:</span> <span class="tok-n">List</span><span class="tok-p">[</span><span class="tok-n">Message</span><span class="tok-p">],</span>
    <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>
<span class="tok-p">):</span>
    <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-n">debug</span><span class="tok-p">(</span><span class="tok-s1">&#39;handling command </span><span class="tok-si">%s</span><span class="tok-s1">&#39;</span><span class="tok-p">,</span> <span class="tok-n">command</span><span class="tok-p">)</span>
    <span class="tok-k">try</span><span class="tok-p">:</span>
        <span class="tok-n">handler</span> <span class="tok-o">=</span> <span class="tok-n">COMMAND_HANDLERS</span><span class="tok-p">[</span><span class="tok-nb">type</span><span class="tok-p">(</span><span class="tok-n">command</span><span class="tok-p">)]</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">handler</span><span class="tok-p">(</span><span class="tok-n">command</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-o">=</span><span class="tok-n">uow</span><span class="tok-p">)</span>
        <span class="tok-n">queue</span><span class="tok-o">.</span><span class="tok-n">extend</span><span class="tok-p">(</span><span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">collect_new_events</span><span class="tok-p">())</span>
        <span class="tok-k">return</span> <span class="tok-n">result</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-k">except</span> <span class="tok-ne">Exception</span><span class="tok-p">:</span>
        <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-n">exception</span><span class="tok-p">(</span><span class="tok-s1">&#39;Exception handling command </span><span class="tok-si">%s</span><span class="tok-s1">&#39;</span><span class="tok-p">,</span> <span class="tok-n">command</span><span class="tok-p">)</span>
        <span class="tok-k">raise</span>  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The command dispatcher expects just one handler per command.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If any errors are raised, they fail fast and will bubble up.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>return result</code> is only temporary; as mentioned in <a href="#temporary_ugly_hack">A Temporary Ugly Hack: The Message Bus Has to Return Results</a>,
it&#8217;s a temporary hack to allow the message bus to return the batch
reference for the API to use.  We&#8217;ll fix this in <a href="#chapter_12_cqrs">Command-Query Responsibility Segregation (CQRS)</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We also change the single <code>HANDLERS</code> dict into different ones for
commands and events. Commands can have only one handler, according
to our convention:</p>
</div>
<div id="new_handlers_dicts" class="exampleblock">
<div class="title">New handlers dicts (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">EVENT_HANDLERS</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">send_out_of_stock_notification</span><span class="tok-p">],</span>
<span class="tok-p">}</span>  <span class="tok-c1"># type: Dict[Type[events.Event], List[Callable]]</span>

<span class="tok-n">COMMAND_HANDLERS</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Allocate</span><span class="tok-p">:</span> <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">,</span>
    <span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">CreateBatch</span><span class="tok-p">:</span> <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">add_batch</span><span class="tok-p">,</span>
    <span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">ChangeBatchQuantity</span><span class="tok-p">:</span> <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">change_batch_quantity</span><span class="tok-p">,</span>
<span class="tok-p">}</span>  <span class="tok-c1"># type: Dict[Type[commands.Command], Callable]</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_discussion_events_commands_and_error_handling">10.3. Discussion: Events, Commands, and Error Handling</h3>
<div class="paragraph">
<p>Many developers get uncomfortable at this point and ask, "What happens when an
event fails to process? How am I supposed to make sure the system is in a
consistent state?" If we manage to process half of the events during <code>messagebus.handle</code> before an
out-of-memory error kills our process, how do we mitigate problems caused by the
lost messages?</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start with the worst case: we fail to handle an event, and the system is
left in an inconsistent state. What kind of error would cause this? Often in our
systems we can end up in an inconsistent state when only half an operation is
completed.</p>
</div>
<div class="paragraph">
<p>For example, we could allocate three units of <code>DESIRABLE_BEANBAG</code> to a customer&#8217;s
order but somehow fail to reduce the amount of remaining stock. This would
cause an inconsistent state: the three units of stock are both allocated <em>and</em>
available, depending on how you look at it. Later, we might allocate those
same beanbags to another customer, causing a headache for customer support.</p>
</div>
<div class="paragraph">
<p>In our allocation service, though, we&#8217;ve already taken steps to prevent that
happening. We&#8217;ve carefully identified <em>aggregates</em> that act as consistency
boundaries, and we&#8217;ve introduced a <em>UoW</em> that manages the atomic
success or failure of an update to an aggregate.</p>
</div>
<div class="paragraph">
<p>For example, when we allocate stock to an order, our consistency boundary is the
<code>Product</code> aggregate. This means that we can&#8217;t accidentally overallocate: either
a particular order line is allocated to the product, or it is not&#8212;&#8203;there&#8217;s no
room for inconsistent states.</p>
</div>
<div class="paragraph">
<p>By definition, we don&#8217;t require two aggregates to be immediately consistent, so
if we fail to process an event and update only a single aggregate, our system
can still be made eventually consistent. We shouldn&#8217;t violate any constraints of
the system.</p>
</div>
<div class="paragraph">
<p>With this example in mind, we can better understand the reason for splitting
messages into commands and events. When a user wants to make the system do
something, we represent their request as a <em>command</em>. That command should modify
a single <em>aggregate</em> and either succeed or fail in totality. Any other bookkeeping, cleanup, and notification we need to do can happen via an <em>event</em>. We
don&#8217;t require the event handlers to succeed in order for the command to be
successful.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at another example (from a different, imaginary projet) to see why not.</p>
</div>
<div class="paragraph">
<p>Imagine we are building an ecommerce website that sells expensive luxury goods.
Our marketing department wants to reward customers for repeat visits. We will
flag customers as VIPs after they make their third purchase, and this will
entitle them to priority treatment and special offers. Our acceptance criteria
for this story reads as follows:</p>
</div>
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="gherkin"><span></span><span class="tok-k">Given </span><span class="tok-nf">a customer with two orders in their history,</span>
<span class="tok-k">When </span><span class="tok-nf">the customer places a third order,</span>
<span class="tok-k">Then </span><span class="tok-nf">they should be flagged as a VIP.</span>

<span class="tok-k">When </span><span class="tok-nf">a customer first becomes a VIP</span>
<span class="tok-k">Then </span><span class="tok-nf">we should send them an email to congratulate them</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the techniques we&#8217;ve already discussed in this book, we decide that we
want to build a new <code>History</code> aggregate that records orders and can raise domain
events when rules are met. We will structure the code like this:</p>
</div>
<div id="vip_customer_listing" class="exampleblock">
<div class="title">VIP customer (example code for a different project)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">History</span><span class="tok-p">:</span>  <span class="tok-c1"># Aggregate</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">customer_id</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">orders</span> <span class="tok-o">=</span> <span class="tok-nb">set</span><span class="tok-p">()</span> <span class="tok-c1"># Set[HistoryEntry]</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">customer_id</span> <span class="tok-o">=</span> <span class="tok-n">customer_id</span>

    <span class="tok-k">def</span> <span class="tok-nf">record_order</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">order_id</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">order_amount</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">):</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">entry</span> <span class="tok-o">=</span> <span class="tok-n">HistoryEntry</span><span class="tok-p">(</span><span class="tok-n">order_id</span><span class="tok-p">,</span> <span class="tok-n">order_amount</span><span class="tok-p">)</span>

        <span class="tok-k">if</span> <span class="tok-n">entry</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">orders</span><span class="tok-p">:</span>
            <span class="tok-k">return</span>

        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">orders</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">entry</span><span class="tok-p">)</span>

        <span class="tok-k">if</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">orders</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-mi">3</span><span class="tok-p">:</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span>
                <span class="tok-n">CustomerBecameVIP</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">customer_id</span><span class="tok-p">)</span>
            <span class="tok-p">)</span>


<span class="tok-k">def</span> <span class="tok-nf">create_order_from_basket</span><span class="tok-p">(</span><span class="tok-n">uow</span><span class="tok-p">,</span> <span class="tok-n">cmd</span><span class="tok-p">:</span> <span class="tok-n">CreateOrder</span><span class="tok-p">):</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">order</span> <span class="tok-o">=</span> <span class="tok-n">Order</span><span class="tok-o">.</span><span class="tok-n">from_basket</span><span class="tok-p">(</span><span class="tok-n">cmd</span><span class="tok-o">.</span><span class="tok-n">customer_id</span><span class="tok-p">,</span> <span class="tok-n">cmd</span><span class="tok-o">.</span><span class="tok-n">basket_items</span><span class="tok-p">)</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">orders</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">order</span><span class="tok-p">)</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span> <span class="tok-c1"># raises OrderCreated</span>


<span class="tok-k">def</span> <span class="tok-nf">update_customer_history</span><span class="tok-p">(</span><span class="tok-n">uow</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">OrderCreated</span><span class="tok-p">):</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">history</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">order_history</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">customer_id</span><span class="tok-p">)</span>
        <span class="tok-n">history</span><span class="tok-o">.</span><span class="tok-n">record_order</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">order_id</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">order_amount</span><span class="tok-p">)</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span> <span class="tok-c1"># raises CustomerBecameVIP</span>


<span class="tok-k">def</span> <span class="tok-nf">congratulate_vip_customer</span><span class="tok-p">(</span><span class="tok-n">uow</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">CustomerBecameVip</span><span class="tok-p">):</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">customer</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">customers</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">customer_id</span><span class="tok-p">)</span>
        <span class="tok-n">email</span><span class="tok-o">.</span><span class="tok-n">send</span><span class="tok-p">(</span>
            <span class="tok-n">customer</span><span class="tok-o">.</span><span class="tok-n">email_address</span><span class="tok-p">,</span>
            <span class="tok-n">f</span><span class="tok-s1">&#39;Congratulations {customer.first_name}!&#39;</span>
        <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>History</code> aggregate captures the rules indicating when a customer becomes a VIP.
This puts us in a good place to handle changes when the rules become more
complex in the future.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Our first handler creates an order for the customer and raises a domain
event <code>OrderCreated</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Our second handler updates the <code>History</code> object to record that an order was
<span class="keep-together">created</span>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Finally, we send an email to the customer when they become a VIP.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Using this code, we can gain some intuition about error handling in an
event-driven system.</p>
</div>
<div class="paragraph">
<p>In our current implementation, we raise events about an aggregate <em>after</em> we
persist our state to the database. What if we raised those events <em>before</em> we
persisted, and committed all our changes at the same time? That way, we could be
sure that all the work was complete. Wouldn&#8217;t that be safer?</p>
</div>
<div class="paragraph">
<p>What happens, though, if the email server is slightly overloaded? If all the work
has to complete at the same time, a busy email server can stop us from taking money
for orders.</p>
</div>
<div class="paragraph">
<p>What happens if there is a bug in the implementation of the <code>History</code> aggregate?
Should we fail to take your money just because we can&#8217;t recognize you as a VIP?</p>
</div>
<div class="paragraph">
<p>By separating out these concerns, we have made it possible for things to fail
in isolation, which improves the overall reliability of the system. The only
part of this code that <em>has</em> to complete is the command handler that creates an
order. This is the only part that a customer cares about, and it&#8217;s the part that
our business stakeholders should prioritize.</p>
</div>
<div class="paragraph">
<p>Notice how we&#8217;ve deliberately aligned our transactional boundaries to the start
and end of the business processes. The names that we use in the code match the
jargon used by our business stakeholders, and the handlers we&#8217;ve written match
the steps of our natural language acceptance criteria. This concordance of names
and structure helps us to reason about our systems as they grow larger and more
complex.</p>
</div>
</div>
<div class="sect2">
<h3 id="recovering_from_errors">10.4. Recovering from Errors Synchronously</h3>
<div class="paragraph">
<p>Hopefully we&#8217;ve convinced you that it&#8217;s OK for events to fail independently
from the commands that raised them. What should we do, then, to make sure we
can recover from errors when they inevitably occur?</p>
</div>
<div class="paragraph">
<p>The first thing we need is to know <em>when</em> an error has occurred, and for that we
usually rely on logs.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look again at the <code>handle_event</code> method from our message bus:</p>
</div>
<div id="messagebus_logging" class="exampleblock">
<div class="title">Current handle function (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">handle_event</span><span class="tok-p">(</span>
    <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Event</span><span class="tok-p">,</span>
    <span class="tok-n">queue</span><span class="tok-p">:</span> <span class="tok-n">List</span><span class="tok-p">[</span><span class="tok-n">Message</span><span class="tok-p">],</span>
    <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>
<span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">handler</span> <span class="tok-ow">in</span> <span class="tok-n">EVENT_HANDLERS</span><span class="tok-p">[</span><span class="tok-nb">type</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)]:</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
<span class="hll">            <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-n">debug</span><span class="tok-p">(</span><span class="tok-s1">&#39;handling event </span><span class="tok-si">%s</span><span class="tok-s1"> with handler </span><span class="tok-si">%s</span><span class="tok-s1">&#39;</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">,</span> <span class="tok-n">handler</span><span class="tok-p">)</span>
</span>            <span class="tok-n">handler</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-o">=</span><span class="tok-n">uow</span><span class="tok-p">)</span>
            <span class="tok-n">queue</span><span class="tok-o">.</span><span class="tok-n">extend</span><span class="tok-p">(</span><span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">collect_new_events</span><span class="tok-p">())</span>
        <span class="tok-k">except</span> <span class="tok-ne">Exception</span><span class="tok-p">:</span>
<span class="hll">            <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-n">exception</span><span class="tok-p">(</span><span class="tok-s1">&#39;Exception handling event </span><span class="tok-si">%s</span><span class="tok-s1">&#39;</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">)</span>
</span>            <span class="tok-k">continue</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>When we handle a message in our system, the first thing we do is write a log
line to record what we&#8217;re about to do. For our <code>CustomerBecameVIP</code> use case, the
logs might read as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Handling event CustomerBecameVIP(customer_id=12345)
with handler &lt;function congratulate_vip_customer at 0x10ebc9a60&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Because we&#8217;ve chosen to use dataclasses for our message types, we get a neatly
printed summary of the incoming data that we can copy and paste into a Python
shell to re-create the object.</p>
</div>
<div class="paragraph">
<p>When an error occurs, we can use the logged data to either reproduce the problem
in a unit test or replay the message into the system.</p>
</div>
<div class="paragraph">
<p>Manual replay works well for cases where we need to fix a bug before we can
re-process an event, but our systems will <em>always</em> experience some background
level of transient failure. This includes things like network hiccups, table
deadlocks, and brief downtime caused by deployments.</p>
</div>
<div class="paragraph">
<p>For most of those cases, we can recover elegantly by trying again. As the
proverb says, "If at first you don&#8217;t succeed, retry the operation with an
exponentially increasing back-off period."</p>
</div>
<div id="messagebus_handle_event_with_retry" class="exampleblock">
<div class="title">Handle with retry (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">tenacity</span> <span class="tok-kn">import</span> <span class="tok-n">Retrying</span><span class="tok-p">,</span> <span class="tok-n">RetryError</span><span class="tok-p">,</span> <span class="tok-n">stop_after_attempt</span><span class="tok-p">,</span> <span class="tok-n">wait_exponential</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-o">...</span>

<span class="tok-k">def</span> <span class="tok-nf">handle_event</span><span class="tok-p">(</span>
    <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Event</span><span class="tok-p">,</span>
    <span class="tok-n">queue</span><span class="tok-p">:</span> <span class="tok-n">List</span><span class="tok-p">[</span><span class="tok-n">Message</span><span class="tok-p">],</span>
    <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>
<span class="tok-p">):</span>

    <span class="tok-k">for</span> <span class="tok-n">handler</span> <span class="tok-ow">in</span> <span class="tok-n">EVENT_HANDLERS</span><span class="tok-p">[</span><span class="tok-nb">type</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)]:</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-k">for</span> <span class="tok-n">attempt</span> <span class="tok-ow">in</span> <span class="tok-n">Retrying</span><span class="tok-p">(</span>  <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="tok-n">stop</span><span class="tok-o">=</span><span class="tok-n">stop_after_attempt</span><span class="tok-p">(</span><span class="tok-mi">3</span><span class="tok-p">),</span>
                <span class="tok-n">wait</span><span class="tok-o">=</span><span class="tok-n">wait_exponential</span><span class="tok-p">()</span>
            <span class="tok-p">):</span>

                <span class="tok-k">with</span> <span class="tok-n">attempt</span><span class="tok-p">:</span>
                    <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-n">debug</span><span class="tok-p">(</span><span class="tok-s1">&#39;handling event </span><span class="tok-si">%s</span><span class="tok-s1"> with handler </span><span class="tok-si">%s</span><span class="tok-s1">&#39;</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">,</span> <span class="tok-n">handler</span><span class="tok-p">)</span>
                    <span class="tok-n">handler</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-o">=</span><span class="tok-n">uow</span><span class="tok-p">)</span>
                    <span class="tok-n">queue</span><span class="tok-o">.</span><span class="tok-n">extend</span><span class="tok-p">(</span><span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">collect_new_events</span><span class="tok-p">())</span>
        <span class="tok-k">except</span> <span class="tok-n">RetryError</span> <span class="tok-k">as</span> <span class="tok-n">retry_failure</span><span class="tok-p">:</span>
            <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-n">error</span><span class="tok-p">(</span>
                <span class="tok-s1">&#39;Failed to handle event </span><span class="tok-si">%s</span><span class="tok-s1"> times, giving up!,</span>
                <span class="tok-n">retry_failure</span><span class="tok-o">.</span><span class="tok-n">last_attempt</span><span class="tok-o">.</span><span class="tok-n">attempt_number</span>
            <span class="tok-p">)</span>
            <span class="tok-k">continue</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Tenacity is a Python library that implements common patterns for retrying.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here we configure our message bus to retry operations up to three times,
with an exponentially increasing wait between attempts.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Retrying operations that might fail is probably the single best way to improve
the resilience of our software. Again, the Unit of Work and Command Handler
patterns mean that each attempt starts from a consistent state and won&#8217;t leave
things half-finished.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
At some point, regardless of <code>tenacity</code>, we&#8217;ll have to give up trying to
    process the message. Building reliable systems with distributed messages is
    hard, and we have to skim over some tricky bits. There are pointers to more
    reference materials in the <a href="#epilogue_1_how_to_get_there_from_here">epilogue</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_wrap_up_9">10.5. Wrap-Up</h3>
<div class="paragraph">
<p>In this book we decided to introduce the concept of events before the concept
of commands, but other guides often do it the other way around.  Making
explicit the requests that our system can respond to by giving them a name
and their own data structure is quite a fundamental thing to do.  You&#8217;ll
sometimes see people use the name <em>Command Handler</em> pattern to describe what
we&#8217;re doing with Events, Commands, and Message Bus.</p>
</div>
<div class="paragraph">
<p><a href="#chapter_10_commands_and_events_tradeoffs">Splitting commands and events: the trade-offs</a> discusses some of the things you
should think about before you jump on board.</p>
</div>
<table id="chapter_10_commands_and_events_tradeoffs" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Splitting commands and events: the trade-offs</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pros</th>
<th class="tableblock halign-left valign-top">Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Treating commands and events differently helps us understand which things
have to succeed and which things we can tidy up later.</p>
</li>
<li>
<p><code>CreateBatch</code> is definitely a less confusing name than <code>BatchCreated</code>. We are
being explicit about the intent of our users, and explicit is better than
implicit, right?</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>The semantic differences between commands and events can be subtle. Expect
bikeshedding arguments over the differences.</p>
</li>
<li>
<p>We&#8217;re expressly inviting failure. We know that sometimes things will break, and
we&#8217;re choosing to handle that by making the failures smaller and more isolated.
This can make the system harder to reason about and requires better monitoring.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In <a href="#chapter_11_external_events">Event-Driven Architecture: Using Events to Integrate Microservices</a> we&#8217;ll talk about using events as an integration pattern.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_11_external_events">11. Event-Driven Architecture: Using Events to Integrate Microservices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the preceding chapter, we never actually spoke about <em>how</em> we would receive
the "batch quantity changed" events, or indeed, how we might notify the
outside world about reallocations.</p>
</div>
<div class="paragraph">
<p>We have a microservice with a web API, but what about other ways of talking
to other systems?  How will we know if, say, a shipment is delayed or the
quantity is amended? How will we tell the warehouse system that an order has
been allocated and needs to be sent to a customer?</p>
</div>
<div class="paragraph">
<p>In this chapter, we&#8217;d like to show how the events metaphor can be extended
to encompass the way that we handle incoming and outgoing messages from the
system. Internally, the core of our application is now a message processor.
Let&#8217;s follow through on that so it becomes a message processor <em>externally</em> as
well. As shown in <a href="#message_processor_diagram">Our application is a message processor</a>, our application will receive
events from external sources via an external message bus (we&#8217;ll use Redis pub/sub
queues as an example) and publish its outputs, in the form of events, back
there as well.</p>
</div>
<div id="message_processor_diagram" class="imageblock">
<div class="content">
<img src="images/apwp_1101.png" alt="apwp 1101">
</div>
<div class="title">Figure 35. Our application is a message processor</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The code for this chapter is in the
chapter_11_external_events branch <a href="https://oreil.ly/UiwRS">on GitHub</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/cosmicpython/code.git
cd code
git checkout chapter_11_external_events
# or to code along, checkout the previous chapter:
git checkout chapter_10_commands</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_distributed_ball_of_mud_and_thinking_in_nouns">11.1. Distributed Ball of Mud, and Thinking in Nouns</h3>
<div class="paragraph">
<p>Before we get into that, let&#8217;s talk about the alternatives. We regularly talk to
engineers who are trying to build out a microservices architecture. Often they
are migrating from an existing application, and their first instinct is to
split their system into <em>nouns</em>.</p>
</div>
<div class="paragraph">
<p>What nouns have we introduced so far in our system? Well, we have batches of
stock, orders, products, and customers. So a naive attempt at breaking
up the system might have looked like <a href="#batches_context_diagram">Context diagram with noun-based services</a> (notice that
we&#8217;ve named our system after a noun, <em>Batches</em>, instead of <em>Allocation</em>).</p>
</div>
<div id="batches_context_diagram" class="imageblock">
<div class="content">
<img src="images/apwp_1102.png" alt="apwp 1102">
</div>
<div class="title">Figure 36. Context diagram with noun-based services</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_1102, config=plantuml.cfg]
@startuml Batches Context Diagram
!include images/C4_Context.puml

System(batches, "Batches", "Knows about available stock")
Person(customer, "Customer", "Wants to buy furniture")
System(orders, "Orders", "Knows about customer orders")
System(warehouse, "Warehouse", "Knows about shipping instructions")

Rel_R(customer, orders, "Places order with")
Rel_D(orders, batches, "Reserves stock with")
Rel_D(batches, warehouse, "Sends instructions to")

@enduml</pre>
</div>
</div>
<div class="paragraph">
<p>Each "thing" in our system has an associated service, which exposes an HTTP API.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s work through an example happy-path flow in <a href="#command_flow_diagram_1">Command flow 1</a>:
our users visit a website and can choose from products that are in stock. When
they add an item to their basket, we will reserve some stock for them. When an
order is complete, we confirm the reservation, which causes us to send dispatch
instructions to the warehouse. Let&#8217;s also say, if this is the customer&#8217;s third
order, we want to update the customer record to flag them as a VIP.</p>
</div>
<div id="command_flow_diagram_1" class="imageblock width-80">
<div class="content">
<img src="images/apwp_1103.png" alt="apwp 1103">
</div>
<div class="title">Figure 37. Command flow 1</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_1103, config=plantuml.cfg]
@startuml
scale 4

actor Customer
entity Orders
entity Batches
entity Warehouse
database CRM


== Reservation ==

  Customer -&gt; Orders: Add product to basket
  Orders -&gt; Batches: Reserve stock

== Purchase ==

  Customer -&gt; Orders: Place order
  activate Orders
  Orders -&gt; Batches: Confirm reservation
  Batches -&gt; Warehouse: Dispatch goods
  Orders -&gt; CRM: Update customer record
  deactivate Orders


@enduml</pre>
</div>
</div>
<div class="paragraph">
<p>We can think of each of these steps as a command in our system: <code>ReserveStock</code>,
<span class="keep-together"><code>ConfirmReservation</code></span>, <code>DispatchGoods</code>, <code>MakeCustomerVIP</code>, and so forth.</p>
</div>
<div class="paragraph">
<p>This style of architecture, where we create a microservice per database table
and treat our HTTP APIs as CRUD interfaces to anemic models, is the most common
initial way for people to approach service-oriented design.</p>
</div>
<div class="paragraph">
<p>This works <em>fine</em> for systems that are very simple, but it can quickly degrade into
a distributed ball of mud.</p>
</div>
<div class="paragraph">
<p>To see why, let&#8217;s consider another case. Sometimes, when stock arrives at the
warehouse, we discover that items have been water damaged during transit. We
can&#8217;t sell water-damaged sofas, so we have to throw them away and request more
stock from our partners. We also need to update our stock model, and that
might mean we need to reallocate a customer&#8217;s order.</p>
</div>
<div class="paragraph">
<p>Where does this logic go?</p>
</div>
<div class="paragraph">
<p>Well, the Warehouse system knows that the stock has been damaged, so maybe it
should own this process, as shown in <a href="#command_flow_diagram_2">Command flow 2</a>.</p>
</div>
<div id="command_flow_diagram_2" class="imageblock">
<div class="content">
<img src="images/apwp_1104.png" alt="apwp 1104">
</div>
<div class="title">Figure 38. Command flow 2</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_1104, config=plantuml.cfg]
@startuml
scale 4

actor w as "Warehouse worker"
entity Warehouse
entity Batches
entity Orders
database CRM


  w -&gt; Warehouse: Report stock damage
  activate Warehouse
  Warehouse -&gt; Batches: Decrease available stock
  Batches -&gt; Batches: Reallocate orders
  Batches -&gt; Orders: Update order status
  Orders -&gt; CRM: Update order history
  deactivate Warehouse

@enduml</pre>
</div>
</div>
<div class="paragraph">
<p>This sort of works too, but now our dependency graph is a mess. To
allocate stock, the Orders service drives the Batches system, which drives
Warehouse; but in order to handle problems at the warehouse, our Warehouse
system drives Batches, which drives Orders.</p>
</div>
<div class="paragraph">
<p>Multiply this by all the other workflows we need to provide, and you can see
how services quickly get tangled up.</p>
</div>
</div>
<div class="sect2">
<h3 id="_error_handling_in_distributed_systems">11.2. Error Handling in Distributed Systems</h3>
<div class="paragraph">
<p>"Things break" is a universal law of software engineering. What happens in our
system when one of our requests fails? Let&#8217;s say that a network error happens
right after we take a user&#8217;s order for three <code>MISBEGOTTEN-RUG</code>, as shown in
<a href="#command_flow_diagram_with_error">Command flow with error</a>.</p>
</div>
<div class="paragraph">
<p>We have two options here: we can place the order anyway and leave it
unallocated, or we can refuse to take the order because the allocation can&#8217;t be
guaranteed. The failure state of our batches service has bubbled up and is
affecting the reliability of our order service.</p>
</div>
<div class="paragraph">
<p>When two things have to be changed together, we say that they are <em>coupled</em>. We
can think of this failure cascade as a kind of <em>temporal coupling</em>: every part
of the system has to work at the same time for any part of it to work. As the
system gets bigger, there is an exponentially increasing probability that some
part is degraded.</p>
</div>
<div id="command_flow_diagram_with_error" class="imageblock">
<div class="content">
<img src="images/apwp_1105.png" alt="apwp 1105">
</div>
<div class="title">Figure 39. Command flow with error</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_1105, config=plantuml.cfg]
@startuml
scale 4

actor Customer
entity Orders
entity Batches

Customer -&gt; Orders: Place order
Orders -[#red]x Batches: Confirm reservation
hnote right: network error
Orders --&gt; Customer: ???

@enduml</pre>
</div>
</div>
<div id="connascence_sidebar" class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Connascence</div>
<div class="paragraph">
<p>We&#8217;re using the term <em>coupling</em> here, but there&#8217;s another way to describe
the relationships between our systems. <em>Connascence</em> is a term used by some
authors to describe the different types of coupling.</p>
</div>
<div class="paragraph">
<p>Connascence isn&#8217;t <em>bad</em>, but some types of connascence are <em>stronger</em> than
others. We want to have strong connascence locally, as when two classes are
closely related, but weak connascence at a distance.</p>
</div>
<div class="paragraph">
<p>In our first example of a distributed ball of mud, we see Connascence of
Execution: multiple components need to know the correct order of work for an
operation to be successful.</p>
</div>
<div class="paragraph">
<p>When thinking about error conditions here, we&#8217;re talking about Connascence of
Timing: multiple things have to happen, one after another, for the operation to
work.</p>
</div>
<div class="paragraph">
<p>When we replace our RPC-style system with events, we replace both of these types
of connascence with a <em>weaker</em> type. That&#8217;s Connascence of Name: multiple
components need to agree only on the name of an event and the names of fields
it carries.</p>
</div>
<div class="paragraph">
<p>We can never completely avoid coupling, except by having our software not talk
to any other software. What we want is to avoid <em>inappropriate</em> coupling.
Connascence provides a mental model for understanding the strength and type of
coupling inherent in different architectural styles. Read all about it at
<a href="http://www.connascence.io">connascence.io</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_alternative_temporal_decoupling_using_asynchronous_messaging">11.3. The Alternative: Temporal Decoupling Using Asynchronous Messaging</h3>
<div class="paragraph">
<p>How do we get appropriate coupling? We&#8217;ve already seen part of the answer, which is that we should think in
terms of verbs, not nouns. Our domain model is about modeling a business
process. It&#8217;s not a static data model about a thing; it&#8217;s a model of a verb.</p>
</div>
<div class="paragraph">
<p>So instead of thinking about a system for orders and a system for batches,
we think about a system for <em>ordering</em> and a system for <em>allocating</em>, and
so on.</p>
</div>
<div class="paragraph">
<p>When we separate things this way, it&#8217;s a little easier to see which system
should be responsible for what.  When thinking about <em>ordering</em>, really we want
to make sure that when we place an order, the order is placed. Everything else
can happen <em>later</em>, so long as it happens.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If this sounds familiar, it should!  Segregating responsibilities is
    the same process we went through when designing our aggregates and commands.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Like aggregates, microservices should be <em>consistency boundaries</em>. Between two
services, we can accept eventual consistency, and that means we don&#8217;t need to
rely on synchronous calls. Each service accepts commands from the outside world
and raises events to record the result. Other services can listen to those
events to trigger the next steps in the workflow.</p>
</div>
<div class="paragraph">
<p>To avoid the Distributed Ball of Mud anti-pattern, instead of temporally coupled HTTP
API calls, we want to use asynchronous messaging to integrate our systems. We
want our <code>BatchQuantityChanged</code> messages to come in as external messages from
upstream systems, and we want our system to publish <code>Allocated</code> events for
downstream systems to listen to.</p>
</div>
<div class="paragraph">
<p>Why is this better? First, because things can fail independently, it&#8217;s easier
to handle degraded behavior: we can still take orders if the allocation system
is having a bad day.</p>
</div>
<div class="paragraph">
<p>Second, we&#8217;re reducing the strength of coupling between our systems. If we
need to change the order of operations or to introduce new steps in the process,
we can do that locally.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_a_redis_pubsub_channel_for_integration">11.4. Using a Redis Pub/Sub Channel for Integration</h3>
<div class="paragraph">
<p>Let&#8217;s see how it will all work concretely. We&#8217;ll need some way of getting
events out of one system and into another, like our message bus, but for
services. This piece of infrastructure is often called a <em>message broker</em>. The
role of a message broker is to take messages from publishers and deliver them
to subscribers.</p>
</div>
<div class="paragraph">
<p>At MADE.com, we use <a href="https://eventstore.org">Event Store</a>; Kafka or RabbitMQ
are valid alternatives. A lightweight solution based on Redis
<a href="https://redis.io/topics/pubsub">pub/sub channels</a> can also work just fine, and because
Redis is much more generally familiar to people, we thought we&#8217;d use it for this
book.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We&#8217;re glossing over the complexity involved in choosing the right messaging
    platform. Concerns like message ordering, failure handling, and idempotency
    all need to be thought through. For a few pointers, see
    <a href="#footguns">Footguns</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Our new flow will look like <a href="#reallocation_sequence_diagram_with_redis">Sequence diagram for reallocation flow</a>:
Redis provides the <code>BatchQuantityChanged</code> event that kicks off the whole process, and our <code>Allocated</code> event is published back out to Redis again at the
end.</p>
</div>
<div id="reallocation_sequence_diagram_with_redis" class="imageblock width-75">
<div class="content">
<img src="images/apwp_1106.png" alt="apwp 1106">
</div>
<div class="title">Figure 40. Sequence diagram for reallocation flow</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_1106, config=plantuml.cfg]
@startuml
scale 4

Redis -&gt; MessageBus : BatchQuantityChanged event

group BatchQuantityChanged Handler + Unit of Work 1
    MessageBus -&gt; Domain_Model : change batch quantity
    Domain_Model -&gt; MessageBus : emit Allocate command(s)
end


group Allocate Handler + Unit of Work 2 (or more)
    MessageBus -&gt; Domain_Model : allocate
    Domain_Model -&gt; MessageBus : emit Allocated event(s)
end

MessageBus -&gt; Redis : publish to line_allocated channel
@enduml</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_test_driving_it_all_using_an_end_to_end_test">11.5. Test-Driving It All Using an End-to-End Test</h3>
<div class="paragraph">
<p>Here&#8217;s how we might start with an end-to-end test.  We can use our existing
API to create batches, and then we&#8217;ll test both inbound and outbound messages:</p>
</div>
<div id="redis_e2e_test" class="exampleblock">
<div class="title">An end-to-end test for our pub/sub model (tests/e2e/test_external_events.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_change_batch_quantity_leading_to_reallocation</span><span class="tok-p">():</span>
    <span class="tok-c1"># start with two batches and an order allocated to one of them  </span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">random_orderid</span><span class="tok-p">(),</span> <span class="tok-n">random_sku</span><span class="tok-p">()</span>
    <span class="tok-n">earlier_batch</span><span class="tok-p">,</span> <span class="tok-n">later_batch</span> <span class="tok-o">=</span> <span class="tok-n">random_batchref</span><span class="tok-p">(</span><span class="tok-s1">&#39;old&#39;</span><span class="tok-p">),</span> <span class="tok-n">random_batchref</span><span class="tok-p">(</span><span class="tok-s1">&#39;newer&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">api_client</span><span class="tok-o">.</span><span class="tok-n">post_to_add_batch</span><span class="tok-p">(</span><span class="tok-n">earlier_batch</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-s1">&#39;2011-01-02&#39;</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">api_client</span><span class="tok-o">.</span><span class="tok-n">post_to_add_batch</span><span class="tok-p">(</span><span class="tok-n">later_batch</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-s1">&#39;2011-01-02&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">response</span> <span class="tok-o">=</span> <span class="tok-n">api_client</span><span class="tok-o">.</span><span class="tok-n">post_to_allocate</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-k">assert</span> <span class="tok-n">response</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">()[</span><span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">earlier_batch</span>

    <span class="tok-n">subscription</span> <span class="tok-o">=</span> <span class="tok-n">redis_client</span><span class="tok-o">.</span><span class="tok-n">subscribe_to</span><span class="tok-p">(</span><span class="tok-s1">&#39;line_allocated&#39;</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="tok-c1"># change quantity on allocated batch so it&#39;s less than our order  </span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">redis_client</span><span class="tok-o">.</span><span class="tok-n">publish_message</span><span class="tok-p">(</span><span class="tok-s1">&#39;change_batch_quantity&#39;</span><span class="tok-p">,</span> <span class="tok-p">{</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">:</span> <span class="tok-n">earlier_batch</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">:</span> <span class="tok-mi">5</span>
    <span class="tok-p">})</span>

    <span class="tok-c1"># wait until we see a message saying the order has been reallocated  </span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">messages</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>
    <span class="tok-k">for</span> <span class="tok-n">attempt</span> <span class="tok-ow">in</span> <span class="tok-n">Retrying</span><span class="tok-p">(</span><span class="tok-n">stop</span><span class="tok-o">=</span><span class="tok-n">stop_after_delay</span><span class="tok-p">(</span><span class="tok-mi">3</span><span class="tok-p">),</span> <span class="tok-n">reraise</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">):</span>  <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-k">with</span> <span class="tok-n">attempt</span><span class="tok-p">:</span>
            <span class="tok-n">message</span> <span class="tok-o">=</span> <span class="tok-n">subscription</span><span class="tok-o">.</span><span class="tok-n">get_message</span><span class="tok-p">(</span><span class="tok-n">timeout</span><span class="tok-o">=</span><span class="tok-mi">1</span><span class="tok-p">)</span>
            <span class="tok-k">if</span> <span class="tok-n">message</span><span class="tok-p">:</span>
                <span class="tok-n">messages</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">message</span><span class="tok-p">)</span>
                <span class="tok-k">print</span><span class="tok-p">(</span><span class="tok-n">messages</span><span class="tok-p">)</span>
            <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-n">json</span><span class="tok-o">.</span><span class="tok-n">loads</span><span class="tok-p">(</span><span class="tok-n">messages</span><span class="tok-p">[</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">][</span><span class="tok-s1">&#39;data&#39;</span><span class="tok-p">])</span>
            <span class="tok-k">assert</span> <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">orderid</span>
            <span class="tok-k">assert</span> <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">later_batch</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can read the story of what&#8217;s going on in this test from the comments:
we want to send an event into the system that causes an order line to be
reallocated, and we see that reallocation come out as an event in Redis too.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>api_client</code> is a little helper that we refactored out to share between
our two test types; it wraps our calls to <code>requests.post</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>redis_client</code> is another little test helper, the details of which
don&#8217;t really matter; its job is to be able to send and receive messages
from various Redis channels. We&#8217;ll use a channel called
<code>change_batch_quantity</code> to send in our request to change the quantity for a
batch, and we&#8217;ll listen to another channel called <code>line_allocated</code> to
look out for the expected reallocation.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Because of the asynchronous nature of the system under test, we need to use
the <code>tenacity</code> library again to add a retry loop—first, because it may
take some time for our new <code>line_allocated</code> message to arrive, but also
because it won&#8217;t be the only message on that channel.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_redis_is_another_thin_adapter_around_our_message_bus">11.5.1. Redis Is Another Thin Adapter Around Our Message Bus</h4>
<div class="paragraph">
<p>Our Redis pub/sub listener (we call it an <em>event consumer</em>) is very much like
Flask: it translates from the outside world to our events:</p>
</div>
<div id="redis_eventconsumer_first_cut" class="exampleblock">
<div class="title">Simple Redis message listener (src/allocation/entrypoints/redis_eventconsumer.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-n">redis</span><span class="tok-o">.</span><span class="tok-n">Redis</span><span class="tok-p">(</span><span class="tok-o">**</span><span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-n">get_redis_host_and_port</span><span class="tok-p">())</span>


<span class="tok-k">def</span> <span class="tok-nf">main</span><span class="tok-p">():</span>
    <span class="tok-n">orm</span><span class="tok-o">.</span><span class="tok-n">start_mappers</span><span class="tok-p">()</span>
    <span class="tok-n">pubsub</span> <span class="tok-o">=</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">pubsub</span><span class="tok-p">(</span><span class="tok-n">ignore_subscribe_messages</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>
    <span class="tok-n">pubsub</span><span class="tok-o">.</span><span class="tok-n">subscribe</span><span class="tok-p">(</span><span class="tok-s1">&#39;change_batch_quantity&#39;</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-k">for</span> <span class="tok-n">m</span> <span class="tok-ow">in</span> <span class="tok-n">pubsub</span><span class="tok-o">.</span><span class="tok-n">listen</span><span class="tok-p">():</span>
        <span class="tok-n">handle_change_batch_quantity</span><span class="tok-p">(</span><span class="tok-n">m</span><span class="tok-p">)</span>


<span class="tok-k">def</span> <span class="tok-nf">handle_change_batch_quantity</span><span class="tok-p">(</span><span class="tok-n">m</span><span class="tok-p">):</span>
    <span class="tok-n">logging</span><span class="tok-o">.</span><span class="tok-n">debug</span><span class="tok-p">(</span><span class="tok-s1">&#39;handling </span><span class="tok-si">%s</span><span class="tok-s1">&#39;</span><span class="tok-p">,</span> <span class="tok-n">m</span><span class="tok-p">)</span>
    <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-n">json</span><span class="tok-o">.</span><span class="tok-n">loads</span><span class="tok-p">(</span><span class="tok-n">m</span><span class="tok-p">[</span><span class="tok-s1">&#39;data&#39;</span><span class="tok-p">])</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">cmd</span> <span class="tok-o">=</span> <span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">ChangeBatchQuantity</span><span class="tok-p">(</span><span class="tok-n">ref</span><span class="tok-o">=</span><span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">],</span> <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">])</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">cmd</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-o">=</span><span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">())</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>main()</code> subscribes us to the <code>change_batch_quantity</code> channel on load.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Our main job as an entrypoint to the system is to deserialize JSON,
convert it to a <code>Command</code>, and pass it to the service layer&#8212;&#8203;much as the
Flask adapter does.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We also build a new downstream adapter to do the opposite job—converting
 domain events to public events:</p>
</div>
<div id="redis_eventpubisher_first_cut" class="exampleblock">
<div class="title">Simple Redis message publisher (src/allocation/adapters/redis_eventpublisher.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-n">redis</span><span class="tok-o">.</span><span class="tok-n">Redis</span><span class="tok-p">(</span><span class="tok-o">**</span><span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-n">get_redis_host_and_port</span><span class="tok-p">())</span>


<span class="tok-k">def</span> <span class="tok-nf">publish</span><span class="tok-p">(</span><span class="tok-n">channel</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Event</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">logging</span><span class="tok-o">.</span><span class="tok-n">debug</span><span class="tok-p">(</span><span class="tok-s1">&#39;publishing: channel=</span><span class="tok-si">%s</span><span class="tok-s1">, event=</span><span class="tok-si">%s</span><span class="tok-s1">&#39;</span><span class="tok-p">,</span> <span class="tok-n">channel</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">)</span>
    <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">publish</span><span class="tok-p">(</span><span class="tok-n">channel</span><span class="tok-p">,</span> <span class="tok-n">json</span><span class="tok-o">.</span><span class="tok-n">dumps</span><span class="tok-p">(</span><span class="tok-n">asdict</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)))</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We take a hardcoded channel here, but you could also store
a mapping between event classes/names and the appropriate channel,
allowing one or more message types to go to different channels.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_our_new_outgoing_event">11.5.2. Our New Outgoing Event</h4>
<div class="paragraph">
<p>Here&#8217;s what the <code>Allocated</code> event will look like:</p>
</div>
<div id="allocated_event" class="exampleblock">
<div class="title">New event (src/allocation/domain/events.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@dataclass</span>
<span class="tok-k">class</span> <span class="tok-nc">Allocated</span><span class="tok-p">(</span><span class="tok-n">Event</span><span class="tok-p">):</span>
    <span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span>
    <span class="tok-n">batchref</span><span class="tok-p">:</span> <span class="tok-nb">str</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It captures everything we need to know about an allocation: the details of the
order line, and which batch it was allocated to.</p>
</div>
<div class="paragraph">
<p>We add it into our model&#8217;s <code>allocate()</code> method (having added a test
first, naturally):</p>
</div>
<div id="model_emits_allocated_event" class="exampleblock">
<div class="title">Product.allocate() emits new event to record what happened (src/allocation/domain/model.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Product</span><span class="tok-p">:</span>
    <span class="tok-o">...</span>
    <span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
        <span class="tok-o">...</span>

            <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">version_number</span> <span class="tok-o">+=</span> <span class="tok-mi">1</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Allocated</span><span class="tok-p">(</span>
                <span class="tok-n">orderid</span><span class="tok-o">=</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">qty</span><span class="tok-p">,</span>
                <span class="tok-n">batchref</span><span class="tok-o">=</span><span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">reference</span><span class="tok-p">,</span>
            <span class="tok-p">))</span>
            <span class="tok-k">return</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">reference</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The handler for <code>ChangeBatchQuantity</code> already exists, so all we need to add
is a handler that publishes the outgoing event:</p>
</div>
<div id="another_handler" class="exampleblock">
<div class="title">The message bus grows (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">HANDLERS</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
<span class="hll">    <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Allocated</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">publish_allocated_event</span><span class="tok-p">],</span>
</span>    <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">:</span> <span class="tok-p">[</span><span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">send_out_of_stock_notification</span><span class="tok-p">],</span>
<span class="tok-p">}</span>  <span class="tok-c1"># type: Dict[Type[events.Event], List[Callable]]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Publishing the event uses our helper function from the Redis wrapper:</p>
</div>
<div id="publish_event_handler" class="exampleblock">
<div class="title">Publish to Redis (src/allocation/service_layer/handlers.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">publish_allocated_event</span><span class="tok-p">(</span>
        <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Allocated</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">,</span>
<span class="tok-p">):</span>
    <span class="tok-n">redis_eventpublisher</span><span class="tok-o">.</span><span class="tok-n">publish</span><span class="tok-p">(</span><span class="tok-s1">&#39;line_allocated&#39;</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_internal_versus_external_events">11.6. Internal Versus External Events</h3>
<div class="paragraph">
<p>It&#8217;s a good idea to keep the distinction between internal and external events
clear.  Some events may come from the outside, and some events may get upgraded
and published externally, but not all of them will.  This is particularly important
if you get into
<a href="https://oreil.ly/FXVil">event sourcing</a>
(very much a topic for another book, though).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Outbound events are one of the places it&#8217;s important to apply validation.
    See <a href="#appendix_validation">Validation</a> for some validation philosophy and <span class="keep-together">examples</span>.
</td>
</tr>
</table>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Exercise for the Reader</div>
<div class="paragraph">
<p>A nice simple one for this chapter: make it so that the main <code>allocate()</code> use
case can also be invoked by an event on a Redis channel, as well as (or instead of)
via the API.</p>
</div>
<div class="paragraph">
<p>You will likely want to add a new E2E test and feed through some changes into
<span class="keep-together"><code>redis_eventconsumer.py</code></span>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up_10">11.7. Wrap-Up</h3>
<div class="paragraph">
<p>Events can come <em>from</em> the outside, but they can also be published
externally&#8212;&#8203;our <code>publish</code> handler converts an event to a message on a Redis
channel. We use events to talk to the outside world.  This kind of temporal
decoupling buys us a lot of flexibility in our application integrations, but
as always, it comes at a cost.</p>
</div>
<blockquote>

<p>
Event notification is nice because it implies a low level of coupling, and is
pretty simple to set up. It can become problematic, however, if there really is
a logical flow that runs over various event notifications...It can be hard to
see such a flow as it's not explicit in any program text....This can make it hard to debug
and modify.
</p>

<p data-type="attribution">Martin Fowler, <a href="https://oreil.ly/uaPNt"><span class="roman">"What do you mean by 'Event-Driven'"</span></a></p>

</blockquote>
<div class="paragraph">
<p><a href="#chapter_11_external_events_tradeoffs">Event-based microservices integration: the trade-offs</a> shows some trade-offs to think about.</p>
</div>
<table id="chapter_11_external_events_tradeoffs" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Event-based microservices integration: the trade-offs</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pros</th>
<th class="tableblock halign-left valign-top">Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Avoids the distributed big ball of mud.</p>
</li>
<li>
<p>Services are decoupled: it&#8217;s easier to change individual services and add
new ones.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>The overall flows of information are harder to see.</p>
</li>
<li>
<p>Eventual consistency is a new concept to deal with.</p>
</li>
<li>
<p>Message reliability and choices around at-least-once versus at-most-once delivery
need thinking through.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>More generally, if you&#8217;re moving from a model of synchronous messaging to an
async one, you also open up a whole host of problems having to do with message
reliability and eventual consistency. Read on to <a href="#footguns">Footguns</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_12_cqrs">12. Command-Query Responsibility Segregation (CQRS)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter, we&#8217;re going to start with a fairly uncontroversial insight:
reads (queries) and writes (commands) are different, so they
should be treated differently (or have their responsibilities segregated, if you will). Then we&#8217;re going to push that insight as far
as we can.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re anything like Harry, this will all seem extreme at first,
but hopefully we can make the argument that it&#8217;s not <em>totally</em> unreasonable.</p>
</div>
<div class="paragraph">
<p><a href="#maps_chapter_11">Separating reads from writes</a> shows where we might end up.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The code for this chapter is in the
chapter_12_cqrs branch <a href="https://oreil.ly/YbWGT">on <span class="keep-together">GitHub</span></a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/cosmicpython/code.git
cd code
git checkout chapter_12_cqrs
# or to code along, checkout the previous chapter:
git checkout chapter_11_external_events</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First, though, why bother?</p>
</div>
<div id="maps_chapter_11" class="imageblock">
<div class="content">
<img src="images/apwp_1201.png" alt="apwp 1201">
</div>
<div class="title">Figure 41. Separating reads from writes</div>
</div>
<div class="sect2">
<h3 id="_domain_models_are_for_writing">12.1. Domain Models Are for Writing</h3>
<div class="paragraph">
<p>We&#8217;ve spent a lot of time in this book talking about how to build software that
enforces the rules of our domain. These rules, or constraints, will be different
for every application, and they make up the interesting core of our systems.</p>
</div>
<div class="paragraph">
<p>In this book, we&#8217;ve set explicit constraints like "You can&#8217;t allocate more stock
than is available," as well as implicit constraints like "Each order line is
allocated to a single batch."</p>
</div>
<div class="paragraph">
<p>We wrote down these rules as unit tests at the beginning of the book:</p>
</div>
<div id="domain_tests" class="exampleblock pagebreak-before">
<div class="title">Our basic domain tests (tests/unit/test_batches.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_allocating_to_a_batch_reduces_the_available_quantity</span><span class="tok-p">():</span>
    <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch-001&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;SMALL-TABLE&quot;</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-mi">20</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">date</span><span class="tok-o">.</span><span class="tok-n">today</span><span class="tok-p">())</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s1">&#39;order-ref&#39;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;SMALL-TABLE&quot;</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">)</span>

    <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>

    <span class="tok-k">assert</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">available_quantity</span> <span class="tok-o">==</span> <span class="tok-mi">18</span>

<span class="tok-o">...</span>

<span class="tok-k">def</span> <span class="tok-nf">test_cannot_allocate_if_available_smaller_than_required</span><span class="tok-p">():</span>
    <span class="tok-n">small_batch</span><span class="tok-p">,</span> <span class="tok-n">large_line</span> <span class="tok-o">=</span> <span class="tok-n">make_batch_and_line</span><span class="tok-p">(</span><span class="tok-s2">&quot;ELEGANT-LAMP&quot;</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-mi">20</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">small_batch</span><span class="tok-o">.</span><span class="tok-n">can_allocate</span><span class="tok-p">(</span><span class="tok-n">large_line</span><span class="tok-p">)</span> <span class="tok-ow">is</span> <span class="tok-bp">False</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To apply these rules properly, we needed to ensure that operations
were consistent, and so we introduced patterns like <em>Unit of Work</em> and <em>Aggregate</em>
that help us commit small chunks of work.</p>
</div>
<div class="paragraph">
<p>To communicate changes between those small chunks, we introduced the Domain Events pattern
so we can write rules like "When stock is damaged or lost, adjust the
available quantity on the batch, and reallocate orders if necessary."</p>
</div>
<div class="paragraph">
<p>All of this complexity exists so we can enforce rules when we change the
state of our system. We&#8217;ve built a flexible set of tools for writing data.</p>
</div>
<div class="paragraph">
<p>What about reads, though?</p>
</div>
</div>
<div class="sect2">
<h3 id="_most_users_arent_going_to_buy_your_furniture">12.2. Most Users Aren&#8217;t Going to Buy Your Furniture</h3>
<div class="paragraph">
<p>At MADE.com, we have a system very like the allocation service. In a busy day, we
might process one hundred orders in an hour, and we have a big gnarly system for
allocating stock to those orders.</p>
</div>
<div class="paragraph">
<p>In that same busy day, though, we might have one hundred product views per <em>second</em>.
Each time somebody visits a product page, or a product listing page, we need
to figure out whether the product is still in stock and how long it will take
us to deliver it.</p>
</div>
<div class="paragraph">
<p>The <em>domain</em> is the same&#8212;&#8203;we&#8217;re concerned with batches of stock, and their
arrival date, and the amount that&#8217;s still available&#8212;&#8203;but the access pattern
is very different. For example, our customers won&#8217;t notice if the query
is a few seconds out of date, but if our allocate service is inconsistent,
we&#8217;ll make a mess of their orders. We can take advantage of this difference by
making our reads <em>eventually consistent</em> in order to make them perform better.</p>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Is Read Consistency Truly Attainable?</div>
<div class="paragraph">
<p>This idea of trading consistency against performance makes a lot of developers
<span class="keep-together">nervous</span> at first, so let&#8217;s talk quickly about that.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s imagine that our "Get Available Stock" query is 30 seconds out of date
when Bob visits the page for <code>ASYMMETRICAL-DRESSER</code>.
Meanwhile, though, Harry has already bought the last item. When we try to
allocate Bob&#8217;s order, we&#8217;ll get a failure, and we&#8217;ll need to either cancel his
order or buy more stock and delay his delivery.</p>
</div>
<div class="paragraph">
<p>People who&#8217;ve worked only with relational data stores get <em>really</em> nervous
about this problem, but it&#8217;s worth considering two other scenarios to gain some
perspective.</p>
</div>
<div class="paragraph">
<p>First, let&#8217;s imagine that Bob and Harry both visit the page at <em>the same
time</em>. Harry goes off to make coffee, and by the time he returns, Bob has
already bought the last dresser. When Harry places his order, we send it to
the allocation service, and because there&#8217;s not enough stock, we have to refund
his payment or buy more stock and delay his delivery.</p>
</div>
<div class="paragraph">
<p>As soon as we render the product page, the data is already stale. This insight
is key to understanding why reads can be safely inconsistent: we&#8217;ll always need
to check the current state of our system when we come to allocate, because all
distributed systems are inconsistent. As soon as you have a web server and two
customers, you have the potential for stale data.</p>
</div>
<div class="paragraph">
<p>OK, let&#8217;s assume we solve that problem somehow: we magically build a totally
consistent web application where nobody ever sees stale data. This time Harry
gets to the page first and buys his dresser.</p>
</div>
<div class="paragraph">
<p>Unfortunately for him, when the warehouse staff tries to dispatch his furniture,
it falls off the forklift and smashes into a zillion pieces. Now what?</p>
</div>
<div class="paragraph">
<p>The only options are to either call Harry and refund his order or buy more
stock and delay delivery.</p>
</div>
<div class="paragraph">
<p>No matter what we do, we&#8217;re always going to find that our software systems are
inconsistent with reality, and so we&#8217;ll always need business processes to cope
with these edge cases. It&#8217;s OK to trade performance for consistency on the
read side, because stale data is essentially unavoidable.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>We can think of these requirements as forming two halves of a system:
the read side and the write side, shown in <a href="#read_and_write_table">Read versus write</a>.</p>
</div>
<div class="paragraph">
<p>For the write side, our fancy domain architectural patterns help us to evolve
our system over time, but the complexity we&#8217;ve built so far doesn&#8217;t buy
anything for reading data. The service layer, the unit of work,  and the clever
domain model are just bloat.</p>
</div>
<table id="read_and_write_table" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Read versus write</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Read side</th>
<th class="tableblock halign-left valign-top">Write side</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Behavior</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Simple read</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complex business logic</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cacheability</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Highly cacheable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uncacheable</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Consistency</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Can be stale</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Must be transactionally consistent</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_postredirectget_and_cqs">12.3. Post/Redirect/Get and CQS</h3>
<div class="paragraph">
<p>If you do web development, you&#8217;re probably familiar with the
Post/Redirect/Get pattern. In this technique, a web endpoint accepts an
HTTP POST and responds with a redirect to see the result. For example, we might
accept a POST to <em>/batches</em> to create a new batch and redirect the user to
<em>/batches/123</em> to see their newly created batch.</p>
</div>
<div class="paragraph">
<p>This approach fixes the problems that arise when users refresh the results page
in their browser or try to bookmark a results page. In the case of a refresh,
it can lead to our users double-submitting data and thus buying two sofas when they
needed only one. In the case of a bookmark, our hapless customers will end up
with a broken page when they try to GET a POST endpoint.</p>
</div>
<div class="paragraph">
<p>Both these problems happen because we&#8217;re returning data in response to a write
operation. Post/Redirect/Get sidesteps the issue by separating the read and
write phases of our operation.</p>
</div>
<div class="paragraph">
<p>This technique is a simple example of command-query separation (CQS). In CQS we
follow one simple rule: functions should either modify state or answer
questions, but never both. This makes software easier to reason about: we should
always be able to ask, "Are the lights on?" without flicking the light switch.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When building APIs, we can apply the same design technique by returning a
    201 Created, or a 202 Accepted, with a Location header containing the URI
    of our new resources. What&#8217;s important here isn&#8217;t the status code we use
    but the logical separation of work into a write phase and a query phase.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you&#8217;ll see, we can use the CQS principle to make our systems faster and more
scalable, but first, let&#8217;s fix the CQS violation in our existing code. Ages ago, we introduced an <code>allocate</code> endpoint that takes an order and
calls our service layer to allocate some stock. At the end of the call, we
return a 200 OK and the batch ID. That&#8217;s led to some ugly design flaws so that
we can get the data we need. Let&#8217;s change it to return a simple OK message and
instead provide a new read-only endpoint to retrieve allocation state:</p>
</div>
<div id="api_test_does_get_after_post" class="exampleblock">
<div class="title">API test does a GET after the POST (tests/e2e/test_api.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@pytest.mark.usefixtures</span><span class="tok-p">(</span><span class="tok-s1">&#39;postgres_db&#39;</span><span class="tok-p">)</span>
<span class="tok-nd">@pytest.mark.usefixtures</span><span class="tok-p">(</span><span class="tok-s1">&#39;restart_api&#39;</span><span class="tok-p">)</span>
<span class="tok-k">def</span> <span class="tok-nf">test_happy_path_returns_202_and_batch_is_allocated</span><span class="tok-p">():</span>
    <span class="tok-n">orderid</span> <span class="tok-o">=</span> <span class="tok-n">random_orderid</span><span class="tok-p">()</span>
    <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">othersku</span> <span class="tok-o">=</span> <span class="tok-n">random_sku</span><span class="tok-p">(),</span> <span class="tok-n">random_sku</span><span class="tok-p">(</span><span class="tok-s1">&#39;other&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">earlybatch</span> <span class="tok-o">=</span> <span class="tok-n">random_batchref</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span>
    <span class="tok-n">laterbatch</span> <span class="tok-o">=</span> <span class="tok-n">random_batchref</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span>
    <span class="tok-n">otherbatch</span> <span class="tok-o">=</span> <span class="tok-n">random_batchref</span><span class="tok-p">(</span><span class="tok-mi">3</span><span class="tok-p">)</span>
    <span class="tok-n">api_client</span><span class="tok-o">.</span><span class="tok-n">post_to_add_batch</span><span class="tok-p">(</span><span class="tok-n">laterbatch</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-s1">&#39;2011-01-02&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">api_client</span><span class="tok-o">.</span><span class="tok-n">post_to_add_batch</span><span class="tok-p">(</span><span class="tok-n">earlybatch</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-s1">&#39;2011-01-01&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">api_client</span><span class="tok-o">.</span><span class="tok-n">post_to_add_batch</span><span class="tok-p">(</span><span class="tok-n">otherbatch</span><span class="tok-p">,</span> <span class="tok-n">othersku</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">)</span>

    <span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-n">api_client</span><span class="tok-o">.</span><span class="tok-n">post_to_allocate</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-mi">3</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">status_code</span> <span class="tok-o">==</span> <span class="tok-mi">202</span>

    <span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-n">api_client</span><span class="tok-o">.</span><span class="tok-n">get_allocation</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">ok</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">()</span> <span class="tok-o">==</span> <span class="tok-p">[</span>
        <span class="tok-p">{</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">:</span> <span class="tok-n">earlybatch</span><span class="tok-p">},</span>
    <span class="tok-p">]</span>


<span class="tok-nd">@pytest.mark.usefixtures</span><span class="tok-p">(</span><span class="tok-s1">&#39;postgres_db&#39;</span><span class="tok-p">)</span>
<span class="tok-nd">@pytest.mark.usefixtures</span><span class="tok-p">(</span><span class="tok-s1">&#39;restart_api&#39;</span><span class="tok-p">)</span>
<span class="tok-k">def</span> <span class="tok-nf">test_unhappy_path_returns_400_and_error_message</span><span class="tok-p">():</span>
    <span class="tok-n">unknown_sku</span><span class="tok-p">,</span> <span class="tok-n">orderid</span> <span class="tok-o">=</span> <span class="tok-n">random_sku</span><span class="tok-p">(),</span> <span class="tok-n">random_orderid</span><span class="tok-p">()</span>
    <span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-n">api_client</span><span class="tok-o">.</span><span class="tok-n">post_to_allocate</span><span class="tok-p">(</span>
        <span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">unknown_sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-mi">20</span><span class="tok-p">,</span> <span class="tok-n">expect_success</span><span class="tok-o">=</span><span class="tok-bp">False</span><span class="tok-p">,</span>
    <span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">status_code</span> <span class="tok-o">==</span> <span class="tok-mi">400</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">()[</span><span class="tok-s1">&#39;message&#39;</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">f</span><span class="tok-s1">&#39;Invalid sku {unknown_sku}&#39;</span>

    <span class="tok-n">r</span> <span class="tok-o">=</span> <span class="tok-n">api_client</span><span class="tok-o">.</span><span class="tok-n">get_allocation</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">status_code</span> <span class="tok-o">==</span> <span class="tok-mi">404</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>OK, what might the Flask app look like?</p>
</div>
<div id="flask_app_calls_view" class="exampleblock">
<div class="title">Endpoint for viewing allocations (src/allocation/entrypoints/flask_app.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">allocation</span> <span class="tok-kn">import</span> <span class="tok-n">views</span>
<span class="tok-o">...</span>

<span class="tok-nd">@app.route</span><span class="tok-p">(</span><span class="tok-s2">&quot;/allocations/&lt;orderid&gt;&quot;</span><span class="tok-p">,</span> <span class="tok-n">methods</span><span class="tok-o">=</span><span class="tok-p">[</span><span class="tok-s1">&#39;GET&#39;</span><span class="tok-p">])</span>
<span class="tok-k">def</span> <span class="tok-nf">allocations_view_endpoint</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">):</span>
    <span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">()</span>
    <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">allocations</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">result</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-s1">&#39;not found&#39;</span><span class="tok-p">,</span> <span class="tok-mi">404</span>
    <span class="tok-k">return</span> <span class="tok-n">jsonify</span><span class="tok-p">(</span><span class="tok-n">result</span><span class="tok-p">),</span> <span class="tok-mi">200</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>All right, a <em>views.py</em>, fair enough; we can keep read-only stuff in there,
and it&#8217;ll be a real <em>views.py</em>, not like Django&#8217;s, something that knows how
to build read-only views of our data&#8230;&#8203;</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="hold-on-ch12">12.4. Hold On to Your Lunch, Folks</h3>
<div class="paragraph">
<p>Hmm, so we can probably just add a list method to our existing repository
object:</p>
</div>
<div id="views_dot_py" class="exampleblock">
<div class="title">Views do&#8230;&#8203;raw SQL? (src/allocation/views.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">allocation.service_layer</span> <span class="tok-kn">import</span> <span class="tok-n">unit_of_work</span>

<span class="tok-k">def</span> <span class="tok-nf">allocations</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">):</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">results</span> <span class="tok-o">=</span> <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span>
            <span class="tok-s1">&#39;SELECT ol.sku, b.reference&#39;</span>
            <span class="tok-s1">&#39; FROM allocations AS a&#39;</span>
            <span class="tok-s1">&#39; JOIN batches AS b ON a.batch_id = b.id&#39;</span>
            <span class="tok-s1">&#39; JOIN order_lines AS ol ON a.orderline_id = ol.id&#39;</span>
            <span class="tok-s1">&#39; WHERE ol.orderid = :orderid&#39;</span><span class="tok-p">,</span>
            <span class="tok-nb">dict</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-o">=</span><span class="tok-n">orderid</span><span class="tok-p">)</span>
        <span class="tok-p">))</span>
    <span class="tok-k">return</span> <span class="tok-p">[{</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">:</span> <span class="tok-n">batchref</span><span class="tok-p">}</span> <span class="tok-k">for</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">batchref</span> <span class="tok-ow">in</span> <span class="tok-n">results</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><em>Excuse me?  Raw SQL?</em></p>
</div>
<div class="paragraph">
<p>If you&#8217;re anything like Harry encountering this pattern for the first time,
you&#8217;ll be wondering what on earth Bob has been smoking. We&#8217;re hand-rolling our
own SQL now, and converting database rows directly to dicts? After all the
effort we put into building a nice domain model? And what about the Repository
pattern? Isn&#8217;t that meant to be our abstraction around the database? Why don&#8217;t
we reuse that?</p>
</div>
<div class="paragraph">
<p>Well, let&#8217;s explore that seemingly simpler alternative first, and see what it
looks like in practice.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll still keep our view in a separate <em>views.py</em> module; enforcing a clear
distinction between reads and writes in your application is still a good idea.
We apply command-query separation, and it&#8217;s easy to see which code modifies
state (the event handlers) and which code just retrieves read-only state (the views).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Splitting out your read-only views from your state-modifying
    command and event handlers is probably a good idea, even if you
    don&#8217;t want to go to full-blown CQRS.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_testing_cqrs_views">12.5. Testing CQRS Views</h3>
<div class="paragraph">
<p>Before we get into exploring various options, let&#8217;s talk about testing.
Whichever approaches you decide to go for, you&#8217;re probably going to need
at least one integration test.  Something like this:</p>
</div>
<div id="integration_testing_views" class="exampleblock">
<div class="title">An integration test for a view (tests/integration/test_views.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_allocations_view</span><span class="tok-p">(</span><span class="tok-n">sqlite_session_factory</span><span class="tok-p">):</span>
    <span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">sqlite_session_factory</span><span class="tok-p">)</span>
    <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">CreateBatch</span><span class="tok-p">(</span><span class="tok-s1">&#39;sku1batch&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku1&#39;</span><span class="tok-p">,</span> <span class="tok-mi">50</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">),</span> <span class="tok-n">uow</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">CreateBatch</span><span class="tok-p">(</span><span class="tok-s1">&#39;sku2batch&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku2&#39;</span><span class="tok-p">,</span> <span class="tok-mi">50</span><span class="tok-p">,</span> <span class="tok-n">today</span><span class="tok-p">),</span> <span class="tok-n">uow</span><span class="tok-p">)</span>
    <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Allocate</span><span class="tok-p">(</span><span class="tok-s1">&#39;order1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku1&#39;</span><span class="tok-p">,</span> <span class="tok-mi">20</span><span class="tok-p">),</span> <span class="tok-n">uow</span><span class="tok-p">)</span>
    <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Allocate</span><span class="tok-p">(</span><span class="tok-s1">&#39;order1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku2&#39;</span><span class="tok-p">,</span> <span class="tok-mi">20</span><span class="tok-p">),</span> <span class="tok-n">uow</span><span class="tok-p">)</span>
    <span class="tok-c1"># add a spurious batch and order to make sure we&#39;re getting the right ones</span>
    <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">CreateBatch</span><span class="tok-p">(</span><span class="tok-s1">&#39;sku1batch-later&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku1&#39;</span><span class="tok-p">,</span> <span class="tok-mi">50</span><span class="tok-p">,</span> <span class="tok-n">today</span><span class="tok-p">),</span> <span class="tok-n">uow</span><span class="tok-p">)</span>
    <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Allocate</span><span class="tok-p">(</span><span class="tok-s1">&#39;otherorder&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku1&#39;</span><span class="tok-p">,</span> <span class="tok-mi">30</span><span class="tok-p">),</span> <span class="tok-n">uow</span><span class="tok-p">)</span>
    <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Allocate</span><span class="tok-p">(</span><span class="tok-s1">&#39;otherorder&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku2&#39;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">),</span> <span class="tok-n">uow</span><span class="tok-p">)</span>

    <span class="tok-k">assert</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">allocations</span><span class="tok-p">(</span><span class="tok-s1">&#39;order1&#39;</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-p">[</span>
        <span class="tok-p">{</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;sku1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;sku1batch&#39;</span><span class="tok-p">},</span>
        <span class="tok-p">{</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;sku2&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;sku2batch&#39;</span><span class="tok-p">},</span>
    <span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We do the setup for the integration test by using the public entrypoint to
our application, the message bus. That keeps our tests decoupled from
any implementation/infrastructure details about how things get stored.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_obvious_alternative_1_using_the_existing_repository">12.6. "Obvious" Alternative 1: Using the Existing Repository</h3>
<div class="paragraph">
<p>How about adding a helper method to our <code>products</code> repository?</p>
</div>
<div id="view_using_repo" class="exampleblock">
<div class="title">A simple view that uses the repository (src/allocation/views.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">allocation</span> <span class="tok-kn">import</span> <span class="tok-n">unit_of_work</span>

<span class="tok-k">def</span> <span class="tok-nf">allocations</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">):</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">products</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">for_order</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-o">=</span><span class="tok-n">orderid</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-n">b</span> <span class="tok-k">for</span> <span class="tok-n">p</span> <span class="tok-ow">in</span> <span class="tok-n">products</span> <span class="tok-k">for</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-n">p</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-p">]</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-k">return</span> <span class="tok-p">[</span>
            <span class="tok-p">{</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">:</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">reference</span><span class="tok-p">}</span>
            <span class="tok-k">for</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-n">batches</span>
            <span class="tok-k">if</span> <span class="tok-n">orderid</span> <span class="tok-ow">in</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">orderids</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Our repository returns <code>Product</code> objects, and we need to find all the
products for the SKUs in a given order, so we&#8217;ll build a new helper method
called <code>.for_order()</code> on the repository.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Now we have products but we actually want batch references, so we
get all the possible batches with a list comprehension.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We filter <em>again</em> to get just the batches for our specific
order. That, in turn, relies on our <code>Batch</code> objects being able to tell us
which order IDs it has allocated.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We implement that last using a <code>.orderid</code> property:</p>
</div>
<div id="orderids_on_batch" class="exampleblock">
<div class="title">An arguably unnecessary property on our model (src/allocation/domain/model.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Batch</span><span class="tok-p">:</span>
    <span class="tok-o">...</span>

    <span class="tok-nd">@property</span>
    <span class="tok-k">def</span> <span class="tok-nf">orderids</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-p">{</span><span class="tok-n">l</span><span class="tok-o">.</span><span class="tok-n">orderid</span> <span class="tok-k">for</span> <span class="tok-n">l</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_allocations</span><span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can start to see that reusing our existing repository and domain model classes
is not as straightforward as you might have assumed.  We&#8217;ve had to add new helper
methods to both, and we&#8217;re doing a bunch of looping and filtering in Python, which
is work that would be done much more efficiently by the database.</p>
</div>
<div class="paragraph">
<p>So yes, on the plus side we&#8217;re reusing our existing abstractions, but on the
downside, it all feels quite clunky.</p>
</div>
</div>
<div class="sect2">
<h3 id="_your_domain_model_is_not_optimized_for_read_operations">12.7. Your Domain Model Is Not Optimized for Read Operations</h3>
<div class="paragraph">
<p>What we&#8217;re seeing here are the effects of having a domain model that
is designed primarily for write operations, while our requirements for
reads are often conceptually quite different.</p>
</div>
<div class="paragraph">
<p>This is the chin-stroking-architect&#8217;s justification for CQRS.  As we&#8217;ve said before,
a domain model is not a data model&#8212;&#8203;we&#8217;re trying to capture the way the
business works: workflow, rules around state changes, messages exchanged;
concerns about how the system reacts to external events and user input.
<em>Most of this stuff is totally irrelevant for read-only operations</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This justification for CQRS is related to the justification for the Domain
    Model pattern. If you&#8217;re building a simple CRUD app, reads and writes are
    going to be closely related, so you don&#8217;t need a domain model or CQRS. But
    the more complex your domain, the more likely you are to need both.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To make a facile point, your domain classes will have multiple methods for
modifying state, and you won&#8217;t need any of them for read-only operations.</p>
</div>
<div class="paragraph">
<p>As the complexity of your domain model grows, you will find yourself making
more and more choices about how to structure that model, which make it more and
more awkward to use for read operations.</p>
</div>
</div>
<div class="sect2">
<h3 id="_obvious_alternative_2_using_the_orm">12.8. "Obvious" Alternative 2: Using the ORM</h3>
<div class="paragraph">
<p>You may be thinking, OK, if our repository is clunky, and working with
<code>Products</code> is clunky, then I can at least  use my ORM and work with <code>Batches</code>.
That&#8217;s what it&#8217;s for!</p>
</div>
<div id="view_using_orm" class="exampleblock">
<div class="title">A simple view that uses the ORM (src/allocation/views.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">allocation</span> <span class="tok-kn">import</span> <span class="tok-n">unit_of_work</span><span class="tok-p">,</span> <span class="tok-n">model</span>

<span class="tok-k">def</span> <span class="tok-nf">allocations</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">):</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">query</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">(</span>
            <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">,</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-o">.</span><span class="tok-n">_allocations</span>
        <span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">filter</span><span class="tok-p">(</span>
            <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-o">.</span><span class="tok-n">orderid</span> <span class="tok-o">==</span> <span class="tok-n">orderid</span>
        <span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-p">[</span>
            <span class="tok-p">{</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">:</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">batchref</span><span class="tok-p">}</span>
            <span class="tok-k">for</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-n">batches</span>
        <span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But is that <em>actually</em> any easier to write or understand than the raw SQL
version from the code example in <a href="#hold-on-ch12">Hold On to Your Lunch, Folks</a>? It may not look too bad up there, but we
can tell you it took several attempts, and plenty of digging through the
SQLAlchemy docs. SQL is just SQL.</p>
</div>
<div class="paragraph">
<p>But the ORM can also expose us to performance problems.</p>
</div>
</div>
<div class="sect2">
<h3 id="_select_n1_and_other_performance_considerations">12.9. SELECT N+1 and Other Performance Considerations</h3>
<div class="paragraph">
<p>The so-called
<a href="https://oreil.ly/OkBOS"><code>SELECT N+1</code></a>
problem is a common performance problem with ORMs: when retrieving a list of
objects, your ORM will often perform an initial query to, say, get all the IDs
of the objects it needs, and then issue individual queries for each object to
retrieve their attributes. This is especially likely if there are any foreign-key relationships on your objects.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In all fairness, we should say that SQLAlchemy is quite good at avoiding
    the <code>SELECT N+1</code> problem. It doesn&#8217;t display it in the preceding example, and
    you can request
    <a href="https://oreil.ly/XKDDm">eager loading</a>
    explicitly to avoid it when dealing with joined objects.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Beyond <code>SELECT N+1</code>, you may have other reasons for wanting to decouple the
way you persist state changes from the way that you retrieve current state.
A set of fully normalized relational tables is a good way to make sure that
write operations never cause data corruption. But retrieving data using lots
of joins can be slow. It&#8217;s common in such cases to add some denormalized views,
build read replicas, or even add caching layers.</p>
</div>
</div>
<div class="sect2">
<h3 id="_time_to_completely_jump_the_shark">12.10. Time to Completely Jump the Shark</h3>
<div class="paragraph">
<p>On that note: have we convinced you that our raw SQL version isn&#8217;t so weird as
it first seemed? Perhaps we were exaggerating for effect? Just you wait.</p>
</div>
<div class="paragraph">
<p>So, reasonable or not, that hardcoded SQL query is pretty ugly, right? What if
we made it nicer&#8230;&#8203;</p>
</div>
<div id="much_nicer_query" class="exampleblock">
<div class="title">A much nicer query (src/allocation/views.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">allocations</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">):</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">results</span> <span class="tok-o">=</span> <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span>
            <span class="tok-s1">&#39;SELECT sku, batchref FROM allocations_view WHERE orderid = :orderid&#39;</span><span class="tok-p">,</span>
            <span class="tok-nb">dict</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-o">=</span><span class="tok-n">orderid</span><span class="tok-p">)</span>
        <span class="tok-p">))</span>
        <span class="tok-o">...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;by <em>keeping a totally separate, denormalized data store for our view model</em>?</p>
</div>
<div id="new_table" class="exampleblock">
<div class="title">Hee hee hee, no foreign keys, just strings, YOLO (src/allocation/adapters/orm.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">allocations_view</span> <span class="tok-o">=</span> <span class="tok-n">Table</span><span class="tok-p">(</span>
    <span class="tok-s1">&#39;allocations_view&#39;</span><span class="tok-p">,</span> <span class="tok-n">metadata</span><span class="tok-p">,</span>
    <span class="tok-n">Column</span><span class="tok-p">(</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">,</span> <span class="tok-n">String</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">)),</span>
    <span class="tok-n">Column</span><span class="tok-p">(</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">,</span> <span class="tok-n">String</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">)),</span>
    <span class="tok-n">Column</span><span class="tok-p">(</span><span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">,</span> <span class="tok-n">String</span><span class="tok-p">(</span><span class="tok-mi">255</span><span class="tok-p">)),</span>
<span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>OK, nicer-looking SQL queries wouldn&#8217;t be a justification for anything really,
but building a denormalized copy of your data that&#8217;s optimized for read operations
isn&#8217;t uncommon, once you&#8217;ve reached the limits of what you can do with indexes.</p>
</div>
<div class="paragraph">
<p>Even with well-tuned indexes, a relational database uses a lot of CPU to perform
joins. The fastest queries will always be <code>SELECT * from <em>mytable</em> WHERE <em>key</em> = :<em>value</em></code>.</p>
</div>
<div class="paragraph">
<p>More than raw speed, though, this approach buys us scale. When we&#8217;re writing
data to a relational database, we need to make sure that we get a lock over the
rows we&#8217;re changing so we don&#8217;t run into consistency problems.</p>
</div>
<div class="paragraph">
<p>If multiple clients are changing data at the same time, we&#8217;ll have weird race
conditions. When we&#8217;re <em>reading</em> data, though, there&#8217;s no limit to the number
of clients that can concurrently execute. For this reason, read-only stores can
be horizontally scaled out.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Because read replicas can be inconsistent, there&#8217;s no limit to how many we
    can have. If you&#8217;re struggling to scale a system with a complex data store,
    ask whether you could build a simpler read model.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Keeping the read model up to date is the challenge!  Database views
(materialized or otherwise) and triggers are a common solution, but that limits
you to your database. We&#8217;d like to show you how to reuse our event-driven
architecture instead.</p>
</div>
<div class="sect3">
<h4 id="_updating_a_read_model_table_using_an_event_handler">12.10.1. Updating a Read Model Table Using an Event Handler</h4>
<div class="paragraph">
<p>We add a second handler to the <code>Allocated</code> event:</p>
</div>
<div id="new_handler_for_allocated" class="exampleblock">
<div class="title">Allocated event gets a new handler (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">EVENT_HANDLERS</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
    <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Allocated</span><span class="tok-p">:</span> <span class="tok-p">[</span>
        <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">publish_allocated_event</span><span class="tok-p">,</span>
        <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">add_allocation_to_read_model</span>
    <span class="tok-p">],</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s what our update-view-model code looks like:</p>
</div>
<div id="update_view_model_1" class="exampleblock">
<div class="title">Update on allocation (src/allocation/service_layer/handlers.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>
<span class="tok-k">def</span> <span class="tok-nf">add_allocation_to_read_model</span><span class="tok-p">(</span>
        <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Allocated</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">,</span>
<span class="tok-p">):</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span>
            <span class="tok-s1">&#39;INSERT INTO allocations_view (orderid, sku, batchref)&#39;</span>
            <span class="tok-s1">&#39; VALUES (:orderid, :sku, :batchref)&#39;</span><span class="tok-p">,</span>
            <span class="tok-nb">dict</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-o">=</span><span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">batchref</span><span class="tok-o">=</span><span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">batchref</span><span class="tok-p">)</span>
        <span class="tok-p">)</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Believe it or not, that will pretty much work!  <em>And it will work
against the exact same integration tests as the rest of our options.</em></p>
</div>
<div class="paragraph">
<p>OK, you&#8217;ll also need to handle <code>Deallocated</code>:</p>
</div>
<div id="handle_deallocated_too" class="exampleblock">
<div class="title">A second listener for read model updates</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Deallocated</span><span class="tok-p">:</span> <span class="tok-p">[</span>
    <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">remove_allocation_from_read_model</span><span class="tok-p">,</span>
    <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">reallocate</span>
<span class="tok-p">],</span>

<span class="tok-o">...</span>

<span class="tok-k">def</span> <span class="tok-nf">remove_allocation_from_read_model</span><span class="tok-p">(</span>
        <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Deallocated</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">,</span>
<span class="tok-p">):</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span>
            <span class="tok-s1">&#39;DELETE FROM allocations_view &#39;</span>
            <span class="tok-s1">&#39; WHERE orderid = :orderid AND sku = :sku&#39;</span><span class="tok-p">,</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><a href="#read_model_sequence_diagram">Sequence diagram for read model</a> shows the flow across the two requests.</p>
</div>
<div id="read_model_sequence_diagram" class="imageblock">
<div class="content">
<img src="images/apwp_1202.png" alt="apwp 1202">
</div>
<div class="title">Figure 42. Sequence diagram for read model</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_1202, config=plantuml.cfg]
@startuml
scale 4
!pragma teoz true

actor User order 1
boundary Flask order 2
participant MessageBus order 3
participant "Domain Model" as Domain order 4
participant View order 9
database DB order 10

User -&gt; Flask: POST to allocate Endpoint
Flask -&gt; MessageBus : Allocate Command

group UoW/transaction 1
    MessageBus -&gt; Domain : allocate()
    MessageBus -&gt; DB: commit write model
end

group UoW/transaction 2
    Domain -&gt; MessageBus : raise Allocated event(s)
    MessageBus -&gt; DB : update view model
end

Flask -&gt; User: 202 OK

User -&gt; Flask: GET allocations endpoint
Flask -&gt; View: get allocations
View -&gt; DB: SELECT on view model
DB -&gt; View: some allocations
&amp; View -&gt; Flask: some allocations
&amp; Flask -&gt; User: some allocations

@enduml</pre>
</div>
</div>
<div class="paragraph">
<p>In <a href="#read_model_sequence_diagram">Sequence diagram for read model</a>, you can see two
transactions in the POST/write operation, one to update the write model and one
to update the read model, which the GET/read operation can use.</p>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Rebuilding from Scratch</div>
<div class="paragraph">
<p>"What happens when it breaks?" should be the first question we ask as engineers.</p>
</div>
<div class="paragraph">
<p>How do we deal with a view model that hasn&#8217;t been updated because of a bug or
temporary outage? Well, this is just another case where events and commands can
fail independently.</p>
</div>
<div class="paragraph">
<p>If we <em>never</em> updated the view model, and the <code>ASYMMETRICAL-DRESSER</code> was forever in
stock, that would be annoying for customers, but the <code>allocate</code> service would
still fail, and we&#8217;d take action to fix the problem.</p>
</div>
<div class="paragraph">
<p>Rebuilding a view model is easy, though. Since we&#8217;re using a service layer to
update our view model, we can write a tool that does the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Queries the current state of the write side to work out what&#8217;s currently
allocated</p>
</li>
<li>
<p>Calls the <code>add_allocate_to_read_model</code> handler for each allocated item</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We can use this technique to create entirely new read models from historical
data.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_changing_our_read_model_implementation_is_easy">12.11. Changing Our Read Model Implementation Is Easy</h3>
<div class="paragraph">
<p>Let&#8217;s see the flexibility that our event-driven model buys us in action,
by seeing what happens if we ever decide we want to implement a read model by
using a totally separate storage engine, Redis.</p>
</div>
<div class="paragraph">
<p>Just watch:</p>
</div>
<div id="redis_readmodel_handlers" class="exampleblock">
<div class="title">Handlers update a Redis read model (src/allocation/service_layer/handlers.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">add_allocation_to_read_model</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Allocated</span><span class="tok-p">,</span> <span class="tok-n">_</span><span class="tok-p">):</span>
    <span class="tok-n">redis_eventpublisher</span><span class="tok-o">.</span><span class="tok-n">update_readmodel</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">batchref</span><span class="tok-p">)</span>

<span class="tok-k">def</span> <span class="tok-nf">remove_allocation_from_read_model</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Deallocated</span><span class="tok-p">,</span> <span class="tok-n">_</span><span class="tok-p">):</span>
    <span class="tok-n">redis_eventpublisher</span><span class="tok-o">.</span><span class="tok-n">update_readmodel</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The helpers in our Redis module are one-liners:</p>
</div>
<div id="redis_readmodel_client" class="exampleblock">
<div class="title">Redis read model read and update (src/allocation/adapters/redis_eventpublisher.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">update_readmodel</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">batchref</span><span class="tok-p">):</span>
    <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">hset</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">batchref</span><span class="tok-p">)</span>


<span class="tok-k">def</span> <span class="tok-nf">get_readmodel</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">):</span>
    <span class="tok-k">return</span> <span class="tok-n">r</span><span class="tok-o">.</span><span class="tok-n">hgetall</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>(Maybe the name <em>redis_eventpublisher.py</em> is a misnomer now, but you get the idea.)</p>
</div>
<div class="paragraph">
<p>And the view itself changes very slightly to adapt to its new backend:</p>
</div>
<div id="redis_readmodel_view" class="exampleblock">
<div class="title">View adapted to Redis (src/allocation/views.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">allocations</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">):</span>
    <span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">redis_eventpublisher</span><span class="tok-o">.</span><span class="tok-n">get_readmodel</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-p">[</span>
        <span class="tok-p">{</span><span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">:</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">decode</span><span class="tok-p">(),</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-n">s</span><span class="tok-o">.</span><span class="tok-n">decode</span><span class="tok-p">()}</span>
        <span class="tok-k">for</span> <span class="tok-n">s</span><span class="tok-p">,</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">items</span><span class="tok-p">()</span>
    <span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And the <em>exact same</em> integration tests that we had before still pass,
because they are written at a level of abstraction that&#8217;s decoupled from the
implementation: setup puts messages on the message bus, and the assertions
are against our view.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Event handlers are a great way to manage updates to a read model,
    if you decide you need one.  They also make it easy to change the
    implementation of that read model at a later date.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Exercise for the Reader</div>
<div class="paragraph">
<p>Implement another view, this time to show the allocation for a single
order line.</p>
</div>
<div class="paragraph">
<p>Here the trade-offs between using hardcoded SQL versus going via a repository
should be much more blurry.  Try a few versions (maybe including going
to Redis), and see which you prefer.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up_11">12.12. Wrap-Up</h3>
<div class="paragraph">
<p><a href="#view_model_tradeoffs">Trade-offs of various view model options</a> proposes some pros and cons for each of our options.</p>
</div>
<div class="paragraph">
<p>As it happens, the allocation service at MADE.com does use "full-blown" CQRS,
with a read model stored in Redis, and even a second layer of cache provided
by Varnish. But its use cases are quite a bit different from what
we&#8217;ve shown here. For the kind of allocation service we&#8217;re building, it seems
unlikely that you&#8217;d need to use a separate read model and event handlers for
updating it.</p>
</div>
<div class="paragraph">
<p>But as your domain model becomes richer and more complex, a simplified read
model become ever more compelling.</p>
</div>
<table id="view_model_tradeoffs" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 11. Trade-offs of various view model options</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Pros</th>
<th class="tableblock halign-left valign-top">Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Just use repositories</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Simple, consistent approach.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expect performance issues with complex query patterns.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use custom queries with your ORM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows reuse of DB configuration and model definitions.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adds another query language with its own quirks and syntax.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use hand-rolled SQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offers fine control over performance with a standard query syntax.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Changes to DB schema have to be made to your hand-rolled queries <em>and</em> your
  ORM definitions. Highly normalized schemas may still have performance
  limitations.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create separate read stores with events</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-only copies are easy to scale out. Views can be constructed when data
  changes so that queries are as simple as possible.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complex technique. Harry will be forever suspicious of your tastes and
  motives.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Often, your read operations will be acting on the same conceptual objects as your
write model, so using the ORM, adding some read methods to your repositories,
and using domain model classes for your read operations is <em>just fine</em>.</p>
</div>
<div class="paragraph">
<p>In our book example, the read operations act on quite different conceptual
entities to our domain model. The allocation service thinks in terms of
<code>Batches</code> for a single SKU, but users care about allocations for a whole order,
with multiple SKUs, so using the ORM ends up being a little awkward. We&#8217;d be
quite tempted to go with the raw-SQL view we showed right at the beginning of
the chapter.</p>
</div>
<div class="paragraph">
<p>On that note, let&#8217;s sally forth into our final chapter.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="chapter_13_dependency_injection">13. Dependency Injection (and Bootstrapping)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Dependency injection (DI) is regarded with suspicion in the Python world.  And
we&#8217;ve managed <em>just fine</em> without it so far in the example code for this
book!</p>
</div>
<div class="paragraph">
<p>In this chapter, we&#8217;ll explore some of the pain points in our code
that lead us to consider using DI, and we&#8217;ll present some options
for how to do it, leaving it to you to pick which you think is most Pythonic.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll also add a new component to our architecture called <em>bootstrap.py</em>;
it will be in charge of dependency injection, as well as some other initialization
stuff that we often need.  We&#8217;ll explain why this sort of thing is called
a <em>composition root</em> in OO languages, and why <em>bootstrap script</em> is just fine
for our purposes.</p>
</div>
<div class="paragraph">
<p><a href="#bootstrap_chapter_before_diagram">Without bootstrap: entrypoints do a lot</a> shows what our app looks like without
a bootstrapper: the entrypoints do a lot of initialization and passing around
of our main dependency, the UoW.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you haven&#8217;t already, it&#8217;s worth reading <a href="#chapter_03_abstractions">A Brief Interlude: On Coupling <span class="keep-together">and Abstractions</span></a>
    before continuing with this chapter, particularly the discussion of
    functional versus object-oriented dependency management.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="bootstrap_chapter_before_diagram" class="imageblock">
<div class="content">
<img src="images/apwp_1301.png" alt="apwp 1301">
</div>
<div class="title">Figure 43. Without bootstrap: entrypoints do a lot</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The code for this chapter is in the
chapter_13_dependency_injection branch <a href="https://oreil.ly/-B7e6">on GitHub</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/cosmicpython/code.git
cd code
git checkout chapter_13_dependency_injection
# or to code along, checkout the previous chapter:
git checkout chapter_12_cqrs</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="#bootstrap_chapter_after_diagram">Bootstrap takes care of all that in one place</a> shows our bootstrapper taking over those
responsibilities.</p>
</div>
<div id="bootstrap_chapter_after_diagram" class="imageblock">
<div class="content">
<img src="images/apwp_1302.png" alt="apwp 1302">
</div>
<div class="title">Figure 44. Bootstrap takes care of all that in one place</div>
</div>
<div class="sect2">
<h3 id="_implicit_versus_explicit_dependencies">13.1. Implicit Versus Explicit Dependencies</h3>
<div class="paragraph">
<p>Depending on your particular brain type, you may have a slight
feeling of unease at the back of your mind at this point.  Let&#8217;s bring it out
into the open. We&#8217;ve shown you two ways of managing
dependencies and testing them.</p>
</div>
<div class="paragraph">
<p>For our database dependency, we&#8217;ve built a careful framework of explicit
dependencies and easy options for overriding them in tests. Our main handler
functions declare an explicit dependency on the UoW:</p>
</div>
<div id="existing_handler" class="exampleblock">
<div class="title">Our handlers have an explicit dependency on the UoW (src/allocation/service_layer/handlers.py)</div>
<div class="content">
<div class="listingblock existing">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span>
        <span class="tok-n">cmd</span><span class="tok-p">:</span> <span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Allocate</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>
<span class="tok-p">):</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And that makes it easy to swap in a fake UoW in our
service-layer tests:</p>
</div>
<div id="existing_services_test" class="exampleblock">
<div class="title">Service-layer tests against a fake UoW: (tests/unit/test_services.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">FakeUnitOfWork</span><span class="tok-p">()</span>
    <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">([</span><span class="tok-o">...</span><span class="tok-p">],</span> <span class="tok-n">uow</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The UoW itself declares an explicit dependency on the session factory:</p>
</div>
<div id="existing_uow" class="exampleblock">
<div class="title">The UoW depends on a session factory (src/allocation/service_layer/unit_of_work.py)</div>
<div class="content">
<div class="listingblock existing">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">SqlAlchemyUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">session_factory</span><span class="tok-o">=</span><span class="tok-n">DEFAULT_SESSION_FACTORY</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session_factory</span> <span class="tok-o">=</span> <span class="tok-n">session_factory</span>
        <span class="tok-o">...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We take advantage of it in our integration tests to be able to sometimes use SQLite
instead of Postgres:</p>
</div>
<div id="existing_integration_test" class="exampleblock">
<div class="title">Integration tests against a different DB (tests/integration/test_uow.py)</div>
<div class="content">
<div class="listingblock existing">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_rolls_back_uncommitted_work_by_default</span><span class="tok-p">(</span><span class="tok-n">sqlite_session_factory</span><span class="tok-p">):</span>
    <span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">sqlite_session_factory</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Integration tests swap out the default Postgres <code>session_factory</code> for a
SQLite one.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_arent_explicit_dependencies_totally_weird_and_java_y">13.2. Aren&#8217;t Explicit Dependencies Totally Weird and Java-y?</h3>
<div class="paragraph">
<p>If you&#8217;re used to the way things normally happen in Python, you&#8217;ll be thinking
all this is a bit weird.  The standard way to do things is to declare our
dependency implicitly by simply importing it, and then if we ever need to
change it for tests, we can monkeypatch, as is Right and True in dynamic
languages:</p>
</div>
<div id="normal_implicit_dependency" class="exampleblock">
<div class="title">Email sending as a normal import-based dependency (src/allocation/service_layer/handlers.py)</div>
<div class="content">
<div class="listingblock existing">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">allocation.adapters</span> <span class="tok-kn">import</span> <span class="tok-n">email</span><span class="tok-p">,</span> <span class="tok-n">redis_eventpublisher</span>  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-o">...</span>

<span class="tok-k">def</span> <span class="tok-nf">send_out_of_stock_notification</span><span class="tok-p">(</span>
        <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">,</span>
<span class="tok-p">):</span>
    <span class="tok-n">email</span><span class="tok-o">.</span><span class="tok-n">send</span><span class="tok-p">(</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-s1">&#39;stock@made.com&#39;</span><span class="tok-p">,</span>
        <span class="tok-n">f</span><span class="tok-s1">&#39;Out of stock for {event.sku}&#39;</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hardcoded import</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Calls specific email sender directly</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Why pollute our application code with unnecessary arguments just for the
sake of our tests? <code>mock.patch</code> makes monkeypatching nice and easy:</p>
</div>
<div id="mocking_is_easy" class="exampleblock">
<div class="title">mock dot patch, thank you Michael Foord (tests/unit/test_handlers.py)</div>
<div class="content">
<div class="listingblock existing">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">with</span> <span class="tok-n">mock</span><span class="tok-o">.</span><span class="tok-n">patch</span><span class="tok-p">(</span><span class="tok-s2">&quot;allocation.adapters.email.send&quot;</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-n">mock_send_mail</span><span class="tok-p">:</span>
        <span class="tok-o">...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The trouble is that we&#8217;ve made it look easy because our toy example doesn&#8217;t
send real email (<code>email.send_mail</code> just does a <code>print</code>), but in real life,
you&#8217;d end up having to call <code>mock.patch</code> for <em>every single test</em> that might
cause an out-of-stock notification. If you&#8217;ve worked on codebases with lots of
mocks used to prevent unwanted side effects, you&#8217;ll know how annoying that
mocky boilerplate gets.</p>
</div>
<div class="paragraph">
<p>And you&#8217;ll know that mocks tightly couple us to the implementation. By
choosing to monkeypatch <code>email.send_mail</code>, we are tied to doing <code>import email</code>,
and if we ever want to do <code>from email import send_mail</code>, a trivial refactor,
we&#8217;d have to change all our mocks.</p>
</div>
<div class="paragraph">
<p>So it&#8217;s a trade-off. Yes, declaring explicit dependencies is unnecessary,
strictly speaking, and using them would make our application code marginally
more complex. But in return, we&#8217;d get tests that are easier to write and
manage.</p>
</div>
<div class="paragraph">
<p>On top of that, declaring an explicit dependency is an example of the
dependency inversion principle—rather than having an (implicit) dependency on
a <em>specific</em> detail, we have an (explicit) dependency on an <em>abstraction</em>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Explicit is better than implicit.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; The Zen of Python
</div>
</div>
<div id="handler_with_explicit_dependency" class="exampleblock">
<div class="title">The explicit dependency is more abstract (src/allocation/service_layer/handlers.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">send_out_of_stock_notification</span><span class="tok-p">(</span>
        <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">,</span> <span class="tok-n">send_mail</span><span class="tok-p">:</span> <span class="tok-n">Callable</span><span class="tok-p">,</span>
<span class="tok-p">):</span>
    <span class="tok-n">send_mail</span><span class="tok-p">(</span>
        <span class="tok-s1">&#39;stock@made.com&#39;</span><span class="tok-p">,</span>
        <span class="tok-n">f</span><span class="tok-s1">&#39;Out of stock for {event.sku}&#39;</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>But if we do change to declaring all these dependencies explicitly, who will
inject them, and how? So far, we&#8217;ve really been dealing with only passing the
UoW around: our tests use <code>FakeUnitOfWork</code>, while Flask and Redis eventconsumer
entrypoints use the real UoW, and the message bus passes them onto our command
handlers. If we add real and fake email classes, who will create them and
pass them on?</p>
</div>
<div class="paragraph">
<p>That&#8217;s extra (duplicated) cruft for Flask, Redis, and our tests. Moreover,
putting all the responsibility for passing dependencies to the right handler
onto the message bus feels like a violation of the SRP.</p>
</div>
<div class="paragraph">
<p>Instead, we&#8217;ll reach for a pattern called <em>Composition Root</em> (a bootstrap
script to you and me),<sup class="footnote">[<a id="_footnoteref_32" class="footnote" href="#_footnotedef_32" title="View footnote.">32</a>]</sup>
 and we&#8217;ll do a bit of "manual DI" (dependency injection without a
framework). See <a href="#bootstrap_new_image">Bootstrapper between entrypoints and message bus</a>.<sup class="footnote">[<a id="_footnoteref_33" class="footnote" href="#_footnotedef_33" title="View footnote.">33</a>]</sup></p>
</div>
<div id="bootstrap_new_image" class="imageblock">
<div class="content">
<img src="images/apwp_1303.png" alt="apwp 1303">
</div>
<div class="title">Figure 45. Bootstrapper between entrypoints and message bus</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[ditaa, apwp_1303]

+---------------+
|  Entrypoints  |
| (Flask/Redis) |
+---------------+
        |
        | call
        V
 /--------------\
 |              |  prepares handlers with correct dependencies injected in
 | Bootstrapper |  (test bootstrapper will use fakes, prod one will use real)
 |              |
 \--------------/
        |
        | pass injected handlers to
        V
/---------------\
|  Message Bus  |
+---------------+
        |
        | dispatches events and commands to injected handlers
        |
        V</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_preparing_handlers_manual_di_with_closures_and_partials">13.3. Preparing Handlers: Manual DI with Closures and Partials</h3>
<div class="paragraph">
<p>One way to turn a function with dependencies into one that&#8217;s ready to be
called later with those dependencies <em>already injected</em> is to use closures or
partial functions to compose the function with its dependencies:</p>
</div>
<div id="di_with_partial_functions_examples" class="exampleblock">
<div class="title">Examples of DI using closures or partial functions</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-c1"># existing allocate function, with abstract uow dependency</span>
<span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span>
        <span class="tok-n">cmd</span><span class="tok-p">:</span> <span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Allocate</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span>
<span class="tok-p">):</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">cmd</span><span class="tok-o">.</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">cmd</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">cmd</span><span class="tok-o">.</span><span class="tok-n">qty</span><span class="tok-p">)</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-o">...</span>

<span class="tok-c1"># bootstrap script prepares actual UoW</span>

<span class="tok-k">def</span> <span class="tok-nf">bootstrap</span><span class="tok-p">(</span><span class="tok-o">..</span><span class="tok-p">):</span>
    <span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">()</span>

    <span class="tok-c1"># prepare a version of the allocate fn with UoW dependency captured in a closure</span>
    <span class="tok-n">allocate_composed</span> <span class="tok-o">=</span> <span class="tok-k">lambda</span> <span class="tok-n">cmd</span><span class="tok-p">:</span> <span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">cmd</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">)</span>

    <span class="tok-c1"># or, equivalently (this gets you a nicer stack trace)</span>
    <span class="tok-k">def</span> <span class="tok-nf">allocate_composed</span><span class="tok-p">(</span><span class="tok-n">cmd</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">cmd</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">)</span>

    <span class="tok-c1"># alternatively with a partial</span>
    <span class="tok-kn">import</span> <span class="tok-nn">functools</span>
    <span class="tok-n">allocate_composed</span> <span class="tok-o">=</span> <span class="tok-n">functools</span><span class="tok-o">.</span><span class="tok-n">partial</span><span class="tok-p">(</span><span class="tok-n">allocate</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-o">=</span><span class="tok-n">uow</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-c1"># later at runtime, we can call the partial function, and it will have</span>
<span class="tok-c1"># the UoW already bound</span>
<span class="tok-n">allocate_composed</span><span class="tok-p">(</span><span class="tok-n">cmd</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The difference between closures (lambdas or named functions) and
<code>functools.partial</code> is that the former use
<a href="https://docs.python-guide.org/writing/gotchas/#late-binding-closures">late
binding of variables</a>, which can be a source of confusion if
any of the dependencies are mutable.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here&#8217;s the same pattern again for the <code>send_out_of_stock_notification()</code> handler,
which has different dependencies:</p>
</div>
<div id="partial_functions_2" class="exampleblock">
<div class="title">Another closure and partial functions example</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">send_out_of_stock_notification</span><span class="tok-p">(</span>
        <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">,</span> <span class="tok-n">send_mail</span><span class="tok-p">:</span> <span class="tok-n">Callable</span><span class="tok-p">,</span>
<span class="tok-p">):</span>
    <span class="tok-n">send_mail</span><span class="tok-p">(</span>
        <span class="tok-s1">&#39;stock@made.com&#39;</span><span class="tok-p">,</span>
        <span class="tok-o">...</span>


<span class="tok-c1"># prepare a version of the send_out_of_stock_notification with dependencies</span>
<span class="tok-n">sosn_composed</span>  <span class="tok-o">=</span> <span class="tok-k">lambda</span> <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">send_out_of_stock_notification</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">,</span> <span class="tok-n">email</span><span class="tok-o">.</span><span class="tok-n">send_mail</span><span class="tok-p">)</span>

<span class="tok-o">...</span>
<span class="tok-c1"># later, at runtime:</span>
<span class="tok-n">sosn_composed</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)</span>  <span class="tok-c1"># will have email.send_mail already injected in</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_an_alternative_using_classes">13.4. An Alternative Using Classes</h3>
<div class="paragraph">
<p>Closures and partial functions will feel familiar to people who&#8217;ve done a bit
of functional programming. Here&#8217;s an alternative using classes, which may
appeal to others. It requires rewriting all our handler functions as
classes, though:</p>
</div>
<div id="di_with_classes" class="exampleblock">
<div class="title">DI using classes</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-c1"># we replace the old `def allocate(cmd, uow)` with:</span>

<span class="tok-k">class</span> <span class="tok-nc">AllocateHandler</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">uow</span>

    <span class="tok-k">def</span> <span class="tok-fm">__call__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">cmd</span><span class="tok-p">:</span> <span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Allocate</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">cmd</span><span class="tok-o">.</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">cmd</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">cmd</span><span class="tok-o">.</span><span class="tok-n">qty</span><span class="tok-p">)</span>
        <span class="tok-k">with</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">uow</span><span class="tok-p">:</span>
            <span class="tok-c1"># rest of handler method as before</span>
            <span class="tok-o">...</span>

<span class="tok-c1"># bootstrap script prepares actual UoW</span>
<span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">()</span>

<span class="tok-c1"># then prepares a version of the allocate fn with dependencies already injected</span>
<span class="tok-n">allocate</span> <span class="tok-o">=</span> <span class="tok-n">AllocateHandler</span><span class="tok-p">(</span><span class="tok-n">uow</span><span class="tok-p">)</span>

<span class="tok-o">...</span>
<span class="tok-c1"># later at runtime, we can call the handler instance, and it will have</span>
<span class="tok-c1"># the UoW already injected</span>
<span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">cmd</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is designed to produce a callable function, so it has a
__call__ method.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>But we use the <code>init</code> to declare the dependencies it
requires. This sort of thing will feel familiar if you&#8217;ve ever made
class-based descriptors, or a class-based context manager that takes
arguments.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Use whichever you and your team feel more comfortable with.</p>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_a_bootstrap_script">13.5. A Bootstrap Script</h3>
<div class="paragraph">
<p>We want our bootstrap script to do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Declare default dependencies but allow us to override them</p>
</li>
<li>
<p>Do the "init" stuff that we need to get our app started</p>
</li>
<li>
<p>Inject all the dependencies into our handlers</p>
</li>
<li>
<p>Give us back the core object for our app, the message bus</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here&#8217;s a first cut:</p>
</div>
<div id="bootstrap_script" class="exampleblock">
<div class="title">A bootstrap function (src/allocation/bootstrap.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">bootstrap</span><span class="tok-p">(</span>
    <span class="tok-n">start_orm</span><span class="tok-p">:</span> <span class="tok-nb">bool</span> <span class="tok-o">=</span> <span class="tok-bp">True</span><span class="tok-p">,</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span> <span class="tok-o">=</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">(),</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">send_mail</span><span class="tok-p">:</span> <span class="tok-n">Callable</span> <span class="tok-o">=</span> <span class="tok-n">email</span><span class="tok-o">.</span><span class="tok-n">send</span><span class="tok-p">,</span>
    <span class="tok-n">publish</span><span class="tok-p">:</span> <span class="tok-n">Callable</span> <span class="tok-o">=</span> <span class="tok-n">redis_eventpublisher</span><span class="tok-o">.</span><span class="tok-n">publish</span><span class="tok-p">,</span>
<span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">MessageBus</span><span class="tok-p">:</span>

    <span class="tok-k">if</span> <span class="tok-n">start_orm</span><span class="tok-p">:</span>
        <span class="tok-n">orm</span><span class="tok-o">.</span><span class="tok-n">start_mappers</span><span class="tok-p">()</span>  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-n">dependencies</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-s1">&#39;uow&#39;</span><span class="tok-p">:</span> <span class="tok-n">uow</span><span class="tok-p">,</span> <span class="tok-s1">&#39;send_mail&#39;</span><span class="tok-p">:</span> <span class="tok-n">send_mail</span><span class="tok-p">,</span> <span class="tok-s1">&#39;publish&#39;</span><span class="tok-p">:</span> <span class="tok-n">publish</span><span class="tok-p">}</span>
    <span class="tok-n">injected_event_handlers</span> <span class="tok-o">=</span> <span class="tok-p">{</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">event_type</span><span class="tok-p">:</span> <span class="tok-p">[</span>
            <span class="tok-n">inject_dependencies</span><span class="tok-p">(</span><span class="tok-n">handler</span><span class="tok-p">,</span> <span class="tok-n">dependencies</span><span class="tok-p">)</span>
            <span class="tok-k">for</span> <span class="tok-n">handler</span> <span class="tok-ow">in</span> <span class="tok-n">event_handlers</span>
        <span class="tok-p">]</span>
        <span class="tok-k">for</span> <span class="tok-n">event_type</span><span class="tok-p">,</span> <span class="tok-n">event_handlers</span> <span class="tok-ow">in</span> <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">EVENT_HANDLERS</span><span class="tok-o">.</span><span class="tok-n">items</span><span class="tok-p">()</span>
    <span class="tok-p">}</span>
    <span class="tok-n">injected_command_handlers</span> <span class="tok-o">=</span> <span class="tok-p">{</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">command_type</span><span class="tok-p">:</span> <span class="tok-n">inject_dependencies</span><span class="tok-p">(</span><span class="tok-n">handler</span><span class="tok-p">,</span> <span class="tok-n">dependencies</span><span class="tok-p">)</span>
        <span class="tok-k">for</span> <span class="tok-n">command_type</span><span class="tok-p">,</span> <span class="tok-n">handler</span> <span class="tok-ow">in</span> <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">COMMAND_HANDLERS</span><span class="tok-o">.</span><span class="tok-n">items</span><span class="tok-p">()</span>
    <span class="tok-p">}</span>

    <span class="tok-k">return</span> <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">MessageBus</span><span class="tok-p">(</span>  <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-n">uow</span><span class="tok-o">=</span><span class="tok-n">uow</span><span class="tok-p">,</span>
        <span class="tok-n">event_handlers</span><span class="tok-o">=</span><span class="tok-n">injected_event_handlers</span><span class="tok-p">,</span>
        <span class="tok-n">command_handlers</span><span class="tok-o">=</span><span class="tok-n">injected_command_handlers</span><span class="tok-p">,</span>
    <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>orm.start_mappers()</code> is our example of initialization work that needs
to be done once at the beginning of an app. We also see things like
setting up the <code>logging</code> module.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We can use the argument defaults to define what the normal/production
defaults are. It&#8217;s nice to have them in a single place, but
sometimes dependencies have some side effects at construction time,
in which case you might prefer to default them to <code>None</code> instead.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We build up our injected versions of the handler mappings by using
a function called <code>inject_dependencies()</code>, which we&#8217;ll show next.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We return a configured message bus ready for use.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here&#8217;s how we inject dependencies into a handler function by inspecting
it:</p>
</div>
<div id="di_by_inspection" class="exampleblock">
<div class="title">DI by inspecting function signatures (src/allocation/bootstrap.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">inject_dependencies</span><span class="tok-p">(</span><span class="tok-n">handler</span><span class="tok-p">,</span> <span class="tok-n">dependencies</span><span class="tok-p">):</span>
    <span class="tok-n">params</span> <span class="tok-o">=</span> <span class="tok-n">inspect</span><span class="tok-o">.</span><span class="tok-n">signature</span><span class="tok-p">(</span><span class="tok-n">handler</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">parameters</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">deps</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
        <span class="tok-n">name</span><span class="tok-p">:</span> <span class="tok-n">dependency</span>
        <span class="tok-k">for</span> <span class="tok-n">name</span><span class="tok-p">,</span> <span class="tok-n">dependency</span> <span class="tok-ow">in</span> <span class="tok-n">dependencies</span><span class="tok-o">.</span><span class="tok-n">items</span><span class="tok-p">()</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-k">if</span> <span class="tok-n">name</span> <span class="tok-ow">in</span> <span class="tok-n">params</span>
    <span class="tok-p">}</span>
    <span class="tok-k">return</span> <span class="tok-k">lambda</span> <span class="tok-n">message</span><span class="tok-p">:</span> <span class="tok-n">handler</span><span class="tok-p">(</span><span class="tok-n">message</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">deps</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We inspect our command/event handler&#8217;s arguments.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We match them by name to our dependencies.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We inject them as kwargs to produce a partial.</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Even-More-Manual DI with Less Magic</div>
<div class="paragraph">
<p>If you&#8217;re finding the preceding <code>inspect</code> code a little harder to grok, this
even simpler version may appeal to you.</p>
</div>
<div class="paragraph">
<p>Harry wrote the code for <code>inject_dependencies()</code> as a first cut of how to do
"manual" dependency injection, and when he saw it, Bob accused him of
overengineering and writing his own DI framework.</p>
</div>
<div class="paragraph">
<p>It honestly didn&#8217;t even occur to Harry that you could do it any more plainly,
but you can, like this:</p>
</div>
<div id="nomagic_di" class="exampleblock">
<div class="title">Manually creating partial functions inline (src/allocation/bootstrap.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">injected_event_handlers</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
        <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Allocated</span><span class="tok-p">:</span> <span class="tok-p">[</span>
            <span class="tok-k">lambda</span> <span class="tok-n">e</span><span class="tok-p">:</span> <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">publish_allocated_event</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">,</span> <span class="tok-n">publish</span><span class="tok-p">),</span>
            <span class="tok-k">lambda</span> <span class="tok-n">e</span><span class="tok-p">:</span> <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">add_allocation_to_read_model</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">),</span>
        <span class="tok-p">],</span>
        <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Deallocated</span><span class="tok-p">:</span> <span class="tok-p">[</span>
            <span class="tok-k">lambda</span> <span class="tok-n">e</span><span class="tok-p">:</span> <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">remove_allocation_from_read_model</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">),</span>
            <span class="tok-k">lambda</span> <span class="tok-n">e</span><span class="tok-p">:</span> <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">reallocate</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">),</span>
        <span class="tok-p">],</span>
        <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">:</span> <span class="tok-p">[</span>
            <span class="tok-k">lambda</span> <span class="tok-n">e</span><span class="tok-p">:</span> <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">send_out_of_stock_notification</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">,</span> <span class="tok-n">send_mail</span><span class="tok-p">)</span>
        <span class="tok-p">]</span>
    <span class="tok-p">}</span>
    <span class="tok-n">injected_command_handlers</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
        <span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Allocate</span><span class="tok-p">:</span> <span class="tok-k">lambda</span> <span class="tok-n">c</span><span class="tok-p">:</span> <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">),</span>
        <span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">CreateBatch</span><span class="tok-p">:</span> \
            <span class="tok-k">lambda</span> <span class="tok-n">c</span><span class="tok-p">:</span> <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">add_batch</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">),</span>
        <span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">ChangeBatchQuantity</span><span class="tok-p">:</span> \
            <span class="tok-k">lambda</span> <span class="tok-n">c</span><span class="tok-p">:</span> <span class="tok-n">handlers</span><span class="tok-o">.</span><span class="tok-n">change_batch_quantity</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">),</span>
    <span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Harry says he couldn&#8217;t even imagine writing out that many lines of code
and having to look up that many function arguments manually.
This is a perfectly viable solution, though, since it&#8217;s only one
line of code or so per handler you add, and thus not a massive maintenance burden
even if you have dozens of handlers.</p>
</div>
<div class="paragraph">
<p>Our app is structured in such a way that we always want to do dependency
injection in only one place, the handler functions, so this super-manual solution
and Harry&#8217;s <code>inspect()</code>-based one will both work fine.</p>
</div>
<div class="paragraph">
<p>If you find yourself wanting to do DI in more things and at different times,
or if you ever get into <em>dependency chains</em> (in which your dependencies have their
own dependencies, and so on), you may get some mileage out of a "real" DI
framework.</p>
</div>
<div class="paragraph">
<p>At MADE, we&#8217;ve used <a href="https://pypi.org/project/Inject">Inject</a> in a few places,
and it&#8217;s fine, although it makes Pylint unhappy.  You might also check out
<a href="https://pypi.org/project/punq">Punq</a>, as written by Bob himself, or the
DRY-Python crew&#8217;s <a href="https://github.com/dry-python/dependencies">dependencies</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_message_bus_is_given_handlers_at_runtime">13.6. Message Bus Is Given Handlers at Runtime</h3>
<div class="paragraph">
<p>Our message bus will no longer be static; it needs to have the already-injected
handlers given to it. So we turn it from being a module into a configurable
class:</p>
</div>
<div id="messagebus_as_class" class="exampleblock">
<div class="title">MessageBus as a class (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">MessageBus</span><span class="tok-p">:</span>  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span>
        <span class="tok-bp">self</span><span class="tok-p">,</span>
        <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">,</span>
        <span class="tok-n">event_handlers</span><span class="tok-p">:</span> <span class="tok-n">Dict</span><span class="tok-p">[</span><span class="tok-n">Type</span><span class="tok-p">[</span><span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Event</span><span class="tok-p">],</span> <span class="tok-n">List</span><span class="tok-p">[</span><span class="tok-n">Callable</span><span class="tok-p">]],</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">command_handlers</span><span class="tok-p">:</span> <span class="tok-n">Dict</span><span class="tok-p">[</span><span class="tok-n">Type</span><span class="tok-p">[</span><span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Command</span><span class="tok-p">],</span> <span class="tok-n">Callable</span><span class="tok-p">],</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">uow</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">event_handlers</span> <span class="tok-o">=</span> <span class="tok-n">event_handlers</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">command_handlers</span> <span class="tok-o">=</span> <span class="tok-n">command_handlers</span>

    <span class="tok-k">def</span> <span class="tok-nf">handle</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">message</span><span class="tok-p">:</span> <span class="tok-n">Message</span><span class="tok-p">):</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">queue</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-n">message</span><span class="tok-p">]</span>  <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-k">while</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">queue</span><span class="tok-p">:</span>
            <span class="tok-n">message</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">queue</span><span class="tok-o">.</span><span class="tok-n">pop</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">)</span>
            <span class="tok-k">if</span> <span class="tok-nb">isinstance</span><span class="tok-p">(</span><span class="tok-n">message</span><span class="tok-p">,</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Event</span><span class="tok-p">):</span>
                <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">handle_event</span><span class="tok-p">(</span><span class="tok-n">message</span><span class="tok-p">)</span>
            <span class="tok-k">elif</span> <span class="tok-nb">isinstance</span><span class="tok-p">(</span><span class="tok-n">message</span><span class="tok-p">,</span> <span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Command</span><span class="tok-p">):</span>
                <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">handle_command</span><span class="tok-p">(</span><span class="tok-n">message</span><span class="tok-p">)</span>
            <span class="tok-k">else</span><span class="tok-p">:</span>
                <span class="tok-k">raise</span> <span class="tok-ne">Exception</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;{message} was not an Event or Command&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The message bus becomes a class&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>&#8230;&#8203;which is given its already-dependency-injected handlers.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The main <code>handle()</code> function is substantially the same, with just a few attributes and methods moved onto <code>self</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Using <code>self.queue</code> like this is not thread-safe, which might
be a problem if you&#8217;re using threads, because the bus instance is global
in the Flask app context as we&#8217;ve written it. Just something to watch out for.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>What else changes in the bus?</p>
</div>
<div id="messagebus_handlers_change" class="exampleblock">
<div class="title">Event and command handler logic stays the same (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">handle_event</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">:</span> <span class="tok-n">events</span><span class="tok-o">.</span><span class="tok-n">Event</span><span class="tok-p">):</span>
        <span class="tok-k">for</span> <span class="tok-n">handler</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">event_handlers</span><span class="tok-p">[</span><span class="tok-nb">type</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)]:</span>  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-k">try</span><span class="tok-p">:</span>
                <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-n">debug</span><span class="tok-p">(</span><span class="tok-s1">&#39;handling event </span><span class="tok-si">%s</span><span class="tok-s1"> with handler </span><span class="tok-si">%s</span><span class="tok-s1">&#39;</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">,</span> <span class="tok-n">handler</span><span class="tok-p">)</span>
                <span class="tok-n">handler</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">queue</span><span class="tok-o">.</span><span class="tok-n">extend</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">collect_new_events</span><span class="tok-p">())</span>
            <span class="tok-k">except</span> <span class="tok-ne">Exception</span><span class="tok-p">:</span>
                <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-n">exception</span><span class="tok-p">(</span><span class="tok-s1">&#39;Exception handling event </span><span class="tok-si">%s</span><span class="tok-s1">&#39;</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">)</span>
                <span class="tok-k">continue</span>


    <span class="tok-k">def</span> <span class="tok-nf">handle_command</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">command</span><span class="tok-p">:</span> <span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Command</span><span class="tok-p">):</span>
        <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-n">debug</span><span class="tok-p">(</span><span class="tok-s1">&#39;handling command </span><span class="tok-si">%s</span><span class="tok-s1">&#39;</span><span class="tok-p">,</span> <span class="tok-n">command</span><span class="tok-p">)</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">handler</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">command_handlers</span><span class="tok-p">[</span><span class="tok-nb">type</span><span class="tok-p">(</span><span class="tok-n">command</span><span class="tok-p">)]</span>  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="tok-n">handler</span><span class="tok-p">(</span><span class="tok-n">command</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">queue</span><span class="tok-o">.</span><span class="tok-n">extend</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">collect_new_events</span><span class="tok-p">())</span>
        <span class="tok-k">except</span> <span class="tok-ne">Exception</span><span class="tok-p">:</span>
            <span class="tok-n">logger</span><span class="tok-o">.</span><span class="tok-n">exception</span><span class="tok-p">(</span><span class="tok-s1">&#39;Exception handling command </span><span class="tok-si">%s</span><span class="tok-s1">&#39;</span><span class="tok-p">,</span> <span class="tok-n">command</span><span class="tok-p">)</span>
            <span class="tok-k">raise</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>handle_event</code> and <code>handle_command</code> are substantially the same, but instead
of indexing into a static <code>EVENT_HANDLERS</code> or <code>COMMAND_HANDLERS</code> dict, they
use the versions on <code>self</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instead of passing a UoW into the handler, we expect the handlers
to already have all their dependencies, so all they need is a single argument,
the specific event or command.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_using_bootstrap_in_our_entrypoints">13.7. Using Bootstrap in Our Entrypoints</h3>
<div class="paragraph">
<p>In our application&#8217;s entrypoints, we now just call <code>bootstrap.bootstrap()</code>
and get a message bus that&#8217;s ready to go, rather than configuring a UoW and the
rest of it:</p>
</div>
<div id="flask_calls_bootstrap" class="exampleblock">
<div class="title">Flask calls bootstrap (src/allocation/entrypoints/flask_app.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span><span class="tok-gd">-from allocation import views</span>
<span class="tok-gi">+from allocation import bootstrap, views</span>

 app = Flask(__name__)
<span class="tok-gd">-orm.start_mappers()  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-gi">+bus = bootstrap.bootstrap()</span>


 @app.route(&quot;/add_batch&quot;, methods=[&#39;POST&#39;])
<span class="tok-gu">@@ -19,8 +16,7 @@ def add_batch():</span>
     cmd = commands.CreateBatch(
         request.json[&#39;ref&#39;], request.json[&#39;sku&#39;], request.json[&#39;qty&#39;], eta,
     )
<span class="tok-gd">-    uow = unit_of_work.SqlAlchemyUnitOfWork()  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-gd">-    messagebus.handle(cmd, uow)</span>
<span class="tok-gi">+    bus.handle(cmd)  </span><i class="conum" data-value="3"></i><b>(3)</b>
     return &#39;OK&#39;, 201</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We no longer need to call <code>start_orm()</code>; the bootstrap script&#8217;s initialization
stages will do that.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We no longer need to explicitly build a particular type of UoW; the bootstrap
script defaults take care of it.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>And our message bus is now a specific instance rather than the global module.<sup class="footnote">[<a id="_footnoteref_34" class="footnote" href="#_footnotedef_34" title="View footnote.">34</a>]</sup></td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_initializing_di_in_our_tests">13.8. Initializing DI in Our Tests</h3>
<div class="paragraph">
<p>In tests, we can use <code>bootstrap.bootstrap()</code> with overridden defaults to get a
custom message bus. Here&#8217;s an example in an integration test:</p>
</div>
<div id="bootstrap_view_tests" class="exampleblock">
<div class="title">Overriding bootstrap defaults (tests/integration/test_views.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@pytest.fixture</span>
<span class="tok-k">def</span> <span class="tok-nf">sqlite_bus</span><span class="tok-p">(</span><span class="tok-n">sqlite_session_factory</span><span class="tok-p">):</span>
    <span class="tok-n">bus</span> <span class="tok-o">=</span> <span class="tok-n">bootstrap</span><span class="tok-o">.</span><span class="tok-n">bootstrap</span><span class="tok-p">(</span>
        <span class="tok-n">start_orm</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">uow</span><span class="tok-o">=</span><span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">sqlite_session_factory</span><span class="tok-p">),</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">send_mail</span><span class="tok-o">=</span><span class="tok-k">lambda</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">:</span> <span class="tok-bp">None</span><span class="tok-p">,</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">publish</span><span class="tok-o">=</span><span class="tok-k">lambda</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">:</span> <span class="tok-bp">None</span><span class="tok-p">,</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-p">)</span>
    <span class="tok-k">yield</span> <span class="tok-n">bus</span>
    <span class="tok-n">clear_mappers</span><span class="tok-p">()</span>

<span class="tok-k">def</span> <span class="tok-nf">test_allocations_view</span><span class="tok-p">(</span><span class="tok-n">sqlite_bus</span><span class="tok-p">):</span>
    <span class="tok-n">sqlite_bus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">CreateBatch</span><span class="tok-p">(</span><span class="tok-s1">&#39;sku1batch&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku1&#39;</span><span class="tok-p">,</span> <span class="tok-mi">50</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">))</span>
    <span class="tok-n">sqlite_bus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">CreateBatch</span><span class="tok-p">(</span><span class="tok-s1">&#39;sku2batch&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku2&#39;</span><span class="tok-p">,</span> <span class="tok-mi">50</span><span class="tok-p">,</span> <span class="tok-n">today</span><span class="tok-p">))</span>
    <span class="tok-o">...</span>
    <span class="tok-k">assert</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">allocations</span><span class="tok-p">(</span><span class="tok-s1">&#39;order1&#39;</span><span class="tok-p">,</span> <span class="tok-n">sqlite_bus</span><span class="tok-o">.</span><span class="tok-n">uow</span><span class="tok-p">)</span> <span class="tok-o">==</span> <span class="tok-p">[</span>
        <span class="tok-p">{</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;sku1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;sku1batch&#39;</span><span class="tok-p">},</span>
        <span class="tok-p">{</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;sku2&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;sku2batch&#39;</span><span class="tok-p">},</span>
    <span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We do still want to start the ORM&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>&#8230;&#8203;because we&#8217;re going to use a real UoW, albeit with an in-memory database.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>But we don&#8217;t need to send email or publish, so we make those noops.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In our unit tests, in contrast, we can reuse our <code>FakeUnitOfWork</code>:</p>
</div>
<div id="bootstrap_tests" class="exampleblock">
<div class="title">Bootstrap in unit test (tests/unit/test_handlers.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">bootstrap_test_app</span><span class="tok-p">():</span>
    <span class="tok-k">return</span> <span class="tok-n">bootstrap</span><span class="tok-o">.</span><span class="tok-n">bootstrap</span><span class="tok-p">(</span>
        <span class="tok-n">start_orm</span><span class="tok-o">=</span><span class="tok-bp">False</span><span class="tok-p">,</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">uow</span><span class="tok-o">=</span><span class="tok-n">FakeUnitOfWork</span><span class="tok-p">(),</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">send_mail</span><span class="tok-o">=</span><span class="tok-k">lambda</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">:</span> <span class="tok-bp">None</span><span class="tok-p">,</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">publish</span><span class="tok-o">=</span><span class="tok-k">lambda</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">:</span> <span class="tok-bp">None</span><span class="tok-p">,</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>No need to start the ORM&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>&#8230;&#8203;because the fake UoW doesn&#8217;t use one.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We want to fake out our email and Redis adapters too.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So that gets rid of a little duplication, and we&#8217;ve moved a bunch
of setup and sensible defaults into a single place.</p>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Exercise for the Reader 1</div>
<div class="paragraph">
<p>Change all the handlers to being classes as per the <a href="#di_with_classes">DI using classes</a> example,
and amend the bootstrapper&#8217;s DI code as appropriate.  This will let you
know whether you prefer the functional approach or the class-based approach when
it comes to your own projects.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building_an_adapter_properly_a_worked_example">13.9. Building an Adapter "Properly": A Worked Example</h3>
<div class="paragraph">
<p>To really get a feel for how it all works, let&#8217;s work through an example of how
you might "properly" build an adapter and do dependency injection for it.</p>
</div>
<div class="paragraph">
<p>At the moment, we have two types of dependencies:</p>
</div>
<div id="two_types_of_dependency" class="exampleblock">
<div class="title">Two types of dependencies (src/allocation/service_layer/messagebus.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">,</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">send_mail</span><span class="tok-p">:</span> <span class="tok-n">Callable</span><span class="tok-p">,</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">publish</span><span class="tok-p">:</span> <span class="tok-n">Callable</span><span class="tok-p">,</span>  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The UoW has an abstract base class. This is the heavyweight
option for declaring and managing your external dependency.
We&#8217;d use this for the case when the dependency is relatively complex.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Our email sender and pub/sub publisher are defined
as functions. This works just fine for simple dependencies.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here are some of the things we find ourselves injecting at work:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An S3 filesystem client</p>
</li>
<li>
<p>A key/value store client</p>
</li>
<li>
<p>A <code>requests</code> session object</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Most of these will have more-complex APIs that you can&#8217;t capture
as a single function: read and write, GET and POST, and so on.</p>
</div>
<div class="paragraph">
<p>Even though it&#8217;s simple, let&#8217;s use <code>send_mail</code> as an example to talk
through how you might define a more complex dependency.</p>
</div>
<div class="sect3">
<h4 id="_define_the_abstract_and_concrete_implementations">13.9.1. Define the Abstract and Concrete Implementations</h4>
<div class="paragraph">
<p>We&#8217;ll imagine a more generic notifications API. Could be
email, could be SMS, could be Slack posts one day.</p>
</div>
<div id="notifications_dot_py" class="exampleblock">
<div class="title">An ABC and a concrete implementation (src/allocation/adapters/notifications.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">AbstractNotifications</span><span class="tok-p">(</span><span class="tok-n">abc</span><span class="tok-o">.</span><span class="tok-n">ABC</span><span class="tok-p">):</span>

    <span class="tok-nd">@abc.abstractmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">send</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">destination</span><span class="tok-p">,</span> <span class="tok-n">message</span><span class="tok-p">):</span>
        <span class="tok-k">raise</span> <span class="tok-ne">NotImplementedError</span>

<span class="tok-o">...</span>

<span class="tok-k">class</span> <span class="tok-nc">EmailNotifications</span><span class="tok-p">(</span><span class="tok-n">AbstractNotifications</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">smtp_host</span><span class="tok-o">=</span><span class="tok-n">DEFAULT_HOST</span><span class="tok-p">,</span> <span class="tok-n">port</span><span class="tok-o">=</span><span class="tok-n">DEFAULT_PORT</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">server</span> <span class="tok-o">=</span> <span class="tok-n">smtplib</span><span class="tok-o">.</span><span class="tok-n">SMTP</span><span class="tok-p">(</span><span class="tok-n">smtp_host</span><span class="tok-p">,</span> <span class="tok-n">port</span><span class="tok-o">=</span><span class="tok-n">port</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">server</span><span class="tok-o">.</span><span class="tok-n">noop</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-nf">send</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">destination</span><span class="tok-p">,</span> <span class="tok-n">message</span><span class="tok-p">):</span>
        <span class="tok-n">msg</span> <span class="tok-o">=</span> <span class="tok-n">f</span><span class="tok-s1">&#39;Subject: allocation service notification</span><span class="tok-se">\n</span><span class="tok-s1">{message}&#39;</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">server</span><span class="tok-o">.</span><span class="tok-n">sendmail</span><span class="tok-p">(</span>
            <span class="tok-n">from_addr</span><span class="tok-o">=</span><span class="tok-s1">&#39;allocations@example.com&#39;</span><span class="tok-p">,</span>
            <span class="tok-n">to_addrs</span><span class="tok-o">=</span><span class="tok-p">[</span><span class="tok-n">destination</span><span class="tok-p">],</span>
            <span class="tok-n">msg</span><span class="tok-o">=</span><span class="tok-n">msg</span>
        <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We change the dependency in the bootstrap script:</p>
</div>
<div id="notifications_in_bus" class="exampleblock">
<div class="title">Notifications in message bus (src/allocation/bootstrap.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="diff"><span></span> def bootstrap(
     start_orm: bool = True,
     uow: unit_of_work.AbstractUnitOfWork = unit_of_work.SqlAlchemyUnitOfWork(),
<span class="tok-gd">-    send_mail: Callable = email.send,</span>
<span class="tok-gi">+    notifications: AbstractNotifications = EmailNotifications(),</span>
     publish: Callable = redis_eventpublisher.publish,
 ) -&gt; messagebus.MessageBus:</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_make_a_fake_version_for_your_tests">13.9.2. Make a Fake Version for Your Tests</h4>
<div class="paragraph">
<p>We work through and define a fake version for unit testing:</p>
</div>
<div id="fake_notifications" class="exampleblock">
<div class="title">Fake notifications (tests/unit/test_handlers.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">FakeNotifications</span><span class="tok-p">(</span><span class="tok-n">notifications</span><span class="tok-o">.</span><span class="tok-n">AbstractNotifications</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">sent</span> <span class="tok-o">=</span> <span class="tok-n">defaultdict</span><span class="tok-p">(</span><span class="tok-nb">list</span><span class="tok-p">)</span>  <span class="tok-c1"># type: Dict[str, List[str]]</span>

    <span class="tok-k">def</span> <span class="tok-nf">send</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">destination</span><span class="tok-p">,</span> <span class="tok-n">message</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">sent</span><span class="tok-p">[</span><span class="tok-n">destination</span><span class="tok-p">]</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">message</span><span class="tok-p">)</span>
<span class="tok-o">...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And we use it in our tests:</p>
</div>
<div id="test_with_fake_notifs" class="exampleblock">
<div class="title">Tests change slightly (tests/unit/test_handlers.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">test_sends_email_on_out_of_stock_error</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">fake_notifs</span> <span class="tok-o">=</span> <span class="tok-n">FakeNotifications</span><span class="tok-p">()</span>
        <span class="tok-n">bus</span> <span class="tok-o">=</span> <span class="tok-n">bootstrap</span><span class="tok-o">.</span><span class="tok-n">bootstrap</span><span class="tok-p">(</span>
            <span class="tok-n">start_orm</span><span class="tok-o">=</span><span class="tok-bp">False</span><span class="tok-p">,</span>
            <span class="tok-n">uow</span><span class="tok-o">=</span><span class="tok-n">FakeUnitOfWork</span><span class="tok-p">(),</span>
            <span class="tok-n">notifications</span><span class="tok-o">=</span><span class="tok-n">fake_notifs</span><span class="tok-p">,</span>
            <span class="tok-n">publish</span><span class="tok-o">=</span><span class="tok-k">lambda</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">:</span> <span class="tok-bp">None</span><span class="tok-p">,</span>
        <span class="tok-p">)</span>
        <span class="tok-n">bus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">CreateBatch</span><span class="tok-p">(</span><span class="tok-s2">&quot;b1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;POPULAR-CURTAINS&quot;</span><span class="tok-p">,</span> <span class="tok-mi">9</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">))</span>
        <span class="tok-n">bus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Allocate</span><span class="tok-p">(</span><span class="tok-s2">&quot;o1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;POPULAR-CURTAINS&quot;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">))</span>
        <span class="tok-k">assert</span> <span class="tok-n">fake_notifs</span><span class="tok-o">.</span><span class="tok-n">sent</span><span class="tok-p">[</span><span class="tok-s1">&#39;stock@made.com&#39;</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-p">[</span>
            <span class="tok-n">f</span><span class="tok-s2">&quot;Out of stock for POPULAR-CURTAINS&quot;</span><span class="tok-p">,</span>
        <span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_figure_out_how_to_integration_test_the_real_thing">13.9.3. Figure Out How to Integration Test the Real Thing</h4>
<div class="paragraph">
<p>Now we test the real thing, usually with an end-to-end or integration
test.  We&#8217;ve used <a href="https://github.com/mailhog/MailHog">MailHog</a> as a
real-ish email server for our Docker dev environment:</p>
</div>
<div id="docker_compose_with_mailhog" class="exampleblock">
<div class="title">Docker-compose config with real fake email server (docker-compose.yml)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">version</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-s">&quot;3&quot;</span>

<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">services</span><span class="tok-p tok-p-Indicator">:</span>

  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">redis_pubsub</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">build</span><span class="tok-p tok-p-Indicator">:</span>
      <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">context</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">.</span>
      <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">dockerfile</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Dockerfile</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">image</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">allocation-image</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">...</span>

  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">image</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">allocation-image</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">...</span>

  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">postgres</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">image</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">postgres:9.6</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">...</span>

  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">redis</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">image</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">redis:alpine</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">...</span>

  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mailhog</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">image</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mailhog/mailhog</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ports</span><span class="tok-p tok-p-Indicator">:</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&quot;11025:1025&quot;</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&quot;18025:8025&quot;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In our integration tests, we use the real <code>EmailNotifications</code> class,
talking to the MailHog server in the Docker cluster:</p>
</div>
<div id="integration_test_email" class="exampleblock">
<div class="title">Integration test for email (tests/integration/test_email.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@pytest.fixture</span>
<span class="tok-k">def</span> <span class="tok-nf">bus</span><span class="tok-p">(</span><span class="tok-n">sqlite_session_factory</span><span class="tok-p">):</span>
    <span class="tok-n">bus</span> <span class="tok-o">=</span> <span class="tok-n">bootstrap</span><span class="tok-o">.</span><span class="tok-n">bootstrap</span><span class="tok-p">(</span>
        <span class="tok-n">start_orm</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span>
        <span class="tok-n">uow</span><span class="tok-o">=</span><span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">sqlite_session_factory</span><span class="tok-p">),</span>
        <span class="tok-n">notifications</span><span class="tok-o">=</span><span class="tok-n">notifications</span><span class="tok-o">.</span><span class="tok-n">EmailNotifications</span><span class="tok-p">(),</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">publish</span><span class="tok-o">=</span><span class="tok-k">lambda</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">:</span> <span class="tok-bp">None</span><span class="tok-p">,</span>
    <span class="tok-p">)</span>
    <span class="tok-k">yield</span> <span class="tok-n">bus</span>
    <span class="tok-n">clear_mappers</span><span class="tok-p">()</span>


<span class="tok-k">def</span> <span class="tok-nf">get_email_from_mailhog</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">host</span><span class="tok-p">,</span> <span class="tok-n">port</span> <span class="tok-o">=</span> <span class="tok-nb">map</span><span class="tok-p">(</span><span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-n">get_email_host_and_port</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-s1">&#39;host&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;http_port&#39;</span><span class="tok-p">])</span>
    <span class="tok-n">all_emails</span> <span class="tok-o">=</span> <span class="tok-n">requests</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;http://{host}:{port}/api/v2/messages&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">json</span><span class="tok-p">()</span>
    <span class="tok-k">return</span> <span class="tok-nb">next</span><span class="tok-p">(</span><span class="tok-n">m</span> <span class="tok-k">for</span> <span class="tok-n">m</span> <span class="tok-ow">in</span> <span class="tok-n">all_emails</span><span class="tok-p">[</span><span class="tok-s1">&#39;items&#39;</span><span class="tok-p">]</span> <span class="tok-k">if</span> <span class="tok-n">sku</span> <span class="tok-ow">in</span> <span class="tok-nb">str</span><span class="tok-p">(</span><span class="tok-n">m</span><span class="tok-p">))</span>


<span class="tok-k">def</span> <span class="tok-nf">test_out_of_stock_email</span><span class="tok-p">(</span><span class="tok-n">bus</span><span class="tok-p">):</span>
    <span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">random_sku</span><span class="tok-p">()</span>
    <span class="tok-n">bus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">CreateBatch</span><span class="tok-p">(</span><span class="tok-s1">&#39;batch1&#39;</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">9</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">))</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">bus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">commands</span><span class="tok-o">.</span><span class="tok-n">Allocate</span><span class="tok-p">(</span><span class="tok-s1">&#39;order1&#39;</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">))</span>
    <span class="tok-n">email</span> <span class="tok-o">=</span> <span class="tok-n">get_email_from_mailhog</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">email</span><span class="tok-p">[</span><span class="tok-s1">&#39;Raw&#39;</span><span class="tok-p">][</span><span class="tok-s1">&#39;From&#39;</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;allocations@example.com&#39;</span>  <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-k">assert</span> <span class="tok-n">email</span><span class="tok-p">[</span><span class="tok-s1">&#39;Raw&#39;</span><span class="tok-p">][</span><span class="tok-s1">&#39;To&#39;</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-p">[</span><span class="tok-s1">&#39;stock@made.com&#39;</span><span class="tok-p">]</span>
    <span class="tok-k">assert</span> <span class="tok-n">f</span><span class="tok-s1">&#39;Out of stock for {sku}&#39;</span> <span class="tok-ow">in</span> <span class="tok-n">email</span><span class="tok-p">[</span><span class="tok-s1">&#39;Raw&#39;</span><span class="tok-p">][</span><span class="tok-s1">&#39;Data&#39;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use our bootstrapper to build a message bus that talks to the
real notifications class.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We figure out how to fetch emails from our "real" email server.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We use the bus to do our test setup.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Against all the odds, this actually worked, pretty much at the first go!</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And that&#8217;s it really.</p>
</div>
<div class="sidebarblock less_space nobreakinside">
<div class="content">
<div class="title">Exercise for the Reader 2</div>
<div class="paragraph">
<p>You could do two things for practice regarding adapters:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Try swapping out our notifications from email to SMS
notifications using Twilio, for example, or Slack notifications.  Can you find
a good equivalent to MailHog for integration testing?</p>
</li>
<li>
<p>In a similar way to what we did moving from <code>send_mail</code> to a <code>Notifications</code>
class, try refactoring our <code>redis_eventpublisher</code> that is currently just
a <code>Callable</code> to some sort of more formal adapter/base class/protocol.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up_12">13.10. Wrap-Up</h3>
<div class="ulist">
<ul>
<li>
<p>Once you have more than one adapter, you&#8217;ll start to feel a lot of pain
from passing dependencies around manually, unless you do some kind of
<em>dependency injection.</em></p>
</li>
<li>
<p>Setting up dependency injection is just one of many typical
setup/initialization activities that you need to do just once when starting
your app.  Putting this all together into a <em>bootstrap script</em> is often a
good idea.</p>
</li>
<li>
<p>The bootstrap script is also good as a place to provide sensible default
configuration for your adapters, and as a single place to override those
adapters with fakes for your tests.</p>
</li>
<li>
<p>A dependency injection framework can be useful if you find yourself
needing to do DI at multiple levels—if you have chained dependencies
of components that all need DI, for example.</p>
</li>
<li>
<p>This chapter also presented a worked example of changing an implicit/simple
dependency into a "proper" adapter, factoring out an ABC, defining its real
and fake implementations, and thinking through integration testing.</p>
</li>
</ul>
</div>
<div class="sidebarblock less_space nobreakinside">
<div class="content">
<div class="title">DI and Bootstrap Recap</div>
<div class="paragraph">
<p>In summary:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define your API using an ABC.</p>
</li>
<li>
<p>Implement the real thing.</p>
</li>
<li>
<p>Build a fake and use it for unit/service-layer/handler tests.</p>
</li>
<li>
<p>Find a less fake version you can put into your Docker environment.</p>
</li>
<li>
<p>Test the less fake "real" thing.</p>
</li>
<li>
<p>Profit!</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>These were the last patterns we wanted to cover, which brings us to the end of <a href="#part2">Event-Driven Architecture</a>. In <a href="#epilogue_1_how_to_get_there_from_here">the epilogue</a>, we&#8217;ll try to give you some pointers for applying these techniques in the Real World<sup>TM</sup>.</p>
</div>
</div>
</div>
</div>
<div class="sect1 afterword">
<h2 id="epilogue_1_how_to_get_there_from_here">Appendix A: Epilogue</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_now">What Now?</h3>
<div class="paragraph">
<p>Phew! We&#8217;ve covered a lot of ground in this book, and for most of our audience
all of these ideas are new. With that in mind, we can&#8217;t hope to make you experts
in these techniques. All we can really do is show you the broad-brush ideas, and
just enough code for you to go ahead and write something from scratch.</p>
</div>
<div class="paragraph">
<p>The code we&#8217;ve shown in this book isn&#8217;t battle-hardened production code: it&#8217;s a
set of Lego blocks that you can play with to make your first house, spaceship,
and <span class="keep-together">skyscraper</span>.</p>
</div>
<div class="paragraph">
<p>That leaves us with two big tasks. We want to talk
about how to start applying these ideas for real in an existing system, and we
need to warn you about some of the things we had to skip. We&#8217;ve given you a
whole new arsenal of ways to shoot yourself in the foot, so we should discuss
some basic firearms safety.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_do_i_get_there_from_here">How Do I Get There from Here?</h3>
<div class="paragraph">
<p>Chances are that a lot of you are thinking something like this:</p>
</div>
<div class="paragraph">
<p>"OK Bob and Harry, that&#8217;s all well and good, and if I ever get hired to work
on a green-field new service, I know what to do. But in the meantime, I&#8217;m
here with my big ball of Django mud, and I don&#8217;t see any way to get to your
nice, clean, perfect, untainted, simplistic model. Not from here."</p>
</div>
<div class="paragraph">
<p>We hear you. Once you&#8217;ve already <em>built</em> a big ball of mud, it&#8217;s hard to know
how to start improving things. Really, we need to tackle things step by step.</p>
</div>
<div class="paragraph">
<p>First things first: what problem are you trying to solve? Is the software too
hard to change? Is the performance unacceptable? Have you got weird, inexplicable
bugs?</p>
</div>
<div class="paragraph">
<p>Having a clear goal in mind will help you to prioritize the work that needs to
be done and, importantly, communicate the reasons for doing it to the rest of
the team. <span class="keep-together">Businesses</span> tend to have pragmatic approaches to technical debt
and refactoring, so long as engineers can make a reasoned argument for fixing
things.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Making complex changes to a system is often an easier sell if you link it
to feature work. Perhaps you&#8217;re launching a new product or opening your service
to new markets? This is the right time to spend engineering resources on fixing
the foundations. With a six-month project to deliver, it&#8217;s easier to make the
argument for three weeks of cleanup work. Bob refers to this as <em>architecture
tax</em>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_separating_entangled_responsibilities">Separating Entangled Responsibilities</h3>
<div class="paragraph">
<p>At the beginning of the book, we said that the main characteristic of a big ball
of mud is homogeneity: every part of the system looks the same, because we
haven&#8217;t been clear about the responsibilities of each component. To fix that,
we&#8217;ll need to start separating out responsibilities and introducing clear
boundaries. One of the first things we can do is to start building a service
layer (<a href="#collaboration_app_model">Domain of a collaboration system</a>).</p>
</div>
<div id="collaboration_app_model" class="imageblock width-60">
<div class="content">
<img src="images/apwp_ep01.png" alt="apwp ep01">
</div>
<div class="title">Figure 46. Domain of a collaboration system</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_ep01, config=plantuml.cfg]
@startuml
scale 4
hide empty members

Workspace *- Folder : contains
Account *- Workspace : owns
Account *-- Package : has
User *-- Account : manages
Workspace *-- User : has members
User *-- Document : owns
Folder *-- Document : contains
Document *- Version: has
User *-- Version: authors
@enduml</pre>
</div>
</div>
<div class="paragraph">
<p>This was the system in which Bob first learned how to break apart a ball of mud,
and it was a doozy. There was logic <em>everywhere</em>—in the web pages, in
manager objects, in helpers, in fat service classes that we&#8217;d written to
abstract the managers and helpers, and in hairy command objects that we&#8217;d
written to break apart the services.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re working in a system that&#8217;s reached this point, the situation can feel hopeless,
but it&#8217;s never too late to start weeding an overgrown garden. Eventually, we
hired an architect who knew what he was doing, and he helped us get things
back under control.</p>
</div>
<div class="paragraph">
<p>Start by working out the <em>use cases</em> of your system. If you have a
user interface, what actions does it perform? If you have a backend
processing component, maybe each cron job or Celery job is a single
use case. Each of your use cases needs to have an imperative name: Apply
Billing Charges, Clean Abandoned Accounts, or Raise Purchase Order, for example.</p>
</div>
<div class="paragraph">
<p>In our case, most of our use cases were part of the manager classes and had
names like Create Workspace or Delete Document Version. Each use case
was invoked from a web frontend.</p>
</div>
<div class="paragraph">
<p>We aim to create a single function or class for each of these supported
operations that deals with <em>orchestrating</em> the work to be done. Each use case
should do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Start its own database transaction if needed</p>
</li>
<li>
<p>Fetch any required data</p>
</li>
<li>
<p>Check any preconditions (see the Ensure pattern in <a href="#appendix_validation">Validation</a>)</p>
</li>
<li>
<p>Update the domain model</p>
</li>
<li>
<p>Persist any changes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each use case should succeed or fail as an atomic unit. You might need to call
one use case from another. That&#8217;s OK; just make a note of it, and try to
avoid long-running database transactions.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
One of the biggest problems we had was that manager methods called other
manager methods, and data access could happen from the model objects themselves.
It was hard to understand what each operation did without going on a treasure hunt across the codebase. Pulling all the logic into a single method, and using
a UoW to control our transactions, made the system easier to reason
about.
</td>
</tr>
</table>
</div>
<div class="sidebarblock less_space nobreakinside">
<div class="content">
<div class="title">Case Study: Layering an Overgrown System</div>
<div class="paragraph">
<p>Many years ago, Bob worked for a software company that had outsourced the first
version of its application, an online collaboration platform for sharing and
working on files.</p>
</div>
<div class="paragraph">
<p>When the company brought development in-house, it passed through several
generations of developers' hands, and each wave of new developers added more
complexity to the code&#8217;s structure.</p>
</div>
<div class="paragraph">
<p>At its heart, the system was an ASP.NET Web Forms application, built with an
NHibernate ORM. Users would upload documents into workspaces, where they could
invite other workspace members to review, comment on, or modify their work.</p>
</div>
<div class="paragraph">
<p>Most of the complexity of the application was in the permissions model because
each document was contained in a folder, and folders allowed read, write, and
edit permissions, much like a Linux filesystem.</p>
</div>
<div class="paragraph">
<p>Additionally, each workspace belonged to an account, and the account had quotas
attached to it via a billing package.</p>
</div>
<div class="paragraph">
<p>As a result, every read or write operation against a document had to load an
enormous number of objects from the database in order to test permissions and
quotas. Creating a new workspace involved hundreds of database queries as we set
up the permissions structure, invited users, and set up sample content.</p>
</div>
<div class="paragraph">
<p>Some of the code for operations was in web handlers that ran when a user clicked
a button or submitted a form; some of it was in manager objects that held
code for orchestrating work; and some of it was in the domain model. Model
objects would make database calls or copy files on disk, and the test coverage
was abysmal.</p>
</div>
<div class="paragraph">
<p>To fix the problem, we first introduced a service layer so that all of the code
for creating a document or workspace was in one place and could be understood.
This involved pulling data access code out of the domain model and into
command handlers. Likewise, we pulled orchestration code out of the managers and
the web handlers and pushed it into handlers.</p>
</div>
<div class="paragraph">
<p>The resulting command handlers were <em>long</em> and messy, but we&#8217;d made a start at
introducing order to the chaos.</p>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It&#8217;s fine if you have duplication in the use-case functions. We&#8217;re not
    trying to write perfect code; we&#8217;re just trying to extract some meaningful
    layers. It&#8217;s better to duplicate some code in a few places than to have
    use-case functions calling one another in a long chain.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is a good opportunity to pull any data-access or orchestration code out of
the domain model and into the use cases. We should also try to pull I/O
concerns (e.g., sending email, writing files) out of the domain model and up into
the use-case functions. We apply the techniques from <a href="#chapter_03_abstractions">A Brief Interlude: On Coupling <span class="keep-together">and Abstractions</span></a> on abstractions
to keep our handlers unit testable even when they&#8217;re performing I/O.</p>
</div>
<div class="paragraph">
<p>These use-case functions will mostly be about logging, data access, and error
handling. Once you&#8217;ve done this step, you&#8217;ll have a grasp of what your program
actually <em>does</em>, and a way to make sure each operation has a clearly defined
start and finish. We&#8217;ll have taken a step toward building a pure domain model.</p>
</div>
<div class="paragraph">
<p>Read <em>Working Effectively with Legacy Code</em> by Michael C. Feathers (Prentice Hall) for guidance on getting legacy code
under test and starting separating responsibilities.</p>
</div>
</div>
<div class="sect2">
<h3 id="_identifying_aggregates_and_bounded_contexts">Identifying Aggregates and Bounded Contexts</h3>
<div class="paragraph">
<p>Part of the problem with the codebase in our case study was that the object
graph was highly connected. Each account had many workspaces, and each workspace had
many members, all of whom had their own accounts. Each workspace contained many
documents, which had many versions.</p>
</div>
<div class="paragraph">
<p>You can&#8217;t express the full horror of the thing in a class diagram.
For one thing, there wasn&#8217;t really a single account related to a user. Instead,
there was a bizarre rule requiring you to enumerate all of the accounts
associated to the user via the workspaces and take the one with the earliest
creation date.</p>
</div>
<div class="paragraph">
<p>Every object in the system was part of an inheritance hierarchy that included
<code>SecureObject</code> and <code>Version</code>. This inheritance hierarchy was mirrored directly
in the database schema, so that every query had to join across 10 different
tables and look at a discriminator column just to tell what kind of objects
you were working with.</p>
</div>
<div class="paragraph">
<p>The codebase made it easy to "dot" your way through these objects like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">user</span><span class="tok-o">.</span><span class="tok-n">account</span><span class="tok-o">.</span><span class="tok-n">workspaces</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-o">.</span><span class="tok-n">documents</span><span class="tok-o">.</span><span class="tok-n">versions</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span><span class="tok-o">.</span><span class="tok-n">owner</span><span class="tok-o">.</span><span class="tok-n">account</span><span class="tok-o">.</span><span class="tok-n">settings</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">];</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Building a system this way with Django ORM or SQLAlchemy is easy but is
to be <span class="keep-together">avoided</span>. Although it&#8217;s <em>convenient</em>, it makes it very hard to reason about
performance because each property might trigger a lookup to the database.</p>
</div>
<div class="admonitionblock tip pagebreak-before">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Aggregates are a <em>consistency boundary</em>. In general, each use case should
    update a single aggregate at a time. One handler fetches one aggregate from
    a repository, modifies its state, and raises any events that happen as a
    result. If you need data from another part of the system, it&#8217;s totally fine
    to use a read model, but avoid updating multiple aggregates in a single
    transaction. When we choose to separate code into different aggregates,
    we&#8217;re explicitly choosing to make them <em>eventually consistent</em> with one
    another.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A bunch of operations required us to loop over objects this way—for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-c1"># Lock a user&#39;s workspaces for nonpayment</span>

<span class="tok-k">def</span> <span class="tok-nf">lock_account</span><span class="tok-p">(</span><span class="tok-n">user</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">workspace</span> <span class="tok-ow">in</span> <span class="tok-n">user</span><span class="tok-o">.</span><span class="tok-n">account</span><span class="tok-o">.</span><span class="tok-n">workspaces</span><span class="tok-p">:</span>
        <span class="tok-n">workspace</span><span class="tok-o">.</span><span class="tok-n">archive</span><span class="tok-p">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or even recurse over collections of folders and documents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">lock_documents_in_folder</span><span class="tok-p">(</span><span class="tok-n">folder</span><span class="tok-p">):</span>

    <span class="tok-k">for</span> <span class="tok-n">doc</span> <span class="tok-ow">in</span> <span class="tok-n">folder</span><span class="tok-o">.</span><span class="tok-n">documents</span><span class="tok-p">:</span>
         <span class="tok-n">doc</span><span class="tok-o">.</span><span class="tok-n">archive</span><span class="tok-p">()</span>

     <span class="tok-k">for</span> <span class="tok-n">child</span> <span class="tok-ow">in</span> <span class="tok-n">folder</span><span class="tok-o">.</span><span class="tok-n">children</span><span class="tok-p">:</span>
         <span class="tok-n">lock_documents_in_folder</span><span class="tok-p">(</span><span class="tok-n">child</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These operations <em>killed</em> performance, but fixing them meant giving up our single
object graph. Instead, we began to identify aggregates and to break the direct
links between objects.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We talked about the infamous <code>SELECT N+1</code> problem in <a href="#chapter_12_cqrs">Command-Query Responsibility Segregation (CQRS)</a>, and how
we might choose to use different techniques when reading data for queries versus
reading data for commands.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Mostly we did this by replacing direct references with identifiers.</p>
</div>
<div class="paragraph pagebreak-before">
<p>Before aggregates:</p>
</div>
<div id="aggregates_before" class="imageblock">
<div class="content">
<img src="images/apwp_ep02.png" alt="apwp ep02">
</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_ep02, config=plantuml.cfg]
@startuml
scale 4
hide empty members

together {
    class Document {
      add_version()
      workspace: Workspace
      parent: Folder
      versions: List[DocumentVersion]

    }

    class DocumentVersion {
      title : str
      version_number: int
      document: Document

    }
    class Folder {
      parent: Workspace
      children: List[Folder]
      copy_to(target: Folder)
      add_document(document: Document)
    }
}

together {
    class User {
      account: Account
    }


    class Account {
      add_package()
      owner : User
      packages : List[BillingPackage]
      workspaces: List[Workspace]
    }
}


class BillingPackage {
}

class Workspace {
  add_member(member: User)
  account: Account
  owner: User
  members: List[User]
}



Account --&gt; Workspace
Account -left-&gt; BillingPackage
Account -right-&gt; User
Workspace --&gt; User
Workspace --&gt; Folder
Workspace --&gt; Account
Folder --&gt; Folder
Folder --&gt; Document
Folder --&gt; Workspace
Folder --&gt; User
Document -right-&gt; DocumentVersion
Document --&gt; Folder
Document --&gt; User
DocumentVersion -right-&gt; Document
DocumentVersion --&gt; User
User -left-&gt; Account

@enduml</pre>
</div>
</div>
<div class="paragraph">
<p>After modeling with aggregates:</p>
</div>
<div id="aggregates_after" class="imageblock">
<div class="content">
<img src="images/apwp_ep03.png" alt="apwp ep03">
</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_ep03, config=plantuml.cfg]
@startuml
scale 4
hide empty members

frame Document {

  class Document {

    add_version()

    workspace_id: int
    parent_folder: int

    versions: List[DocumentVersion]

  }

  class DocumentVersion {

    title : str
    version_number: int

  }
}

frame Account {

  class Account {
    add_package()

    owner : int
    packages : List[BillingPackage]
  }


  class BillingPackage {
  }

}

frame Workspace {
   class Workspace {

     add_member(member: int)

     account_id: int
     owner: int
     members: List[int]

   }
}

frame Folder {

  class Folder {
    workspace_id : int
    children: List[int]

    copy_to(target: int)
  }

}

Document o-- DocumentVersion
Account o-- BillingPackage

@enduml</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Bidirectional links are often a sign that your aggregates aren&#8217;t right.
    In our original code, a <code>Document</code> knew about its containing <code>Folder</code>, and the
    <code>Folder</code> had a collection of <code>Documents</code>. This makes it easy to traverse the
    object graph but stops us from thinking properly about the consistency
    boundaries we need. We break apart aggregates by using references instead.
    In the new model, a <code>Document</code> had reference to its <code>parent_folder</code> but had no way
    to directly access the <code>Folder</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If we needed to <em>read</em> data, we avoided writing complex loops and transforms and
tried to replace them with straight SQL. For example, one of our screens was a
tree view of folders and documents.</p>
</div>
<div class="paragraph">
<p>This screen was <em>incredibly</em> heavy on the database, because it relied on nested
<code>for</code> loops that triggered a lazy-loaded ORM.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
We use this same technique in <a href="#chapter_11_external_events">Event-Driven Architecture: Using Events to Integrate Microservices</a>, where we replace a
    nested loop over ORM objects with a simple SQL query. It&#8217;s the first step
    in a CQRS approach.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After a lot of head-scratching, we replaced the ORM code with a big, ugly stored
procedure. The code looked horrible, but it was much faster and helped
to break the links between <code>Folder</code> and <code>Document</code>.</p>
</div>
<div class="paragraph">
<p>When we needed to <em>write</em> data, we changed a single aggregate at a time, and we
introduced a message bus to handle events. For example, in the new model, when
we locked an account, we could first query for all the affected workspaces via
<code>SELECT <em>id</em> FROM <em>workspace</em> WHERE <em>account_id</em> = ?</code>.</p>
</div>
<div class="paragraph">
<p>We could then raise a new command for each workspace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">for</span> <span class="tok-n">workspace_id</span> <span class="tok-ow">in</span> <span class="tok-n">workspaces</span><span class="tok-p">:</span>
    <span class="tok-n">bus</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">(</span><span class="tok-n">LockWorkspace</span><span class="tok-p">(</span><span class="tok-n">workspace_id</span><span class="tok-p">))</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_an_event_driven_approach_to_go_to_microservices_via_strangler_pattern">An Event-Driven Approach to Go to Microservices via Strangler Pattern</h3>
<div class="paragraph">
<p>The <em>Strangler Fig</em> pattern involves creating a new system around the edges
of an old system, while keeping it running. Bits of old functionality
are gradually intercepted and replaced, until the old system is left
doing nothing at all and can be switched off.</p>
</div>
<div class="paragraph">
<p>When building the availability service, we used a technique called <em>event
interception</em> to move functionality from one place to another. This is a three-step
process:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Raise events to represent the changes happening in a system you want to
replace.</p>
</li>
<li>
<p>Build a second system that consumes those events and uses them to build its
own domain model.</p>
</li>
<li>
<p>Replace the older system with the new.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We used event interception to move from <a href="#strangler_before">Before: strong, bidirectional coupling based on XML-RPC</a>&#8230;&#8203;</p>
</div>
<div id="strangler_before" class="imageblock">
<div class="content">
<img src="images/apwp_ep04.png" alt="apwp ep04">
</div>
<div class="title">Figure 47. Before: strong, bidirectional coupling based on XML-RPC</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_ep04, config=plantuml.cfg]
@startuml Ecommerce Context
!include images/C4_Context.puml

LAYOUT_LEFT_RIGHT
scale 2

Person_Ext(customer, "Customer", "Wants to buy furniture")

System(fulfillment, "Fulfillment System", "Manages order fulfillment and logistics")
System(ecom, "Ecommerce website", "Allows customers to buy furniture")

Rel(customer, ecom, "Uses")
Rel(fulfillment, ecom, "Updates stock and orders", "xml-rpc")
Rel(ecom, fulfillment, "Sends orders", "xml-rpc")

@enduml</pre>
</div>
</div>
<div class="paragraph">
<p>to <a href="#strangler_after">After: loose coupling with asynchronous events (you can find a high-resolution version of this diagram at cosmicpython.com)</a>.</p>
</div>
<div id="strangler_after" class="imageblock">
<div class="content">
<img src="images/apwp_ep05.png" alt="apwp ep05">
</div>
<div class="title">Figure 48. After: loose coupling with asynchronous events (you can find a high-resolution version of this diagram at cosmicpython.com)</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_ep05, config=plantuml.cfg]
@startuml Ecommerce Context
!include images/C4_Context.puml

LAYOUT_LEFT_RIGHT
scale 2

Person_Ext(customer, "Customer", "Wants to buy furniture")

System(av, "Availability Service", "Calculates stock availability")
System(fulfillment, "Fulfillment System", "Manages order fulfillment and logistics")
System(ecom, "Ecommerce website", "Allows customers to buy furniture")

Rel(customer, ecom, "Uses")
Rel(customer, av, "Uses")
Rel(fulfillment, av, "Publishes batch_created", "events")
Rel(av, ecom, "Publishes out_of_stock", "events")
Rel(ecom, fulfillment, "Sends orders", "xml-rpc")

@enduml</pre>
</div>
</div>
<div class="paragraph">
<p>Practically, this was a several month-long project. Our first step was to write a
domain model that could represent batches, shipments, and products. We used TDD
to build a toy system that could answer a single question: "If I want N units of
<span class="keep-together">HAZARDOUS_RUG</span>, how long will they take to be delivered?"</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When deploying an event-driven system, start with a "walking skeleton."
    Deploying a system that just logs its input forces us to tackle all the
    infrastructural questions and start working in <span class="keep-together">production</span>.
</td>
</tr>
</table>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Case Study: Carving Out a Microservice to Replace a Domain</div>
<div class="paragraph">
<p>MADE.com started out with <em>two</em> monoliths: one for the frontend ecommerce
application, and one for the backend fulfillment system.</p>
</div>
<div class="paragraph">
<p>The two systems communicated through XML-RPC. Periodically, the backend system
would wake up and query the frontend system to find out about new orders. When
it had imported all the new orders, it would send RPC commands to update the
stock levels.</p>
</div>
<div class="paragraph">
<p>Over time this synchronization process became slower and slower until, one
Christmas, it took longer than 24 hours to import a single day&#8217;s orders. Bob was
hired to break the system into a set of event-driven services.</p>
</div>
<div class="paragraph">
<p>First, we identified that the slowest part of the process was calculating and
synchronizing the available stock. What we needed was a system that could listen
to external events and keep a running total of how much stock was available.</p>
</div>
<div class="paragraph">
<p>We exposed that information via an API, so that the user&#8217;s browser could ask
how much stock was available for each product and how long it would take to
deliver to their address.</p>
</div>
<div class="paragraph">
<p>Whenever a product ran out of stock completely, we would raise a new event that
the ecommerce platform could use to take a product off sale. Because we didn&#8217;t
know how much load we would need to handle, we wrote the system with a CQRS
pattern. Whenever the amount of stock changed, we would update a Redis database
with a cached view model. Our Flask API queried these <em>view models</em> instead of
running the complex domain model.</p>
</div>
<div class="paragraph">
<p>As a result, we could answer the question "How much stock is available?" in 2
to 3 milliseconds, and now the API frequently handles hundreds of requests a
second for sustained periods.</p>
</div>
<div class="paragraph">
<p>If this all sounds a little familiar, well, now you know where our example app
came from!</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Once we had a working domain model, we switched to building out some
infrastructural pieces. Our first production deployment was a tiny system that
could receive a <code>batch_created</code> event and log its JSON representation. This is
the "Hello World" of event-driven architecture. It forced us to deploy a message
bus, hook up a producer and consumer, build a deployment pipeline, and write a
simple message handler.</p>
</div>
<div class="paragraph">
<p>Given a deployment pipeline, the infrastructure we needed, and a basic domain
model, we were off. A couple months later, we were in production and serving
real customers.</p>
</div>
</div>
<div class="sect2">
<h3 id="_convincing_your_stakeholders_to_try_something_new">Convincing Your Stakeholders to Try Something New</h3>
<div class="paragraph">
<p>If you&#8217;re thinking about carving a new system out of a big ball of mud, you&#8217;re
probably suffering problems with reliability, performance, maintainability, or
all three simultaneously. Deep, intractable problems call for drastic measures!</p>
</div>
<div class="paragraph">
<p>We recommend <em>domain modeling</em> as a first step. In many overgrown systems, the
engineers, product owners, and customers no longer speak the same language.
Business stakeholders speak about the system in abstract, process-focused terms,
while developers are forced to speak about the system as it physically exists in
its wild and chaotic state.</p>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Case Study: The User Model</div>
<div class="paragraph">
<p>We mentioned earlier that the account and user model in our first system were
bound together by a "bizarre rule." This is a perfect example of how engineering
and business stakeholders can drift apart.</p>
</div>
<div class="paragraph">
<p>In this system, <em>accounts</em> parented <em>workspaces</em>, and users were <em>members</em> of
workspaces. Workspaces were the fundamental unit for applying permissions and
quotas. If a user <em>joined</em> a workspace and didn&#8217;t already have an <em>account</em>, we
would associate them with the account that owned that workspace.</p>
</div>
<div class="paragraph">
<p>This was messy and ad hoc, but it worked fine until the day a product owner
asked for a new feature:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>When a user joins a company, we want to add them to some default workspaces
  for the company, like the HR workspace or the Company Announcements workspace.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>We had to explain to them that there was <em>no such thing</em> as a company, and there
was no sense in which a user joined an account. Moreover, a "company" might have
<em>many</em> accounts owned by different users, and a new user might be invited to
any one of them.</p>
</div>
<div class="paragraph">
<p>Years of adding hacks and work-arounds to a broken model caught up with us, and
we had to rewrite the entire user management function as a brand-new system.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Figuring out how to model your domain is a complex task that&#8217;s the subject of many
decent books in its own right. We like to use interactive techniques like event
storming and CRC modeling, because humans are good at collaborating through
play. <em>Event modeling</em> is another technique that brings engineers and product
owners together to understand a system in terms of commands, queries, and events.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Check out <em>www.eventmodeling.org</em> and <em>www.eventstorming.org</em> for some great
guides to visual modeling of systems with events.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The goal is to be able to talk about the system by using the same ubiquitous
language, so that you can agree on where the complexity lies.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve found a lot of value in treating domain problems as TDD kata. For example,
the first code we wrote for the availability service was the batch and order
line model. You can treat this as a lunchtime workshop, or as a spike at the
beginning of a project. Once you can demonstrate the value of modeling, it&#8217;s
easier to make the argument for structuring the project to optimize for modeling.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Case Study: David Seddon on Taking Small Steps</div>
<div class="paragraph">
<p><em>Hi, I&#8217;m David, one of the tech reviewers on this book. I&#8217;ve worked on
several complex Django monoliths, and so I&#8217;ve known the pain that Bob and
Harry have made all sorts of grand promises about soothing.</em></p>
</div>
<div class="paragraph">
<p><em>When I was first exposed to the patterns described here, I was rather
excited. I had successfully used some of the techniques already on
smaller projects, but here was a blueprint for much larger, database-backed
systems like the one I work on in my day job. So I started trying to figure
out how I could implement that blueprint at my current organization.</em></p>
</div>
<div class="paragraph">
<p><em>I chose to tackle a problem area of the codebase that had always bothered me.
I began by implementing it as a use case. But I found myself running
into unexpected questions. There were things that I hadn&#8217;t considered
while reading that now made it difficult to see what to do. Was it a
problem if my use case interacted with two different aggregates? Could
one use case call another? And how was it going to exist within
a system that followed different architectural principles without resulting
in a horrible mess?</em></p>
</div>
<div class="paragraph">
<p><em>What happened to that oh-so-promising blueprint? Did I actually understand
the ideas well enough to put them into practice? Was it even suitable for my
application? Even if it was, would any of my colleagues agree to such a
major change? Were these just nice ideas for me to fantasize about while I got
on with real life?</em></p>
</div>
<div class="paragraph">
<p><em>It took me a while to realize that I could start small. I didn&#8217;t
need to be a purist or to 'get it right' the first time: I could experiment,
finding what worked for me.</em></p>
</div>
<div class="paragraph">
<p><em>And so that&#8217;s what I&#8217;ve done. I&#8217;ve been able to apply</em> some <em>of the ideas
in a few places. I&#8217;ve built new features whose business logic
can be tested without the database or mocks. And as a team, we&#8217;ve
introduced a service layer to help define the jobs the system does.</em></p>
</div>
<div class="paragraph">
<p><em>If you start trying to apply these patterns in your work, you may go through
similar feelings to begin with. When the nice theory of a book meets the reality
of your codebase, it can be demoralizing.</em></p>
</div>
<div class="paragraph">
<p><em>My advice is to focus on a specific problem and ask yourself how you can
put the relevant ideas to use, perhaps in an initially limited and imperfect fashion.
You may discover, as I did, that the first problem you pick might be a bit too difficult; if so, move on to something else. Don&#8217;t try to boil the ocean, and don&#8217;t be</em> too
<em>afraid of making mistakes. It will be a learning experience, and you can be confident
that you&#8217;re moving roughly in a direction that others have found useful.</em></p>
</div>
<div class="paragraph">
<p><em>So, if you&#8217;re feeling the pain too, give these ideas a try. Don&#8217;t feel you need permission
to rearchitect everything. Just look for somewhere small to start. And above all, do it
to solve a specific problem. If you&#8217;re successful in solving it, you&#8217;ll know you got something
right—and others will too.</em></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_questions_our_tech_reviewers_asked_that_we_couldnt_work_into_prose">Questions Our Tech Reviewers Asked That We Couldn&#8217;t Work into Prose</h3>
<div class="paragraph">
<p>Here are some questions we heard during drafting that we couldn&#8217;t find a good place to address elsewhere in the book:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Do I need to do all of this at once? Can I just do a bit at a time?</dt>
<dd>
<p>No, you can absolutely adopt these techniques bit by bit. If you have an existing system, we recommend building a service layer to try to keep orchestration in one place. Once you have that, it&#8217;s much easier to push logic into the model and push edge concerns like validation or error handling to the entrypoints.</p>
<div class="paragraph">
<p>It&#8217;s worth having a service layer even if you still have a big, messy Django ORM because it&#8217;s a way to start understanding the boundaries of operations.</p>
</div>
</dd>
<dt class="hdlist1">Extracting use cases will break a lot of my existing code; it&#8217;s too tangled</dt>
<dd>
<p>Just copy and paste. It&#8217;s OK to cause more duplication in the short term. Think of this as a multistep process. Your code is in a bad state now, so copy and paste it to a new place and then make that new code clean and tidy.</p>
<div class="paragraph">
<p>Once you&#8217;ve done that, you can replace uses of the old code with calls to your new code and finally delete the mess. Fixing large codebases is a messy and painful process. Don&#8217;t expect things to get instantly better, and don&#8217;t worry if some bits of your application stay messy.</p>
</div>
</dd>
<dt class="hdlist1">Do I need to do CQRS? That sounds weird. Can&#8217;t I just use repositories?</dt>
<dd>
<p>Of course you can! The techniques we&#8217;re presenting in this book are intended to make your life <em>easier</em>. They&#8217;re not some kind of ascetic discipline with which to punish yourself.</p>
<div class="paragraph">
<p>In our first case-study system, we had a lot of <em>View Builder</em> objects that used repositories to fetch data and then performed some transformations to return dumb read models. The advantage is that when you hit a performance problem, it&#8217;s easy to rewrite a view builder to use custom queries or raw SQL.</p>
</div>
</dd>
<dt class="hdlist1">How should use cases interact across a larger system? Is it a problem for one to call another?</dt>
<dd>
<p>This might be an interim step. Again, in the first case study, we had handlers that would need to invoke other handlers. This gets <em>really</em> messy, though, and it&#8217;s much better to move to using a message bus to separate these concerns.</p>
<div class="paragraph">
<p>Generally, your system will have a single message bus implementation and a bunch of subdomains that center on a particular aggregate or set of aggregates. When your use case has finished, it can raise an event, and a handler elsewhere can run.</p>
</div>
</dd>
<dt class="hdlist1">Is it a code smell for a use case to use multiple repositories/aggregates, and if so, why?</dt>
<dd>
<p>An aggregate is a consistency boundary, so if your use case needs to update two aggregates atomically (within the same transaction), then your consistency boundary is wrong, strictly speaking. Ideally you should think about moving to a new aggregate that wraps up all the things you want to change at the same time.</p>
<div class="paragraph">
<p>If you&#8217;re actually updating only one aggregate and using the other(s) for read-only access, then that&#8217;s <em>fine</em>, although you could consider building a read/view model to get you that data instead&#8212;&#8203;it makes things cleaner if each use case has only one aggregate.</p>
</div>
<div class="paragraph">
<p>If you do need to modify two aggregates, but the two operations don&#8217;t have to be in the same transaction/UoW, then consider splitting the work out into two different handlers and using a domain event to carry information between the two. You can read more in <a href="https://oreil.ly/sufKE">these papers on aggregate design</a> by Vaughn Vernon.</p>
</div>
</dd>
<dt class="hdlist1">What if I have a read-only but business-logic-heavy system?</dt>
<dd>
<p>View models can have complex logic in them. In this book, we&#8217;ve encouraged you to separate your read and write models because they have different consistency and throughput requirements. Mostly, we can use simpler logic for reads, but that&#8217;s not always true. In particular, permissions and authorization models can add a lot of complexity to our read side.</p>
<div class="paragraph">
<p>We&#8217;ve written systems in which the view models needed extensive unit tests. In those systems, we split a <em>view builder</em> from a <em>view fetcher</em>, as in <a href="#view_builder_diagram">A view builder and view fetcher (you can find a high-resolution version of this diagram at cosmicpython.com)</a>.</p>
</div>
</dd>
</dl>
</div>
<div id="view_builder_diagram" class="imageblock">
<div class="content">
<img src="images/apwp_ep06.png" alt="apwp ep06">
</div>
<div class="title">Figure 49. A view builder and view fetcher (you can find a high-resolution version of this diagram at cosmicpython.com)</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_ep06, config=plantuml.cfg]
@startuml View Fetcher Component Diagram
!include images/C4_Component.puml

ComponentDb(db, "Database", "RDBMS")
Component(fetch, "View Fetcher", "Reads data from db, returning list of tuples or dicts")
Component(build, "View Builder", "Filters and maps tuples")
Component(api, "API", "Handles HTTP and serialization concerns")

Rel(api, build, "Invokes")
Rel_R(build, fetch, "Invokes")
Rel_D(fetch, db, "Reads data from")

@enduml</pre>
</div>
</div>
<div class="paragraph">
<p>+
This makes it easy to test the view builder by giving it mocked data (e.g., a list of dicts). "Fancy CQRS" with event handlers is really a way of running our complex view logic whenever we write so that we can avoid running it when we read.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Do I need to build microservices to do this stuff?</dt>
<dd>
<p>Egads, no! These techniques predate microservices by a decade or so. Aggregates,
domain events, and dependency inversion are ways to control complexity in large
systems. It just so happens that when you&#8217;ve built a set of use cases and a model
for a business process, moving it to its own service is relatively easy, but
that&#8217;s not a requirement.</p>
</dd>
<dt class="hdlist1">I&#8217;m using Django. Can I still do this?</dt>
<dd>
<p>We have an entire appendix just for you: <a href="#appendix_django">Repository and Unit of Work <span class="keep-together">Patterns with Django</span></a>!</p>
</dd>
</dl>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="footguns">Footguns</h3>
<div class="paragraph">
<p>OK, so we&#8217;ve given you a whole bunch of new toys to play with. Here&#8217;s the
fine print. Harry and Bob do not recommend that you copy and paste our code into
a production system and rebuild your automated trading platform on Redis
pub/sub. For reasons of brevity and simplicity, we&#8217;ve hand-waved a lot of tricky
subjects. Here&#8217;s a list of things we think you should know before trying this
for real.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Reliable messaging is hard</dt>
<dd>
<p>Redis pub/sub is not reliable and shouldn&#8217;t be used as a general-purpose
messaging tool. We picked it because it&#8217;s familiar and easy to run. At MADE, we
run Event Store as our messaging tool, but we&#8217;ve had experience with RabbitMQ and
Amazon EventBridge.</p>
<div class="paragraph">
<p>Tyler Treat has some excellent blog posts on his site <em>bravenewgeek.com</em>; you
should read at least read <a href="https://oreil.ly/pcstD">"You Cannot Have Exactly-Once Delivery"</a>
and <a href="https://oreil.ly/j8bmF">"What You Want Is What You Don’t: Understanding Trade-Offs in Distributed Messaging"</a>.</p>
</div>
</dd>
<dt class="hdlist1">We explicitly choose small, focused transactions that can fail independently</dt>
<dd>
<p>In <a href="#chapter_08_events_and_message_bus">Events and the Message Bus</a>, we update our process so that <em>deallocating</em> an order line and
<em>reallocating</em> the line happen in two separate units of work.
You will need monitoring to know when these transactions fail, and tooling to
replay events. Some of this is made easier by using a transaction log as your
message broker (e.g., Kafka or <span class="keep-together">EventStore</span>). You might also look at the
<a href="https://oreil.ly/sLfnp">Outbox pattern</a>.</p>
</dd>
<dt class="hdlist1">We don&#8217;t discuss idempotency</dt>
<dd>
<p>We haven&#8217;t given any real thought to what happens when handlers are retried.
In practice you will want to make handlers idempotent so that calling them
repeatedly with the same message will not make repeated changes to state.
This is a key technique for building reliability, because it enables us to
safely retry events when they fail.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>There&#8217;s a lot of good material on idempotent message handling, try starting
with <a href="https://oreil.ly/yERzR">"How to Ensure Idempotency in an Eventual Consistent DDD/CQRS Application"</a> and <a href="https://oreil.ly/Ekuhi">"(Un)Reliability in Messaging"</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Your events will need to change their schema over time</dt>
<dd>
<p>You&#8217;ll need to find some way of documenting your events and sharing schema
with consumers. We like using JSON schema and markdown because it&#8217;s simple but
there is other prior art. Greg Young wrote an entire book on managing event-driven systems over time: <em>Versioning in an Event Sourced System</em> (Leanpub).</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_more_required_reading">More Required Reading</h3>
<div class="paragraph">
<p>A few more books we&#8217;d like to recommend to help you on your way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Clean Architectures in Python</em> by Leonardo Giordani (Leanpub), which came out in 2019, is one of the few previous books on application architecture in Python.</p>
</li>
<li>
<p><em>Enterprise Integration Patterns</em> by Gregor Hohpe and Bobby Woolf (Addison-Wesley Professional) is a pretty good start for messaging patterns.</p>
</li>
<li>
<p><em>Monolith to Microservices</em> by Sam Newman (O&#8217;Reilly), and Newman&#8217;s first book,
<em>Building Microservices</em> (O&#8217;Reilly). The Strangler Fig pattern is mentioned as a
favorite, along with many others. These are good to check out if you&#8217;re thinking of moving to
microservices, and they&#8217;re also good on integration patterns and the considerations
of async messaging-based <span class="keep-together">integration</span>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up_13">Wrap-Up</h3>
<div class="paragraph">
<p>Phew! That&#8217;s a lot of warnings and reading suggestions; we hope we
haven&#8217;t scared you off completely. Our goal with this book is to give you
just enough knowledge and intuition for you to start building some of this
for yourself. We would love to hear how you get on and what problems you&#8217;re
facing with the techniques in your own systems, so why not get in touch with us
over at <em>www.cosmicpython.com</em>?</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix_ds1_table">Appendix B: Summary Diagram and Table</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here&#8217;s what our architecture looks like by the end of the book:</p>
</div>
<div id="recap_diagram" class="imageblock">
<div class="content">
<img src="images/apwp_aa01.png" alt="diagram showing all components: flask+eventconsumer, service layer, adapters, domain etc">
</div>
</div>
<div class="paragraph">
<p><a href="#ds1_table">The components of our architecture and what they all do</a> recaps each pattern and what it does.</p>
</div>
<table id="ds1_table" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 12. The components of our architecture and what they all do</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Layer</th>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" rowspan="5"><div class="content"><div class="paragraph">
<p><strong>Domain</strong></p>
</div>
<div class="paragraph">
<p><em>Defines the business logic.</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A domain object whose attributes may change but that has a recognizable identity over time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An immutable domain object whose attributes entirely define it. It is fungible with other identical objects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aggregate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cluster of associated objects that we treat as a unit for the purpose of data changes. Defines and enforces a consistency boundary.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Represents something that happened.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Command</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Represents a job the system should perform.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3"><div class="content"><div class="paragraph">
<p><strong>Service Layer</strong></p>
</div>
<div class="paragraph">
<p><em>Defines the jobs the system should perform and orchestrates different components.</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Handler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Receives a command or an event and performs what needs to happen.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unit of work</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Abstraction around data integrity. Each unit of work represents an atomic update. Makes repositories available. Tracks new events on retrieved aggregates.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message bus (internal)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Handles commands and events by routing them to the appropriate handler.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="2"><div class="content"><div class="paragraph">
<p><strong>Adapters</strong> (Secondary)</p>
</div>
<div class="paragraph">
<p><em>Concrete implementations of an interface that goes from our system
to the outside world (I/O).</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Repository</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Abstraction around persistent storage. Each aggregate has its own repository.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event publisher</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pushes events onto the external message bus.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="2"><div class="content"><div class="paragraph">
<p><strong>Entrypoints</strong> (Primary adapters)</p>
</div>
<div class="paragraph">
<p><em>Translate external inputs into calls into the service layer.</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Web</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Receives web requests and translates them into commands, passing them to the internal message bus.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event consumer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reads events from the external message bus and translates them into commands, passing them to the internal message bus.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">External message bus (message broker)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A piece of infrastructure that different services use to intercommunicate, via events.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="appendix_project_structure">Appendix C: A Template Project Structure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Around <a href="#chapter_04_service_layer">Our First Use Case: <span class="keep-together">Flask API and Service Layer</span></a>, we moved from just having
everything in one folder to a more structured tree, and we thought it might
be of interest to outline the moving parts.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The code for this appendix is in the
appendix_project_structure branch <a href="https://oreil.ly/1rDRC">on GitHub</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/cosmicpython/code.git
cd code
git checkout appendix_project_structure</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The basic folder structure looks like this:</p>
</div>
<div id="project_tree" class="exampleblock">
<div class="title">Project tree</div>
<div class="content">
<div class="listingblock tree">
<div class="content">
<pre class="pygments highlight"><code data-lang="text"><span></span>.
├── Dockerfile  <i class="conum" data-value="1"></i><b>(1)</b>
├── Makefile  <i class="conum" data-value="2"></i><b>(2)</b>
├── README.md
├── docker-compose.yml  <i class="conum" data-value="1"></i><b>(1)</b>
├── license.txt
├── mypy.ini
├── requirements.txt
├── src  <i class="conum" data-value="3"></i><b>(3)</b>
│   ├── allocation
│   │   ├── __init__.py
│   │   ├── adapters
│   │   │   ├── __init__.py
│   │   │   ├── orm.py
│   │   │   └── repository.py
│   │   ├── config.py
│   │   ├── domain
│   │   │   ├── __init__.py
│   │   │   └── model.py
│   │   ├── entrypoints
│   │   │   ├── __init__.py
│   │   │   └── flask_app.py
│   │   └── service_layer
│   │       ├── __init__.py
│   │       └── services.py
│   └── setup.py  <i class="conum" data-value="3"></i><b>(3)</b>
└── tests  <i class="conum" data-value="4"></i><b>(4)</b>
    ├── conftest.py  <i class="conum" data-value="4"></i><b>(4)</b>
    ├── e2e
    │   └── test_api.py
    ├── integration
    │   ├── test_orm.py
    │   └── test_repository.py
    ├── pytest.ini  <i class="conum" data-value="4"></i><b>(4)</b>
    └── unit
        ├── test_allocate.py
        ├── test_batches.py
        └── test_services.py</code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Our <em>docker-compose.yml</em> and our <em>Dockerfile</em> are the main bits of configuration
for the containers that run our app, and they can also run the tests (for CI).  A
more complex project might have several Dockerfiles, although we&#8217;ve found that
minimizing the number of images is usually a good idea.<sup class="footnote">[<a id="_footnoteref_35" class="footnote" href="#_footnotedef_35" title="View footnote.">35</a>]</sup></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A <em>Makefile</em> provides the entrypoint for all the typical commands a developer
(or a CI server) might want to run during their normal workflow: <code>make
build</code>, <code>make test</code>, and so on.<sup class="footnote">[<a id="_footnoteref_36" class="footnote" href="#_footnotedef_36" title="View footnote.">36</a>]</sup> This is optional. You could just use
<code>docker-compose</code> and <code>pytest</code> directly, but if nothing else, it&#8217;s nice to
have all the "common commands" in a list somewhere, and unlike
documentation, a Makefile is code so it has less tendency to become out of date.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>All the source code for our app, including the domain model, the
Flask app, and infrastructure code, lives in a Python package inside
<em>src</em>,<sup class="footnote">[<a id="_footnoteref_37" class="footnote" href="#_footnotedef_37" title="View footnote.">37</a>]</sup>
which we install using <code>pip install -e</code> and the <em>setup.py</em> file.  This makes
imports easy. Currently, the structure within this module is totally flat,
but for a more complex project, you&#8217;d expect to grow a folder hierarchy
that includes <em>domain_model/</em>, <em>infrastructure/</em>, <em>services/</em>, and <em>api/</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Tests live in their own folder. Subfolders distinguish different test
types and allow you to run them separately.  We can keep shared fixtures
(<em>conftest.py</em>) in the main tests folder and nest more specific ones if we
wish. This is also the place to keep <em>pytest.ini</em>.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <a href="https://oreil.ly/QVb9Q">pytest docs</a> are really good on test layout and importability.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s look at a few of these files and concepts in more detail.</p>
</div>
<div class="sect2">
<h3 id="_env_vars_12_factor_and_config_inside_and_outside_containers">C.1. Env Vars, 12-Factor, and Config, Inside and Outside Containers</h3>
<div class="paragraph">
<p>The basic problem we&#8217;re trying to solve here is that we need different
config settings for the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Running code or tests directly from your own dev machine, perhaps
talking to mapped ports from Docker containers</p>
</li>
<li>
<p>Running on the containers themselves, with "real" ports and hostnames</p>
</li>
<li>
<p>Different container environments (dev, staging, prod, and so on)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Configuration through environment variables as suggested by the
<a href="https://12factor.net/config">12-factor manifesto</a> will solve this problem,
but concretely, how do we implement it in our code and our containers?</p>
</div>
</div>
<div class="sect2">
<h3 id="_config_py">C.2. Config.py</h3>
<div class="paragraph">
<p>Whenever our application code needs access to some config, it&#8217;s going to
get it from a file called <em>config.py</em>. Here are a couple of examples from our
app:</p>
</div>
<div id="config_dot_py" class="exampleblock">
<div class="title">Sample config functions (src/allocation/config.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">import</span> <span class="tok-nn">os</span>

<span class="tok-k">def</span> <span class="tok-nf">get_postgres_uri</span><span class="tok-p">():</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">host</span> <span class="tok-o">=</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s1">&#39;DB_HOST&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;localhost&#39;</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">port</span> <span class="tok-o">=</span> <span class="tok-mi">54321</span> <span class="tok-k">if</span> <span class="tok-n">host</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;localhost&#39;</span> <span class="tok-k">else</span> <span class="tok-mi">5432</span>
    <span class="tok-n">password</span> <span class="tok-o">=</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s1">&#39;DB_PASSWORD&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;abc123&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">user</span><span class="tok-p">,</span> <span class="tok-n">db_name</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;allocation&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;allocation&#39;</span>
    <span class="tok-k">return</span> <span class="tok-n">f</span><span class="tok-s2">&quot;postgresql://{user}:{password}@{host}:{port}/{db_name}&quot;</span>


<span class="tok-k">def</span> <span class="tok-nf">get_api_url</span><span class="tok-p">():</span>
    <span class="tok-n">host</span> <span class="tok-o">=</span> <span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s1">&#39;API_HOST&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;localhost&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">port</span> <span class="tok-o">=</span> <span class="tok-mi">5005</span> <span class="tok-k">if</span> <span class="tok-n">host</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;localhost&#39;</span> <span class="tok-k">else</span> <span class="tok-mi">80</span>
    <span class="tok-k">return</span> <span class="tok-n">f</span><span class="tok-s2">&quot;http://{host}:{port}&quot;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use functions for getting the current config, rather than constants
available at import time, because that allows client code to modify
<code>os.environ</code> if it needs to.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><em>config.py</em> also defines some default settings, designed to work when
running the code from the developer&#8217;s local machine.<sup class="footnote">[<a id="_footnoteref_38" class="footnote" href="#_footnotedef_38" title="View footnote.">38</a>]</sup></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An elegant Python package called
<a href="https://github.com/hynek/environ-config"><em>environ-config</em></a> is worth looking
at if you get tired of hand-rolling your own environment-based config functions.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Don&#8217;t let this config module become a dumping ground that is full of things only vaguely related to config and that is then imported all over the place.
    Keep things immutable and modify them only via environment variables.
    If you decide to use a <a href="#chapter_13_dependency_injection">bootstrap script</a>,
    you can make it the only place (other than tests) that config is imported to.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_docker_compose_and_containers_config">C.3. Docker-Compose and Containers Config</h3>
<div class="paragraph">
<p>We use a lightweight Docker container orchestration tool called <em>docker-compose</em>.
It&#8217;s main configuration is via a YAML file (sigh):<sup class="footnote">[<a id="_footnoteref_39" class="footnote" href="#_footnotedef_39" title="View footnote.">39</a>]</sup></p>
</div>
<div id="docker_compose" class="exampleblock">
<div class="title">docker-compose config file (docker-compose.yml)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">version</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-s">&quot;3&quot;</span>
<span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">services</span><span class="tok-p tok-p-Indicator">:</span>

  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span><span class="tok-p tok-p-Indicator">:</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">build</span><span class="tok-p tok-p-Indicator">:</span>
      <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">context</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">.</span>
      <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">dockerfile</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Dockerfile</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">depends_on</span><span class="tok-p tok-p-Indicator">:</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">postgres</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">environment</span><span class="tok-p tok-p-Indicator">:</span>  <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">DB_HOST=postgres</span>  <i class="conum" data-value="4"></i><b>(4)</b>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">DB_PASSWORD=abc123</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">API_HOST=app</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">PYTHONDONTWRITEBYTECODE=1</span>  <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">volumes</span><span class="tok-p tok-p-Indicator">:</span>  <i class="conum" data-value="6"></i><b>(6)</b>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">./src:/src</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">./tests:/tests</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ports</span><span class="tok-p tok-p-Indicator">:</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&quot;5005:80&quot;</span>  <i class="conum" data-value="7"></i><b>(7)</b>


  <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">postgres</span><span class="tok-p tok-p-Indicator">:</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">image</span><span class="tok-p tok-p-Indicator">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">postgres:9.6</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">environment</span><span class="tok-p tok-p-Indicator">:</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">POSTGRES_USER=allocation</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">POSTGRES_PASSWORD=abc123</span>
    <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ports</span><span class="tok-p tok-p-Indicator">:</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-s">&quot;54321:5432&quot;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In the <em>docker-compose</em> file, we define the different <em>services</em>
(containers) that we need for our app. Usually one main image
contains all our code, and we can use it to run our API, our tests,
or any other service that needs access to the domain model.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You&#8217;ll probably have other infrastructure services, including a database.
In production you might not use containers for this; you might have a cloud
provider instead, but <em>docker-compose</em> gives us a way of producing a
similar service for dev or CI.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>environment</code> stanza lets you set the environment variables for your
containers, the hostnames and ports as seen from inside the Docker cluster.
If you have enough containers that information starts to be duplicated in
these sections, you can use <code>environment_file</code> instead. We usually call
ours <em>container.env</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Inside a cluster, <em>docker-compose</em> sets up networking such that containers are
available to each other via hostnames named after their service name.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Pro tip: if you&#8217;re mounting volumes to share source folders between your
local dev machine and the container, the <code>PYTHONDONTWRITEBYTECODE</code> environment variable
tells Python to not write <em>.pyc</em> files, and that will save you from
having millions of root-owned files sprinkled all over your local filesystem,
being all annoying to delete and causing weird Python compiler errors besides.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Mounting our source and test code as <code>volumes</code> means we don&#8217;t need to rebuild
our containers every time we make a code change.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The <code>ports</code> section allows us to expose the ports from inside the containers
to the outside world<sup class="footnote">[<a id="_footnoteref_40" class="footnote" href="#_footnotedef_40" title="View footnote.">40</a>]</sup>—these correspond to the default ports we set
in <em>config.py</em>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Inside Docker, other containers are available through hostnames named after
    their service name. Outside Docker, they are available on <code>localhost</code>, at the
    port defined in the <code>ports</code> section.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_installing_your_source_as_a_package">C.4. Installing Your Source as a Package</h3>
<div class="paragraph">
<p>All our application code (everything except tests, really) lives inside an
<em>src</em> folder:</p>
</div>
<div id="src_folder_tree" class="exampleblock">
<div class="title">The src folder</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="text"><span></span>├── src
│   ├── allocation  <i class="conum" data-value="1"></i><b>(1)</b>
│   │   ├── config.py
│   │   └── ...
│   └── setup.py  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Subfolders define top-level module names. You can have multiple if you like.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>And <em>setup.py</em> is the file you need to make it pip-installable, shown next.</td>
</tr>
</table>
</div>
<div id="setup_dot_py" class="exampleblock">
<div class="title">pip-installable modules in three lines (src/setup.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">setuptools</span> <span class="tok-kn">import</span> <span class="tok-n">setup</span>

<span class="tok-n">setup</span><span class="tok-p">(</span>
    <span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s1">&#39;allocation&#39;</span><span class="tok-p">,</span>
    <span class="tok-n">version</span><span class="tok-o">=</span><span class="tok-s1">&#39;0.1&#39;</span><span class="tok-p">,</span>
    <span class="tok-n">packages</span><span class="tok-o">=</span><span class="tok-p">[</span><span class="tok-s1">&#39;allocation&#39;</span><span class="tok-p">],</span>
<span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s all you need. <code>packages=</code> specifies the names of subfolders that you
want to install as top-level modules. The <code>name</code> entry is just cosmetic, but
it&#8217;s required. For a package that&#8217;s never actually going to hit PyPI, it&#8217;ll
do fine.<sup class="footnote">[<a id="_footnoteref_41" class="footnote" href="#_footnotedef_41" title="View footnote.">41</a>]</sup></p>
</div>
</div>
<div class="sect2">
<h3 id="_dockerfile">C.5. Dockerfile</h3>
<div class="paragraph">
<p>Dockerfiles are going to be very project-specific, but here are a few key stages
you&#8217;ll expect to see:</p>
</div>
<div id="dockerfile" class="exampleblock">
<div class="title">Our Dockerfile (Dockerfile)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="dockerfile"><span></span><span class="tok-k">FROM</span><span class="tok-s"> python:3.8-alpine</span>

<i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-k">RUN</span> apk add --no-cache --virtual .build-deps gcc postgresql-dev musl-dev python3-dev
<span class="tok-k">RUN</span> apk add libpq

<i class="conum" data-value="2"></i><b>(2)</b>
COPY requirements.txt /tmp/
<span class="tok-k">RUN</span> pip install -r /tmp/requirements.txt

<span class="tok-k">RUN</span> apk del --no-cache .build-deps

<i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-k">RUN</span> mkdir -p /src
COPY src/ /src/
<span class="tok-k">RUN</span> pip install -e /src
COPY tests/ /tests/

<i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-k">WORKDIR</span><span class="tok-s"> /src</span>
<span class="tok-k">ENV</span><span class="tok-s"> FLASK_APP=allocation/entrypoints/flask_app.py FLASK_DEBUG=1 PYTHONUNBUFFERED=1</span>
<span class="tok-k">CMD</span><span class="tok-s"> flask run --host=0.0.0.0 --port=80</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Installing system-level dependencies</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Installing our Python dependencies (you may want to split out your dev from
prod dependencies; we haven&#8217;t here, for simplicity)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Copying and installing our source</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Optionally configuring a default startup command (you&#8217;ll probably override
this a lot from the command line)</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
One thing to note is that we install things in the order of how frequently they
    are likely to change. This allows us to maximize Docker build cache reuse. I
    can&#8217;t tell you how much pain and frustration underlies this lesson. For this
    and many more Python Dockerfile improvement tips, check out
    <a href="https://pythonspeed.com/docker">"Production-Ready Docker Packaging"</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_tests">C.6. Tests</h3>
<div class="paragraph">
<p>Our tests are kept alongside everything else, as shown here:</p>
</div>
<div id="tests_folder" class="exampleblock">
<div class="title">Tests folder tree</div>
<div class="content">
<div class="listingblock tree">
<div class="content">
<pre class="pygments highlight"><code data-lang="text"><span></span>└── tests
    ├── conftest.py
    ├── e2e
    │   └── test_api.py
    ├── integration
    │   ├── test_orm.py
    │   └── test_repository.py
    ├── pytest.ini
    └── unit
        ├── test_allocate.py
        ├── test_batches.py
        └── test_services.py</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Nothing particularly clever here, just some separation of different test types
that you&#8217;re likely to want to run separately, and some files for common fixtures,
config, and so on.</p>
</div>
<div class="paragraph">
<p>There&#8217;s no <em>src</em> folder or <em>setup.py</em> in the test folders because we usually
haven&#8217;t needed to make tests pip-installable, but if you have difficulties with
import paths, you might find it helps.</p>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up_14">C.7. Wrap-Up</h3>
<div class="paragraph">
<p>These are our basic building blocks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Source code in an <em>src</em> folder, pip-installable using <em>setup.py</em></p>
</li>
<li>
<p>Some Docker config for spinning up a local cluster that mirrors production as far as possible</p>
</li>
<li>
<p>Configuration via environment variables, centralized in a Python file called <em>config.py</em>, with defaults allowing things to run <em>outside</em> containers</p>
</li>
<li>
<p>A Makefile for useful command-line, um, commands</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We doubt that anyone will end up with <em>exactly</em> the same solutions we did, but we hope you
find some inspiration here.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix_csvs">Appendix D: Swapping Out the Infrastructure: <span class="keep-together">Do Everything with CSVs</span></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This appendix is intended as a little illustration of the benefits of the
Repository, Unit of Work, and Service Layer patterns. It&#8217;s intended to
follow from <a href="#chapter_06_uow">Unit of Work Pattern</a>.</p>
</div>
<div class="paragraph">
<p>Just as we finish building out our Flask API and getting it ready for release,
the business comes to us apologetically, saying they&#8217;re not ready to use our API
and asking if we could build a thing that reads just batches and orders from a couple of
CSVs and outputs a third CSV with allocations.</p>
</div>
<div class="paragraph">
<p>Ordinarily this is the kind of thing that might have a team cursing and spitting
and making notes for their memoirs.  But not us!  Oh no, we&#8217;ve ensured that
our infrastructure concerns are nicely decoupled from our domain model and
service layer.  Switching to CSVs will be a simple matter of writing a couple
of new <code>Repository</code> and <code>UnitOfWork</code> classes, and then we&#8217;ll be able to reuse
<em>all</em> of our logic from the domain layer and the service layer.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an E2E test to show you how the CSVs flow in and out:</p>
</div>
<div id="first_csv_test" class="exampleblock">
<div class="title">A first CSV test (tests/e2e/test_csv.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_cli_app_reads_csvs_with_batches_and_orders_and_outputs_allocations</span><span class="tok-p">(</span>
        <span class="tok-n">make_csv</span>
<span class="tok-p">):</span>
    <span class="tok-n">sku1</span><span class="tok-p">,</span> <span class="tok-n">sku2</span> <span class="tok-o">=</span> <span class="tok-n">random_ref</span><span class="tok-p">(</span><span class="tok-s1">&#39;s1&#39;</span><span class="tok-p">),</span> <span class="tok-n">random_ref</span><span class="tok-p">(</span><span class="tok-s1">&#39;s2&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">batch1</span><span class="tok-p">,</span> <span class="tok-n">batch2</span><span class="tok-p">,</span> <span class="tok-n">batch3</span> <span class="tok-o">=</span> <span class="tok-n">random_ref</span><span class="tok-p">(</span><span class="tok-s1">&#39;b1&#39;</span><span class="tok-p">),</span> <span class="tok-n">random_ref</span><span class="tok-p">(</span><span class="tok-s1">&#39;b2&#39;</span><span class="tok-p">),</span> <span class="tok-n">random_ref</span><span class="tok-p">(</span><span class="tok-s1">&#39;b3&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">order_ref</span> <span class="tok-o">=</span> <span class="tok-n">random_ref</span><span class="tok-p">(</span><span class="tok-s1">&#39;o&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">make_csv</span><span class="tok-p">(</span><span class="tok-s1">&#39;batches.csv&#39;</span><span class="tok-p">,</span> <span class="tok-p">[</span>
        <span class="tok-p">[</span><span class="tok-s1">&#39;ref&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;eta&#39;</span><span class="tok-p">],</span>
        <span class="tok-p">[</span><span class="tok-n">batch1</span><span class="tok-p">,</span> <span class="tok-n">sku1</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">],</span>
        <span class="tok-p">[</span><span class="tok-n">batch2</span><span class="tok-p">,</span> <span class="tok-n">sku2</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-s1">&#39;2011-01-01&#39;</span><span class="tok-p">],</span>
        <span class="tok-p">[</span><span class="tok-n">batch3</span><span class="tok-p">,</span> <span class="tok-n">sku2</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-s1">&#39;2011-01-02&#39;</span><span class="tok-p">],</span>
    <span class="tok-p">])</span>
    <span class="tok-n">orders_csv</span> <span class="tok-o">=</span> <span class="tok-n">make_csv</span><span class="tok-p">(</span><span class="tok-s1">&#39;orders.csv&#39;</span><span class="tok-p">,</span> <span class="tok-p">[</span>
        <span class="tok-p">[</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">],</span>
        <span class="tok-p">[</span><span class="tok-n">order_ref</span><span class="tok-p">,</span> <span class="tok-n">sku1</span><span class="tok-p">,</span> <span class="tok-mi">3</span><span class="tok-p">],</span>
        <span class="tok-p">[</span><span class="tok-n">order_ref</span><span class="tok-p">,</span> <span class="tok-n">sku2</span><span class="tok-p">,</span> <span class="tok-mi">12</span><span class="tok-p">],</span>
    <span class="tok-p">])</span>

    <span class="tok-n">run_cli_script</span><span class="tok-p">(</span><span class="tok-n">orders_csv</span><span class="tok-o">.</span><span class="tok-n">parent</span><span class="tok-p">)</span>

    <span class="tok-n">expected_output_csv</span> <span class="tok-o">=</span> <span class="tok-n">orders_csv</span><span class="tok-o">.</span><span class="tok-n">parent</span> <span class="tok-o">/</span> <span class="tok-s1">&#39;allocations.csv&#39;</span>
    <span class="tok-k">with</span> <span class="tok-nb">open</span><span class="tok-p">(</span><span class="tok-n">expected_output_csv</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-n">f</span><span class="tok-p">:</span>
        <span class="tok-n">rows</span> <span class="tok-o">=</span> <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-n">csv</span><span class="tok-o">.</span><span class="tok-n">reader</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">))</span>
    <span class="tok-k">assert</span> <span class="tok-n">rows</span> <span class="tok-o">==</span> <span class="tok-p">[</span>
        <span class="tok-p">[</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">],</span>
        <span class="tok-p">[</span><span class="tok-n">order_ref</span><span class="tok-p">,</span> <span class="tok-n">sku1</span><span class="tok-p">,</span> <span class="tok-s1">&#39;3&#39;</span><span class="tok-p">,</span> <span class="tok-n">batch1</span><span class="tok-p">],</span>
        <span class="tok-p">[</span><span class="tok-n">order_ref</span><span class="tok-p">,</span> <span class="tok-n">sku2</span><span class="tok-p">,</span> <span class="tok-s1">&#39;12&#39;</span><span class="tok-p">,</span> <span class="tok-n">batch2</span><span class="tok-p">],</span>
    <span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Diving in and implementing without thinking about repositories and all
that jazz, you might start with something like this:</p>
</div>
<div id="first_cut_csvs" class="exampleblock">
<div class="title">A first cut of our CSV reader/writer (src/bin/allocate-from-csv)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-ch">#!/usr/bin/env python</span>
<span class="tok-kn">import</span> <span class="tok-nn">csv</span>
<span class="tok-kn">import</span> <span class="tok-nn">sys</span>
<span class="tok-kn">from</span> <span class="tok-nn">datetime</span> <span class="tok-kn">import</span> <span class="tok-n">datetime</span>
<span class="tok-kn">from</span> <span class="tok-nn">pathlib</span> <span class="tok-kn">import</span> <span class="tok-n">Path</span>

<span class="tok-kn">from</span> <span class="tok-nn">allocation</span> <span class="tok-kn">import</span> <span class="tok-n">model</span>

<span class="tok-k">def</span> <span class="tok-nf">load_batches</span><span class="tok-p">(</span><span class="tok-n">batches_path</span><span class="tok-p">):</span>
    <span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>
    <span class="tok-k">with</span> <span class="tok-n">batches_path</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">()</span> <span class="tok-k">as</span> <span class="tok-n">inf</span><span class="tok-p">:</span>
        <span class="tok-n">reader</span> <span class="tok-o">=</span> <span class="tok-n">csv</span><span class="tok-o">.</span><span class="tok-n">DictReader</span><span class="tok-p">(</span><span class="tok-n">inf</span><span class="tok-p">)</span>
        <span class="tok-k">for</span> <span class="tok-n">row</span> <span class="tok-ow">in</span> <span class="tok-n">reader</span><span class="tok-p">:</span>
            <span class="tok-k">if</span> <span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;eta&#39;</span><span class="tok-p">]:</span>
                <span class="tok-n">eta</span> <span class="tok-o">=</span> <span class="tok-n">datetime</span><span class="tok-o">.</span><span class="tok-n">strptime</span><span class="tok-p">(</span><span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;eta&#39;</span><span class="tok-p">],</span> <span class="tok-s1">&#39;%Y-%m-</span><span class="tok-si">%d</span><span class="tok-s1">&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">date</span><span class="tok-p">()</span>
            <span class="tok-k">else</span><span class="tok-p">:</span>
                <span class="tok-n">eta</span> <span class="tok-o">=</span> <span class="tok-bp">None</span>
            <span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span>
                <span class="tok-n">ref</span><span class="tok-o">=</span><span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;ref&#39;</span><span class="tok-p">],</span>
                <span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">],</span>
                <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">]),</span>
                <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">eta</span>
            <span class="tok-p">))</span>
    <span class="tok-k">return</span> <span class="tok-n">batches</span>



<span class="tok-k">def</span> <span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-n">folder</span><span class="tok-p">):</span>
    <span class="tok-n">batches_path</span> <span class="tok-o">=</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">folder</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-s1">&#39;batches.csv&#39;</span>
    <span class="tok-n">orders_path</span> <span class="tok-o">=</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">folder</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-s1">&#39;orders.csv&#39;</span>
    <span class="tok-n">allocations_path</span> <span class="tok-o">=</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">folder</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-s1">&#39;allocations.csv&#39;</span>

    <span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">load_batches</span><span class="tok-p">(</span><span class="tok-n">batches_path</span><span class="tok-p">)</span>

    <span class="tok-k">with</span> <span class="tok-n">orders_path</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">()</span> <span class="tok-k">as</span> <span class="tok-n">inf</span><span class="tok-p">,</span> <span class="tok-n">allocations_path</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-s1">&#39;w&#39;</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-n">outf</span><span class="tok-p">:</span>
        <span class="tok-n">reader</span> <span class="tok-o">=</span> <span class="tok-n">csv</span><span class="tok-o">.</span><span class="tok-n">DictReader</span><span class="tok-p">(</span><span class="tok-n">inf</span><span class="tok-p">)</span>
        <span class="tok-n">writer</span> <span class="tok-o">=</span> <span class="tok-n">csv</span><span class="tok-o">.</span><span class="tok-n">writer</span><span class="tok-p">(</span><span class="tok-n">outf</span><span class="tok-p">)</span>
        <span class="tok-n">writer</span><span class="tok-o">.</span><span class="tok-n">writerow</span><span class="tok-p">([</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">])</span>
        <span class="tok-k">for</span> <span class="tok-n">row</span> <span class="tok-ow">in</span> <span class="tok-n">reader</span><span class="tok-p">:</span>
            <span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">],</span> <span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">]</span>
            <span class="tok-n">qty</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">])</span>
            <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">)</span>
            <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">)</span>
            <span class="tok-n">writer</span><span class="tok-o">.</span><span class="tok-n">writerow</span><span class="tok-p">([</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">batchref</span><span class="tok-p">])</span>



<span class="tok-k">if</span> <span class="tok-vm">__name__</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;__main__&#39;</span><span class="tok-p">:</span>
    <span class="tok-n">main</span><span class="tok-p">(</span><span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">argv</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">])</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s not looking too bad! And we&#8217;re reusing our domain model objects
and our domain service.</p>
</div>
<div class="paragraph">
<p>But it&#8217;s not going to work. Existing allocations need to also be part
of our permanent CSV storage. We can write a second test to force us to improve
things:</p>
</div>
<div id="second_csv_test" class="exampleblock">
<div class="title">And another one, with existing allocations (tests/e2e/test_csv.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_cli_app_also_reads_existing_allocations_and_can_append_to_them</span><span class="tok-p">(</span>
        <span class="tok-n">make_csv</span>
<span class="tok-p">):</span>
    <span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">random_ref</span><span class="tok-p">(</span><span class="tok-s1">&#39;s&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">batch1</span><span class="tok-p">,</span> <span class="tok-n">batch2</span> <span class="tok-o">=</span> <span class="tok-n">random_ref</span><span class="tok-p">(</span><span class="tok-s1">&#39;b1&#39;</span><span class="tok-p">),</span> <span class="tok-n">random_ref</span><span class="tok-p">(</span><span class="tok-s1">&#39;b2&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">old_order</span><span class="tok-p">,</span> <span class="tok-n">new_order</span> <span class="tok-o">=</span> <span class="tok-n">random_ref</span><span class="tok-p">(</span><span class="tok-s1">&#39;o1&#39;</span><span class="tok-p">),</span> <span class="tok-n">random_ref</span><span class="tok-p">(</span><span class="tok-s1">&#39;o2&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">make_csv</span><span class="tok-p">(</span><span class="tok-s1">&#39;batches.csv&#39;</span><span class="tok-p">,</span> <span class="tok-p">[</span>
        <span class="tok-p">[</span><span class="tok-s1">&#39;ref&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;eta&#39;</span><span class="tok-p">],</span>
        <span class="tok-p">[</span><span class="tok-n">batch1</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-s1">&#39;2011-01-01&#39;</span><span class="tok-p">],</span>
        <span class="tok-p">[</span><span class="tok-n">batch2</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-s1">&#39;2011-01-02&#39;</span><span class="tok-p">],</span>
    <span class="tok-p">])</span>
    <span class="tok-n">make_csv</span><span class="tok-p">(</span><span class="tok-s1">&#39;allocations.csv&#39;</span><span class="tok-p">,</span> <span class="tok-p">[</span>
        <span class="tok-p">[</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">],</span>
        <span class="tok-p">[</span><span class="tok-n">old_order</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-n">batch1</span><span class="tok-p">],</span>
    <span class="tok-p">])</span>
    <span class="tok-n">orders_csv</span> <span class="tok-o">=</span> <span class="tok-n">make_csv</span><span class="tok-p">(</span><span class="tok-s1">&#39;orders.csv&#39;</span><span class="tok-p">,</span> <span class="tok-p">[</span>
        <span class="tok-p">[</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">],</span>
        <span class="tok-p">[</span><span class="tok-n">new_order</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">7</span><span class="tok-p">],</span>
    <span class="tok-p">])</span>

    <span class="tok-n">run_cli_script</span><span class="tok-p">(</span><span class="tok-n">orders_csv</span><span class="tok-o">.</span><span class="tok-n">parent</span><span class="tok-p">)</span>

    <span class="tok-n">expected_output_csv</span> <span class="tok-o">=</span> <span class="tok-n">orders_csv</span><span class="tok-o">.</span><span class="tok-n">parent</span> <span class="tok-o">/</span> <span class="tok-s1">&#39;allocations.csv&#39;</span>
    <span class="tok-k">with</span> <span class="tok-nb">open</span><span class="tok-p">(</span><span class="tok-n">expected_output_csv</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-n">f</span><span class="tok-p">:</span>
        <span class="tok-n">rows</span> <span class="tok-o">=</span> <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-n">csv</span><span class="tok-o">.</span><span class="tok-n">reader</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">))</span>
    <span class="tok-k">assert</span> <span class="tok-n">rows</span> <span class="tok-o">==</span> <span class="tok-p">[</span>
        <span class="tok-p">[</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">],</span>
        <span class="tok-p">[</span><span class="tok-n">old_order</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-s1">&#39;10&#39;</span><span class="tok-p">,</span> <span class="tok-n">batch1</span><span class="tok-p">],</span>
        <span class="tok-p">[</span><span class="tok-n">new_order</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-s1">&#39;7&#39;</span><span class="tok-p">,</span> <span class="tok-n">batch2</span><span class="tok-p">],</span>
    <span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And we could keep hacking about and adding extra lines to that <code>load_batches</code> function,
and some sort of way of tracking and saving new allocations—but we already have a model for doing that! It&#8217;s called our Repository and Unit of Work patterns.</p>
</div>
<div class="paragraph">
<p>All we need to do ("all we need to do") is reimplement those same abstractions, but
with CSVs underlying them instead of a database. And as you&#8217;ll see, it really is relatively straightforward.</p>
</div>
<div class="sect2">
<h3 id="_implementing_a_repository_and_unit_of_work_for_csvs">D.1. Implementing a Repository and Unit of Work for CSVs</h3>
<div class="paragraph">
<p>Here&#8217;s what a CSV-based repository could look like.  It abstracts away all the
logic for reading CSVs from disk, including the fact that it has to read <em>two
different CSVs</em> (one for batches and one for allocations), and it gives us just
the familiar <code>.list()</code> API, which provides the illusion of an in-memory
collection of domain objects:</p>
</div>
<div id="csv_repository" class="exampleblock">
<div class="title">A repository that uses CSV as its storage mechanism (src/allocation/service_layer/csv_uow.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">CsvRepository</span><span class="tok-p">(</span><span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">AbstractRepository</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">folder</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_batches_path</span> <span class="tok-o">=</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">folder</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-s1">&#39;batches.csv&#39;</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_allocations_path</span> <span class="tok-o">=</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">folder</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-s1">&#39;allocations.csv&#39;</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_batches</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>  <span class="tok-c1"># type: Dict[str, model.Batch]</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_load</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-nf">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">reference</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_batches</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">reference</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">add</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">batch</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_batches</span><span class="tok-p">[</span><span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">reference</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">batch</span>

    <span class="tok-k">def</span> <span class="tok-nf">_load</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">with</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_batches_path</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">()</span> <span class="tok-k">as</span> <span class="tok-n">f</span><span class="tok-p">:</span>
            <span class="tok-n">reader</span> <span class="tok-o">=</span> <span class="tok-n">csv</span><span class="tok-o">.</span><span class="tok-n">DictReader</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">)</span>
            <span class="tok-k">for</span> <span class="tok-n">row</span> <span class="tok-ow">in</span> <span class="tok-n">reader</span><span class="tok-p">:</span>
                <span class="tok-n">ref</span><span class="tok-p">,</span> <span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;ref&#39;</span><span class="tok-p">],</span> <span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">]</span>
                <span class="tok-n">qty</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">])</span>
                <span class="tok-k">if</span> <span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;eta&#39;</span><span class="tok-p">]:</span>
                    <span class="tok-n">eta</span> <span class="tok-o">=</span> <span class="tok-n">datetime</span><span class="tok-o">.</span><span class="tok-n">strptime</span><span class="tok-p">(</span><span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;eta&#39;</span><span class="tok-p">],</span> <span class="tok-s1">&#39;%Y-%m-</span><span class="tok-si">%d</span><span class="tok-s1">&#39;</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">date</span><span class="tok-p">()</span>
                <span class="tok-k">else</span><span class="tok-p">:</span>
                    <span class="tok-n">eta</span> <span class="tok-o">=</span> <span class="tok-bp">None</span>
                <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_batches</span><span class="tok-p">[</span><span class="tok-n">ref</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span>
                    <span class="tok-n">ref</span><span class="tok-o">=</span><span class="tok-n">ref</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">eta</span>
                <span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_allocations_path</span><span class="tok-o">.</span><span class="tok-n">exists</span><span class="tok-p">()</span> <span class="tok-ow">is</span> <span class="tok-bp">False</span><span class="tok-p">:</span>
            <span class="tok-k">return</span>
        <span class="tok-k">with</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_allocations_path</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">()</span> <span class="tok-k">as</span> <span class="tok-n">f</span><span class="tok-p">:</span>
            <span class="tok-n">reader</span> <span class="tok-o">=</span> <span class="tok-n">csv</span><span class="tok-o">.</span><span class="tok-n">DictReader</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">)</span>
            <span class="tok-k">for</span> <span class="tok-n">row</span> <span class="tok-ow">in</span> <span class="tok-n">reader</span><span class="tok-p">:</span>
                <span class="tok-n">batchref</span><span class="tok-p">,</span> <span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">],</span> <span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">],</span> <span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">]</span>
                <span class="tok-n">qty</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">])</span>
                <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">)</span>
                <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_batches</span><span class="tok-p">[</span><span class="tok-n">batchref</span><span class="tok-p">]</span>
                <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">_allocations</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_batches</span><span class="tok-o">.</span><span class="tok-n">values</span><span class="tok-p">())</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And here&#8217;s what a UoW for CSVs would look like:</p>
</div>
<div id="csvs_uow" class="exampleblock">
<div class="title">A UoW for CSVs: commit = csv.writer (src/allocation/service_layer/csv_uow.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">CsvUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">folder</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">CsvRepository</span><span class="tok-p">(</span><span class="tok-n">folder</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">commit</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">with</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">_allocations_path</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">(</span><span class="tok-s1">&#39;w&#39;</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-n">f</span><span class="tok-p">:</span>
            <span class="tok-n">writer</span> <span class="tok-o">=</span> <span class="tok-n">csv</span><span class="tok-o">.</span><span class="tok-n">writer</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">)</span>
            <span class="tok-n">writer</span><span class="tok-o">.</span><span class="tok-n">writerow</span><span class="tok-p">([</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">])</span>
            <span class="tok-k">for</span> <span class="tok-n">batch</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">list</span><span class="tok-p">():</span>
                <span class="tok-k">for</span> <span class="tok-n">line</span> <span class="tok-ow">in</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">_allocations</span><span class="tok-p">:</span>
                    <span class="tok-n">writer</span><span class="tok-o">.</span><span class="tok-n">writerow</span><span class="tok-p">(</span>
                        <span class="tok-p">[</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">reference</span><span class="tok-p">]</span>
                    <span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">rollback</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">pass</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And once we have that, our CLI app for reading and writing batches
and allocations to CSV is pared down to what it should be—a bit
of code for reading order lines, and a bit of code that invokes our
<em>existing</em> service layer:</p>
</div>
<div id="final_cli" class="exampleblock nobreakinside less_space">
<div class="title">Allocation with CSVs in nine lines (src/bin/allocate-from-csv)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">main</span><span class="tok-p">(</span><span class="tok-n">folder</span><span class="tok-p">):</span>
    <span class="tok-n">orders_path</span> <span class="tok-o">=</span> <span class="tok-n">Path</span><span class="tok-p">(</span><span class="tok-n">folder</span><span class="tok-p">)</span> <span class="tok-o">/</span> <span class="tok-s1">&#39;orders.csv&#39;</span>
    <span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">csv_uow</span><span class="tok-o">.</span><span class="tok-n">CsvUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">folder</span><span class="tok-p">)</span>
    <span class="tok-k">with</span> <span class="tok-n">orders_path</span><span class="tok-o">.</span><span class="tok-n">open</span><span class="tok-p">()</span> <span class="tok-k">as</span> <span class="tok-n">f</span><span class="tok-p">:</span>
        <span class="tok-n">reader</span> <span class="tok-o">=</span> <span class="tok-n">csv</span><span class="tok-o">.</span><span class="tok-n">DictReader</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-p">)</span>
        <span class="tok-k">for</span> <span class="tok-n">row</span> <span class="tok-ow">in</span> <span class="tok-n">reader</span><span class="tok-p">:</span>
            <span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">],</span> <span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">]</span>
            <span class="tok-n">qty</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">row</span><span class="tok-p">[</span><span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">])</span>
            <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Ta-da! <em>Now are y&#8217;all impressed or what</em>?</p>
</div>
<div class="paragraph">
<p>Much love,</p>
</div>
<div class="paragraph">
<p>Bob and Harry</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix_django">Appendix E: Repository and Unit of Work <span class="keep-together">Patterns with Django</span></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Suppose you wanted to use Django instead of SQLAlchemy and Flask. How
might things look? The first thing is to choose where to install it. We put it in a separate
package next to our main allocation code:</p>
</div>
<div id="django_tree" class="exampleblock">
<div class="content">
<div class="listingblock tree">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-err">├──</span> <span class="tok-n">src</span>
<span class="tok-err">│  </span> <span class="tok-err">├──</span> <span class="tok-n">allocation</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">├──</span> <span class="tok-fm">__init__</span><span class="tok-o">.</span><span class="tok-n">py</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">├──</span> <span class="tok-n">adapters</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">├──</span> <span class="tok-fm">__init__</span><span class="tok-o">.</span><span class="tok-n">py</span>
<span class="tok-o">...</span>
<span class="tok-err">│  </span> <span class="tok-err">├──</span> <span class="tok-n">djangoproject</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">├──</span> <span class="tok-n">alloc</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">├──</span> <span class="tok-fm">__init__</span><span class="tok-o">.</span><span class="tok-n">py</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">├──</span> <span class="tok-n">apps</span><span class="tok-o">.</span><span class="tok-n">py</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">├──</span> <span class="tok-n">migrations</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">├──</span> <span class="tok-mo">0001</span><span class="tok-n">_initial</span><span class="tok-o">.</span><span class="tok-n">py</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">└──</span> <span class="tok-fm">__init__</span><span class="tok-o">.</span><span class="tok-n">py</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">├──</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">py</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">└──</span> <span class="tok-n">views</span><span class="tok-o">.</span><span class="tok-n">py</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">├──</span> <span class="tok-n">django_project</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">├──</span> <span class="tok-fm">__init__</span><span class="tok-o">.</span><span class="tok-n">py</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">├──</span> <span class="tok-n">settings</span><span class="tok-o">.</span><span class="tok-n">py</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">├──</span> <span class="tok-n">urls</span><span class="tok-o">.</span><span class="tok-n">py</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">└──</span> <span class="tok-n">wsgi</span><span class="tok-o">.</span><span class="tok-n">py</span>
<span class="tok-err">│  </span> <span class="tok-err">│  </span> <span class="tok-err">└──</span> <span class="tok-n">manage</span><span class="tok-o">.</span><span class="tok-n">py</span>
<span class="tok-err">│  </span> <span class="tok-err">└──</span> <span class="tok-n">setup</span><span class="tok-o">.</span><span class="tok-n">py</span>
<span class="tok-err">└──</span> <span class="tok-n">tests</span>
    <span class="tok-err">├──</span> <span class="tok-n">conftest</span><span class="tok-o">.</span><span class="tok-n">py</span>
    <span class="tok-err">├──</span> <span class="tok-n">e2e</span>
    <span class="tok-err">│  </span> <span class="tok-err">└──</span> <span class="tok-n">test_api</span><span class="tok-o">.</span><span class="tok-n">py</span>
    <span class="tok-err">├──</span> <span class="tok-n">integration</span>
    <span class="tok-err">│  </span> <span class="tok-err">├──</span> <span class="tok-n">test_repository</span><span class="tok-o">.</span><span class="tok-n">py</span>
<span class="tok-o">...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The code for this appendix is in the
appendix_django branch <a href="https://oreil.ly/A-I76">on GitHub</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/cosmicpython/code.git
cd code
git checkout appendix_django</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_repository_pattern_with_django">E.1. Repository Pattern with Django</h3>
<div class="paragraph">
<p>We used a plug-in called
<a href="https://github.com/pytest-dev/pytest-django"><code>pytest-django</code></a> to help with test
database management.</p>
</div>
<div class="paragraph">
<p>Rewriting the first repository test was a minimal change—just rewriting
some raw SQL with a call to the Django ORM/QuerySet language:</p>
</div>
<div id="django_repo_test1" class="exampleblock">
<div class="title">First repository test adapted (tests/integration/test_repository.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">djangoproject.alloc</span> <span class="tok-kn">import</span> <span class="tok-n">models</span> <span class="tok-k">as</span> <span class="tok-n">django_models</span>


<span class="tok-nd">@pytest.mark.django_db</span>
<span class="tok-k">def</span> <span class="tok-nf">test_repository_can_save_a_batch</span><span class="tok-p">():</span>
    <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">,</span> <span class="tok-s2">&quot;RUSTY-SOAPDISH&quot;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">date</span><span class="tok-p">(</span><span class="tok-mi">2011</span><span class="tok-p">,</span> <span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">25</span><span class="tok-p">))</span>

    <span class="tok-n">repo</span> <span class="tok-o">=</span> <span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">DjangoRepository</span><span class="tok-p">()</span>
    <span class="tok-n">repo</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">batch</span><span class="tok-p">)</span>

    <span class="tok-p">[</span><span class="tok-n">saved_batch</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">django_models</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()</span>
    <span class="tok-k">assert</span> <span class="tok-n">saved_batch</span><span class="tok-o">.</span><span class="tok-n">reference</span> <span class="tok-o">==</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">reference</span>
    <span class="tok-k">assert</span> <span class="tok-n">saved_batch</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">==</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">sku</span>
    <span class="tok-k">assert</span> <span class="tok-n">saved_batch</span><span class="tok-o">.</span><span class="tok-n">qty</span> <span class="tok-o">==</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">_purchased_quantity</span>
    <span class="tok-k">assert</span> <span class="tok-n">saved_batch</span><span class="tok-o">.</span><span class="tok-n">eta</span> <span class="tok-o">==</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">eta</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The second test is a bit more involved since it has allocations,
but it is still made up of familiar-looking Django code:</p>
</div>
<div id="django_repo_test2" class="exampleblock">
<div class="title">Second repository test is more involved (tests/integration/test_repository.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@pytest.mark.django_db</span>
<span class="tok-k">def</span> <span class="tok-nf">test_repository_can_retrieve_a_batch_with_allocations</span><span class="tok-p">():</span>
    <span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;PONY-STATUE&quot;</span>
    <span class="tok-n">d_line</span> <span class="tok-o">=</span> <span class="tok-n">django_models</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-o">=</span><span class="tok-s2">&quot;order1&quot;</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-mi">12</span><span class="tok-p">)</span>
    <span class="tok-n">d_batch1</span> <span class="tok-o">=</span> <span class="tok-n">django_models</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span>
        <span class="tok-n">reference</span><span class="tok-o">=</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span>
    <span class="tok-p">)</span>
    <span class="tok-n">d_batch2</span> <span class="tok-o">=</span> <span class="tok-n">django_models</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span>
        <span class="tok-n">reference</span><span class="tok-o">=</span><span class="tok-s2">&quot;batch2&quot;</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span>
    <span class="tok-p">)</span>
    <span class="tok-n">django_models</span><span class="tok-o">.</span><span class="tok-n">Allocation</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-o">=</span><span class="tok-n">d_line</span><span class="tok-p">,</span> <span class="tok-n">batch</span><span class="tok-o">=</span><span class="tok-n">d_batch1</span><span class="tok-p">)</span>

    <span class="tok-n">repo</span> <span class="tok-o">=</span> <span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">DjangoRepository</span><span class="tok-p">()</span>
    <span class="tok-n">retrieved</span> <span class="tok-o">=</span> <span class="tok-n">repo</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">)</span>

    <span class="tok-n">expected</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-s2">&quot;batch1&quot;</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">None</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">retrieved</span> <span class="tok-o">==</span> <span class="tok-n">expected</span>  <span class="tok-c1"># Batch.__eq__ only compares reference</span>
    <span class="tok-k">assert</span> <span class="tok-n">retrieved</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">==</span> <span class="tok-n">expected</span><span class="tok-o">.</span><span class="tok-n">sku</span>
    <span class="tok-k">assert</span> <span class="tok-n">retrieved</span><span class="tok-o">.</span><span class="tok-n">_purchased_quantity</span> <span class="tok-o">==</span> <span class="tok-n">expected</span><span class="tok-o">.</span><span class="tok-n">_purchased_quantity</span>
    <span class="tok-k">assert</span> <span class="tok-n">retrieved</span><span class="tok-o">.</span><span class="tok-n">_allocations</span> <span class="tok-o">==</span> <span class="tok-p">{</span>
        <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s2">&quot;order1&quot;</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">12</span><span class="tok-p">),</span>
    <span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s how the actual repository ends up looking:</p>
</div>
<div id="django_repository" class="exampleblock">
<div class="title">A Django repository (src/allocation/adapters/repository.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">DjangoRepository</span><span class="tok-p">(</span><span class="tok-n">AbstractRepository</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-nf">add</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">batch</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">batch</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span><span class="tok-n">batch</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">update</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">batch</span><span class="tok-p">):</span>
        <span class="tok-n">django_models</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-o">.</span><span class="tok-n">update_from_domain</span><span class="tok-p">(</span><span class="tok-n">batch</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">_get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">reference</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-n">django_models</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">filter</span><span class="tok-p">(</span>
            <span class="tok-n">reference</span><span class="tok-o">=</span><span class="tok-n">reference</span>
        <span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">first</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">to_domain</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-nf">list</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-p">[</span><span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">to_domain</span><span class="tok-p">()</span> <span class="tok-k">for</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-n">django_models</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You can see that the implementation relies on the Django models having
some custom methods for translating to and from our domain model.<sup class="footnote">[<a id="_footnoteref_42" class="footnote" href="#_footnotedef_42" title="View footnote.">42</a>]</sup></p>
</div>
<div class="sect3">
<h4 id="_custom_methods_on_django_orm_classes_to_translate_tofrom_our_domain_model">E.1.1. Custom Methods on Django ORM Classes to Translate to/from Our Domain Model</h4>
<div class="paragraph">
<p>Those custom methods look something like this:</p>
</div>
<div id="django_models" class="exampleblock">
<div class="title">Django ORM with custom methods for domain model conversion (src/djangoproject/alloc/models.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">django.db</span> <span class="tok-kn">import</span> <span class="tok-n">models</span>
<span class="tok-kn">from</span> <span class="tok-nn">allocation.domain</span> <span class="tok-kn">import</span> <span class="tok-n">model</span> <span class="tok-k">as</span> <span class="tok-n">domain_model</span>

<span class="tok-k">class</span> <span class="tok-nc">Batch</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-n">reference</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">max_length</span><span class="tok-o">=</span><span class="tok-mi">255</span><span class="tok-p">)</span>
    <span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">CharField</span><span class="tok-p">(</span><span class="tok-n">max_length</span><span class="tok-o">=</span><span class="tok-mi">255</span><span class="tok-p">)</span>
    <span class="tok-n">qty</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">IntegerField</span><span class="tok-p">()</span>
    <span class="tok-n">eta</span> <span class="tok-o">=</span> <span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">DateField</span><span class="tok-p">(</span><span class="tok-n">blank</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">,</span> <span class="tok-n">null</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>

    <span class="tok-nd">@staticmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">update_from_domain</span><span class="tok-p">(</span><span class="tok-n">batch</span><span class="tok-p">:</span> <span class="tok-n">domain_model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">):</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">reference</span><span class="tok-o">=</span><span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">reference</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-k">except</span> <span class="tok-n">Batch</span><span class="tok-o">.</span><span class="tok-n">DoesNotExist</span><span class="tok-p">:</span>
            <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-n">reference</span><span class="tok-o">=</span><span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">reference</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">sku</span>
        <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">qty</span> <span class="tok-o">=</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">_purchased_quantity</span>
        <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">eta</span> <span class="tok-o">=</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">eta</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">save</span><span class="tok-p">()</span>
        <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">allocation_set</span><span class="tok-o">.</span><span class="tok-n">set</span><span class="tok-p">(</span>
            <span class="tok-n">Allocation</span><span class="tok-o">.</span><span class="tok-n">from_domain</span><span class="tok-p">(</span><span class="tok-n">l</span><span class="tok-p">,</span> <span class="tok-n">b</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="tok-k">for</span> <span class="tok-n">l</span> <span class="tok-ow">in</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">_allocations</span>
        <span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">to_domain</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">domain_model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">:</span>
        <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-n">domain_model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span>
            <span class="tok-n">ref</span><span class="tok-o">=</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">reference</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">eta</span>
        <span class="tok-p">)</span>
        <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">_allocations</span> <span class="tok-o">=</span> <span class="tok-nb">set</span><span class="tok-p">(</span>
            <span class="tok-n">a</span><span class="tok-o">.</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">to_domain</span><span class="tok-p">()</span>
            <span class="tok-k">for</span> <span class="tok-n">a</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">allocation_set</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">()</span>
        <span class="tok-p">)</span>
        <span class="tok-k">return</span> <span class="tok-n">b</span>


<span class="tok-k">class</span> <span class="tok-nc">OrderLine</span><span class="tok-p">(</span><span class="tok-n">models</span><span class="tok-o">.</span><span class="tok-n">Model</span><span class="tok-p">):</span>
    <span class="tok-c1">#...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For value objects, <code>objects.get_or_create</code> can work, but for entities,
you probably need an explicit try-get/except to handle the upsert.<sup class="footnote">[<a id="_footnoteref_43" class="footnote" href="#_footnotedef_43" title="View footnote.">43</a>]</sup></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We&#8217;ve shown the most complex example here. If you do decide to do this,
be aware that there will be boilerplate! Thankfully it&#8217;s not very
complex boilerplate.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Relationships also need some careful, custom handling.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As in <a href="#chapter_02_repository">Repository Pattern</a>, we use dependency inversion.
    The ORM (Django) depends on the model and not the other way around.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_unit_of_work_pattern_with_django">E.2. Unit of Work Pattern with Django</h3>
<div class="paragraph">
<p>The tests don&#8217;t change too much:</p>
</div>
<div id="test_uow_django" class="exampleblock">
<div class="title">Adapted UoW tests (tests/integration/test_uow.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">insert_batch</span><span class="tok-p">(</span><span class="tok-n">ref</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">django_models</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">create</span><span class="tok-p">(</span><span class="tok-n">reference</span><span class="tok-o">=</span><span class="tok-n">ref</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-n">eta</span><span class="tok-p">)</span>

<span class="tok-k">def</span> <span class="tok-nf">get_allocated_batch_ref</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">return</span> <span class="tok-n">django_models</span><span class="tok-o">.</span><span class="tok-n">Allocation</span><span class="tok-o">.</span><span class="tok-n">objects</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span>
        <span class="tok-n">line__orderid</span><span class="tok-o">=</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">line__sku</span><span class="tok-o">=</span><span class="tok-n">sku</span>
    <span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">reference</span>


<span class="tok-nd">@pytest.mark.django_db</span><span class="tok-p">(</span><span class="tok-n">transaction</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>
<span class="tok-k">def</span> <span class="tok-nf">test_uow_can_retrieve_a_batch_and_allocate_to_it</span><span class="tok-p">():</span>
    <span class="tok-n">insert_batch</span><span class="tok-p">(</span><span class="tok-s1">&#39;batch1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;HIPSTER-WORKBENCH&#39;</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-bp">None</span><span class="tok-p">)</span>

    <span class="tok-n">uow</span> <span class="tok-o">=</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">DjangoUnitOfWork</span><span class="tok-p">()</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">reference</span><span class="tok-o">=</span><span class="tok-s1">&#39;batch1&#39;</span><span class="tok-p">)</span>
        <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-s1">&#39;o1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;HIPSTER-WORKBENCH&#39;</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>
        <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>

    <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">get_allocated_batch_ref</span><span class="tok-p">(</span><span class="tok-s1">&#39;o1&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;HIPSTER-WORKBENCH&#39;</span><span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">batchref</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;batch1&#39;</span>


<span class="tok-nd">@pytest.mark.django_db</span><span class="tok-p">(</span><span class="tok-n">transaction</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-k">def</span> <span class="tok-nf">test_rolls_back_uncommitted_work_by_default</span><span class="tok-p">():</span>
    <span class="tok-o">...</span>

<span class="tok-nd">@pytest.mark.django_db</span><span class="tok-p">(</span><span class="tok-n">transaction</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-k">def</span> <span class="tok-nf">test_rolls_back_on_error</span><span class="tok-p">():</span>
    <span class="tok-o">...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Because we had little helper functions in these tests, the actual
main bodies of the tests are pretty much the same as they were with
SQLAlchemy.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>pytest-django</code> <code>mark.django_db(transaction=True)</code> is required to
test our custom transaction/rollback behaviors.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And the implementation is quite simple, although it took me a few
tries to find which invocation of Django&#8217;s transaction magic
would work:</p>
</div>
<div id="start_uow_django" class="exampleblock">
<div class="title">UoW adapted for Django (src/allocation/service_layer/unit_of_work.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">DjangoUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">):</span>

    <span class="tok-k">def</span> <span class="tok-fm">__enter__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">DjangoRepository</span><span class="tok-p">()</span>
        <span class="tok-n">transaction</span><span class="tok-o">.</span><span class="tok-n">set_autocommit</span><span class="tok-p">(</span><span class="tok-bp">False</span><span class="tok-p">)</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-k">return</span> <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__enter__</span><span class="tok-p">()</span>

    <span class="tok-k">def</span> <span class="tok-fm">__exit__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__exit__</span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">args</span><span class="tok-p">)</span>
        <span class="tok-n">transaction</span><span class="tok-o">.</span><span class="tok-n">set_autocommit</span><span class="tok-p">(</span><span class="tok-bp">True</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">commit</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">for</span> <span class="tok-n">batch</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">seen</span><span class="tok-p">:</span>  <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">update</span><span class="tok-p">(</span><span class="tok-n">batch</span><span class="tok-p">)</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">transaction</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>  <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-k">def</span> <span class="tok-nf">rollback</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">transaction</span><span class="tok-o">.</span><span class="tok-n">rollback</span><span class="tok-p">()</span>  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>set_autocommit(False)</code> was the best way to tell Django to stop
automatically committing each ORM operation immediately, and to
begin a transaction.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then we use the explicit rollback and commits.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>One difficulty: because, unlike with SQLAlchemy, we&#8217;re not
instrumenting the domain model instances themselves, the
<code>commit()</code> command needs to explicitly go through all the
objects that have been touched by every repository and manually
update them back to the ORM.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_api_django_views_are_adapters">E.3. API: Django Views Are Adapters</h3>
<div class="paragraph">
<p>The Django <em>views.py</em> file ends up being almost identical to the
old <em>flask_app.py</em>, because our architecture means it&#8217;s a very
thin wrapper around our service layer (which didn&#8217;t change at all, by the way):</p>
</div>
<div id="django_views" class="exampleblock">
<div class="title">Flask app &#8594; Django views (src/djangoproject/alloc/views.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">os</span><span class="tok-o">.</span><span class="tok-n">environ</span><span class="tok-p">[</span><span class="tok-s1">&#39;DJANGO_SETTINGS_MODULE&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;djangoproject.django_project.settings&#39;</span>
<span class="tok-n">django</span><span class="tok-o">.</span><span class="tok-n">setup</span><span class="tok-p">()</span>

<span class="tok-nd">@csrf_exempt</span>
<span class="tok-k">def</span> <span class="tok-nf">add_batch</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-n">json</span><span class="tok-o">.</span><span class="tok-n">loads</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">body</span><span class="tok-p">)</span>
    <span class="tok-n">eta</span> <span class="tok-o">=</span> <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-s1">&#39;eta&#39;</span><span class="tok-p">]</span>
    <span class="tok-k">if</span> <span class="tok-n">eta</span> <span class="tok-ow">is</span> <span class="tok-ow">not</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
        <span class="tok-n">eta</span> <span class="tok-o">=</span> <span class="tok-n">datetime</span><span class="tok-o">.</span><span class="tok-n">fromisoformat</span><span class="tok-p">(</span><span class="tok-n">eta</span><span class="tok-p">)</span><span class="tok-o">.</span><span class="tok-n">date</span><span class="tok-p">()</span>
    <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">add_batch</span><span class="tok-p">(</span>
        <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-s1">&#39;ref&#39;</span><span class="tok-p">],</span> <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">],</span> <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">],</span> <span class="tok-n">eta</span><span class="tok-p">,</span>
        <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">DjangoUnitOfWork</span><span class="tok-p">(),</span>
    <span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">HttpResponse</span><span class="tok-p">(</span><span class="tok-s1">&#39;OK&#39;</span><span class="tok-p">,</span> <span class="tok-n">status</span><span class="tok-o">=</span><span class="tok-mi">201</span><span class="tok-p">)</span>

<span class="tok-nd">@csrf_exempt</span>
<span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-p">):</span>
    <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-n">json</span><span class="tok-o">.</span><span class="tok-n">loads</span><span class="tok-p">(</span><span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">body</span><span class="tok-p">)</span>
    <span class="tok-k">try</span><span class="tok-p">:</span>
        <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span>
            <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">],</span>
            <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-s1">&#39;sku&#39;</span><span class="tok-p">],</span>
            <span class="tok-n">data</span><span class="tok-p">[</span><span class="tok-s1">&#39;qty&#39;</span><span class="tok-p">],</span>
            <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">DjangoUnitOfWork</span><span class="tok-p">(),</span>
        <span class="tok-p">)</span>
    <span class="tok-k">except</span> <span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OutOfStock</span><span class="tok-p">,</span> <span class="tok-n">services</span><span class="tok-o">.</span><span class="tok-n">InvalidSku</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-n">e</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-n">JsonResponse</span><span class="tok-p">({</span><span class="tok-s1">&#39;message&#39;</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">)},</span> <span class="tok-n">status</span><span class="tok-o">=</span><span class="tok-mi">400</span><span class="tok-p">)</span>

    <span class="tok-k">return</span> <span class="tok-n">JsonResponse</span><span class="tok-p">({</span><span class="tok-s1">&#39;batchref&#39;</span><span class="tok-p">:</span> <span class="tok-n">batchref</span><span class="tok-p">},</span> <span class="tok-n">status</span><span class="tok-o">=</span><span class="tok-mi">201</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_why_was_this_all_so_hard">E.4. Why Was This All So Hard?</h3>
<div class="paragraph">
<p>OK, it works, but it does feel like more effort than Flask/SQLAlchemy. Why is
that?</p>
</div>
<div class="paragraph">
<p>The main reason at a low level is because Django&#8217;s ORM doesn&#8217;t work in the same
way.  We don&#8217;t have an equivalent of the SQLAlchemy classical mapper, so our
<code>ActiveRecord</code> and our domain model can&#8217;t be the same object. Instead we have to
build a manual translation layer behind the repository. That&#8217;s more
work (although once it&#8217;s done, the ongoing maintenance burden shouldn&#8217;t be too
high).</p>
</div>
<div class="paragraph">
<p>Because Django is so tightly coupled to the database, you have to use helpers
like <code>pytest-django</code> and think carefully about test databases, right from
the very first line of code, in a way that we didn&#8217;t have to when we started
out with our pure domain model.</p>
</div>
<div class="paragraph">
<p>But at a higher level, the entire reason that Django is so great
is that it&#8217;s designed around the sweet spot of making it easy to build CRUD
apps with minimal boilerplate. But the entire thrust of our book is about
what to do when your app is no longer a simple CRUD app.</p>
</div>
<div class="paragraph">
<p>At that point, Django starts hindering more than it helps. Things like the
Django admin, which are so awesome when you start out, become actively dangerous
if the whole point of your app is to build a complex set of rules and modeling
around the workflow of state changes.  The Django admin bypasses all of that.</p>
</div>
</div>
<div class="sect2">
<h3 id="_what_to_do_if_you_already_have_django">E.5. What to Do If You Already Have Django</h3>
<div class="paragraph">
<p>So what should you do if you want to apply some of the patterns in this book
to a Django app? We&#8217;d say the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Repository and Unit of Work patterns are going to be quite a lot of work. The
main thing they will buy you in the short term is faster unit tests, so
evaluate whether that benefit feels worth it in your case. In the longer term, they
decouple your app from Django and the database, so if you anticipate wanting
to migrate away from either of those, Repository and UoW are a good idea.</p>
</li>
<li>
<p>The Service Layer pattern might be of interest if you&#8217;re seeing a lot of duplication in
your <em>views.py</em>. It can be a good way of thinking about your use cases separately from your web endpoints.</p>
</li>
<li>
<p>You can still theoretically do DDD and domain modeling with Django models,
tightly coupled as they are to the database; you may be slowed by
migrations, but it shouldn&#8217;t be fatal. So as long as your app is not too
complex and your tests not too slow, you may be able to get something out of
the <em>fat models</em> approach: push as much logic down to your models as possible,
and apply patterns like Entity, Value Object, and Aggregate. However, see
the following caveat.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With that said,
<a href="https://oreil.ly/Nbpjj">word
in the Django community</a> is that people find that the fat models approach runs into
scalability problems of its own, particularly around managing interdependencies
between apps. In those cases, there&#8217;s a lot to be said for extracting out a
business logic or domain layer to sit between your views and forms and
your <em>models.py</em>, which you can then keep as minimal as possible.</p>
</div>
</div>
<div class="sect2">
<h3 id="_steps_along_the_way">E.6. Steps Along the Way</h3>
<div class="paragraph">
<p>Suppose you&#8217;re working on a Django project that you&#8217;re not sure is going
to get complex enough to warrant the patterns we recommend, but you still
want to put a few steps in place to make your life easier, both in the medium
term and if you want to migrate to some of our patterns later. Consider the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One piece of advice we&#8217;ve heard is to put a <em>logic.py</em> into every Django app from day one. This gives you a place to put business logic, and to keep your
forms, views, and models free of business logic. It can become a stepping-stone
for moving to a fully decoupled domain model and/or service layer later.</p>
</li>
<li>
<p>A business-logic layer might start out working with Django model objects and only later become fully decoupled from the framework and work on
plain Python data structures.</p>
</li>
</ul>
</div>
<div class="ulist pagebreak-before">
<ul>
<li>
<p>For the read side, you can get some of the benefits of CQRS by putting reads
into one place, avoiding ORM calls sprinkled all over the place.</p>
</li>
<li>
<p>When separating out modules for reads and modules for domain logic, it
may be worth decoupling yourself from the Django apps hierarchy. Business
concerns will cut across them.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We&#8217;d like to give a shout-out to David Seddon and Ashia Zawaduk for
    talking through some of the ideas in this appendix. They did their best to
    stop us from saying anything really stupid about a topic we don&#8217;t really
    have enough personal experience of, but they may have failed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For more thoughts and actual lived experience dealing with existing
applications, refer to the <a href="#epilogue_1_how_to_get_there_from_here">epilogue</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix_validation">Appendix F: Validation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Whenever we&#8217;re teaching and talking about these techniques, one question that
comes up over and over is "Where should I do validation? Does that belong with
my business logic in the domain model, or is that an infrastructural concern?"</p>
</div>
<div class="paragraph">
<p>As with any architectural question, the answer is: it depends!</p>
</div>
<div class="paragraph">
<p>The most important consideration is that we want to keep our code well separated
so that each part of the system is simple. We don&#8217;t want to clutter our code
with irrelevant detail.</p>
</div>
<div class="sect2">
<h3 id="_what_is_validation_anyway">F.1. What Is Validation, Anyway?</h3>
<div class="paragraph">
<p>When people use the word <em>validation</em>, they usually mean a process whereby they
test the inputs of an operation to make sure that they match certain criteria.
Inputs that match the criteria are considered <em>valid</em>, and inputs that don&#8217;t
are <em>invalid</em>.</p>
</div>
<div class="paragraph">
<p>If the input is invalid, the operation can&#8217;t continue but should exit with
some kind of error. In other words, validation is about creating <em>preconditions</em>. We find it useful
to separate our preconditions into three subtypes: syntax, semantics, and
pragmatics.</p>
</div>
</div>
<div class="sect2">
<h3 id="_validating_syntax">F.2. Validating Syntax</h3>
<div class="paragraph">
<p>In linguistics, the <em>syntax</em> of a language is the set of rules that govern the
structure of grammatical sentences. For example, in English, the sentence
"Allocate three units of <code>TASTELESS-LAMP</code> to order twenty-seven" is grammatically
sound, while the phrase "hat hat hat hat hat hat wibble" is not. We can describe
grammatically correct sentences as <em>well formed</em>.</p>
</div>
<div class="paragraph pagebreak-before">
<p>How does this map to our application? Here are some examples of syntactic rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An <code>Allocate</code> command must have an order ID, a SKU, and a quantity.</p>
</li>
<li>
<p>A quantity is a positive integer.</p>
</li>
<li>
<p>A SKU is a string.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are rules about the shape and structure of incoming data. An <code>Allocate</code>
command without a SKU or an order ID isn&#8217;t a valid message. It&#8217;s the equivalent
of the phrase "Allocate three to."</p>
</div>
<div class="paragraph">
<p>We tend to validate these rules at the edge of the system. Our rule of thumb is
that a message handler should always receive only a message that is well-formed
and contains all required information.</p>
</div>
<div class="paragraph">
<p>One option is to put your validation logic on the message type itself:</p>
</div>
<div id="validation_on_message" class="exampleblock">
<div class="title">Validation on the message class (src/allocation/commands.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-kn">from</span> <span class="tok-nn">schema</span> <span class="tok-kn">import</span> <span class="tok-n">And</span><span class="tok-p">,</span> <span class="tok-n">Schema</span><span class="tok-p">,</span> <span class="tok-n">Use</span>


<span class="tok-nd">@dataclass</span>
<span class="tok-k">class</span> <span class="tok-nc">Allocate</span><span class="tok-p">(</span><span class="tok-n">Command</span><span class="tok-p">):</span>

    <span class="tok-n">_schema</span> <span class="tok-o">=</span> <span class="tok-n">Schema</span><span class="tok-p">({</span>  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-s1">&#39;orderid&#39;</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span>
         <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span>
         <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-n">And</span><span class="tok-p">(</span><span class="tok-n">Use</span><span class="tok-p">(</span><span class="tok-nb">int</span><span class="tok-p">),</span> <span class="tok-k">lambda</span> <span class="tok-n">n</span><span class="tok-p">:</span> <span class="tok-n">n</span> <span class="tok-o">&gt;</span> <span class="tok-mi">0</span><span class="tok-p">)</span>
     <span class="tok-p">},</span> <span class="tok-n">ignore_extra_keys</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>

    <span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span>
    <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span>

    <span class="tok-nd">@classmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">from_json</span><span class="tok-p">(</span><span class="tok-bp">cls</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
       <span class="tok-n">data</span> <span class="tok-o">=</span> <span class="tok-n">json</span><span class="tok-o">.</span><span class="tok-n">loads</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">)</span>
       <span class="tok-k">return</span> <span class="tok-bp">cls</span><span class="tok-p">(</span><span class="tok-o">**</span><span class="tok-n">_schema</span><span class="tok-o">.</span><span class="tok-n">validate</span><span class="tok-p">(</span><span class="tok-n">data</span><span class="tok-p">))</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <a href="https://pypi.org/project/schema">schema library</a> lets us
describe the structure and validation of our messages in a nice declarative way.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>from_json</code> method reads a string as JSON and turns it into our message
type.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This can get repetitive, though, since we need to specify our fields twice,
so we might want to introduce a helper library that can unify the validation and
declaration of our message types:</p>
</div>
<div id="command_factory" class="exampleblock">
<div class="title">A command factory with schema (src/allocation/commands.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">command</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">fields</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">schema</span> <span class="tok-o">=</span> <span class="tok-n">Schema</span><span class="tok-p">(</span><span class="tok-n">And</span><span class="tok-p">(</span><span class="tok-n">Use</span><span class="tok-p">(</span><span class="tok-n">json</span><span class="tok-o">.</span><span class="tok-n">loads</span><span class="tok-p">),</span> <span class="tok-n">fields</span><span class="tok-p">),</span> <span class="tok-n">ignore_extra_keys</span><span class="tok-o">=</span><span class="tok-bp">True</span><span class="tok-p">)</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-bp">cls</span> <span class="tok-o">=</span> <span class="tok-n">make_dataclass</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-p">,</span> <span class="tok-n">fields</span><span class="tok-o">.</span><span class="tok-n">keys</span><span class="tok-p">())</span>
    <span class="tok-bp">cls</span><span class="tok-o">.</span><span class="tok-n">from_json</span> <span class="tok-o">=</span> <span class="tok-k">lambda</span> <span class="tok-n">s</span><span class="tok-p">:</span> <span class="tok-bp">cls</span><span class="tok-p">(</span><span class="tok-o">**</span><span class="tok-n">schema</span><span class="tok-o">.</span><span class="tok-n">validate</span><span class="tok-p">(</span><span class="tok-n">s</span><span class="tok-p">))</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-k">return</span> <span class="tok-bp">cls</span>

<span class="tok-k">def</span> <span class="tok-nf">greater_than_zero</span><span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-p">):</span>
    <span class="tok-k">return</span> <span class="tok-n">x</span> <span class="tok-o">&gt;</span> <span class="tok-mi">0</span>

<span class="tok-n">quantity</span> <span class="tok-o">=</span> <span class="tok-n">And</span><span class="tok-p">(</span><span class="tok-n">Use</span><span class="tok-p">(</span><span class="tok-nb">int</span><span class="tok-p">),</span> <span class="tok-n">greater_than_zero</span><span class="tok-p">)</span>  <i class="conum" data-value="4"></i><b>(4)</b>

<span class="tok-n">Allocate</span> <span class="tok-o">=</span> <span class="tok-n">command</span><span class="tok-p">(</span>  <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="tok-n">orderid</span><span class="tok-o">=</span><span class="tok-nb">int</span><span class="tok-p">,</span>
    <span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-nb">str</span><span class="tok-p">,</span>
    <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-n">quantity</span>
<span class="tok-p">)</span>

<span class="tok-n">AddStock</span> <span class="tok-o">=</span> <span class="tok-n">command</span><span class="tok-p">(</span>
    <span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-nb">str</span><span class="tok-p">,</span>
    <span class="tok-n">qty</span><span class="tok-o">=</span><span class="tok-n">quantity</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>command</code> function takes a message name, plus kwargs for the fields of
the message payload, where the name of the kwarg is the name of the field and
the value is the parser.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We use the <code>make_dataclass</code> function from the dataclass module to dynamically
create our message type.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We patch the <code>from_json</code> method onto our dynamic dataclass.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We can create reusable parsers for quantity, SKU, and so on to keep things DRY.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Declaring a message type becomes a one-liner.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This comes at the expense of losing the types on your dataclass, so bear that
trade-off in mind.</p>
</div>
</div>
<div class="sect2">
<h3 id="_postels_law_and_the_tolerant_reader_pattern">F.3. Postel&#8217;s Law and the Tolerant Reader Pattern</h3>
<div class="paragraph">
<p><em>Postel&#8217;s law</em>, or the <em>robustness principle</em>, tells us, "Be liberal in what you
accept, and conservative in what you emit." We think this applies particularly
well in the context of integration with our other systems. The idea here is
that we should be strict whenever we&#8217;re sending messages to other systems, but
as lenient as possible when we&#8217;re receiving messages from others.</p>
</div>
<div class="paragraph">
<p>For example, our system <em>could</em> validate the format of a SKU. We&#8217;ve been using
made-up SKUs like <code>UNFORGIVING-CUSHION</code> and <code>MISBEGOTTEN-POUFFE</code>. These follow
a simple pattern: two words, separated by dashes, where the second word is the
type of product and the first word is an adjective.</p>
</div>
<div class="paragraph">
<p>Developers <em>love</em> to validate this kind of thing in their messages, and reject
anything that looks like an invalid SKU. This causes horrible problems down the
line when some anarchist releases a product named <code>COMFY-CHAISE-LONGUE</code> or when
a snafu at the supplier results in a shipment of <code>CHEAP-CARPET-2</code>.</p>
</div>
<div class="paragraph">
<p>Really, as the allocation system, it&#8217;s <em>none of our business</em> what the format of
a SKU might be. All we need is an identifier, so we can simply describe it as a
string. This means that the procurement system can change the format whenever
they like, and we won&#8217;t care.</p>
</div>
<div class="paragraph">
<p>This same principle applies to order numbers, customer phone numbers, and much
more. For the most part, we can ignore the internal structure of strings.</p>
</div>
<div class="paragraph">
<p>Similarly, developers <em>love</em> to validate incoming messages with tools like JSON
Schema, or to build libraries that validate incoming messages and share them
among systems. This likewise fails the robustness test.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s imagine, for example, that the procurement system adds new fields to the
<code>ChangeBatchQuantity</code> message that record the reason for the change and the
email of the user responsible for the change.</p>
</div>
<div class="paragraph">
<p>Since these fields don&#8217;t matter to the allocation service, we should simply
ignore them. We can do that in the <code>schema</code> library by passing the keyword arg
<code>ignore_extra_keys=True</code>.</p>
</div>
<div class="paragraph">
<p>This pattern, whereby we extract only the fields we care about and do minimal
validation of them, is the Tolerant Reader pattern.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Validate as little as possible. Read only the fields you need, and don&#8217;t
    overspecify their contents. This will help your system stay robust when other
    systems change over time. Resist the temptation to share message
    definitions between systems: instead, make it easy to define the data you
    depend on. For more info, see Martin Fowler&#8217;s article on the
    <a href="https://oreil.ly/YL_La">Tolerant Reader pattern</a>.
</td>
</tr>
</table>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Is Postel Always Right?</div>
<div class="paragraph">
<p>Mentioning Postel can be quite triggering to some people. They will
<a href="https://oreil.ly/bzLmb">tell you</a>
that Postel is the precise reason that everything on the internet is broken and
we can&#8217;t have nice things. Ask Hynek about SSLv3 one day.</p>
</div>
<div class="paragraph">
<p>We like the Tolerant Reader approach in the particular context of event-based
integration between services that we control, because it allows for independent
evolution of those services.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re in charge of an API that&#8217;s open to the public on the big bad
internet, there might be good reasons to be more conservative about what
inputs you allow.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_validating_at_the_edge">F.4. Validating at the Edge</h3>
<div class="paragraph">
<p>Earlier, we said that we want to avoid cluttering our code with irrelevant
details. In particular, we don&#8217;t want to code defensively inside our domain model.
Instead, we want to make sure that requests are known to be valid before our
domain model or use-case handlers see them. This helps our code stay clean
and maintainable over the long term. We sometimes refer to this as <em>validating
at the edge of the system</em>.</p>
</div>
<div class="paragraph">
<p>In addition to keeping your code clean and free of endless checks and asserts,
bear in mind that invalid data wandering through your system is a time bomb;
the deeper it gets, the more damage it can do, and the fewer tools
you have to respond to it.</p>
</div>
<div class="paragraph">
<p>Back in <a href="#chapter_08_events_and_message_bus">Events and the Message Bus</a>, we said that the message bus was a great place to put
cross-cutting concerns, and validation is a perfect example of that. Here&#8217;s how
we might change our bus to perform validation for us:</p>
</div>
<div id="validation_on_bus" class="exampleblock">
<div class="title">Validation</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">MessageBus</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-nf">handle_message</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">name</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">body</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">):</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">message_type</span> <span class="tok-o">=</span> <span class="tok-nb">next</span><span class="tok-p">(</span><span class="tok-n">mt</span> <span class="tok-k">for</span> <span class="tok-n">mt</span> <span class="tok-ow">in</span> <span class="tok-n">EVENT_HANDLERS</span> <span class="tok-k">if</span> <span class="tok-n">mt</span><span class="tok-o">.</span><span class="tok-vm">__name__</span> <span class="tok-o">==</span> <span class="tok-n">name</span><span class="tok-p">)</span>
            <span class="tok-n">message</span> <span class="tok-o">=</span> <span class="tok-n">message_type</span><span class="tok-o">.</span><span class="tok-n">from_json</span><span class="tok-p">(</span><span class="tok-n">body</span><span class="tok-p">)</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">handle</span><span class="tok-p">([</span><span class="tok-n">message</span><span class="tok-p">])</span>
        <span class="tok-k">except</span> <span class="tok-ne">StopIteration</span><span class="tok-p">:</span>
            <span class="tok-k">raise</span> <span class="tok-ne">KeyError</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s2">&quot;Unknown message name {name}&quot;</span><span class="tok-p">)</span>
        <span class="tok-k">except</span> <span class="tok-n">ValidationError</span> <span class="tok-k">as</span> <span class="tok-n">e</span><span class="tok-p">:</span>
            <span class="tok-n">logging</span><span class="tok-o">.</span><span class="tok-n">error</span><span class="tok-p">(</span>
                <span class="tok-n">f</span><span class="tok-s1">&#39;invalid message of type {name}</span><span class="tok-se">\n</span><span class="tok-s1">&#39;</span>
                <span class="tok-n">f</span><span class="tok-s1">&#39;{body}</span><span class="tok-se">\n</span><span class="tok-s1">&#39;</span>
                <span class="tok-n">f</span><span class="tok-s1">&#39;{e}&#39;</span>
            <span class="tok-p">)</span>
            <span class="tok-k">raise</span> <span class="tok-n">e</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s how we might use that method from our Flask API endpoint:</p>
</div>
<div id="validation_bubbles_up" class="exampleblock">
<div class="title">API bubbles up validation errors (src/allocation/flask_app.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-nd">@app.route</span><span class="tok-p">(</span><span class="tok-s2">&quot;/change_quantity&quot;</span><span class="tok-p">,</span> <span class="tok-n">methods</span><span class="tok-o">=</span><span class="tok-p">[</span><span class="tok-s1">&#39;POST&#39;</span><span class="tok-p">])</span>
<span class="tok-k">def</span> <span class="tok-nf">change_batch_quantity</span><span class="tok-p">():</span>
    <span class="tok-k">try</span><span class="tok-p">:</span>
        <span class="tok-n">bus</span><span class="tok-o">.</span><span class="tok-n">handle_message</span><span class="tok-p">(</span><span class="tok-s1">&#39;ChangeBatchQuantity&#39;</span><span class="tok-p">,</span> <span class="tok-n">request</span><span class="tok-o">.</span><span class="tok-n">body</span><span class="tok-p">)</span>
    <span class="tok-k">except</span> <span class="tok-n">ValidationError</span> <span class="tok-k">as</span> <span class="tok-n">e</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-n">bad_request</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">)</span>
    <span class="tok-k">except</span> <span class="tok-n">exceptions</span><span class="tok-o">.</span><span class="tok-n">InvalidSku</span> <span class="tok-k">as</span> <span class="tok-n">e</span><span class="tok-p">:</span>
        <span class="tok-k">return</span> <span class="tok-n">jsonify</span><span class="tok-p">({</span><span class="tok-s1">&#39;message&#39;</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">)}),</span> <span class="tok-mi">400</span>

<span class="tok-k">def</span> <span class="tok-nf">bad_request</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">:</span> <span class="tok-n">ValidationError</span><span class="tok-p">):</span>
    <span class="tok-k">return</span> <span class="tok-n">e</span><span class="tok-o">.</span><span class="tok-n">code</span><span class="tok-p">,</span> <span class="tok-mi">400</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>And here&#8217;s how we might plug it in to our asynchronous message processor:</p>
</div>
<div id="validation_pubsub" class="exampleblock">
<div class="title">Validation errors when handling Redis messages (src/allocation/redis_pubsub.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">handle_change_batch_quantity</span><span class="tok-p">(</span><span class="tok-n">m</span><span class="tok-p">,</span> <span class="tok-n">bus</span><span class="tok-p">:</span> <span class="tok-n">messagebus</span><span class="tok-o">.</span><span class="tok-n">MessageBus</span><span class="tok-p">):</span>
    <span class="tok-k">try</span><span class="tok-p">:</span>
        <span class="tok-n">bus</span><span class="tok-o">.</span><span class="tok-n">handle_message</span><span class="tok-p">(</span><span class="tok-s1">&#39;ChangeBatchQuantity&#39;</span><span class="tok-p">,</span> <span class="tok-n">m</span><span class="tok-p">)</span>
    <span class="tok-k">except</span> <span class="tok-n">ValidationError</span><span class="tok-p">:</span>
       <span class="tok-k">print</span><span class="tok-p">(</span><span class="tok-s1">&#39;Skipping invalid message&#39;</span><span class="tok-p">)</span>
    <span class="tok-k">except</span> <span class="tok-n">exceptions</span><span class="tok-o">.</span><span class="tok-n">InvalidSku</span> <span class="tok-k">as</span> <span class="tok-n">e</span><span class="tok-p">:</span>
        <span class="tok-k">print</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s1">&#39;Unable to change stock for missing sku {e}&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Notice that our entrypoints are solely concerned with how to get a message from
the outside world and how to report success or failure. Our message bus takes
care of validating our requests and routing them to the correct handler, and
our handlers are exclusively focused on the logic of our use case.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When you receive an invalid message, there&#8217;s usually little you can do but
    log the error and continue. At MADE we use metrics to count the number of
    messages a system receives, and how many of those are successfully
    processed, skipped, or invalid. Our monitoring tools will alert us if we
    see spikes in the numbers of bad messages.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_validating_semantics">F.5. Validating Semantics</h3>
<div class="paragraph">
<p>While syntax is concerned with the structure of messages, <em>semantics</em> is the study
of <em>meaning</em> in messages. The sentence "Undo no dogs from ellipsis four" is
syntactically valid and has the same structure as the sentence "Allocate one
teapot to order five,"" but it is meaningless.</p>
</div>
<div class="paragraph">
<p>We can read this JSON blob as an <code>Allocate</code> command but can&#8217;t successfully
execute it, because it&#8217;s <em>nonsense</em>:</p>
</div>
<div id="invalid_order" class="exampleblock">
<div class="title">A meaningless message</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-p">{</span>
  <span class="tok-s2">&quot;orderid&quot;</span><span class="tok-p">:</span> <span class="tok-s2">&quot;superman&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;sku&quot;</span><span class="tok-p">:</span> <span class="tok-s2">&quot;zygote&quot;</span><span class="tok-p">,</span>
  <span class="tok-s2">&quot;qty&quot;</span><span class="tok-p">:</span> <span class="tok-o">-</span><span class="tok-mi">1</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We tend to validate semantic concerns at the message-handler layer with a kind
of contract-based programming:</p>
</div>
<div id="ensure_dot_py" class="exampleblock">
<div class="title">Preconditions (src/allocation/ensure.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-sd">&quot;&quot;&quot;</span>
<span class="tok-sd">This module contains preconditions that we apply to our handlers.</span>
<span class="tok-sd">&quot;&quot;&quot;</span>

<span class="tok-k">class</span> <span class="tok-nc">MessageUnprocessable</span><span class="tok-p">(</span><span class="tok-ne">Exception</span><span class="tok-p">):</span>  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">message</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">message</span> <span class="tok-o">=</span> <span class="tok-n">message</span>

<span class="tok-k">class</span> <span class="tok-nc">ProductNotFound</span><span class="tok-p">(</span><span class="tok-n">MessageUnprocessable</span><span class="tok-p">):</span>  <i class="conum" data-value="2"></i><b>(2)</b>
   <span class="tok-sd">&quot;&quot;&quot;&quot;</span>
<span class="tok-sd">   This exception is raised when we try to perform an action on a product</span>
<span class="tok-sd">   that doesn&#39;t exist in our database.</span>
<span class="tok-sd">   &quot;&quot;&quot;</span><span class="tok-s2">&quot;</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">message</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-n">message</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">message</span><span class="tok-o">.</span><span class="tok-n">sku</span>

<span class="tok-k">def</span> <span class="tok-nf">product_exists</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">):</span>  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-n">product</span> <span class="tok-ow">is</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
        <span class="tok-k">raise</span> <span class="tok-n">ProductNotFound</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use a common base class for errors that mean a message is invalid.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Using a specific error type for this problem makes it easier to report on
and handle the error. For example, it&#8217;s easy to map <code>ProductNotFound</code> to a 404
in Flask.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>product_exists</code> is a precondition. If the condition is <code>False</code>, we raise an
error.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This keeps the main flow of our logic in the service layer clean and declarative:</p>
</div>
<div id="ensure_in_services" class="exampleblock">
<div class="title">Ensure calls in services (src/allocation/services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-c1"># services.py</span>

<span class="tok-kn">from</span> <span class="tok-nn">allocation</span> <span class="tok-kn">import</span> <span class="tok-n">ensure</span>

<span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">):</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">mode</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">qty</span><span class="tok-p">)</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
<span class="hll">        <span class="tok-n">ensure</span><span class="tok-o">.</span><span class="tok-n">product_exists</span><span class="tok-p">(</span><span class="tok-n">uow</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">)</span>
</span>
        <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">)</span>
        <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We can extend this technique to make sure that we apply messages idempotently.
For example, we want to make sure that we don&#8217;t insert a batch of stock more
than once.</p>
</div>
<div class="paragraph">
<p>If we get asked to create a batch that already exists, we&#8217;ll log a warning and
continue to the next message:</p>
</div>
<div id="skipmessage" class="exampleblock">
<div class="title">Raise SkipMessage exception for ignorable events (src/allocation/services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">SkipMessage</span> <span class="tok-p">(</span><span class="tok-ne">Exception</span><span class="tok-p">):</span>
    <span class="tok-sd">&quot;&quot;&quot;&quot;</span>
<span class="tok-sd">    This exception is raised when a message can&#39;t be processed, but there&#39;s no</span>
<span class="tok-sd">    incorrect behavior. For example, we might receive the same message multiple</span>
<span class="tok-sd">    times, or we might receive a message that is now out of date.</span>
<span class="tok-sd">    &quot;&quot;&quot;</span><span class="tok-s2">&quot;</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">reason</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">reason</span> <span class="tok-o">=</span> <span class="tok-n">reason</span>

<span class="tok-k">def</span> <span class="tok-nf">batch_is_new</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">event</span><span class="tok-p">,</span> <span class="tok-n">uow</span><span class="tok-p">):</span>
    <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-o">.</span><span class="tok-n">batchid</span><span class="tok-p">)</span>
    <span class="tok-k">if</span> <span class="tok-n">batch</span> <span class="tok-ow">is</span> <span class="tok-ow">not</span> <span class="tok-bp">None</span><span class="tok-p">:</span>
        <span class="tok-k">raise</span> <span class="tok-n">SkipMessage</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s2">&quot;Batch with id {event.batchid} already exists&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Introducing a <code>SkipMessage</code> exception lets us handle these cases in a generic
way in our message bus:</p>
</div>
<div id="skip_in_bus" class="exampleblock">
<div class="title">The bus now knows how to skip (src/allocation/messagebus.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">MessageBus</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-nf">handle_message</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">message</span><span class="tok-p">):</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
           <span class="tok-o">...</span>
       <span class="tok-k">except</span> <span class="tok-n">SkipMessage</span> <span class="tok-k">as</span> <span class="tok-n">e</span><span class="tok-p">:</span>
           <span class="tok-n">logging</span><span class="tok-o">.</span><span class="tok-n">warn</span><span class="tok-p">(</span><span class="tok-n">f</span><span class="tok-s2">&quot;Skipping message {message.id} because {e.reason}&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There are a couple of pitfalls to be aware of here. First, we need to be sure
that we&#8217;re using the same UoW that we use for the main logic of our
use case. Otherwise, we open ourselves to irritating concurrency bugs.</p>
</div>
<div class="paragraph">
<p>Second, we should try to avoid putting <em>all</em> our business logic into these
precondition checks. As a rule of thumb, if a rule <em>can</em> be tested inside our
domain model, then it <em>should</em> be tested in the domain model.</p>
</div>
</div>
<div class="sect2">
<h3 id="_validating_pragmatics">F.6. Validating Pragmatics</h3>
<div class="paragraph">
<p><em>Pragmatics</em> is the study of how we understand language in context. After we have
parsed a message and grasped its meaning, we still need to process it in
context. For example, if you get a comment on a pull request saying, "I think
this is very brave," it may mean that the reviewer admires your courage—unless
they&#8217;re British, in which case, they&#8217;re trying to tell you that what you&#8217;re doing
is insanely risky, and only a fool would attempt it. Context is everything.</p>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Validation Recap</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Validation means different things to different people</dt>
<dd>
<p>When talking about validation, make sure you&#8217;re clear about what you&#8217;re
validating.
We find it useful to think about syntax, semantics, and pragmatics: the
structure of messages, the meaningfulness of messages, and the business
logic governing our response to messages.</p>
</dd>
<dt class="hdlist1">Validate at the edge when possible</dt>
<dd>
<p>Validating required fields and the permissible ranges of numbers is <em>boring</em>,
and we want to keep it out of our nice clean codebase. Handlers should always
receive only valid messages.</p>
</dd>
<dt class="hdlist1">Only validate what you require</dt>
<dd>
<p>Use the Tolerant Reader pattern: read only the fields your application needs
and don&#8217;t overspecify their internal structure. Treating fields as opaque
strings buys you a lot of flexibility.</p>
</dd>
<dt class="hdlist1">Spend time writing helpers for validation</dt>
<dd>
<p>Having a nice declarative way to validate incoming messages and apply
preconditions to your handlers will make your codebase much cleaner.
It&#8217;s worth investing time to make boring code easy to maintain.</p>
</dd>
<dt class="hdlist1">Locate each of the three types of validation in the right place</dt>
<dd>
<p>Validating syntax can happen on message classes, validating
semantics can happen in the service layer or on the message bus,
and validating pragmatics belongs in the domain model.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Once you&#8217;ve validated the syntax and semantics of your commands
    at the edges of your system, the domain is the place for the rest
    of your validation.  Validation of pragmatics is often a core part
    of your business rules.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In software terms, the pragmatics of an operation are usually managed by the
domain model. When we receive a message like "allocate three million units of
<code>SCARCE-CLOCK</code> to order 76543," the message is <em>syntactically</em> valid and
<em>semantically</em> valid, but we&#8217;re unable to comply because we don&#8217;t have the stock
available.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. <code>python -c "import this"</code>
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. If you&#8217;ve come across     class-responsibility-collaborator (CRC) cards, they&#8217;re     driving at the same thing: thinking about <em>responsibilities</em> helps you decide how to split things up.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. SOLID is an acronym for Robert C. Martin&#8217;s five principles of object-oriented design: single responsibility, open for extension but closed for modification, Liskov substitution, interface segregation, and dependency inversion. See <a href="https://oreil.ly/UFM7U">"S.O.L.I.D: The First 5 Principles of Object-Oriented Design"</a> by Samuel Oloruntoba.
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. DDD did not originate domain modeling. Eric Evans refers to the 2002 book <em>Object Design</em> by Rebecca Wirfs-Brock and Alan McKean  (Addison-Wesley Professional), which introduced responsibility-driven design, of which DDD is a special case dealing with the domain. But even that is too late, and OO enthusiasts will tell you to look further back to Ivar Jacobson and Grady Booch; the term has been around since the mid-1980s.
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. In previous Python versions, we might have used a namedtuple. You could also check out Hynek Schlawack&#8217;s excellent <a href="https://pypi.org/project/attrs">attrs</a>.
</div>
<div class="footnote" id="_footnotedef_6">
<a href="#_footnoteref_6">6</a>. Or perhaps you think there&#8217;s not enough code?  What about some sort of check that the SKU in the <code>OrderLine</code> matches <code>Batch.sku</code>?  We saved some thoughts on validation for <a href="#appendix_validation">Validation</a>.
</div>
<div class="footnote" id="_footnotedef_7">
<a href="#_footnoteref_7">7</a>. It is appalling. Please, please don&#8217;t do this. —Harry
</div>
<div class="footnote" id="_footnotedef_8">
<a href="#_footnoteref_8">8</a>. The <code>__eq__</code> method is pronounced "dunder-EQ." By some, at least.
</div>
<div class="footnote" id="_footnotedef_9">
<a href="#_footnoteref_9">9</a>. Domain services are not the same thing as the services from the <a href="#chapter_04_service_layer">service layer</a>, although they are often closely related. A domain service represents a business concept or process, whereas a service-layer service represents a use case for your application. Often the service layer will call a domain service.
</div>
<div class="footnote" id="_footnotedef_10">
<a href="#_footnoteref_10">10</a>. I suppose we mean "no stateful dependencies." Depending on a helper library is fine; depending on an ORM or a web framework is not.
</div>
<div class="footnote" id="_footnotedef_11">
<a href="#_footnoteref_11">11</a>. Mark Seemann has <a href="https://oreil.ly/LpFS9">an excellent blog post</a> on the topic.
</div>
<div class="footnote" id="_footnotedef_12">
<a href="#_footnoteref_12">12</a>. In this sense, using an ORM is already an example of the DIP. Instead of depending on hardcoded SQL, we depend on an abstraction, the ORM. But that&#8217;s not enough for us—not in this book!
</div>
<div class="footnote" id="_footnotedef_13">
<a href="#_footnoteref_13">13</a>. Even in projects where we don&#8217;t use an ORM, we often use SQLAlchemy alongside Alembic to declaratively create schemas in Python and to manage migrations, connections, and sessions.
</div>
<div class="footnote" id="_footnotedef_14">
<a href="#_footnoteref_14">14</a>. Shout-out to the amazingly helpful SQLAlchemy maintainers, and to Mike Bayer in particular.
</div>
<div class="footnote" id="_footnotedef_15">
<a href="#_footnoteref_15">15</a>. You may be thinking, "What about <code>list</code> or <code>delete</code> or <code>update</code>?" However, in an ideal world, we modify our model objects one at a time, and delete is usually handled as a soft-delete—i.e., <code>batch.cancel()</code>. Finally, update is taken care of by the Unit of Work pattern, as you&#8217;ll see in <a href="#chapter_06_uow">Unit of Work Pattern</a>.
</div>
<div class="footnote" id="_footnotedef_16">
<a href="#_footnoteref_16">16</a>. To really reap the benefits of ABCs (such as they may be), be running helpers like <code>pylint</code> and <code>mypy</code>.
</div>
<div class="footnote" id="_footnotedef_17">
<a href="#_footnoteref_17">17</a>. Diagram inspired by a post called <a href="https://oreil.ly/fQXkP">"Global Complexity, Local Simplicity"</a> by Rob Vens.
</div>
<div class="footnote" id="_footnotedef_18">
<a href="#_footnoteref_18">18</a>. A code kata is a small, contained programming challenge often used to practice TDD. See <a href="https://oreil.ly/vhjju">"Kata—The Only Way to Learn TDD"</a> by Peter Provost.
</div>
<div class="footnote" id="_footnotedef_19">
<a href="#_footnoteref_19">19</a>. If you&#8217;re used to thinking in terms of interfaces, that&#8217;s what we&#8217;re trying to define here.
</div>
<div class="footnote" id="_footnotedef_20">
<a href="#_footnoteref_20">20</a>. Which is not to say that we think the London school people are wrong. Some insanely smart people work that way. It&#8217;s just not what we&#8217;re used to.
</div>
<div class="footnote" id="_footnotedef_21">
<a href="#_footnoteref_21">21</a>. Service-layer services and domain services do have confusingly similar names. We tackle this topic later in <a href="#why_is_everything_a_service">Why Is Everything Called a Service?</a>.
</div>
<div class="footnote" id="_footnotedef_22">
<a href="#_footnoteref_22">22</a>. A valid concern about writing tests at a higher level is that it can lead to combinatorial explosion for more complex use cases. In these cases, dropping down to lower-level unit tests of the various collaborating domain objects can be useful. But see also <a href="#chapter_08_events_and_message_bus">Events and the Message Bus</a> and <a href="#fake_message_bus">Optionally: Unit Testing Event Handlers in Isolation with a Fake Message Bus</a>.
</div>
<div class="footnote" id="_footnotedef_23">
<a href="#_footnoteref_23">23</a>. You may have come across the use of the word <em>collaborators</em> to describe objects that work together to achieve a goal. The unit of work and the repository are a great example of collaborators in the object-modeling sense. In responsibility-driven design, clusters of objects that collaborate in their roles are called <em>object neighborhoods</em>, which is, in our professional opinion, totally adorable.
</div>
<div class="footnote" id="_footnotedef_24">
<a href="#_footnoteref_24">24</a>. Perhaps we could get some ORM/SQLAlchemy magic to tell us when an object is dirty, but how would that work in the generic case—for example, for a <code>CsvRepository</code>?
</div>
<div class="footnote" id="_footnotedef_25">
<a href="#_footnoteref_25">25</a>. <code>time.sleep()</code> works well in our use case, but it&#8217;s not the most reliable or efficient way to reproduce concurrency bugs.  Consider using semaphores or similar synchronization primitives shared between your threads to get better guarantees of behavior.
</div>
<div class="footnote" id="_footnotedef_26">
<a href="#_footnoteref_26">26</a>. If you&#8217;re not using Postgres, you&#8217;ll need to read different documentation. Annoyingly, different databases all have quite different definitions. Oracle&#8217;s <code>SERIALIZABLE</code> is equivalent to Postgres&#8217;s <code>REPEATABLE READ</code>, for <span class="keep-together">example</span>.
</div>
<div class="footnote" id="_footnotedef_27">
<a href="#_footnoteref_27">27</a>. This principle is the <em>S</em> in <a href="https://oreil.ly/AIdSD">SOLID</a>.
</div>
<div class="footnote" id="_footnotedef_28">
<a href="#_footnoteref_28">28</a>. Our tech reviewer Ed Jung likes to say that the move from imperative to event-based flow control changes what used to be <em>orchestration</em> into <em>choreography</em>.
</div>
<div class="footnote" id="_footnotedef_29">
<a href="#_footnoteref_29">29</a>. Event-based modeling is so popular that a practice called <em>event storming</em> has been developed for facilitating event-based requirements gathering and domain model elaboration.
</div>
<div class="footnote" id="_footnotedef_30">
<a href="#_footnoteref_30">30</a>. If you&#8217;ve done a bit of reading about event-driven   architectures, you may be thinking, "Some of these events sound more like   commands!" Bear with us! We&#8217;re trying to introduce one concept at a time.   In the <a href="#chapter_10_commands">next chapter</a>, we&#8217;ll introduce the distinction   between commands and events.
</div>
<div class="footnote" id="_footnotedef_31">
<a href="#_footnoteref_31">31</a>. The "simple" implementation in this chapter essentially uses the <em>messagebus.py</em> module itself to implement the Singleton Pattern.
</div>
<div class="footnote" id="_footnotedef_32">
<a href="#_footnoteref_32">32</a>. Because Python is not a "pure" OO language, Python developers aren&#8217;t necessarily used to the concept of needing to <em>compose</em> a set of objects into a working application. We just pick our entrypoint and run code from top to bottom.
</div>
<div class="footnote" id="_footnotedef_33">
<a href="#_footnoteref_33">33</a>. Mark Seemann calls this <a href="https://oreil.ly/iGpDL"><em>Pure DI</em></a> or sometimes <em>Vanilla DI</em>.
</div>
<div class="footnote" id="_footnotedef_34">
<a href="#_footnoteref_34">34</a>. However, it&#8217;s still a global in the <code>flask_app</code> module scope, if that makes sense. This may cause problems if you ever find yourself wanting to test your Flask app in-process by using the Flask Test Client instead of using Docker as we do. It&#8217;s worth researching <a href="https://oreil.ly/_a6Kl">Flask app factories</a> if you get into this.
</div>
<div class="footnote" id="_footnotedef_35">
<a href="#_footnoteref_35">35</a>. Splitting out images for production and testing is sometimes a good idea, but we&#8217;ve tended to find that going further and trying to split out different images for different types of application code (e.g., Web API versus pub/sub client) usually ends up being more trouble than it&#8217;s worth; the cost in terms of complexity and longer rebuild/CI times is too high. YMMV.
</div>
<div class="footnote" id="_footnotedef_36">
<a href="#_footnoteref_36">36</a>. A pure-Python alternative to Makefiles is <a href="http://www.pyinvoke.org">Invoke</a>, worth checking out if everyone on your team knows Python (or at least knows it better than Bash!).
</div>
<div class="footnote" id="_footnotedef_37">
<a href="#_footnoteref_37">37</a>. <a href="https://hynek.me/articles/testing-packaging">"Testing and Packaging"</a> by Hynek Schlawack provides more information on <em>src</em> folders.
</div>
<div class="footnote" id="_footnotedef_38">
<a href="#_footnoteref_38">38</a>. This gives us a local development setup that "just works" (as much as possible). You may prefer to fail hard on missing environment variables instead, particularly if any of the defaults would be insecure in production.
</div>
<div class="footnote" id="_footnotedef_39">
<a href="#_footnoteref_39">39</a>. Harry is a bit YAML-weary. It&#8217;s <em>everywhere</em>, and yet he can never remember the syntax or how it&#8217;s supposed to indent.
</div>
<div class="footnote" id="_footnotedef_40">
<a href="#_footnoteref_40">40</a>. On a CI server, you may not be able to expose arbitrary ports reliably, but it&#8217;s only a convenience for local dev. You can find ways of making these port mappings optional (e.g., with <em>docker-compose.override.yml</em>).
</div>
<div class="footnote" id="_footnotedef_41">
<a href="#_footnoteref_41">41</a>. For more <em>setup.py</em> tips, see <a href="https://oreil.ly/KMWDz">this article on packaging</a> by Hynek.
</div>
<div class="footnote" id="_footnotedef_42">
<a href="#_footnoteref_42">42</a>. The DRY-Python project people have built a tool called <a href="https://mappers.readthedocs.io/en/latest">mappers</a> that looks like it might help minimize boilerplate for this sort of thing.
</div>
<div class="footnote" id="_footnotedef_43">
<a href="#_footnoteref_43">43</a>. <code>@mr-bo-jangles</code> suggested you might be able to use <a href="https://oreil.ly/HTq1r"><code>update_or_create</code></a>, but that&#8217;s beyond our Django-fu.
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-03-16 11:03:29 UTC
</div>
</div>
<style>
pre.pygments .hll { background-color: #ffffcc }
pre.pygments  { background: #f0f0f0; }
pre.pygments .tok-c { color: #60a0b0; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #007020; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #60a0b0; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #60a0b0; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #007020 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #60a0b0; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #60a0b0; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #60a0b0; background-color: #fff0f0 } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #FF0000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
pre.pygments .tok-go { color: #888888 } /* Generic.Output */
pre.pygments .tok-gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #007020; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #007020; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #007020; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #007020 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #007020; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #902000 } /* Keyword.Type */
pre.pygments .tok-m { color: #40a070 } /* Literal.Number */
pre.pygments .tok-s { color: #4070a0 } /* Literal.String */
pre.pygments .tok-na { color: #4070a0 } /* Name.Attribute */
pre.pygments .tok-nb { color: #007020 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0e84b5; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #60add5 } /* Name.Constant */
pre.pygments .tok-nd { color: #555555; font-weight: bold } /* Name.Decorator */
pre.pygments .tok-ni { color: #d55537; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #007020 } /* Name.Exception */
pre.pygments .tok-nf { color: #06287e } /* Name.Function */
pre.pygments .tok-nl { color: #002070; font-weight: bold } /* Name.Label */
pre.pygments .tok-nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #062873; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #bb60d5 } /* Name.Variable */
pre.pygments .tok-ow { color: #007020; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #40a070 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #40a070 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #40a070 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #40a070 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #40a070 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #4070a0 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #4070a0 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #4070a0 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #4070a0 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #4070a0; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #4070a0 } /* Literal.String.Double */
pre.pygments .tok-se { color: #4070a0; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #4070a0 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #70a0d0; font-style: italic } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #c65d09 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #235388 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #4070a0 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #517918 } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #007020 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #06287e } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #bb60d5 } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #bb60d5 } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #bb60d5 } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #bb60d5 } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #40a070 } /* Literal.Number.Integer.Long */
</style>
</body>
</html>