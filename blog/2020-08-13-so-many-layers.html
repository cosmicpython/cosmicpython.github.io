<!DOCTYPE html>
<html lang="en">

  <head>
    <title>
      
        So Many Layers! A Note of Caution.
      
    </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Harry Percival and Bob Gregory">
    <meta name="description" content="">
    <meta property="og:title" content="cosmic_python" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.cosmicpython.com/blog/2020-08-13-so-many-layers.html" />
    <meta property="og:image" content="https://www.cosmicpython.com/images/lobster_nebula.jpg" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/milligram/1.3.0/milligram.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pygments-css@1.0.0/friendly.css">
    <link rel="stylesheet" href="/styles.css">

  </head>

  <body>
    <main class="wrapper">

      <nav class="navigation">
        <section class="container">
          <a class="navigation-title" href="/">
            <h1 class="title">Cosmic Python</h1>
          </a>
        </section>
      </nav>

      <section class="container">
        
  <h1> So Many Layers! A Note of Caution.</h1>
  <p>by Harry, 2020-08-13</p>

  
    <div class="row">
      <div class="column">
        <img src="/images/slice_of_sagittarius.jpg" />
        
          <p class="float-right">
            <em><small><a href="https://www.nasa.gov/image-feature/goddard/2017/hubbles-slice-of-sagittarius">
              find out more about this image
            </a></small></em></p>
        
      </div>
    </div>
  

  <div class="content">
    <p>In the book we are at pains to point out that each pattern is a trade-off, and
comes with costs.  But just on the offchance that anyone was still missing the
message and thinking we were saying that <em>all</em> apps should be built like this,
I thought I&rsquo;d write a small blog post just to reinforce the message about
costs.</p>
<p>Each time you add a layer, you buy yourself some decoupling, but it
comes at the cost of an extra moving part.  In the simplest terms, there&rsquo;s an
extra file you have to maintain.</p>
<p><a href="/book/appendix_ds1_table.html">
<figure>
  <img src="/book/images/apwp_aa01.png" alt="a recap of all the layers + parts of our architecture" max-height="60%">
  <figcaption>Here&rsquo;s a recap of all the layers + parts of our architecture</figcaption>
</figure>
</a></p>
<p>So. Once upon a time, early in my time at MADE, I remember having to make a
simple change to an app that the buying team uses. We needed to record an extra
piece of information for each shipment, an optional &ldquo;delay&rdquo; field to be used in
some ETA calculations.  This is a nice illustration of a trip all the way
through the stack, because things have to change all the way from the
frontend/UI, all the way down to the database.</p>
<p>If you&rsquo;re using a framework like Django, you might be used to thinking of a
change like this, in a perfect world, as a change you can make to just <strong>one</strong> file.
You would change <code>models.py</code>, and then your <code>ModelForm</code> will be updated automatically,
and maybe even the frontend will &ldquo;just work&rdquo; too, if you&rsquo;re using the form&rsquo;s
autogenerated HTML.  That&rsquo;s one of the reasons that Django is so good as a
rapid application development framework: by closely coupling its various parts,
it saves you a lot of messing about with database tables, html forms,
validation, and so on. And if those are the main things you spend your time on,
then Django is going to save you a lot of time.</p>
<p>But in our world (at least in theory <a href="#in_theory">*</a>),
database tables and html forms are <em>not</em> where we spend our time.  Instead, we
want to optimise for capturing and understand business logic, and as a
result we want to <em>decouple</em> things.</p>
<p>What does it cost?  Well, let&rsquo;s take a trip through each file I had to touch,
when I was making my <em>very minor</em> change to the data model in our app.</p>
<ol start="0"><li>
  I started off with editing a selenium test of the frontend, plus a javascript
  frontend test, plus the frontend javascript itself, plus an html template.
  That's four files already, but they're not strictly relevant to the patterns
  and layers whose cost I want to account for, so I'm going to say they don't
  count.  If you think I'm cheating, don't worry; there's plenty more to come.
</li></ol>

<p>So:</p>
<ol>
<li>An <strong>end-to-end / API test</strong> for the create and edit use cases for the objects in question.</li>
<li>The <strong>Command classes</strong> that capture those <a href="/book/chapter_10_commands.html">write interactions</a> a user can have
   with this model.</li>
<li>The <strong>Command schema</strong> which we use to <a href="/book/appendix_validation.html">validate incoming requests</a>.</li>
<li>The <strong>Service-Layer tests</strong> which instantiates those commands to test their
   handlers</li>
<li>The <strong>Handlers at the Service Layer</strong> that orchestrate these use cases.</li>
<li>The <strong>Domain Model tests</strong> that were affected. Although
   <a href="/book/chapter_05_high_gear_low_gear.html">not every domain model needs low-level unit tests as well as service-layer
   tests</a>,
   so if I was being indulgent I might not count this.  But we did happen to
   have a few low-level tests in this case.</li>
<li>The <strong>Domain Model</strong> <a href="/book/chapter_01_domain_model.html">itself</a>.</li>
<li>The <strong>Repository integration test</strong>
  (repo and DB stuff is in <a href="/book/chapter_02_repository.html">chapter 3</a>)</li>
<li>The <strong>Repository and ORM config</strong> </li>
<li>The <strong>database schema</strong></li>
<li>A <strong>migration file</strong> (admittedly autogenerated by Alembic, but we like to just give them a bit of a tidy-up before committing).</li>
<li>The <strong>Event classes</strong> that capture ongoing <a href="/book/chapter_08_events_and_message_bus.html">internal</a> / <a href="/book/chapter_11_external_events.html">external</a> consequences
    of the various affected use cases</li>
<li>The <strong>Event schema</strong> files we use for (outbound) <a href="/book/appendix_validation.html">validation</a>.</li>
<li>And that&rsquo;s not all!  Because this app uses <a href="/book/chapter_12_cqrs.html">CQRS</a>, the read-side is separate from the
write side, so I also had to change some <strong>API JSON view tests</strong></li>
<li>And the <strong>CQRS JSON views code</strong></li>
</ol>
<p>So that&rsquo;s fifteen files.  Fifteen!  To add one field!</p>
<p>Now I should add that each change was very simple.  Most were a matter of
copy-pasting a line and some find+replace.  The whole job might have taken an hour
or so.  But if you&rsquo;re used to this sort of thing taking five minutes and happening
in a single file, or at most a couple, then when first confronted with all these
layers, you are definitely going to start questioning the sanity of the entire
endeavour.  I know I certainly did.</p>
<p>We think the cost we impose on ourselves here is worth it, because we believe
that the main thing we want to make easy is not adding database fields and html
forms.  We want to make it easy to capture complex and evolving business
requirements in a <a href="/book/chapter_01_domain_model.html">domain model</a>.  But, as we try to say in each chapter,
your mileage may vary!</p>
<div id="#in_theory"><small><i>
  OK, in theory.  In practice, I think this particular app was a _little_
  overengineered. It was one of the first ones that the team had complete
  freedom to try new patterns on, and they may have gone to town a bit...
  But on the other hand, there is now talk of converting that app to eventsourcing,
  and thanks to all the layers, that would be relatively easy. Relatively.
</i></small></div>
  </div>

  <div id="disqus_thread" style="margin: 10px"></div>
  <script>

  var disqus_config = function () {
    this.page.url = 'https://www.cosmicpython.com/blog/2020-08-13-so-many-layers.html';
    this.page.identifier = 'cosmic-python--blog-2020-08-13-so-many-layers';
  };

  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://cosmic-python.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-40928035-3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-40928035-3');
  </script>

      </section>
    </main>
  </body>
</html>