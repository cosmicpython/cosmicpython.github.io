<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Aggregates and Consistency Boundaries</title>
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */

@import url("//fonts.googleapis.com/css?family=Noto+Sans:300,600italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700");
@import url(//asciidoctor.org/stylesheets/asciidoctor.css); /* Default asciidoc style framework - important */

/* customisations by harry */

h1, h2, h3, h4, h5, h6 {
    position: relative;
}

a.anchor {
    top: 0;
}

/* hide inline ditaa/plantuml source listings for images */
.image-source {
    display: none
}
/* make formal codeblocks a bit nicer */
.exampleblock > .content {
    padding: 2px;
    background-color: white;
    border: 0;
    margin-bottom: 2em;
}
.exampleblock .title {
    text-align: right;
}

/* prev/next chapter links at bottom of page */
.prev_and_next_chapter_links {
    margin: 10px;
}
.prev_chapter_link {
    float: left;
}
.next_chapter_link {
    float: right;
}


/* a few tweaks to existing styles */
#toc li {
    margin-top: 0.5em;
}

#footnotes hr {
    width: 100%;
}

/* end customisations by harry */


/* CUSTOMISATIONS */

/* Change the values in root for quick customisation. If you want even more fine grain... venture further. */

:root{
--maincolor:#FFFFFF;
--primarycolor:#2c3e50;
--secondarycolor:#ba3925;
--tertiarycolor: #186d7a;
--sidebarbackground:#CCC;
--linkcolor:#b71c1c;
--linkcoloralternate:#f44336;
--white:#FFFFFF;
--black:#000000;
}

/* Text styles */
h1{color:var(--primarycolor) !important;}

h2,h3,h4,h5,h6{color:var(--secondarycolor) !important;}

.title{color:var(--tertiarycolor) !important; font-family:"Noto Sans",sans-serif !important;font-style: normal !important; font-weight: normal !important;}
p{font-family: "Noto Sans",sans-serif !important}

/* Table styles */
th{font-family: "Noto Sans",sans-serif !important}

/* Responsiveness fixes */
video {
  max-width: 100%;
}

@media all and (max-width: 600px) {
table {
  width: 55vw!important;
  font-size: 3vw;
}

</style>
<style>
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f0f0f0; }
pre.pygments .tok-c { color: #60a0b0; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #007020; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #60a0b0; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #60a0b0; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #007020 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #60a0b0; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #60a0b0; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #60a0b0; background-color: #fff0f0 } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #FF0000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
pre.pygments .tok-go { color: #888888 } /* Generic.Output */
pre.pygments .tok-gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #007020; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #007020; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #007020; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #007020 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #007020; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #902000 } /* Keyword.Type */
pre.pygments .tok-m { color: #40a070 } /* Literal.Number */
pre.pygments .tok-s { color: #4070a0 } /* Literal.String */
pre.pygments .tok-na { color: #4070a0 } /* Name.Attribute */
pre.pygments .tok-nb { color: #007020 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0e84b5; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #60add5 } /* Name.Constant */
pre.pygments .tok-nd { color: #555555; font-weight: bold } /* Name.Decorator */
pre.pygments .tok-ni { color: #d55537; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #007020 } /* Name.Exception */
pre.pygments .tok-nf { color: #06287e } /* Name.Function */
pre.pygments .tok-nl { color: #002070; font-weight: bold } /* Name.Label */
pre.pygments .tok-nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #062873; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #bb60d5 } /* Name.Variable */
pre.pygments .tok-ow { color: #007020; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #40a070 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #40a070 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #40a070 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #40a070 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #40a070 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #4070a0 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #4070a0 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #4070a0 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #4070a0 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #4070a0; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #4070a0 } /* Literal.String.Double */
pre.pygments .tok-se { color: #4070a0; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #4070a0 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #70a0d0; font-style: italic } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #c65d09 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #235388 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #4070a0 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #517918 } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #007020 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #06287e } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #bb60d5 } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #bb60d5 } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #bb60d5 } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #bb60d5 } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #40a070 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="buy_the_book" style="position: absolute; top: 0; right: 0; z-index:100">
  <a href="/#buy_the_book">
    <img src="/images/buy_the_book.svg" alt="buy the book ribbon">
  </a>
</div>
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="/book/preface.html">Preface</a></li>
<li><a href="/book/introduction.html">Introduction</a></li>
<li><a href="/book/part1.html">Part 1: Building an Architecture to Support Domain Modeling</a></li>
<li><a href="/book/chapter_01_domain_model.html">1. Domain Modeling</a></li>
<li><a href="/book/chapter_02_repository.html">2. Repository Pattern</a></li>
<li><a href="/book/chapter_03_abstractions.html">3. A Brief Interlude: On Coupling <span class="keep-together">and Abstractions</span></a></li>
<li><a href="/book/chapter_04_service_layer.html">4. Our First Use Case: <span class="keep-together">Flask API and Service Layer</span></a></li>
<li><a href="/book/chapter_05_high_gear_low_gear.html">5. TDD in High Gear and Low Gear</a></li>
<li><a href="/book/chapter_06_uow.html">6. Unit of Work Pattern</a></li>
<li><a href="/book/chapter_07_aggregate.html">7. Aggregates and Consistency Boundaries</a></li>
<li><a href="/book/part2.html">Part 2: Event-Driven Architecture</a></li>
<li><a href="/book/chapter_08_events_and_message_bus.html">8. Events and the Message Bus</a></li>
<li><a href="/book/chapter_09_all_messagebus.html">9. Going to Town on the Message Bus</a></li>
<li><a href="/book/chapter_10_commands.html">10. Commands and Command Handler</a></li>
<li><a href="/book/chapter_11_external_events.html">11. Event-Driven Architecture: Using Events to Integrate Microservices</a></li>
<li><a href="/book/chapter_12_cqrs.html">12. Command-Query Responsibility Segregation (CQRS)</a></li>
<li><a href="/book/chapter_13_dependency_injection.html">13. Dependency Injection (and Bootstrapping)</a></li>
<li><a href="/book/epilogue_1_how_to_get_there_from_here.html">Epilogue: Epilogue</a></li>
<li><a href="/book/appendix_ds1_table.html">Appendix A: Summary Diagram and Table</a></li>
<li><a href="/book/appendix_project_structure.html">Appendix B: A Template Project Structure</a></li>
<li><a href="/book/appendix_csvs.html">Appendix C: Swapping Out the Infrastructure: Do Everything with CSVs</a></li>
<li><a href="/book/appendix_django.html">Appendix D: Repository and Unit of Work Patterns with Django</a></li>
<li><a href="/book/appendix_validation.html">Appendix E: Validation</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="chapter_07_aggregate">7: Aggregates and Consistency Boundaries<a class="anchor" href="#chapter_07_aggregate"></a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>



In this chapter, we&#8217;d like to revisit our domain model to talk about invariants
and constraints, and see how our domain objects can maintain their own
internal consistency, both conceptually and in persistent storage.  We&#8217;ll
discuss the concept of a <em>consistency boundary</em> and show how making it
explicit can help us to build high-performance software without compromising
maintainability.</p>
</div>
<div class="paragraph">
<p><a href="#maps_chapter_06">Adding the Product aggregate</a> shows a preview of where we&#8217;re headed: we&#8217;ll introduce
a new model object called <code>Product</code> to wrap multiple batches, and we&#8217;ll make
the old <code>allocate()</code> domain service available as a method on <code>Product</code> instead.</p>
</div>
<div id="maps_chapter_06" class="imageblock">
<div class="content">
<img src="images/apwp_0701.png" alt="apwp 0701">
</div>
<div class="title">Figure 1. Adding the Product aggregate</div>
</div>
<div class="paragraph">
<p>Why? Let&#8217;s find out.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The code for this chapter is in the chapter_07_aggregate branch
<a href="https://github.com/cosmicpython/code/tree/chapter_07_aggregate">on <span class="keep-together">GitHub</span></a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/cosmicpython/code.git
cd code
git checkout chapter_07_aggregate
# or to code along, checkout the previous chapter:
git checkout chapter_06_uow</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_why_not_just_run_everything_in_a_spreadsheet"><a class="anchor" href="#_why_not_just_run_everything_in_a_spreadsheet"></a>Why Not Just Run Everything in a Spreadsheet?</h3>
<div class="paragraph">
<p>

What&#8217;s the point of a domain model, anyway? What&#8217;s the fundamental problem
we&#8217;re trying to address?</p>
</div>
<div class="paragraph">
<p>Couldn&#8217;t we just run everything in a spreadsheet? Many of our users would be
<span class="keep-together">delighted</span> by that. Business users <em>like</em> spreadsheets because
they&#8217;re simple, familiar, and yet enormously powerful.</p>
</div>
<div class="paragraph">
<p>
In fact, an enormous number of business processes do operate by manually sending
spreadsheets back and forth over email. This "CSV over SMTP" architecture has
low initial complexity but tends not to scale very well because it&#8217;s difficult
to apply logic and maintain consistency.</p>
</div>
<div class="paragraph">
<p>Who is allowed to view this particular field? Who&#8217;s allowed to update it? What
happens when we try to order &#8211;350 chairs, or 10,000,000 tables? Can an employee
have a negative salary?</p>
</div>
<div class="paragraph">
<p>These are the constraints of a system. Much of the domain logic we write exists
to enforce these constraints in order to maintain the invariants of the
system. The <em>invariants</em> are the things that have to be true whenever we finish
an operation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_invariants_constraints_and_consistency"><a class="anchor" href="#_invariants_constraints_and_consistency"></a>Invariants, Constraints, and Consistency</h3>
<div class="paragraph">
<p>

The two words are somewhat interchangeable, but a <em>constraint</em> is a
rule that restricts the possible states our model can get into, while an <em>invariant</em>
is defined a little more precisely as a condition that is always true.</p>
</div>
<div class="paragraph">
<p>
If we were writing a hotel-booking system, we might have the constraint that double
bookings are not allowed. This supports the invariant that a room cannot have more
than one booking for the same night.</p>
</div>
<div class="paragraph">
<p>
Of course, sometimes we might need to temporarily <em>bend</em> the rules. Perhaps we
need to shuffle the rooms around because of a VIP booking. While we&#8217;re moving
bookings around in memory, we might be double booked, but our domain model
should ensure that, when we&#8217;re finished, we end up in a final consistent state,
where the invariants are met. If we can&#8217;t find a way to accommodate all our guests,
we should raise an error and refuse to complete the operation.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at a couple of concrete examples from our business requirements; we&#8217;ll start with this one:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>An order line can be allocated to only one batch at a time.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; The business
</div>
</div>
<div class="paragraph">
<p>
This is a business rule that imposes an invariant. The invariant is that an
order line is allocated to either zero or one batch, but never more than one.
We need to make sure that our code never accidentally calls <code>Batch.allocate()</code>
on two different batches for the same line, and currently, there&#8217;s nothing
there to explicitly stop us from doing that.</p>
</div>
<div class="sect3">
<h4 id="_invariants_concurrency_and_locks"><a class="anchor" href="#_invariants_concurrency_and_locks"></a>Invariants, Concurrency, and Locks</h4>
<div class="paragraph">
<p>
Let&#8217;s look at another one of our business rules:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>We can&#8217;t allocate to a batch if the available quantity is less than the
quantity of the order line.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; The business
</div>
</div>
<div class="paragraph">
<p>
Here the constraint is that we can&#8217;t allocate more stock than is available to a
batch, so we never oversell stock by allocating two customers to the same
physical cushion, for example. Every time we update the state of the system, our code needs
to ensure that we don&#8217;t break the invariant, which is that the available
quantity must be greater than or equal to zero.</p>
</div>
<div class="paragraph">
<p>In a single-threaded, single-user application, it&#8217;s relatively easy for us to
maintain this invariant. We can just allocate stock one line at a time, and
raise an error if there&#8217;s no stock available.</p>
</div>
<div class="paragraph">
<p>
This gets much harder when we introduce the idea of <em>concurrency</em>. Suddenly we
might be allocating stock for multiple order lines simultaneously. We might
even be allocating order lines at the same time as processing changes to the
batches <span class="keep-together">themselves</span>.</p>
</div>
<div class="paragraph">
<p>
We usually solve this problem by applying <em>locks</em> to our database tables. This
prevents two operations from happening simultaneously on the same row or same
table.</p>
</div>
<div class="paragraph">
<p>As we start to think about scaling up our app, we realize that our model
of allocating lines against all available batches may not scale. If we process
tens of thousands of orders per hour, and hundreds of thousands of
order lines, we can&#8217;t hold a lock over the whole <code>batches</code> table for
every single one&#8212;&#8203;we&#8217;ll get deadlocks or performance problems at the very least.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_what_is_an_aggregate"><a class="anchor" href="#_what_is_an_aggregate"></a>What Is an Aggregate?</h3>
<div class="paragraph">
<p>


OK, so if we can&#8217;t lock the whole database every time we want to allocate an
order line, what should we do instead? We want to protect the invariants of our
system but allow for the greatest degree of concurrency. Maintaining our
invariants inevitably means preventing concurrent writes; if multiple users can
allocate <code>DEADLY-SPOON</code> at the same time, we run the risk of overallocating.</p>
</div>
<div class="paragraph">
<p>On the other hand, there&#8217;s no reason we can&#8217;t allocate <code>DEADLY-SPOON</code> at the
same time as <code>FLIMSY-DESK</code>. It&#8217;s safe to allocate two products at the
same time because there&#8217;s no invariant that covers them both. We don&#8217;t need them
to be consistent with each other.</p>
</div>
<div class="paragraph">
<p>

The <em>Aggregate</em> pattern is a design pattern from the DDD community that helps us
to resolve this tension. An <em>aggregate</em> is just a domain object that contains
other domain objects and lets us treat the whole collection as a single unit.</p>
</div>
<div class="paragraph">
<p>The only way to modify the objects inside the aggregate is to load the whole
thing, and to call methods on the aggregate itself.</p>
</div>
<div class="paragraph">
<p>
As a model gets more complex and grows more entity and value objects,
referencing each other in a tangled graph, it can be hard to keep track of who
can modify what. Especially when we have <em>collections</em> in the model as we do
(our batches are a collection), it&#8217;s a good idea to nominate some entities to be
the single entrypoint for modifying their related objects. It makes the system
conceptually simpler and easy to reason about if you nominate some objects to be
in charge of consistency for the others.</p>
</div>
<div class="paragraph">
<p>For example, if we&#8217;re building a shopping site, the Cart might make a good
aggregate: it&#8217;s a collection of items that we can treat as a single unit.
Importantly, we want to load the entire basket as a single blob from our data
store. We don&#8217;t want two requests to modify the basket at the same time, or we
run the risk of weird concurrency errors. Instead, we want each change to the
basket to run in a single database transaction.</p>
</div>
<div class="paragraph">
<p>
We don&#8217;t want to modify multiple baskets in a transaction, because there&#8217;s no
use case for changing the baskets of several customers at the same time. Each
basket is a single <em>consistency boundary</em> responsible for maintaining its own
invariants.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>An AGGREGATE is a cluster of associated objects that we treat as a unit for the
purpose of data changes.
</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Eric Evans<br>
<cite>Domain-Driven Design blue book</cite>
</div>
</div>
<div class="paragraph">
<p>Per Evans, our aggregate has a root entity (the Cart) that encapsulates access
to items. Each item has its own identity, but other parts of the system will always
refer to the Cart only as an indivisible whole.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Just as we sometimes use <code><em>_leading_underscores</em></code> to mark methods or functions
    as "private," you can think of aggregates as being the "public" classes of our
    model, and the rest of the entities and value objects as "private."
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_choosing_an_aggregate"><a class="anchor" href="#_choosing_an_aggregate"></a>Choosing an Aggregate</h3>
<div class="paragraph">
<p>

What aggregate should we use for our system? The choice is somewhat arbitrary,
but it&#8217;s important. The aggregate will be the boundary where we make sure
every operation ends in a consistent state. This helps us to reason about our
software and prevent weird race issues. We want to draw a boundary around a
small number of objects&#8212;the smaller, the better, for performance&#8212;that have to
be consistent with one another, and we need to give this boundary a good name.</p>
</div>
<div class="paragraph">
<p>
The object we&#8217;re manipulating under the covers is <code>Batch</code>. What do we call a
collection of batches? How should we divide all the batches in the system into
discrete islands of consistency?</p>
</div>
<div class="paragraph">
<p>We <em>could</em> use <code>Shipment</code> as our boundary. Each shipment contains several
batches, and they all travel to our warehouse at the same time. Or perhaps we
could use <code>Warehouse</code> as our boundary: each warehouse contains many batches,
and counting all the stock at the same time could make sense.</p>
</div>
<div class="paragraph">
<p>Neither of these concepts really satisfies us, though. We should be able to
allocate <code>DEADLY-SPOONs</code> or <code>FLIMSY-DESKs</code> in one go, even if they&#8217;re not in the
same warehouse or the same shipment. These concepts have the wrong granularity.</p>
</div>
<div class="paragraph">
<p>When we allocate an order line, we&#8217;re interested only in batches
that have the same SKU as the order line. Some sort of concept like
<code>GlobalSkuStock</code> could work: a collection of all the batches for a given SKU.</p>
</div>
<div class="paragraph">
<p>It&#8217;s an unwieldy name, though, so after some bikeshedding via <code>SkuStock</code>, <code>Stock</code>,
<code>ProductStock</code>, and so on, we decided to simply call it <code>Product</code>&#8212;after all,
that was the first concept we came across in our exploration of the
domain language back in <a href="/book/chapter_01_domain_model.html">[chapter_01_domain_model]</a>.</p>
</div>
<div class="paragraph">
<p>

So the plan is this: when we want to allocate an order line, instead of
<a href="#before_aggregates_diagram">Before: allocate against all batches using the domain service</a>, where we look up all the <code>Batch</code> objects in
the world and pass them to the <code>allocate()</code> domain service&#8230;&#8203;</p>
</div>
<div id="before_aggregates_diagram" class="imageblock width-60">
<div class="content">
<img src="images/apwp_0702.png" alt="apwp 0702">
</div>
<div class="title">Figure 2. Before: allocate against all batches using the domain service</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_0702, config=plantuml.cfg]
@startuml
scale 4

hide empty members

package "Service Layer" as services {
    class "allocate()" as allocate {
    }
    hide allocate circle
    hide allocate members
}



package "Domain Model" as domain_model {

  class Batch {
  }

  class "allocate()" as allocate_domain_service {
  }
    hide allocate_domain_service circle
    hide allocate_domain_service members
}


package Repositories {

  class BatchRepository {
    list()
  }

}

allocate -&gt; BatchRepository: list all batches
allocate --&gt; allocate_domain_service: allocate(orderline, batches)

@enduml</pre>
</div>
</div>
<div class="paragraph">
<p>

&#8230;&#8203;we&#8217;ll move to the world of <a href="#after_aggregates_diagram">After: ask Product to allocate against its batches</a>, in which there is a new
<code>Product</code> object for the particular SKU of our order line, and it will be in charge
of all the batches <em>for that SKU</em>, and we can call a <code>.allocate()</code> method on that
instead.</p>
</div>
<div id="after_aggregates_diagram" class="imageblock width-75">
<div class="content">
<img src="images/apwp_0703.png" alt="apwp 0703">
</div>
<div class="title">Figure 3. After: ask Product to allocate against its batches</div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_0703, config=plantuml.cfg]
@startuml
scale 4

hide empty members

package "Service Layer" as services {
    class "allocate()" as allocate {
    }
}

hide allocate circle
hide allocate members


package "Domain Model" as domain_model {

  class Product {
    allocate()
  }

  class Batch {
  }
}


package Repositories {

  class ProductRepository {
    get()
  }

}

allocate -&gt; ProductRepository: get me the product for this SKU
allocate --&gt; Product: product.allocate(orderline)
Product o- Batch: has

@enduml</pre>
</div>
</div>
<div class="paragraph">
<p>
Let&#8217;s see how that looks in code form:</p>
</div>
<div id="product_aggregate" class="exampleblock pagebreak-before">
<div class="title">Our chosen aggregate, Product (src/allocation/domain/model.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Product</span><span class="tok-p">:</span>
    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">:</span> <span class="tok-n">List</span><span class="tok-p">[</span><span class="tok-n">Batch</span><span class="tok-p">]):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">sku</span>  #<b class="conum">(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">batches</span>  #<b class="conum">(2)</b>

    <span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>  #<b class="conum">(3)</b>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-nb">next</span><span class="tok-p">(</span><span class="tok-n">b</span> <span class="tok-k">for</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-nb">sorted</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-p">)</span> <span class="tok-k">if</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">can_allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">))</span>
            <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
            <span class="tok-k">return</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">reference</span>
        <span class="tok-k">except</span> <span class="tok-ne">StopIteration</span><span class="tok-p">:</span>
            <span class="tok-k">raise</span> <span class="tok-n">OutOfStock</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"Out of stock for sku </span><span class="tok-si">{</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>Product</code>'s main identifier is the <code>sku</code>.</p>
</li>
<li>
<p>Our <code>Product</code> class holds a reference to a collection of <code>batches</code> for that SKU.
</p>
</li>
<li>
<p>Finally, we can move the <code>allocate()</code> domain service to
be a method on the <span class="keep-together"><code>Product</code></span> aggregate.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This <code>Product</code> might not look like what you&#8217;d expect a <code>Product</code>
    model to look like.  No price, no description, no dimensions.
    Our allocation service doesn&#8217;t care about any of those things.
    This is the power of bounded contexts; the concept
    of a product in one app can be very different from another.
    See the following sidebar for more discussion.
    
</td>
</tr>
</table>
</div>
<div id="bounded_contexts_sidebar" class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Aggregates, Bounded Contexts, and Microservices</div>
<div class="paragraph">
<p>
One of the most important contributions from Evans and the DDD community
is the concept of
<a href="https://martinfowler.com/bliki/BoundedContext.html"><em>bounded contexts</em></a>.</p>
</div>
<div class="paragraph">
<p>
In essence, this was a reaction against attempts to capture entire businesses
into a single model. The word <em>customer</em> means different things to people
in sales, customer service, logistics, support, and so on. Attributes
needed in one context are irrelevant in another; more perniciously, concepts
with the same name can have entirely different meanings in different contexts.
Rather than trying to build a single model (or class, or database) to capture
all the use cases, it&#8217;s better to have several models, draw boundaries
around each context, and handle the translation between different contexts
explicitly.</p>
</div>
<div class="paragraph">
<p>
This concept translates very well to the world of microservices, where each
microservice is free to have its own concept of "customer" and its own rules for
translating that to and from other microservices it integrates with.</p>
</div>
<div class="paragraph">
<p>In our example, the allocation service has <code>Product(sku, batches)</code>,
whereas the ecommerce will have <code>Product(sku, description, price, image_url,
dimensions, etc&#8230;&#8203;)</code>. As a rule of thumb, your domain models should
include only the data that they need for performing calculations.</p>
</div>
<div class="paragraph">
<p>Whether or not you have a microservices architecture, a key consideration
in choosing your aggregates is also choosing the bounded context that they
will operate in. By restricting the context, you can keep your number of
aggregates low and their size manageable.</p>
</div>
<div class="paragraph">
<p>
Once again, we find ourselves forced to say that we can&#8217;t give this issue
the treatment it deserves here, and we can only encourage you to read up on it
elsewhere. The Fowler link at the start of this sidebar is a good starting point, and either
(or indeed, any) DDD book will have a chapter or more on bounded contexts.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_one_aggregate_one_repository"><a class="anchor" href="#_one_aggregate_one_repository"></a>One Aggregate = One Repository</h3>
<div class="paragraph">
<p>

Once you define certain entities to be aggregates, we need to apply the rule
that they are the only entities that are publicly accessible to the outside
world.  In other words, the only repositories we are allowed should be
repositories that return aggregates.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The rule that repositories should only return aggregates is the main place
    where we enforce the convention that aggregates are the only way into our
    domain model.  Be wary of breaking it!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>

In our case, we&#8217;ll switch from <code>BatchRepository</code> to <code>ProductRepository</code>:</p>
</div>
<div id="new_uow_and_repository" class="exampleblock">
<div class="title">Our new UoW and repository (unit_of_work.py and repository.py)</div>
<div class="content">
<div class="listingblock skip">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">AbstractUnitOfWork</span><span class="tok-p">(</span><span class="tok-n">abc</span><span class="tok-o">.</span><span class="tok-n">ABC</span><span class="tok-p">):</span>
    <span class="tok-n">products</span><span class="tok-p">:</span> <span class="tok-n">repository</span><span class="tok-o">.</span><span class="tok-n">AbstractProductRepository</span>

<span class="tok-o">...</span>

<span class="tok-k">class</span> <span class="tok-nc">AbstractProductRepository</span><span class="tok-p">(</span><span class="tok-n">abc</span><span class="tok-o">.</span><span class="tok-n">ABC</span><span class="tok-p">):</span>

    <span class="tok-nd">@abc</span><span class="tok-o">.</span><span class="tok-n">abstractmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">add</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">product</span><span class="tok-p">):</span>
        <span class="tok-o">...</span>

    <span class="tok-nd">@abc</span><span class="tok-o">.</span><span class="tok-n">abstractmethod</span>
    <span class="tok-k">def</span> <span class="tok-nf">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">:</span>
        <span class="tok-o">...</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>


The ORM layer will need some tweaks so that the right batches automatically get
loaded and associated with <code>Product</code> objects. The nice thing is, the Repository
pattern means we don&#8217;t have to worry about that yet. We can just use
our <code>FakeRepository</code> and then feed through the new model into our service
layer to see how it looks with <code>Product</code> as its main entrypoint:</p>
</div>
<div id="service_layer_uses_products" class="exampleblock">
<div class="title">Service layer (src/allocation/service_layer/services.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">add_batch</span><span class="tok-p">(</span>
    <span class="tok-n">ref</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-p">:</span> <span class="tok-n">Optional</span><span class="tok-p">[</span><span class="tok-n">date</span><span class="tok-p">],</span>
    <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">,</span>
<span class="tok-p">):</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-n">product</span> <span class="tok-ow">is</span> <span class="tok-kc">None</span><span class="tok-p">:</span>
            <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-o">=</span><span class="tok-p">[])</span>
            <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">product</span><span class="tok-p">)</span>
        <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Batch</span><span class="tok-p">(</span><span class="tok-n">ref</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-p">))</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>


<span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span>
    <span class="tok-n">orderid</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span>
    <span class="tok-n">uow</span><span class="tok-p">:</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">AbstractUnitOfWork</span><span class="tok-p">,</span>
<span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">qty</span><span class="tok-p">)</span>
    <span class="tok-k">with</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-n">product</span> <span class="tok-ow">is</span> <span class="tok-kc">None</span><span class="tok-p">:</span>
            <span class="tok-k">raise</span> <span class="tok-n">InvalidSku</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"Invalid sku </span><span class="tok-si">{</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">)</span>
        <span class="tok-n">batchref</span> <span class="tok-o">=</span> <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>
    <span class="tok-k">return</span> <span class="tok-n">batchref</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_what_about_performance"><a class="anchor" href="#_what_about_performance"></a>What About Performance?</h3>
<div class="paragraph">
<p>

We&#8217;ve mentioned a few times that we&#8217;re modeling with aggregates because we want
to have high-performance software, but here we are loading <em>all</em> the batches when
we only need one. You might expect that to be inefficient, but there are a few
reasons why we&#8217;re comfortable here.</p>
</div>
<div class="paragraph">
<p>First, we&#8217;re purposefully modeling our data so that we can make a single
query to the database to read, and a single update to persist our changes. This
tends to perform much better than systems that issue lots of ad hoc queries. In
systems that don&#8217;t model this way, we often find that transactions slowly
get longer and more complex as the software evolves.</p>
</div>
<div class="paragraph">
<p>Second, our data structures are minimal and comprise a few strings and
integers per row. We can easily load tens or even hundreds of batches in a few
milliseconds.</p>
</div>
<div class="paragraph">
<p>Third, we expect to have only 20 or so batches of each product at a time.
Once a batch is used up, we can discount it from our calculations. This means
that the amount of data we&#8217;re fetching shouldn&#8217;t get out of control over time.</p>
</div>
<div class="paragraph">
<p>If we <em>did</em> expect to have thousands of active batches for a product, we&#8217;d have
a couple of options. For one, we could use lazy-loading for the batches in a
product. From the perspective of our code, nothing would change, but in the
background, SQLAlchemy would page through data for us. This would lead to more
requests, each fetching a smaller number of rows. Because we need to find only a
single batch with enough capacity for our order, this might work pretty well.</p>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Exercise for the Reader</div>
<div class="paragraph">
<p>
You&#8217;ve just seen the main top layers of the code, so this shouldn&#8217;t be too hard,
but we&#8217;d like you to implement the <code>Product</code> aggregate starting from <code>Batch</code>,
just as we did.</p>
</div>
<div class="paragraph">
<p>Of course, you could cheat and copy/paste from the previous listings, but even
if you do that, you&#8217;ll still have to solve a few challenges on your own,
like adding the model to the ORM and making sure all the moving parts can
talk to each other, which we hope will be instructive.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll find the code <a href="https://github.com/cosmicpython/code/tree/chapter_07_aggregate_exercise">on GitHub</a>.
We&#8217;ve put in a "cheating" implementation in the delegates to the existing
<code>allocate()</code> function, so you should be able to evolve that toward the real
thing.</p>
</div>
<div class="paragraph">
<p>
We&#8217;ve marked a couple of tests with <code>@pytest.skip()</code>. After you&#8217;ve read the
rest of this chapter, come back to these tests to have a go at implementing
version numbers. Bonus points if you can get SQLAlchemy to do them for you by
magic!</p>
</div>
</div>
</div>
<div class="paragraph">
<p>If all else failed, we&#8217;d just look for a different aggregate. Maybe we could
split up batches by region or by warehouse. Maybe we could redesign our data
access strategy around the shipment concept. The Aggregate pattern is designed
to help manage some technical constraints around consistency and performance.
There isn&#8217;t <em>one</em> correct aggregate, and we should feel comfortable changing our
minds if we find our boundaries are causing performance woes.</p>
</div>
</div>
<div class="sect2">
<h3 id="_optimistic_concurrency_with_version_numbers"><a class="anchor" href="#_optimistic_concurrency_with_version_numbers"></a>Optimistic Concurrency with Version Numbers</h3>
<div class="paragraph">
<p>


We have our new aggregate, so we&#8217;ve solved the conceptual problem of choosing
an object to be in charge of consistency boundaries.  Let&#8217;s now spend a little
time talking about how to enforce data integrity at the database level.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This section has a lot of implementation details; for example, some of it
    is Postgres-specific. But more generally, we&#8217;re showing one way of managing
    concurrency issues, but it is just one approach. Real requirements in this
    area vary a lot from project to project. You shouldn&#8217;t expect to be able to
    copy and paste code from here into production.
    
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>
We don&#8217;t want to hold a lock over the entire <code>batches</code> table, but how will we
implement holding a lock over just the rows for a particular SKU?</p>
</div>
<div class="paragraph">
<p>
One answer is to have a single attribute on the <code>Product</code> model that acts as a marker for
the whole state change being complete and to use it as the single resource
that concurrent workers can fight over. If two transactions read the
state of the world for <code>batches</code> at the same time, and both want to update
the <code>allocations</code> tables, we force both to also try to update the
<code>version_number</code> in the <code>products</code> table, in such a way that only one of them
can win and the world stays consistent.</p>
</div>
<div class="paragraph">
<p>

<a href="#version_numbers_sequence_diagram">Sequence diagram: two transactions attempting a concurrent update on <span class="keep-together"><code>Product</code></span></a> illustrates two concurrent
transactions doing their read operations at the same time, so they see
a <code>Product</code> with, for example, <code>version=3</code>.  They both call <code>Product.allocate()</code>
in order to modify a state. But we set up our database integrity
rules such that only one of them is allowed to <code>commit</code> the new <code>Product</code>
with <code>version=4</code>, and the other update is rejected.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Version numbers are just one way to implement optimistic locking. You
    could achieve the same thing by setting the Postgres transaction isolation
    level to <code>SERIALIZABLE</code>, but that often comes at a severe performance cost.
    Version numbers also make implicit concepts explicit.
    
</td>
</tr>
</table>
</div>
<div id="version_numbers_sequence_diagram" class="imageblock">
<div class="content">
<img src="images/apwp_0704.png" alt="apwp 0704">
</div>
<div class="title">Figure 4. Sequence diagram: two transactions attempting a concurrent update on <span class="keep-together"><code>Product</code></span></div>
</div>
<div class="listingblock image-source">
<div class="content">
<pre>[plantuml, apwp_0704, config=plantuml.cfg]
@startuml
scale 4

entity Model
collections Transaction1
collections Transaction2
database Database


Transaction1 -&gt; Database: get product
Database -&gt; Transaction1: Product(version=3)
Transaction2 -&gt; Database: get product
Database -&gt; Transaction2: Product(version=3)
Transaction1 -&gt; Model: Product.allocate()
Model -&gt; Transaction1: Product(version=4)
Transaction2 -&gt; Model: Product.allocate()
Model -&gt; Transaction2: Product(version=4)
Transaction1 -&gt; Database: commit Product(version=4)
Database -[#green]&gt; Transaction1: OK
Transaction2 -&gt; Database: commit Product(version=4)
Database -[#red]&gt;x Transaction2: Error! version is already 4

@enduml</pre>
</div>
</div>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Optimistic Concurrency Control and Retries</div>
<div class="paragraph">
<p>What we&#8217;ve implemented here is called <em>optimistic</em> concurrency control because
our default assumption is that everything will be fine when two users want to
make changes to the database. We think it&#8217;s unlikely that they will conflict
with each other, so we let them go ahead and just make sure we have a way to
notice if there is a <span class="keep-together">problem</span>.</p>
</div>
<div class="paragraph">
<p>


<em>Pessimistic</em> concurrency control works under the assumption that two users
are going to cause conflicts, and we want to prevent conflicts in all cases, so
we lock everything just to be safe. In our example, that would mean locking
the whole <code>batches</code> table, or using SELECT FOR UPDATE&#8212;we&#8217;re pretending
that we&#8217;ve ruled those out for performance reasons, but in real life you&#8217;d
want to do some evaluations and measurements of your own.</p>
</div>
<div class="paragraph">
<p>
With pessimistic locking, you don&#8217;t need to think about handling failures
because the database will prevent them for you (although you do need to think
about deadlocks). With optimistic locking, you need to explicitly handle
the possibility of failures in the (hopefully unlikely) case of a clash.</p>
</div>
<div class="paragraph">
<p>
The usual way to handle a failure is to retry the failed operation from the
beginning. Imagine we have two customers, Harry and Bob, and each submits an order
for <code>SHINY-TABLE</code>. Both threads load the product at version 1 and allocate
stock. The database prevents the concurrent update, and Bob&#8217;s order fails with
an error. When we <em>retry</em> the operation, Bob&#8217;s order loads the product at
version 2 and tries to allocate again. If there is enough stock left, all is
well; otherwise, he&#8217;ll receive <code>OutOfStock</code>. Most operations can be retried this
way in the case of a concurrency problem.</p>
</div>
<div class="paragraph">
<p>Read more on retries in <a href="/book/chapter_10_commands.html#recovering_from_errors">[recovering_from_errors]</a> and <a href="/book/epilogue_1_how_to_get_there_from_here.html#footguns">[footguns]</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_implementation_options_for_version_numbers"><a class="anchor" href="#_implementation_options_for_version_numbers"></a>Implementation Options for Version Numbers</h4>
<div class="paragraph">
<p>

There are essentially three options for implementing version numbers:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>version_number</code> lives in the domain; we add it to the <code>Product</code> constructor,
and <code>Product.allocate()</code> is responsible for incrementing it.</p>
</li>
<li>
<p>The service layer could do it!  The version number isn&#8217;t <em>strictly</em> a domain
concern, so instead our service layer could assume that the current version number
is attached to <code>Product</code> by the repository, and the service layer will increment it
before it does the <code>commit()</code>.</p>
</li>
<li>
<p>Since it&#8217;s arguably an infrastructure concern, the UoW and repository
could do it by magic.  The repository has access to version numbers for any
products it retrieves, and when the UoW does a commit, it can increment the
version number for any products it knows about, assuming them to have changed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Option 3 isn&#8217;t ideal, because there&#8217;s no real way of doing it without having to
assume that <em>all</em> products have changed, so we&#8217;ll be incrementing version numbers
when we don&#8217;t have to.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</div>
<div class="paragraph">
<p>Option 2 involves mixing the responsibility for mutating state between the service
layer and the domain layer, so it&#8217;s a little messy as well.</p>
</div>
<div class="paragraph">
<p>So in the end, even though version numbers don&#8217;t <em>have</em> to be a domain concern,
you might decide the cleanest trade-off is to put them in the domain:</p>
</div>
<div id="product_aggregate_with_version_number" class="exampleblock">
<div class="title">Our chosen aggregate, Product (src/allocation/domain/model.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Product</span><span class="tok-p">:</span>
    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">batches</span><span class="tok-p">:</span> <span class="tok-n">List</span><span class="tok-p">[</span><span class="tok-n">Batch</span><span class="tok-p">],</span> <span class="tok-n">version_number</span><span class="tok-p">:</span> <span class="tok-nb">int</span> <span class="tok-o">=</span> <span class="tok-mi">0</span><span class="tok-p">):</span>  #<b class="conum">(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">sku</span> <span class="tok-o">=</span> <span class="tok-n">sku</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span> <span class="tok-o">=</span> <span class="tok-n">batches</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">version_number</span> <span class="tok-o">=</span> <span class="tok-n">version_number</span>  #<b class="conum">(1)</b>

    <span class="tok-k">def</span> <span class="tok-nf">allocate</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">line</span><span class="tok-p">:</span> <span class="tok-n">OrderLine</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
        <span class="tok-k">try</span><span class="tok-p">:</span>
            <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-nb">next</span><span class="tok-p">(</span><span class="tok-n">b</span> <span class="tok-k">for</span> <span class="tok-n">b</span> <span class="tok-ow">in</span> <span class="tok-nb">sorted</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">batches</span><span class="tok-p">)</span> <span class="tok-k">if</span> <span class="tok-n">b</span><span class="tok-o">.</span><span class="tok-n">can_allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">))</span>
            <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">version_number</span> <span class="tok-o">+=</span> <span class="tok-mi">1</span>  #<b class="conum">(1)</b>
            <span class="tok-k">return</span> <span class="tok-n">batch</span><span class="tok-o">.</span><span class="tok-n">reference</span>
        <span class="tok-k">except</span> <span class="tok-ne">StopIteration</span><span class="tok-p">:</span>
            <span class="tok-k">raise</span> <span class="tok-n">OutOfStock</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s2">"Out of stock for sku </span><span class="tok-si">{</span><span class="tok-n">line</span><span class="tok-o">.</span><span class="tok-n">sku</span><span class="tok-si">}</span><span class="tok-s2">"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>There it is!</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
If you&#8217;re scratching your head at this version number business, it might
    help to remember that the <em>number</em> isn&#8217;t important. What&#8217;s important is
    that the <code>Product</code> database row is modified whenever we make a change to the
    <code>Product</code> aggregate. The version number is a simple, human-comprehensible way
    to model a thing that changes on every write, but it could equally be a
    random UUID every time.
    
    
    
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_for_our_data_integrity_rules"><a class="anchor" href="#_testing_for_our_data_integrity_rules"></a>Testing for Our Data Integrity Rules</h3>
<div class="paragraph">
<p>


Now to make sure we can get the behavior we want: if we have two
concurrent attempts to do allocation against the same <code>Product</code>, one of them
should fail, because they can&#8217;t both update the version number.</p>
</div>
<div class="paragraph">
<p>



First, let&#8217;s simulate a "slow" transaction using a function that does
allocation and then does an explicit sleep:<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup></p>
</div>
<div id="time_sleep_thread" class="exampleblock">
<div class="title">time.sleep can reproduce concurrency behavior (tests/integration/test_uow.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">try_to_allocate</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">exceptions</span><span class="tok-p">):</span>
    <span class="tok-n">line</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">OrderLine</span><span class="tok-p">(</span><span class="tok-n">orderid</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">)</span>
    <span class="tok-k">try</span><span class="tok-p">:</span>
        <span class="tok-k">with</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">()</span> <span class="tok-k">as</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
            <span class="tok-n">product</span> <span class="tok-o">=</span> <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">products</span><span class="tok-o">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">)</span>
            <span class="tok-n">product</span><span class="tok-o">.</span><span class="tok-n">allocate</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">)</span>
            <span class="tok-n">time</span><span class="tok-o">.</span><span class="tok-n">sleep</span><span class="tok-p">(</span><span class="tok-mf">0.2</span><span class="tok-p">)</span>
            <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>
    <span class="tok-k">except</span> <span class="tok-ne">Exception</span> <span class="tok-k">as</span> <span class="tok-n">e</span><span class="tok-p">:</span>
        <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">traceback</span><span class="tok-o">.</span><span class="tok-n">format_exc</span><span class="tok-p">())</span>
        <span class="tok-n">exceptions</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>

Then we have our test invoke this slow allocation twice, concurrently, using
threads:</p>
</div>
<div id="data_integrity_test" class="exampleblock">
<div class="title">An integration test for concurrency behavior (tests/integration/test_uow.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">test_concurrent_updates_to_version_are_not_allowed</span><span class="tok-p">(</span><span class="tok-n">postgres_session_factory</span><span class="tok-p">):</span>
    <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">batch</span> <span class="tok-o">=</span> <span class="tok-n">random_sku</span><span class="tok-p">(),</span> <span class="tok-n">random_batchref</span><span class="tok-p">()</span>
    <span class="tok-n">session</span> <span class="tok-o">=</span> <span class="tok-n">postgres_session_factory</span><span class="tok-p">()</span>
    <span class="tok-n">insert_batch</span><span class="tok-p">(</span><span class="tok-n">session</span><span class="tok-p">,</span> <span class="tok-n">batch</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-mi">100</span><span class="tok-p">,</span> <span class="tok-n">eta</span><span class="tok-o">=</span><span class="tok-kc">None</span><span class="tok-p">,</span> <span class="tok-n">product_version</span><span class="tok-o">=</span><span class="tok-mi">1</span><span class="tok-p">)</span>
    <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">commit</span><span class="tok-p">()</span>

    <span class="tok-n">order1</span><span class="tok-p">,</span> <span class="tok-n">order2</span> <span class="tok-o">=</span> <span class="tok-n">random_orderid</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">),</span> <span class="tok-n">random_orderid</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">)</span>
    <span class="tok-n">exceptions</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>  <span class="tok-c1"># type: List[Exception]</span>
    <span class="tok-n">try_to_allocate_order1</span> <span class="tok-o">=</span> <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-n">try_to_allocate</span><span class="tok-p">(</span><span class="tok-n">order1</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">exceptions</span><span class="tok-p">)</span>
    <span class="tok-n">try_to_allocate_order2</span> <span class="tok-o">=</span> <span class="tok-k">lambda</span><span class="tok-p">:</span> <span class="tok-n">try_to_allocate</span><span class="tok-p">(</span><span class="tok-n">order2</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">,</span> <span class="tok-n">exceptions</span><span class="tok-p">)</span>
    <span class="tok-n">thread1</span> <span class="tok-o">=</span> <span class="tok-n">threading</span><span class="tok-o">.</span><span class="tok-n">Thread</span><span class="tok-p">(</span><span class="tok-n">target</span><span class="tok-o">=</span><span class="tok-n">try_to_allocate_order1</span><span class="tok-p">)</span>  #<b class="conum">(1)</b>
    <span class="tok-n">thread2</span> <span class="tok-o">=</span> <span class="tok-n">threading</span><span class="tok-o">.</span><span class="tok-n">Thread</span><span class="tok-p">(</span><span class="tok-n">target</span><span class="tok-o">=</span><span class="tok-n">try_to_allocate_order2</span><span class="tok-p">)</span>  #<b class="conum">(1)</b>
    <span class="tok-n">thread1</span><span class="tok-o">.</span><span class="tok-n">start</span><span class="tok-p">()</span>
    <span class="tok-n">thread2</span><span class="tok-o">.</span><span class="tok-n">start</span><span class="tok-p">()</span>
    <span class="tok-n">thread1</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">()</span>
    <span class="tok-n">thread2</span><span class="tok-o">.</span><span class="tok-n">join</span><span class="tok-p">()</span>

    <span class="tok-p">[[</span><span class="tok-n">version</span><span class="tok-p">]]</span> <span class="tok-o">=</span> <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span>
        <span class="tok-s2">"SELECT version_number FROM products WHERE sku=:sku"</span><span class="tok-p">,</span>
        <span class="tok-nb">dict</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">),</span>
    <span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">version</span> <span class="tok-o">==</span> <span class="tok-mi">2</span>  #<b class="conum">(2)</b>
    <span class="tok-p">[</span><span class="tok-n">exception</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">exceptions</span>
    <span class="tok-k">assert</span> <span class="tok-s2">"could not serialize access due to concurrent update"</span> <span class="tok-ow">in</span> <span class="tok-nb">str</span><span class="tok-p">(</span><span class="tok-n">exception</span><span class="tok-p">)</span>  #<b class="conum">(3)</b>

    <span class="tok-n">orders</span> <span class="tok-o">=</span> <span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span>
        <span class="tok-s2">"SELECT orderid FROM allocations"</span>
        <span class="tok-s2">" JOIN batches ON allocations.batch_id = batches.id"</span>
        <span class="tok-s2">" JOIN order_lines ON allocations.orderline_id = order_lines.id"</span>
        <span class="tok-s2">" WHERE order_lines.sku=:sku"</span><span class="tok-p">,</span>
        <span class="tok-nb">dict</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">),</span>
    <span class="tok-p">)</span>
    <span class="tok-k">assert</span> <span class="tok-n">orders</span><span class="tok-o">.</span><span class="tok-n">rowcount</span> <span class="tok-o">==</span> <span class="tok-mi">1</span>  #<b class="conum">(4)</b>
    <span class="tok-k">with</span> <span class="tok-n">unit_of_work</span><span class="tok-o">.</span><span class="tok-n">SqlAlchemyUnitOfWork</span><span class="tok-p">()</span> <span class="tok-k">as</span> <span class="tok-n">uow</span><span class="tok-p">:</span>
        <span class="tok-n">uow</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">(</span><span class="tok-s2">"select 1"</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We start two threads that will reliably produce the concurrency behavior we
want: <code>read1, read2, write1, write2</code>.</p>
</li>
<li>
<p>We assert that the version number has been incremented only once.</p>
</li>
<li>
<p>We can also check on the specific exception if we like.</p>
</li>
<li>
<p>And we double-check that only one allocation has gotten through.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_enforcing_concurrency_rules_by_using_database_transaction_isolation_levels"><a class="anchor" href="#_enforcing_concurrency_rules_by_using_database_transaction_isolation_levels"></a>Enforcing Concurrency Rules by Using Database Transaction <span class="keep-together">Isolation Levels</span></h4>
<div class="paragraph">
<p>

To get the test to pass as it is, we can set the transaction isolation level
on our session:</p>
</div>
<div id="isolation_repeatable_read" class="exampleblock">
<div class="title">Set isolation level for session (src/allocation/service_layer/unit_of_work.py)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">DEFAULT_SESSION_FACTORY</span> <span class="tok-o">=</span> <span class="tok-n">sessionmaker</span><span class="tok-p">(</span>
    <span class="tok-n">bind</span><span class="tok-o">=</span><span class="tok-n">create_engine</span><span class="tok-p">(</span>
        <span class="tok-n">config</span><span class="tok-o">.</span><span class="tok-n">get_postgres_uri</span><span class="tok-p">(),</span>
        <span class="tok-n">isolation_level</span><span class="tok-o">=</span><span class="tok-s2">"REPEATABLE READ"</span><span class="tok-p">,</span>
    <span class="tok-p">)</span>
<span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Transaction isolation levels are tricky stuff, so it&#8217;s worth spending time
    understanding <a href="https://oreil.ly/5vxJA">the Postgres documentation</a>.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>
    
    
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_pessimistic_concurrency_control_example_select_for_update"><a class="anchor" href="#_pessimistic_concurrency_control_example_select_for_update"></a>Pessimistic Concurrency Control Example: SELECT FOR UPDATE</h4>
<div class="paragraph">
<p>


There are multiple ways to approach this, but we&#8217;ll show one. <a href="https://oreil.ly/i8wKL"><code>SELECT FOR UPDATE</code></a>
produces different behavior; two concurrent transactions will not be allowed to
do a read on the same rows at the same time:</p>
</div>
<div class="paragraph">
<p>
<code>SELECT FOR UPDATE</code> is a way of picking a row or rows to use as a lock
(although those rows don&#8217;t have to be the ones you update).  If two
transactions both try to <code>SELECT FOR UPDATE</code> a row at the same time, one will
win, and the other will wait until the lock is released. So this is an example
of pessimistic concurrency control.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s how you can use the SQLAlchemy DSL to specify <code>FOR UPDATE</code> at
query time:</p>
</div>
<div id="with_for_update" class="exampleblock">
<div class="title">SQLAlchemy with_for_update (src/allocation/adapters/repository.py)</div>
<div class="content">
<div class="listingblock non-head">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span>    <span class="tok-k">def</span> <span class="tok-nf">get</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">sku</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-p">(</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">session</span><span class="tok-o">.</span><span class="tok-n">query</span><span class="tok-p">(</span><span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">Product</span><span class="tok-p">)</span>
            <span class="tok-o">.</span><span class="tok-n">filter_by</span><span class="tok-p">(</span><span class="tok-n">sku</span><span class="tok-o">=</span><span class="tok-n">sku</span><span class="tok-p">)</span>
            <span class="tok-o">.</span><span class="tok-n">with_for_update</span><span class="tok-p">()</span>
            <span class="tok-o">.</span><span class="tok-n">first</span><span class="tok-p">()</span>
        <span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This will have the effect of changing the concurrency pattern from</p>
</div>
<div class="listingblock skip">
<div class="content">
<pre>read1, read2, write1, write2(fail)</pre>
</div>
</div>
<div class="paragraph">
<p>to</p>
</div>
<div class="listingblock skip">
<div class="content">
<pre>read1, write1, read2, write2(succeed)</pre>
</div>
</div>
<div class="paragraph">
<p>

Some people refer to this as the "read-modify-write" failure mode.
Read <a href="https://oreil.ly/uXeZI">"PostgreSQL Anti-Patterns: Read-Modify-Write Cycles"</a> for a good <span class="keep-together">overview</span>.</p>
</div>
<div class="paragraph">
<p>

We don&#8217;t really have time to discuss all the trade-offs between <code>REPEATABLE READ</code>
and <code>SELECT FOR UPDATE</code>, or optimistic versus pessimistic locking in general.
But if you have a test like the one we&#8217;ve shown, you can specify the behavior
you want and see how it changes. You can also use the test as a basis for
performing some performance experiments.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wrap_up"><a class="anchor" href="#_wrap_up"></a>Wrap-Up</h3>
<div class="paragraph">
<p>
Specific choices around concurrency control vary a lot based on business
circumstances and storage technology choices, but we&#8217;d like to bring this
chapter back to the conceptual idea of an aggregate: we explicitly model an
object as being the main entrypoint to some subset of our model, and as being in
charge of enforcing the invariants and business rules that apply across all of
those objects.</p>
</div>
<div class="paragraph">
<p>


Choosing the right aggregate is key, and it&#8217;s a decision you may revisit
over time. You can read more about it in multiple DDD books.
We also recommend these three online papers on
<a href="https://dddcommunity.org/library/vernon_2011">effective aggregate design</a>
by Vaughn Vernon (the "red book" author).</p>
</div>
<div class="paragraph">
<p>
<a href="#chapter_07_aggregate_tradoffs">Aggregates: the trade-offs</a> has some thoughts on the trade-offs of implementing the Aggregate pattern.</p>
</div>
<table id="chapter_07_aggregate_tradoffs" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Aggregates: the trade-offs</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Pros</th>
<th class="tableblock halign-left valign-top">Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Python might not have "official" public and private methods, but we do have
the underscores convention, because it&#8217;s often useful to try to indicate what&#8217;s for
"internal" use and what&#8217;s for "outside code" to use. Choosing aggregates is
just the next level up: it lets you decide which of your domain model classes
are the public ones, and which aren&#8217;t.</p>
</li>
<li>
<p>Modeling our operations around explicit consistency boundaries helps us avoid
performance problems with our ORM.
</p>
</li>
<li>
<p>Putting the aggregate in sole charge of state changes to its subsidiary models
makes the system easier to reason about, and makes it easier to control invariants.</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Yet another new concept for new developers to take on. Explaining entities versus
value objects was already a mental load; now there&#8217;s a third type of domain
model object?</p>
</li>
<li>
<p>Sticking rigidly to the rule that we modify only one aggregate at a time is a
big mental shift.</p>
</li>
<li>
<p>Dealing with eventual consistency between aggregates can be complex.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="sidebarblock nobreakinside less_space">
<div class="content">
<div class="title">Aggregates and Consistency Boundaries Recap</div>
<div class="paragraph">
<p></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Aggregates are your entrypoints into the domain model</dt>
<dd>
<p>By restricting the number of ways that things can be changed,
we make the system easier to reason about.</p>
</dd>
<dt class="hdlist1">Aggregates are in charge of a consistency boundary</dt>
<dd>
<p>An aggregate&#8217;s job is to be able to manage our business rules
about invariants as they apply to a group of related objects.
It&#8217;s the aggregate&#8217;s job to check that the objects within its
remit are consistent with each other and with our rules, and
to reject changes that would break the rules.</p>
</dd>
<dt class="hdlist1">Aggregates and concurrency issues go together</dt>
<dd>
<p>When thinking about implementing these consistency checks, we
end up thinking about transactions and locks.  Choosing the
right aggregate is about performance as well as conceptual
organization of your domain.
</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_part_i_recap"><a class="anchor" href="#_part_i_recap"></a>Part I Recap</h3>
<div class="paragraph">
<p>
Do you remember <a href="#recap_components_diagram">A component diagram for our app at the end of Part I</a>, the diagram we showed at the
beginning of <a href="/book/part1.html">[part1]</a> to preview where we were heading?</p>
</div>
<div id="recap_components_diagram" class="imageblock width-75">
<div class="content">
<img src="images/apwp_0705.png" alt="apwp 0705">
</div>
<div class="title">Figure 5. A component diagram for our app at the end of Part I</div>
</div>
<div class="paragraph">
<p>So that&#8217;s where we are at the end of Part I. What have we achieved? We&#8217;ve
seen how to build a domain model that&#8217;s exercised by a set of
high-level unit tests. Our tests are living documentation: they describe the
behavior of our system&#8212;&#8203;the rules upon which we agreed with our business
stakeholders&#8212;&#8203;in nice readable code. When our business requirements change, we
have confidence that our tests will help us to prove the new functionality, and
when new developers join the project, they can read our tests to understand how
things work.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve decoupled the infrastructural parts of our system, like the database and
API handlers, so that we can plug them into the outside of our application.
This helps us to keep our codebase well organized and stops us from building a
big ball of mud.</p>
</div>
<div class="paragraph">
<p>

By applying the dependency inversion principle, and by using
ports-and-adapters-inspired patterns like Repository and Unit of Work, we&#8217;ve
made it possible to do TDD in both high gear and low gear and to maintain a
healthy test pyramid. We can test our system edge to edge, and the need for
integration and end-to-end tests is kept to a minimum.</p>
</div>
<div class="paragraph">
<p>Lastly, we&#8217;ve talked about the idea of consistency boundaries. We don&#8217;t want to
lock our entire system whenever we make a change, so we have to choose which
parts are consistent with one another.</p>
</div>
<div class="paragraph">
<p>For a small system, this is everything you need to go and play with the ideas of
domain-driven design. You now have the tools to build database-agnostic domain
models that represent the shared language of your business experts. Hurrah!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
At the risk of laboring the point&#8212;&#8203;we&#8217;ve been at pains to point out that
    each pattern comes at a cost. Each layer of indirection has a price in terms
    of complexity and duplication in our code and will be confusing to programmers
    who&#8217;ve never seen these patterns before. If your app is essentially a simple CRUD
    wrapper around a database and isn&#8217;t likely to be anything more than that
    in the foreseeable future, <em>you don&#8217;t need these patterns</em>. Go ahead and
    use Django, and save yourself a lot of bother.
    
    
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In Part II, we&#8217;ll zoom out and talk about a bigger topic: if aggregates are our
boundary, and we can update only one at a time, how do we model processes that
cross consistency boundaries?</p>
</div>
</div>
</div>
</div>
<div class="prev_and_next_chapter_links">
  <hr>
  <a class="prev_chapter_link" href="/book/chapter_06_uow.html">&lt;&lt; Previous - 6: Unit of Work Pattern</a>
  <a class="next_chapter_link" href="/book/part2.html">Next - Part 2: Event-Driven Architecture &gt;&gt;</a>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Perhaps we could get some ORM/SQLAlchemy magic to tell us when an object is dirty, but how would that work in the generic case&#8212;for example, for a <code>CsvRepository</code>?
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. <code>time.sleep()</code> works well in our use case, but it&#8217;s not the most reliable or efficient way to reproduce concurrency bugs.  Consider using semaphores or similar synchronization primitives shared between your threads to get better guarantees of behavior.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. If     you&#8217;re not using Postgres, you&#8217;ll need to read different documentation.     Annoyingly, different databases all have quite different definitions.     Oracle&#8217;s <code>SERIALIZABLE</code> is equivalent to Postgres&#8217;s <code>REPEATABLE READ</code>, for     <span class="keep-together">example</span>.
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-11-24 02:20:52 UTC
</div>
</div>
<div><div id="disqus_thread" style="margin: 10px"></div>
<script>

var disqus_config = function () {
  this.page.url = 'https://www.cosmicpython.com/book/chapter_07_aggregate.html';
  this.page.identifier = 'cosmic-python-chapter_07_aggregate';
};

(function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://cosmic-python.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div><html><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-40928035-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-40928035-3');
</script>
</head></html></body>
</html>